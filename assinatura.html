<!DOCTYPE html>
{% load static %}
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="theme-color" content="#0a000f">
    <title>Assinatura Premium · Beatflow</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/static/icones.ico" type="image/x-icon">

    <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
        --bg-primary: #0a000f;
        --bg-secondary: #14001a;
        --bg-tertiary: #1f0028;
        --border-light: rgba(255,255,255,0.05);
        --border-med: rgba(255,255,255,0.1);
        --text-primary: #ffffff;
        --text-secondary: #e0b0ff;
        --text-muted: #b08fc7;
        --accent-1: #8b2cf6;
        --accent-2: #c026d3;
        --accent-3: #e11d9b;
        --accent-4: #f472b6;
        --success: #a855f7;
        --warning: #d946ef;
        --danger: #f43f5e;
        --glow: rgba(168,85,247,0.5);
        /* safe area for notch/home indicator */
        --sat: env(safe-area-inset-top, 0px);
        --sab: env(safe-area-inset-bottom, 0px);
        --sal: env(safe-area-inset-left, 0px);
        --sar: env(safe-area-inset-right, 0px);
    }

    html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #000000;
        color: var(--text-primary);
        min-height: 100vh;
        min-height: 100dvh; /* dynamic viewport height */
        overflow-x: hidden;
        position: relative;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* ===================== WRAPPER ===================== */
    .wrapper {
        position: relative;
        z-index: 2;
        max-width: 960px;
        margin: 0 auto;
        /* mobile-first: smaller padding, safe area aware */
        padding: calc(64px + var(--sat)) 14px calc(80px + var(--sab));
        padding-left: max(14px, var(--sal));
        padding-right: max(14px, var(--sar));
    }

    /* ===================== BACK BUTTON ===================== */
    .btn-back {
        position: fixed;
        top: max(12px, var(--sat));
        right: max(12px, var(--sar));
        left: auto;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        padding: 10px 16px;
        background: rgba(20,0,26,0.92);
        border: 1px solid rgba(168,85,247,0.4);
        border-radius: 50px;
        color: #fff;
        cursor: pointer;
        text-decoration: none;
        font-family: 'Clash Display', sans-serif;
        font-size: 13px;
        font-weight: 700;
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow: 0 0 20px rgba(168,85,247,0.2);
        z-index: 999;
        transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
        /* minimum touch target */
        min-height: 44px;
    }

    .btn-back:hover, .btn-back:active {
        background: linear-gradient(135deg, rgba(139,44,246,0.4), rgba(225,29,155,0.4));
        border-color: var(--accent-2);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(168,85,247,0.4);
    }

    /* ===================== PAGE HEADER ===================== */
    .page-header {
        margin-bottom: 28px;
        padding-top: 4px;
        animation: slideDown 0.8s cubic-bezier(0.34,1.56,0.64,1) both;
    }

    @keyframes slideDown {
        from { opacity:0; transform:translateY(-24px); }
        to { opacity:1; transform:translateY(0); }
    }

    .logo-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, rgba(139,44,246,0.25), rgba(225,29,155,0.15));
        border: 1px solid rgba(168,85,247,0.35);
        border-radius: 50px;
        padding: 6px 16px;
        font-family: 'Clash Display', sans-serif;
        font-size: 11px;
        font-weight: 700;
        color: var(--accent-2);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        margin-bottom: 14px;
        backdrop-filter: blur(10px);
    }

    .page-header h1 {
        font-family: 'Clash Display', sans-serif;
        font-size: clamp(28px, 8vw, 56px);
        font-weight: 800;
        line-height: 1.1;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, #fff, var(--accent-1), var(--accent-3), var(--accent-4));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .page-header p {
        font-size: 14px;
        color: var(--text-secondary);
        max-width: 520px;
        line-height: 1.65;
    }

    /* ===================== ACTIVE BANNER ===================== */
    .active-banner {
        background: linear-gradient(135deg, #14532d, #166534, #15803d);
        background-size: 300% 300%;
        color: #bbf7d0;
        padding: 15px 20px;
        border-radius: 16px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 20px;
        box-shadow: 0 12px 32px rgba(34,197,94,0.2);
        animation: gradientMove 5s ease infinite, floatUp 3s ease-in-out infinite;
        border: 1px solid rgba(34,197,94,0.4);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .active-banner::after {
        content: '';
        position: absolute;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: rotate(45deg);
        animation: shimmer 4s infinite;
    }

    @keyframes gradientMove {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes floatUp {
        0%,100% { transform:translateY(0); }
        50% { transform:translateY(-4px); }
    }

    @keyframes shimmer {
        0% { transform:translateX(-100%) rotate(45deg); }
        100% { transform:translateX(100%) rotate(45deg); }
    }

    /* ===================== NO PLAN BANNER ===================== */
    .no-plan-banner {
        background: linear-gradient(135deg, rgba(139,44,246,0.15), rgba(225,29,155,0.08));
        border: 1px solid rgba(168,85,247,0.25);
        border-radius: 18px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 22px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        animation: slideUp 0.7s ease both;
        overflow: hidden;
        position: relative;
    }

    .no-plan-banner::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(168,85,247,0.08) 50%, transparent 70%);
        animation: shine 3s infinite;
    }

    @keyframes shine {
        0% { transform:translateX(-100%); }
        100% { transform:translateX(100%); }
    }

    @keyframes slideUp {
        from { opacity:0; transform:translateY(16px); }
        to { opacity:1; transform:translateY(0); }
    }

    .no-plan-icon {
        width: 46px;
        height: 46px;
        min-width: 46px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #fff;
        box-shadow: 0 6px 20px rgba(168,85,247,0.35);
    }

    .no-plan-text h3 {
        font-family: 'Clash Display', sans-serif;
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 4px;
        background: linear-gradient(135deg, #fff, var(--accent-2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .no-plan-text p {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    .no-plan-arrow {
        margin-left: auto;
        font-size: 18px;
        color: var(--accent-2);
        flex-shrink: 0;
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%,100% { transform:translateX(0); }
        50% { transform:translateX(8px); }
    }

    /* ===================== PENDING BANNER ===================== */
    .pending-subscription-banner {
        border-radius: 20px;
        overflow: hidden;
        margin-bottom: 22px;
        border: 1px solid rgba(192,38,211,0.35);
        background: linear-gradient(135deg, rgba(139,44,246,0.12), rgba(225,29,155,0.08));
        box-shadow: 0 16px 48px rgba(168,85,247,0.18);
        animation: glowPulse 3s infinite;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        position: relative;
    }

    @keyframes glowPulse {
        0%,100% { box-shadow:0 16px 48px rgba(168,85,247,0.18); }
        50% { box-shadow:0 24px 60px rgba(192,38,211,0.35); }
    }

    .pending-subscription-banner::before {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 3px;
        background: linear-gradient(90deg, transparent, var(--accent-1), var(--accent-2), var(--accent-3), transparent);
        animation: borderSlide 3s linear infinite;
    }

    @keyframes borderSlide {
        0% { left:-100%; }
        100% { left:100%; }
    }

    .psb-inner { padding: 18px; position: relative; z-index: 1; }

    .psb-header {
        display: flex;
        gap: 12px;
        margin-bottom: 18px;
        align-items: flex-start;
    }

    .psb-icon-wrap {
        width: 46px;
        height: 46px;
        min-width: 46px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        box-shadow: 0 6px 20px rgba(168,85,247,0.35);
    }

    .psb-titles { flex: 1; min-width: 0; }

    .psb-eyebrow {
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--accent-2);
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .psb-eyebrow .live-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--accent-2);
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0%,100% { opacity:1; }
        50% { opacity:.3; }
    }

    .psb-headline {
        font-family: 'Clash Display', sans-serif;
        font-size: clamp(16px, 4.5vw, 22px);
        font-weight: 700;
        background: linear-gradient(135deg, #fff, var(--accent-2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 5px;
    }

    .psb-sub {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    .psb-badge {
        background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
        border-radius: 100px;
        padding: 5px 12px;
        font-size: 11px;
        font-weight: 700;
        color: #fff;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(168,85,247,0.3);
        align-self: flex-start;
        flex-shrink: 0;
    }

    .psb-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--accent-1), var(--accent-2), var(--accent-3), transparent);
        margin: 16px 0;
    }

    .psb-pix-label {
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .psb-pix-label i { color: var(--accent-2); }

    /* Mobile-first: stack QR below textarea */
    .psb-pix-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .psb-pix-code {
        background: rgba(0,0,0,0.4);
        border: 1px solid rgba(168,85,247,0.25);
        border-radius: 14px;
        color: #fff;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        padding: 14px;
        resize: none;
        height: 80px;
        width: 100%;
        transition: all .3s ease;
        backdrop-filter: blur(5px);
        /* prevent zoom on focus iOS */
        font-size: max(16px, 11px);
    }

    .psb-pix-code:focus {
        outline: none;
        border-color: var(--accent-2);
        box-shadow: 0 0 24px rgba(168,85,247,0.25);
    }

    .psb-qr-box {
        width: 100%;
        height: 140px;
        background: linear-gradient(135deg, rgba(139,44,246,0.2), rgba(225,29,155,0.1));
        border: 1px solid rgba(168,85,247,0.25);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .psb-qr-box img { max-height:100%; max-width:100%; object-fit:contain; }

    /* Actions: stack on mobile, row on larger screens */
    .psb-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 14px;
    }

    .psb-copy-btn, .psb-confirm-btn, .psb-cancel-btn {
        padding: 15px 18px;
        border-radius: 14px;
        font-family: 'Clash Display', sans-serif;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all .3s cubic-bezier(0.34,1.56,0.64,1);
        border: none;
        width: 100%;
        /* touch-friendly minimum */
        min-height: 50px;
        -webkit-tap-highlight-color: transparent;
        letter-spacing: 0.01em;
    }

    .psb-copy-btn {
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        color: #fff;
        box-shadow: 0 8px 18px rgba(139,44,246,0.25);
    }

    .psb-confirm-btn {
        background: linear-gradient(135deg, var(--accent-3), var(--accent-4));
        color: #fff;
        box-shadow: 0 8px 18px rgba(225,29,155,0.25);
    }

    .psb-cancel-btn {
        background: rgba(244,63,94,0.15);
        color: #f87171;
        box-shadow: none;
        border: 1px solid rgba(244,63,94,0.3);
    }

    .psb-copy-btn:active, .psb-confirm-btn:active, .psb-cancel-btn:active {
        transform: scale(0.97);
    }

    .psb-help {
        margin-top: 14px;
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        gap: 8px;
        padding: 12px;
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
        line-height: 1.55;
        align-items: flex-start;
    }

    .psb-help i { flex-shrink:0; margin-top:2px; color:var(--accent-2); }

    /* ===================== PLANS GRID ===================== */
    /* Mobile-first: 2 columns on small, auto-fit on large */
    .plans-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 22px;
    }

    .plan-option {
        background: linear-gradient(135deg, rgba(20,0,26,0.7), rgba(31,0,40,0.7));
        border: 1px solid rgba(168,85,247,0.2);
        border-radius: 18px;
        padding: 18px 12px;
        text-align: center;
        cursor: pointer;
        transition: all .3s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        position: relative;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    .plan-option:active {
        transform: scale(0.97);
        background: linear-gradient(135deg, rgba(31,0,40,0.9), rgba(45,0,60,0.9));
    }

    .po-name {
        font-family: 'Clash Display', sans-serif;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 6px;
        color: #fff;
    }

    .po-price {
        font-size: 24px;
        font-weight: 800;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 4px;
    }

    .po-duration {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }

    .btn-select {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 9px 16px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        color: #fff;
        text-decoration: none;
        font-size: 12px;
        font-weight: 700;
        transition: all .3s ease;
        border: none;
        min-height: 36px;
        width: 100%;
    }

    .btn-select:active { transform: scale(0.96); }

    /* ===================== PLAN CARD ===================== */
    .plan-card {
        background: linear-gradient(135deg, rgba(20,0,26,0.9), rgba(31,0,40,0.9));
        border: 1px solid rgba(168,85,247,0.2);
        border-radius: 24px;
        overflow: hidden;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        animation: cardAppear 0.8s ease both;
        position: relative;
    }

    @keyframes cardAppear {
        from { opacity:0; transform:translateY(24px) scale(0.97); }
        to { opacity:1; transform:translateY(0) scale(1); }
    }

    .plan-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-1), var(--accent-2), var(--accent-3), var(--accent-4));
    }

    /* Mobile-first: single column, desktop: two columns */
    .plan-body {
        display: flex;
        flex-direction: column;
    }

    .plan-info {
        padding: 24px 20px 20px;
        border-bottom: 1px solid rgba(168,85,247,0.15);
        background: linear-gradient(135deg, rgba(139,44,246,0.04), rgba(225,29,155,0.02));
    }

    .plan-action {
        padding: 20px 20px 24px;
    }

    .plan-tag {
        font-family: 'Clash Display', sans-serif;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 6px;
    }

    .plan-name {
        font-family: 'Clash Display', sans-serif;
        font-size: clamp(22px, 6vw, 28px);
        font-weight: 700;
        margin-bottom: 6px;
        background: linear-gradient(135deg, #fff, var(--accent-2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .plan-price {
        display: flex;
        align-items: baseline;
        gap: 5px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .plan-price .currency {
        font-size: 16px;
        color: var(--text-secondary);
    }

    .plan-price .amount {
        font-family: 'Clash Display', sans-serif;
        font-size: clamp(34px, 10vw, 52px);
        font-weight: 800;
        line-height: 1;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .plan-price .period {
        font-size: 14px;
        color: var(--text-secondary);
    }

    /* 2-column features on mobile too */
    .feature-list {
        list-style: none;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .feature-list li {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .feature-list li .icon {
        width: 20px;
        height: 20px;
        min-width: 20px;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #fff;
        box-shadow: 0 3px 10px rgba(168,85,247,0.25);
    }

    /* ===================== STATUS PILL ===================== */
    .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 100px;
        font-size: 13px;
        font-weight: 600;
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(168,85,247,0.25);
        color: var(--text-secondary);
        margin-bottom: 16px;
    }

    .status-pill .dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
    }

    .status-pill.active {
        background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(16,185,129,0.1));
        border-color: rgba(34,197,94,0.5);
        color: #4ade80;
    }

    .status-pill.active .dot {
        background: #4ade80;
        animation: pulse 2s infinite;
    }

    .status-pill.pending {
        background: linear-gradient(135deg, rgba(192,38,211,0.2), rgba(244,114,182,0.15));
        border-color: var(--accent-3);
        color: var(--accent-4);
    }

    .status-pill.pending .dot {
        background: var(--accent-3);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%,100% { box-shadow:0 0 0 0 currentColor; }
        50% { box-shadow:0 0 12px 3px currentColor; }
    }

    /* ===================== SUBSCRIBE BUTTON ===================== */
    .btn-subscribe {
        width: 100%;
        padding: 17px 24px;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3));
        background-size: 200% 200%;
        border: none;
        border-radius: 16px;
        color: #fff;
        font-family: 'Clash Display', sans-serif;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all .3s cubic-bezier(0.34,1.56,0.64,1);
        box-shadow: 0 12px 36px rgba(139,44,246,0.4);
        position: relative;
        overflow: hidden;
        min-height: 52px;
        -webkit-tap-highlight-color: transparent;
        letter-spacing: 0.01em;
    }

    .btn-subscribe::before {
        content: '';
        position: absolute;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: linear-gradient(135deg, transparent, rgba(255,255,255,0.25), transparent);
        transform: rotate(45deg);
        animation: shimmer 3s infinite;
    }

    .btn-subscribe:active { transform: scale(0.98); }

    .btn-subscribe:disabled {
        opacity: .7;
        cursor: not-allowed;
        transform: none;
    }

    .btn-cancel-sub {
        width: 100%;
        padding: 17px 24px;
        background: rgba(244,63,94,0.12);
        border: 1px solid rgba(244,63,94,0.35);
        border-radius: 16px;
        color: #f87171;
        font-family: 'Clash Display', sans-serif;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all .3s cubic-bezier(0.34,1.56,0.64,1);
        min-height: 52px;
        -webkit-tap-highlight-color: transparent;
    }

    .btn-cancel-sub:active { transform: scale(0.98); background: rgba(244,63,94,0.2); }

    .btn-cancel-sub:disabled {
        opacity: .7;
        cursor: not-allowed;
    }

    .subscribe-footnote {
        margin-top: 12px;
        font-size: 12px;
        color: var(--text-muted);
        text-align: center;
        line-height: 1.5;
    }

    /* ===================== DATA CARD ===================== */
    .data-card {
        background: linear-gradient(135deg, rgba(20,0,26,0.5), rgba(31,0,40,0.5));
        border: 1px solid rgba(168,85,247,0.15);
        border-radius: 18px;
        overflow: hidden;
        margin-top: 16px;
        backdrop-filter: blur(5px);
    }

    .data-card-header {
        padding: 14px 18px;
        border-bottom: 1px solid rgba(168,85,247,0.12);
        font-size: 11px;
        font-weight: 700;
        color: var(--accent-2);
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .sub-item {
        padding: 14px 18px;
        border-top: 1px solid rgba(168,85,247,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        transition: all .3s ease;
    }

    .sub-item:first-child { border-top: none; }

    .sub-item-name {
        font-family: 'Clash Display', sans-serif;
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 2px;
        color: #fff;
    }

    .sub-item-meta { font-size: 12px; color: var(--text-secondary); }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 100px;
        font-size: 11px;
        font-weight: 700;
        white-space: nowrap;
    }

    .status-badge.paid {
        background: linear-gradient(135deg, rgba(139,44,246,0.2), rgba(168,85,247,0.15));
        color: var(--accent-2);
        border: 1px solid var(--accent-1);
    }

    .status-badge.pending {
        background: linear-gradient(135deg, rgba(192,38,211,0.2), rgba(225,29,155,0.15));
        color: var(--accent-3);
        border: 1px solid var(--accent-2);
    }

    /* ===================== ACTIVE INFO BOX ===================== */
    .active-info-box {
        background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.07));
        border: 1px solid rgba(34,197,94,0.3);
        border-radius: 12px;
        padding: 13px 16px;
        margin-bottom: 16px;
        font-size: 13px;
        color: #86efac;
        line-height: 1.6;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .active-info-box i { color: #4ade80; flex-shrink: 0; }

    /* ===================== BOTTOM CTA ===================== */
    .bottom-cta {
        text-align: center;
        padding: 24px 20px;
        padding-bottom: max(24px, calc(20px + var(--sab)));
        background: linear-gradient(135deg, rgba(139,44,246,0.1), rgba(225,29,155,0.07));
        color: var(--text-secondary);
        font-size: 13px;
        line-height: 1.6;
        border-top: 1px solid rgba(168,85,247,0.15);
        margin-top: 32px;
        backdrop-filter: blur(10px);
    }

    /* ===================== DESKTOP ENHANCEMENTS ===================== */
    @media (min-width: 540px) {
        .wrapper {
            padding: calc(72px + var(--sat)) 24px calc(80px + var(--sab));
        }

        .psb-inner { padding: 24px; }

        /* Side-by-side QR and textarea on tablet+ */
        .psb-pix-row {
            display: grid;
            grid-template-columns: 1fr 110px;
            gap: 14px;
            align-items: start;
        }

        .psb-qr-box {
            width: 110px;
            height: 110px;
        }

        .psb-pix-code { height: 90px; font-size: 12px; }

        /* Row actions on tablet */
        .psb-actions {
            flex-direction: row;
        }

        .psb-copy-btn, .psb-confirm-btn, .psb-cancel-btn {
            flex: 1;
        }

        .plan-option { padding: 20px 14px; }
        .plans-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 14px; }
    }

    @media (min-width: 680px) {
        .plan-body {
            flex-direction: row;
        }

        .plan-info {
            flex: 1.2;
            padding: 32px;
            border-bottom: none;
            border-right: 1px solid rgba(168,85,247,0.15);
        }

        .plan-action {
            flex: 1;
            padding: 32px;
        }

        .feature-list {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .feature-list li { font-size: 14px; }
    }

    @media (min-width: 960px) {
        .wrapper {
            padding: 80px 32px 100px;
        }
    }

    /* ===================== ACCESSIBILITY ===================== */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            transition-duration: 0.01ms !important;
        }
    }
    </style>
</head>
<body>

<!-- Back button (fixed, safe-area aware) -->
<a href="{% url 'home' %}" class="btn-back" aria-label="Voltar">
    <i class="fa fa-arrow-left" aria-hidden="true"></i>
    Voltar
</a>

<div class="wrapper">

    <!-- Page Header -->
    {% if not has_pending_payment %}
    <div class="page-header">
        <div class="logo-badge">
            <i class="fa fa-music"></i>
            Beatflow Premium
        </div>
        <h1>Sua Assinatura</h1>
        {% if assinatura_ativa %}
            {% if assinatura_ativa.plano_id == 'trial_3dias' %}
                <p>Seu <strong>teste grátis de 3 dias</strong> está ativo até <strong>{{ assinatura_ativa.periodo_termina_em|date:'d/m/Y' }}</strong> ({{ assinatura_ativa.dias_restantes }} dias restantes).</p>
            {% else %}
                <p>Você já possui o <strong>{{ assinatura_ativa.plano_id|default:'Plano Mensal Premium' }}</strong> ativo até <strong>{{ assinatura_ativa.periodo_termina_em|date:'d/m/Y' }}</strong>.</p>
            {% endif %}
        {% else %}
            <p>Acesso ilimitado a músicas e recursos exclusivos. Escolha o plano perfeito para você.</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Active subscription banner -->
    {% if assinatura_ativa %}
    <div class="active-banner">
        <i class="fa fa-check-circle"></i>
        Assinatura ativa até <strong>{{ assinatura_ativa.periodo_termina_em|date:'d/m/Y' }}</strong>
    </div>
    {% endif %}

    <!-- No plan banner -->
    {% if not assinatura_ativa and not has_pending_payment %}
    <div class="no-plan-banner">
        <div class="no-plan-icon">
            <i class="fa fa-crown"></i>
        </div>
        <div class="no-plan-text">
            <h3>Você ainda não tem um plano ativo</h3>
            <p>Escolha abaixo o plano que mais combina com você e ative agora!</p>
        </div>
        <div class="no-plan-arrow">
            <i class="fa fa-arrow-right"></i>
        </div>
    </div>
    {% endif %}

    <!-- Pending payment banner -->
    {% if has_pending_payment and pagamento_pendente %}
    <div class="pending-subscription-banner" id="pending-banner" data-payment-id="{{ pagamento_pendente.id }}">
        <div class="psb-inner">
            <div class="psb-header">
                <div class="psb-icon-wrap">✨</div>
                <div class="psb-titles">
                    <div class="psb-eyebrow"><span class="live-dot"></span> Aguardando pagamento</div>
                    <div class="psb-headline">Assinatura quase lá!</div>
                    <div class="psb-sub">PIX gerado mas não confirmado. Pague agora e acesso Premium é liberado na hora.</div>
                </div>
                <div class="psb-badge">{{ SELECTED_PLAN_LABEL|default:PLAN_LABEL }}</div>
            </div>

            <div class="psb-divider"></div>

            <div class="psb-pix-label">
                <i class="fa fa-qrcode"></i>
                Código PIX
            </div>

            <div class="psb-pix-row">
                <textarea id="psb-pix-code" class="psb-pix-code" readonly placeholder="Código PIX copia e cola…">{{ pagamento_pendente.pix_qr_payload|default:'' }}</textarea>
                <div class="psb-qr-box">
                    {% if pagamento_pendente.pix_qr_image %}
                        <img src="{{ pagamento_pendente.pix_qr_image }}" alt="QR Code PIX" />
                    {% else %}
                        <div style="text-align:center;color:var(--text-muted);">
                            <i class="fa fa-qrcode" style="font-size:28px;display:block;margin-bottom:6px;"></i>
                            <small>QR Code</small>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="psb-actions">
                <button class="psb-copy-btn" id="psb-copy-btn" onclick="copyPsbPix()">
                    <i class="fa fa-copy"></i>Copiar PIX
                </button>
                <button class="psb-confirm-btn" id="psb-confirm-btn" onclick="confirmPayment()">
                    <i class="fa fa-circle-check"></i>Já paguei
                </button>
                <button class="psb-cancel-btn" id="psb-cancel-btn" onclick="cancelPayment()">
                    <i class="fa fa-trash"></i>Cancelar
                </button>
            </div>

            <div class="psb-help">
                <i class="fa fa-circle-info"></i>
                <span>Abra seu banco → <strong>Pix</strong> → <strong>Pagar</strong> → cole o código ou escaneie o QR. Acesso liberado automaticamente.</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Plans Grid: hidden when there's a pending PIX -->
    {% if plans and not assinatura_ativa and not has_pending_payment %}
    <div id="plans" class="plans-grid">
        {% for p in plans %}
            {% if p.price > 0 %}
        <div class="plan-option">
            <div class="po-name">{{ p.name }}</div>
            <div class="po-price">R$ {{ p.price }}</div>
            <div class="po-duration">{{ p.duration_days }} dias</div>
            <a href="?plan={{ p.slug }}" class="btn-select">Selecionar</a>
        </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Plan Card: hidden when there's a pending PIX -->
    {% if selected_plan or assinatura_ativa and not has_pending_payment %}
    <div class="plan-card">
        <div class="plan-body">
            <div class="plan-info">
                {% if assinatura_ativa %}
                    <div class="plan-tag" style="background:linear-gradient(135deg,#22c55e,#10b981);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">✓ Plano Ativo</div>
                {% elif selected_plan %}
                    <div class="plan-tag">Plano Selecionado</div>
                {% else %}
                    <div class="plan-tag">Plano Disponível</div>
                {% endif %}

                <div class="plan-name">{{ SELECTED_PLAN_NAME|default:PLAN_NAME }}</div>

                {% if assinatura_ativa %}
                    <div class="plan-price">
                        <span class="amount">{{ assinatura_ativa.plano_id|default:PLAN_NAME }}</span>
                    </div>
                {% else %}
                    <div class="plan-price">
                        <span class="currency">R$</span>
                        <span class="amount">{{ SELECTED_PLAN_PRICE|default:PLAN_PRICE }}</span>
                        <span class="period">/mês</span>
                    </div>
                {% endif %}

                <ul class="feature-list">
                    <li><span class="icon"><i class="fa fa-check"></i></span>Músicas ilimitadas</li>
                    <li><span class="icon"><i class="fa fa-check"></i></span>Sem anúncios</li>
                    <li><span class="icon"><i class="fa fa-check"></i></span>Suporte prioritário</li>
                    <li><span class="icon"><i class="fa fa-check"></i></span>Novidades first</li>
                </ul>
            </div>

            <div class="plan-action">
                {% if assinatura_ativa %}
                    <div class="status-pill active">
                        <span class="dot"></span>
                        <span>Status: Ativo</span>
                    </div>

                    <div class="active-info-box">
                        <i class="fa fa-shield-halved"></i>
                        <span>Acesso válido até <strong>{{ assinatura_ativa.periodo_termina_em|date:'d/m/Y' }}</strong>. Aproveite!</span>
                    </div>

                    <button id="cancel-sub-btn" class="btn-cancel-sub" onclick="cancelSubscription()">
                        <i class="fa fa-trash"></i>Cancelar assinatura
                    </button>

                    {% if pagamentos %}
                    <div class="data-card">
                        <div class="data-card-header">Histórico de pagamentos</div>
                        {% for p in pagamentos %}
                        <div class="sub-item">
                            <div>
                                <div class="sub-item-name">{{ p.criado_em|date:'d/m/Y H:i' }}</div>
                                <div class="sub-item-meta">R$ {{ p.amount }}</div>
                            </div>
                            <span class="status-badge {% if p.status == 'paid' %}paid{% elif p.status == 'pending' %}pending{% endif %}">
                                {{ p.get_status_display }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                {% elif has_pending_payment %}
                    <div class="status-pill pending">
                        <span class="dot"></span>
                        <span>Pagamento Pendente</span>
                    </div>

                    <button class="btn-subscribe" onclick="confirmPayment()">
                        <i class="fa fa-circle-check"></i>
                        <span>Já paguei</span>
                    </button>

                {% else %}
                    <div class="status-pill">
                        <span class="dot"></span>
                        <span>Sem plano ativo</span>
                    </div>

                    <button id="assinatura-btn" class="btn-subscribe">
                        <i class="fa fa-bolt"></i>
                        <span class="btn-label">Ativar por {{ SELECTED_PLAN_LABEL|default:PLAN_LABEL }}</span>
                    </button>

                    <p class="subscribe-footnote">Pagamento via PIX · Cancele quando quiser · Sem fidelidade</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

</div><!-- /wrapper -->

<div class="bottom-cta">
    <p>Mais músicas, menos limites — acesso Premium instantâneo na Beatflow.</p>
</div>

<script>
function copyPsbPix() {
    const ta = document.getElementById('psb-pix-code');
    if (!ta || !ta.value) return;
    navigator.clipboard.writeText(ta.value).then(function() {
        const btn = document.getElementById('psb-copy-btn');
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="fa fa-check"></i> Copiado!';
        setTimeout(function() { btn.innerHTML = orig; }, 2000);
    });
}

function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}

function confirmPayment() {
    document.querySelectorAll('.psb-confirm-btn, .btn-subscribe').forEach(function(b) {
        b.disabled = true;
        b.style.opacity = '.7';
    });
    setTimeout(function() { window.location.reload(); }, 1800);
}

function cancelPayment() {
    let pid = window.currentPendingPaymentId ||
              document.getElementById('pending-banner')?.dataset.paymentId;
    if (!pid) return;

    document.querySelectorAll('.psb-cancel-btn, .psb-confirm-btn, .btn-subscribe').forEach(function(b) {
        b.disabled = true;
        b.style.opacity = '.7';
    });

    fetch('/api/payments/asaas/cancel-pix/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({payment_id: pid})
    }).then(async resp => {
        if (resp.ok) {
            setTimeout(() => window.location.reload(), 800);
        } else {
            const data = await resp.json().catch(() => ({}));
            alert(data.error || 'Não foi possível cancelar o pagamento');
            document.querySelectorAll('.psb-cancel-btn, .psb-confirm-btn, .btn-subscribe').forEach(function(b) {
                b.disabled = false;
                b.style.opacity = '1';
            });
        }
    }).catch(err => {
        console.error(err);
        alert('Erro ao comunicar com o servidor.');
    });
}

function cancelSubscription() {
    const btn = document.getElementById('cancel-sub-btn');
    if (!btn) return;
    if (!confirm('Deseja realmente cancelar sua assinatura?')) return;
    btn.disabled = true;
    btn.style.opacity = '.7';

    fetch('/api/subscriptions/cancel/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: '{}'
    }).then(async resp => {
        if (resp.ok) {
            setTimeout(() => window.location.reload(), 800);
        } else {
            const data = await resp.json().catch(() => ({}));
            alert(data.error || 'Erro ao cancelar assinatura');
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    }).catch(err => {
        console.error(err);
        alert('Erro ao comunicar com o servidor.');
        btn.disabled = false;
        btn.style.opacity = '1';
    });
}

function showPending(data) {
    if (!data) return;
    window.currentPendingPaymentId = data.payment_id;
    const container = document.querySelector('.wrapper');
    if (!container) return;

    ['#plans', '.no-plan-banner', '.plan-card'].forEach(sel => {
        const el = document.querySelector(sel);
        if (el) el.style.display = 'none';
    });

    const existing = document.getElementById('pending-banner');
    if (existing) existing.remove();

    // hide the header too
    const hdr = document.querySelector('.page-header');
    if (hdr) hdr.style.display = 'none';

    let qrImg = data.pix_qr
        ? `<img src="${data.pix_qr}" alt="QR Code PIX"/>`
        : `<div style="text-align:center;color:var(--text-muted);">
               <i class="fa fa-qrcode" style="font-size:28px;display:block;margin-bottom:6px;"></i>
               <small>QR Code</small>
           </div>`;

    const html = `
    <div class="pending-subscription-banner" id="pending-banner" data-payment-id="${data.payment_id}">
        <div class="psb-inner">
            <div class="psb-header">
                <div class="psb-icon-wrap">✨</div>
                <div class="psb-titles">
                    <div class="psb-eyebrow"><span class="live-dot"></span> Aguardando pagamento</div>
                    <div class="psb-headline">Assinatura quase lá!</div>
                    <div class="psb-sub">PIX gerado mas não confirmado. Pague agora e acesso Premium é liberado na hora.</div>
                </div>
                <div class="psb-badge">${data.description || ''}</div>
            </div>
            <div class="psb-divider"></div>
            <div class="psb-pix-label"><i class="fa fa-qrcode"></i> Código PIX</div>
            <div class="psb-pix-row">
                <textarea id="psb-pix-code" class="psb-pix-code" readonly placeholder="Código PIX copia e cola…">${data.pix_payload||''}</textarea>
                <div class="psb-qr-box">${qrImg}</div>
            </div>
            <div class="psb-actions">
                <button class="psb-copy-btn" id="psb-copy-btn" onclick="copyPsbPix()">
                    <i class="fa fa-copy"></i>Copiar PIX
                </button>
                <button class="psb-confirm-btn" id="psb-confirm-btn" onclick="confirmPayment()">
                    <i class="fa fa-circle-check"></i>Já paguei
                </button>
                <button class="psb-cancel-btn" id="psb-cancel-btn" onclick="cancelPayment()">
                    <i class="fa fa-trash"></i>Cancelar
                </button>
            </div>
            <div class="psb-help">
                <i class="fa fa-circle-info"></i>
                <span>Abra seu banco → <strong>Pix</strong> → <strong>Pagar</strong> → cole o código ou escaneie o QR.</span>
            </div>
        </div>
    </div>`;
    container.insertAdjacentHTML('afterbegin', html);
}

(function() {
    const btn = document.getElementById('assinatura-btn');
    if (btn) {
        btn.addEventListener('click', async function() {
            btn.disabled = true;
            btn.style.opacity = '.7';
            try {
                const payload = {
                    amount: '{{ SELECTED_PLAN_PRICE|default:PLAN_PRICE }}',
                    description: 'Assinatura {{ SELECTED_PLAN_LABEL|default:PLAN_LABEL }}'
                };
                {% if profile and profile.cpf_cnpj %}
                payload.document = '{{ profile.cpf_cnpj }}';
                {% endif %}

                const resp = await fetch('/api/payments/asaas/create-pix/', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    const data = await resp.json();
                    showPending(data);
                } else {
                    const data = await resp.json();
                    alert(data.error || 'Erro ao criar cobrança');
                }
            } catch (e) {
                console.error(e);
                alert('Erro ao comunicar com o servidor.');
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        });
    }
})();
</script>

</body>
</html>
