<!DOCTYPE html>
{% load static %}
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Editar Perfil ¬∑ Beatflow</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
        --bg-primary: #0a000f;
        --bg-secondary: #14001a;
        --bg-tertiary: #1f0028;
        --border-light: rgba(255,255,255,0.05);
        --border-med: rgba(255,255,255,0.1);
        --text-primary: #ffffff;
        --text-secondary: #e0b0ff;
        --text-muted: #b08fc7;
        --accent-1: #8b2cf6;
        --accent-2: #c026d3;
        --accent-3: #e11d9b;
        --accent-4: #f472b6;
        --green: #4ade80;
        --green-dim: rgba(34,197,94,0.15);
        --green-border: rgba(34,197,94,0.3);
    }

    html { scroll-behavior: smooth; }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #000;
        color: var(--text-primary);
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
    }

    body::before {
        content: '';
        position: fixed; inset: 0;
        background:
            radial-gradient(circle at 20% 30%, rgba(139,44,246,0.1) 0%, transparent 60%),
            radial-gradient(circle at 80% 70%, rgba(192,38,211,0.08) 0%, transparent 60%),
            radial-gradient(circle at 40% 80%, rgba(225,29,155,0.06) 0%, transparent 60%);
        pointer-events: none; z-index: 0;
        animation: bgPulse 20s ease-in-out infinite;
    }

    @keyframes bgPulse {
        0%,100% { opacity:.8; } 50% { opacity:1; }
    }

    body::after {
        content: '';
        position: fixed; inset: 0;
        background-image:
            linear-gradient(0deg, transparent 24%, rgba(168,85,247,0.06) 25%, rgba(168,85,247,0.06) 26%, transparent 27%, transparent 74%, rgba(168,85,247,0.06) 75%, rgba(168,85,247,0.06) 76%, transparent 77%),
            linear-gradient(90deg, transparent 24%, rgba(192,38,211,0.06) 25%, rgba(192,38,211,0.06) 26%, transparent 27%, transparent 74%, rgba(192,38,211,0.06) 75%, rgba(192,38,211,0.06) 76%, transparent 77%);
        background-size: 60px 60px;
        pointer-events: none; z-index: 0; opacity:.35;
        animation: gridMove 30s linear infinite;
    }

    @keyframes gridMove {
        0% { background-position: 0 0; }
        100% { background-position: 60px 60px; }
    }

    /* ‚îÄ‚îÄ Back button ‚îÄ‚îÄ */
    .btn-back {
        position: fixed;
        top: 16px; right: 16px;
        display: inline-flex; align-items: center; gap: 8px;
        padding: 10px 18px;
        background: rgba(20,0,26,0.85);
        border: 1px solid rgba(168,85,247,0.4);
        border-radius: 50px;
        color: #fff;
        cursor: pointer;
        text-decoration: none;
        font-family: 'Clash Display', sans-serif;
        font-size: 13px; font-weight: 700;
        backdrop-filter: blur(12px);
        box-shadow: 0 0 20px rgba(168,85,247,0.2);
        z-index: 999;
        transition: all .3s cubic-bezier(0.34,1.56,0.64,1);
    }

    .btn-back:hover {
        background: linear-gradient(135deg, rgba(139,44,246,0.4), rgba(225,29,155,0.4));
        border-color: var(--accent-2);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(168,85,247,0.4);
    }

    /* ‚îÄ‚îÄ Wrapper ‚îÄ‚îÄ */
    .wrapper {
        position: relative; z-index: 2;
        max-width: 720px;
        margin: 0 auto;
        padding: 56px 20px 100px;
    }

    /* ‚îÄ‚îÄ Page header ‚îÄ‚îÄ */
    .page-header {
        margin-bottom: 40px;
        animation: slideDown .7s cubic-bezier(0.34,1.56,0.64,1) both;
    }

    @keyframes slideDown {
        from { opacity:0; transform:translateY(-20px); }
        to   { opacity:1; transform:translateY(0); }
    }

    .logo-badge {
        display: inline-flex; align-items: center; gap: 8px;
        background: linear-gradient(135deg, rgba(139,44,246,0.25), rgba(225,29,155,0.15));
        border: 1px solid rgba(168,85,247,0.35);
        border-radius: 50px;
        padding: 7px 18px;
        font-family: 'Clash Display', sans-serif;
        font-size: 11px; font-weight: 700;
        color: var(--accent-2);
        letter-spacing: .12em; text-transform: uppercase;
        margin-bottom: 16px;
        backdrop-filter: blur(10px);
    }

    .page-header h1 {
        font-family: 'Clash Display', sans-serif;
        font-size: clamp(28px, 6vw, 48px);
        font-weight: 800; line-height: 1.1;
        letter-spacing: -.02em;
        background: linear-gradient(135deg, #fff, var(--accent-1), var(--accent-3));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        margin-bottom: 10px;
    }

    .page-header p {
        font-size: 14px; color: var(--text-secondary); line-height: 1.6;
    }

    /* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
    .messages {
        list-style: none; margin-bottom: 20px;
        display: flex; flex-direction: column; gap: 8px;
    }

    .messages li {
        padding: 10px 16px; border-radius: 12px; font-size: 13px;
        background: rgba(255,60,110,.1); border: 1px solid rgba(255,60,110,.25); color: #ff6b8a;
        display: flex; align-items: center; gap: 8px;
        backdrop-filter: blur(8px);
    }

    .messages li.success {
        background: var(--green-dim); border-color: var(--green-border); color: var(--green);
    }

    /* ‚îÄ‚îÄ Section card ‚îÄ‚îÄ */
    .section-card {
        background: linear-gradient(135deg, rgba(20,0,26,0.9), rgba(31,0,40,0.9));
        border: 1px solid rgba(168,85,247,0.2);
        border-radius: 24px;
        overflow: hidden;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
        box-shadow: 0 20px 48px rgba(0,0,0,0.4);
        animation: cardAppear .5s ease both;
        position: relative;
    }

    .section-card:nth-child(2) { animation-delay: .07s; }
    .section-card:nth-child(3) { animation-delay: .14s; }

    @keyframes cardAppear {
        from { opacity:0; transform:translateY(20px) scale(.97); }
        to   { opacity:1; transform:translateY(0) scale(1); }
    }

    /* top gradient stripe */
    .section-card::before {
        content: ''; display: block; height: 3px;
        background: linear-gradient(90deg, var(--accent-1), var(--accent-2), var(--accent-3), var(--accent-4));
    }

    /* ‚îÄ‚îÄ Section header ‚îÄ‚îÄ */
    .section-header {
        padding: 18px 24px 14px;
        border-bottom: 1px solid rgba(168,85,247,0.12);
        display: flex; align-items: center; gap: 12px;
    }

    .section-emoji {
        width: 36px; height: 36px; border-radius: 12px;
        background: linear-gradient(135deg, rgba(139,44,246,0.25), rgba(225,29,155,0.15));
        border: 1px solid rgba(168,85,247,0.3);
        display: flex; align-items: center; justify-content: center;
        font-size: 16px; flex-shrink: 0;
    }

    .section-title {
        font-family: 'Clash Display', sans-serif;
        font-size: 15px; font-weight: 700;
        background: linear-gradient(135deg, #fff, var(--accent-2));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }

    .section-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    /* ‚îÄ‚îÄ Form body ‚îÄ‚îÄ */
    .section-body { padding: 20px 24px; }

    /* ‚îÄ‚îÄ Field grid ‚îÄ‚îÄ */
    .field-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    @media (max-width: 560px) { .field-grid { grid-template-columns: 1fr; } }

    .field-grid .span-2 { grid-column: 1 / -1; }

    .field { display: flex; flex-direction: column; gap: 0; }

    /* ‚îÄ‚îÄ Input wrap ‚îÄ‚îÄ */
    .field-input-wrap { position: relative; }

    .field-input-wrap input {
        width: 100%;
        height: 42px;
        background: rgba(0,0,0,0.35);
        border: 1px solid rgba(168,85,247,0.2);
        border-radius: 12px;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        font-size: 13px;
        padding: 0 14px 0 36px;
        transition: border-color .2s, box-shadow .2s, background .2s;
        backdrop-filter: blur(4px);
    }

    .field-input-wrap input::placeholder {
        color: rgba(255,255,255,0.2);
        font-size: 12px;
    }

    .field-input-wrap input:focus {
        outline: none;
        border-color: rgba(168,85,247,0.55);
        box-shadow: 0 0 0 3px rgba(139,44,246,0.12);
        background: rgba(20,0,26,0.6);
    }

    .field-input-wrap .fi-icon {
        position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        font-size: 12px; color: var(--accent-2); pointer-events: none;
    }

    /* ‚îÄ‚îÄ Button row ‚îÄ‚îÄ */
    .btn-row {
        display: flex; gap: 10px; margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid rgba(168,85,247,0.12);
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    .btn {
        height: 40px;
        padding: 0 18px; border-radius: 12px;
        font-family: 'Clash Display', sans-serif; font-size: 13px; font-weight: 700;
        cursor: pointer; display: inline-flex; align-items: center; gap: 7px;
        transition: all .25s cubic-bezier(0.34,1.56,0.64,1); border: none;
        text-decoration: none;
        -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3));
        color: #fff;
        box-shadow: 0 8px 24px rgba(139,44,246,0.35);
        position: relative; overflow: hidden;
    }

    .btn-primary::after {
        content: ''; position: absolute; inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,.15) 0%, transparent 55%);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 32px rgba(139,44,246,0.45);
    }

    .btn-secondary {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(168,85,247,0.2);
        color: var(--text-muted);
    }

    .btn-secondary:hover {
        background: rgba(168,85,247,0.1);
        border-color: rgba(168,85,247,0.4);
        color: var(--text-primary);
    }

    /* ‚îÄ‚îÄ Subscription box ‚îÄ‚îÄ */
    .sub-box { padding: 20px 24px; }

    .sub-info-grid {
        display: grid; grid-template-columns: 1fr 1fr;
        gap: 10px; margin-bottom: 16px;
    }

    @media (max-width: 480px) { .sub-info-grid { grid-template-columns: 1fr; } }

    .sub-info-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(168,85,247,0.15);
        border-radius: 14px;
        padding: 12px 16px;
        display: flex; align-items: center; gap: 10px;
        transition: all .25s ease;
    }

    .sub-info-item:hover {
        border-color: rgba(168,85,247,0.3);
        background: rgba(139,44,246,0.07);
    }

    .sub-info-item.green-item {
        background: var(--green-dim);
        border-color: var(--green-border);
    }

    .sii-emoji { font-size: 18px; flex-shrink: 0; }

    .sii-label {
        font-size: 10px; color: var(--text-muted);
        text-transform: uppercase; letter-spacing: .07em;
        margin-bottom: 2px;
    }

    .sii-value {
        font-family: 'Clash Display', sans-serif;
        font-size: 13px; font-weight: 700;
        color: var(--text-primary);
    }

    .sii-value.green { color: var(--green); }
    .sii-value.muted { color: var(--text-muted); }

    /* ‚îÄ‚îÄ Subscribe button ‚îÄ‚îÄ */
    .btn-subscribe {
        width: 100%; height: 44px;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3));
        border: none; border-radius: 16px; color: #fff;
        font-family: 'Clash Display', sans-serif; font-size: 14px; font-weight: 700;
        cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: all .3s cubic-bezier(0.34,1.56,0.64,1);
        box-shadow: 0 10px 30px rgba(139,44,246,0.35);
        position: relative; overflow: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    .btn-subscribe::before {
        content: ''; position: absolute; inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,.15) 0%, transparent 55%);
    }

    .btn-subscribe:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 16px 40px rgba(168,85,247,0.5);
    }

    .btn-subscribe:disabled {
        background: linear-gradient(135deg, #166534, #15803d);
        box-shadow: 0 8px 24px rgba(34,197,94,0.2);
        cursor: default;
        color: #bbf7d0;
    }

    /* ‚îÄ‚îÄ PIX area ‚îÄ‚îÄ */
    #profile-pix-area {
        margin-top: 16px;
        animation: fadeUp .3s ease;
    }

    @keyframes fadeUp {
        from { opacity:0; transform:translateY(8px); }
        to   { opacity:1; transform:translateY(0); }
    }

    .pix-hint {
        font-size: 12px; color: var(--text-muted); margin-bottom: 10px;
        display: flex; align-items: center; gap: 6px;
    }

    .pix-hint i { color: var(--accent-2); }

    .pix-row { display: flex; gap: 10px; align-items: flex-start; }

    #profile-pix-payload {
        flex: 1; min-height: 80px;
        background: rgba(0,0,0,0.4);
        border: 1px solid rgba(168,85,247,0.2);
        border-radius: 12px; color: var(--text-primary);
        font-family: 'Courier New', monospace; font-size: 11px;
        padding: 10px; resize: none; line-height: 1.5;
        transition: border-color .2s;
    }

    #profile-pix-payload:focus {
        outline: none;
        border-color: rgba(168,85,247,0.5);
        box-shadow: 0 0 0 3px rgba(139,44,246,0.1);
    }

    #profile-pix-qr {
        width: 100px; height: 100px;
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(168,85,247,0.2);
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        color: var(--text-muted); font-size: 12px;
        overflow: hidden; flex-shrink: 0;
    }

    @media (max-width: 420px) {
        .pix-row { flex-direction: column; }
        #profile-pix-qr { width: 100%; height: 120px; }
    }

    /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
    @media (max-width: 480px) {
        .wrapper { padding: 56px 14px 80px; }
        .section-header { padding: 14px 16px 12px; }
        .section-body, .sub-box { padding: 16px; }
        .page-header h1 { font-size: 28px; }
        .btn-row { justify-content: stretch; }
        .btn-row .btn { flex: 1; justify-content: center; }
    }
    </style>
</head>
<body>

<!-- Back button -->
<a href="{% url 'buscar_musicas' %}" class="btn-back" aria-label="Voltar">
    <i class="fa fa-arrow-left" aria-hidden="true"></i>
    Voltar
</a>

<div class="wrapper">

    <!-- Page header -->
    <div class="page-header">
        <div class="logo-badge">
            <i class="fa fa-music"></i>
            Beatflow
        </div>
        <h1>Editar Perfil</h1>
        <p>Atualize suas informa√ß√µes pessoais e dados de cobran√ßa.</p>
    </div>

    {% if messages %}
    <ul class="messages">
        {% for m in messages %}
        <li class="{{ m.tags }}">
            {% if 'success' in m.tags %}
                <i class="fa fa-circle-check"></i>
            {% else %}
                <i class="fa fa-circle-exclamation"></i>
            {% endif %}
            {{ m }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <!-- ‚îÄ‚îÄ DADOS PESSOAIS ‚îÄ‚îÄ -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-emoji">üë§</div>
                <div>
                    <div class="section-title">Dados Pessoais</div>
                    <div class="section-desc">Seu nome e e-mail de acesso</div>
                </div>
            </div>
            <div class="section-body">
                <div class="field-grid">

                    <div class="field span-2">
                        <div class="field-input-wrap">
                            <input type="text" name="full_name" value="{{ user.get_full_name }}" placeholder="Seu nome completo" />
                            <i class="fa fa-user fi-icon"></i>
                        </div>
                    </div>

                    <div class="field span-2">
                        <div class="field-input-wrap">
                            <input type="email" name="email" value="{{ user.email }}" placeholder="seu@email.com" />
                            <i class="fa fa-envelope fi-icon"></i>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ DADOS DE COBRAN√áA ‚îÄ‚îÄ -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-emoji">üßæ</div>
                <div>
                    <div class="section-title">Dados para Cobran√ßa</div>
                    <div class="section-desc">Necess√°rios para emiss√£o de cobran√ßas via PIX</div>
                </div>
            </div>
            <div class="section-body">
                <div class="field-grid">

                    <div class="field">
                        <div class="field-input-wrap">
                            <input type="text" name="cpf_cnpj" value="{{ profile.cpf_cnpj|default_if_none:'' }}" placeholder="CPF / CNPJ" />
                            <i class="fa fa-id-card fi-icon"></i>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-input-wrap">
                            <input type="text" name="phone" value="{{ profile.phone|default_if_none:'' }}" placeholder="Telefone (11) 3000-0000" />
                            <i class="fa fa-phone fi-icon"></i>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-input-wrap">
                            <input type="text" name="mobile_phone" value="{{ profile.mobile_phone|default_if_none:'' }}" placeholder="Celular (11) 90000-0000" />
                            <i class="fa fa-mobile fi-icon"></i>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-input-wrap">
                            <input type="text" name="postal_code" value="{{ profile.postal_code|default_if_none:'' }}" placeholder="CEP 00000-000" />
                            <i class="fa fa-location-pin fi-icon"></i>
                        </div>
                    </div>

                    <div class="field span-2">
                        <div class="field-input-wrap">
                            <input type="text" name="address" value="{{ profile.address|default_if_none:'' }}" placeholder="Endere√ßo ‚Äî Rua, Avenida‚Ä¶" />
                            <i class="fa fa-road fi-icon"></i>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-input-wrap">
                            <input type="text" name="address_number" value="{{ profile.address_number|default_if_none:'' }}" placeholder="N√∫mero" />
                            <i class="fa fa-hashtag fi-icon"></i>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-input-wrap">
                            <input type="text" name="complement" value="{{ profile.complement|default_if_none:'' }}" placeholder="Complemento ‚Äî Apto, Sala‚Ä¶" />
                            <i class="fa fa-building fi-icon"></i>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-input-wrap">
                            <input type="text" name="city" value="{{ profile.city|default_if_none:'' }}" placeholder="Cidade" />
                            <i class="fa fa-city fi-icon"></i>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-input-wrap">
                            <input type="text" name="state" value="{{ profile.state|default_if_none:'' }}" placeholder="Estado ‚Äî SP" />
                            <i class="fa fa-map fi-icon"></i>
                        </div>
                    </div>

                </div>

                <div class="btn-row">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-check"></i> Salvar altera√ß√µes
                    </button>
                    <a href="{% url 'buscar_musicas' %}" class="btn btn-secondary">
                        <i class="fa fa-xmark"></i> Cancelar
                    </a>
                </div>
            </div>
        </div>

    </form>

    <!-- ‚îÄ‚îÄ ASSINATURA ‚îÄ‚îÄ -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-emoji">‚≠ê</div>
            <div>
                <div class="section-title">Assinatura {{ PLAN_NAME }}</div>
                <div class="section-desc">Plano mensal ¬∑ {{ PLAN_LABEL }} ¬∑ Pague via PIX</div>
            </div>
        </div>

        <div class="sub-box">

            {% if assinatura_ativa %}
            <!-- ATIVO -->
            <div class="sub-info-grid">
                <div class="sub-info-item green-item">
                    <span class="sii-emoji">‚úÖ</span>
                    <div>
                        <div class="sii-label">Status</div>
                        <div class="sii-value green">Ativo</div>
                    </div>
                </div>
                <div class="sub-info-item">
                    <span class="sii-emoji">üìÖ</span>
                    <div>
                        <div class="sii-label">Renova em</div>
                        <div class="sii-value">{{ assinatura_ativa.periodo_termina_em|date:'d/m/Y' }}</div>
                    </div>
                </div>
                <div class="sub-info-item">
                    <span class="sii-emoji">üéµ</span>
                    <div>
                        <div class="sii-label">Plano</div>
                        <div class="sii-value">{{ assinatura_ativa.plano_id|default:'Premium Mensal' }}</div>
                    </div>
                </div>
                <div class="sub-info-item">
                    <span class="sii-emoji">üí∞</span>
                    <div>
                        <div class="sii-label">Valor</div>
                        <div class="sii-value">{{ PLAN_LABEL }}</div>
                    </div>
                </div>
            </div>

            <button class="btn-subscribe" disabled>
                <i class="fa fa-circle-check"></i> Plano ativo ‚Äî tudo liberado!
            </button>

            {% else %}
            <!-- SEM PLANO -->
            <div class="sub-info-grid">
                <div class="sub-info-item">
                    <span class="sii-emoji">üîí</span>
                    <div>
                        <div class="sii-label">Status</div>
                        <div class="sii-value muted">Sem assinatura</div>
                    </div>
                </div>
                <div class="sub-info-item">
                    <span class="sii-emoji">üí∏</span>
                    <div>
                        <div class="sii-label">Valor</div>
                        <div class="sii-value">{{ PLAN_LABEL }}</div>
                    </div>
                </div>
            </div>

            <button id="profile-subscribe-btn" class="btn-subscribe">
                <i class="fa fa-bolt"></i> Assinar agora por {{ PLAN_LABEL }}
            </button>

            <div id="profile-pix-area" style="display:none;">
                <p class="pix-hint">
                    <i class="fa fa-qrcode"></i>
                    Escaneie o QR ou copie o c√≥digo PIX para pagar:
                </p>
                <div class="pix-row">
                    <textarea id="profile-pix-payload" readonly placeholder="C√≥digo PIX‚Ä¶"></textarea>
                    <div id="profile-pix-qr">
                        <i class="fa fa-qrcode" style="font-size:22px;opacity:.2;"></i>
                    </div>
                </div>
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <button id="profile-copy-pix" class="btn btn-secondary">
                        <i class="fa fa-copy"></i> Copiar c√≥digo
                    </button>
                </div>
            </div>
            {% endif %}

        </div>
    </div>

</div><!-- /wrapper -->

<script>
(function(){
    function getCookie(name){
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
    }

    const btn        = document.getElementById('profile-subscribe-btn');
    const pixArea    = document.getElementById('profile-pix-area');
    const pixPayload = document.getElementById('profile-pix-payload');
    const pixQr      = document.getElementById('profile-pix-qr');
    const copyBtn    = document.getElementById('profile-copy-pix');

    if(btn){
        btn.addEventListener('click', async function(){
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Criando cobran√ßa‚Ä¶';
            try{
                const payload = { amount: '{{ PLAN_PRICE }}', description: 'Assinatura {{ PLAN_LABEL }}' };
                {% if user.is_authenticated and user.profile.cpf_cnpj %}
                payload.document = '{{ user.profile.cpf_cnpj }}';
                {% endif %}

                const resp = await fetch('/api/payments/asaas/create-pix/', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if(!resp.ok){
                    let msg = data.error || 'Erro ao criar cobran√ßa';
                    if(data.message) msg += '\n' + data.message;
                    if(data.asaas_error) msg += '\n' + JSON.stringify(data.asaas_error);
                    alert(msg); return;
                }

                let ptext = data.pix_payload || data.copy_paste || '';
                let qr    = data.pix_qr || '';
                if((!ptext || !qr) && data.raw){
                    const r = data.raw;
                    if(!ptext) ptext = r.pixQrCode || r.pixPayload || (r.pix && (r.pix.payload || r.pix.copyPaste || r.pix.pixPayload)) || '';
                    if(!qr && r.pix) qr = r.pix.qrcode || r.pix.qrcode_base64 || r.pix.qrCode || r.pix.qrCodeBase64 || '';
                }

                if(ptext) pixPayload.value = ptext;
                if(qr) pixQr.innerHTML = '<img src="'+qr+'" style="width:100%;height:100%;object-fit:contain;border-radius:8px;" />';

                pixArea.style.display = 'block';
                setTimeout(function(){ pixArea.scrollIntoView({ behavior:'smooth', block:'nearest' }); }, 80);

            } catch(e){
                console.error(e);
                alert('Erro ao comunicar com o servidor');
            } finally {
                btn.disabled  = false;
                btn.innerHTML = '<i class="fa fa-bolt"></i> Assinar agora por {{ PLAN_LABEL }}';
            }
        });
    }

    if(copyBtn){
        copyBtn.addEventListener('click', function(){
            const t = pixPayload.value || '';
            if(!t) return;
            navigator.clipboard.writeText(t).then(function(){
                copyBtn.innerHTML = '<i class="fa fa-check"></i> Copiado!';
                setTimeout(function(){ copyBtn.innerHTML = '<i class="fa fa-copy"></i> Copiar c√≥digo'; }, 2200);
            }).catch(function(){ alert('N√£o foi poss√≠vel copiar'); });
        });
    }
})();
</script>

</body>
</html>
