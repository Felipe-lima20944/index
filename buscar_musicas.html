<!DOCTYPE html>
{% load static %}
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Beatflow · Professional Streaming</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/static/icones.ico" type="image/x-icon">
    <!-- Swiper for smooth touch sliders -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- Hammer.js for advanced gestures -->
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

    <style>
        /* ═══════════════════════════════════════════════════════════════
           TOKENS & RESET - Enhanced with dynamic variables
        ═══════════════════════════════════════════════════════════════ */
        :root {
            /* primary accents now purple/pink gradient hues */
            --accent:        #a855f7;            /* vivid purple */
            --accent-2:      #ec4899;            /* bright pink */
            --accent-glow:   rgba(232, 72, 153, 0.45);
            --accent-dim:    rgba(168, 85, 247, 0.18);

            /* shuffled and repeat icons keep contrast but fit theme */
            --shuffle-color: #7c3aed;            /* purple */
            --shuffle-glow:  rgba(124, 58, 237, 0.35);
            --repeat-once:   #3b82f6;            /* blue */
            --repeat-once-glow: rgba(59, 130, 246, 0.35);

            /* base backgrounds use deep purple/blue shades for gradient */
            --bg:            #000000; /* puro preto */
            --surface-1:     #080008;
            --surface-2:     #100010;
            --surface-3:     #180018;
            --surface-glass: rgba(255,255,255,0.04);
            --border:        rgba(255,255,255,0.07);
            --border-accent: rgba(232, 72, 153, 0.4);

            --txt-1:  #ececec; /* texto principal levemente mais escuro */
            --txt-2:  #a2a2b0; /* secundário mais visível */
            --txt-3:  #77778b; /* detalhes subtis */

            --player-h:      72px;
            --nav-h:         66px;
            --safe-b:        env(safe-area-inset-bottom, 0px);
            --safe-t:        env(safe-area-inset-top, 0px);

            --radius-sm:  8px;
            --radius-md:  14px;
            --radius-lg:  20px;
            --radius-xl:  28px;

            --font-display: 'Syne', sans-serif;
            --font-body:    'DM Sans', sans-serif;

            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-out:    cubic-bezier(0.22, 1, 0.36, 1);
            --ease-in:     cubic-bezier(0.76, 0, 0.24, 1);
            --ease-soft:   cubic-bezier(0.16, 1, 0.3, 1);
        }

        *, *::before, *::after {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html { overflow-x: hidden; height: -webkit-fill-available; }

        body {
            /* solid black with very subtle pink overlay via pseudo-element */
            background: var(--bg);
            color: var(--txt-1);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh;
            height: -webkit-fill-available;
            position: fixed;
            width: 100%;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior: none;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.12; /* a bit more visible */
            background: linear-gradient(135deg, rgba(232,72,153,0.06), rgba(232,72,153,0) 60%);
        }

        /* Dynamic App Grid with Gesture Support */
        .app-grid {
            display: grid;
            grid-template-rows: 1fr var(--player-h) var(--nav-h);
            height: 100vh;
            height: -webkit-fill-available;
            transition: grid-template-rows 0.4s var(--ease-soft);
            position: relative;
            touch-action: pan-y;
        }

        .app-grid.player-hidden {
            grid-template-rows: 1fr 0px var(--nav-h);
        }

        /* Main View with Momentum Scroll */
        .main-view {
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 16px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
            position: relative;
            touch-action: pan-y;
        }

        .main-view::-webkit-scrollbar { width: 2px; }
        .main-view::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 2px; }

        /* Draggable Panels */
        .drag-panel {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--surface-1);
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s var(--ease-soft);
            z-index: 2000;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
            will-change: transform;
            box-shadow: 0 -20px 60px rgba(0,0,0,0.8);
            border-top: 1px solid var(--border);
        }

        .drag-panel.active {
            transform: translateY(0);
        }

        .drag-panel.dragging {
            transition: none;
        }

        .drag-handle {
            width: 40px;
            height: 4px;
            background: var(--surface-3);
            border-radius: 2px;
            margin: 12px auto;
            cursor: grab;
            touch-action: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .panel-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 16px 24px;
            flex: 1;
        }

        /* Swipeable Cards Container */
        .swiper-container {
            margin: 0 -16px;
            padding: 0 16px;
        }

        .swiper-slide {
            width: 140px;
            height: auto;
        }

        .scroll-card {
            width: 140px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s var(--ease-bounce);
            position: relative;
            margin-right: 8px;
        }

        .scroll-card:active {
            transform: scale(0.97);
        }

        .scroll-card img {
            width: 100%;
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            object-fit: cover;
            margin-bottom: 8px;
        }

        /* Gesture Feedback */
        .gesture-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-radius: 100px;
            padding: 16px 24px;
            color: white;
            font-weight: 700;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            border: 1px solid var(--border-accent);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .gesture-feedback.show {
            opacity: 1;
        }

        /* Pull to Refresh */
        .ptr-container {
            position: relative;
            overflow: hidden;
            min-height: 100%;
        }

        .ptr-spinner {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            color: var(--accent);
            transition: transform 0.2s;
        }

        .ptr-spinner i {
            font-size: 1.5rem;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }


        /* Mini Player Gesture Area */
        .player-gesture-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            z-index: 10;
            cursor: pointer;
        }

        /* search bar queue button */
        @keyframes pulse-minimal {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(168,85,247,0);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 6px rgba(168,85,247,0.3);
            }
        }

        .queue-btn {
            background: var(--accent);
            color: white;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            /* subtle continuous pulse to draw attention without overwhelming */
            animation: pulse-minimal 2.5s ease-in-out infinite;
        }
        .queue-btn i {
            color: var(--accent-2);
            text-shadow: 0 0 3px rgba(232,72,153,0.6);
        }
        .queue-btn:hover {
            background: var(--accent-2);
        }
        .queue-btn:active {
            transform: scale(0.95);
        }
        /* when the queue is open we can damp the pulse so it isn't distracting */
        .queue-btn.open {
            animation: none;
        }

        /* Swipe to Delete */
        .swipe-delete-container {
            position: relative;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .swipe-delete-content {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 12px;
            transition: transform 0.15s;
            position: relative;
            z-index: 2;
        }

        .swipe-delete-action {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 80px;
            background: #ff3b30;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            z-index: 1;
        }

        /* Ripple Effect */
        .ripple-host { position: relative; overflow: hidden; }

        .ripple-wave {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: rippleAnim 0.55s linear;
            background: rgba(255,255,255,0.18);
            pointer-events: none;
            z-index: 10;
        }

        @keyframes rippleAnim {
            to { transform: scale(4); opacity: 0; }
        }

        /* Bottom Sheet (Expanded Player) */
        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--surface-1);
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s var(--ease-soft);
            z-index: 3000;
            max-height: 100vh; /* full screen */
            touch-action: pan-y;
            box-shadow: 0 -20px 60px rgba(0,0,0,0.8);
            border-top: 1px solid var(--border);
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .bottom-sheet.dragging {
            transition: none;
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--surface-3);
            border-radius: 2px;
            margin: 12px auto;
            cursor: grab;
        }

        .sheet-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 20px 30px;
            max-height: calc(100vh - 30px); /* allow full screen */
        }

        /* Queue Drawer */
        .queue-drawer {
            position: fixed;
            right: -100%;
            top: 0;
            bottom: 0;
            width: 90%;
            max-width: 400px;
            background: var(--surface-1);
            z-index: 4000;
            transition: right 0.3s var(--ease-soft);
            border-left: 1px solid var(--border);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .queue-drawer.active {
            right: 0;
        }

        .queue-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 3500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        


        /* Rest of your existing styles remain the same */
        /* (keeping all your existing CSS for cards, lists, player, etc.) */
        .search-bar { position: sticky; top: 0; z-index: 100; padding: 16px 16px 12px; background: linear-gradient(to bottom, var(--bg) 70%, transparent 100%); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); display: flex; gap: 10px; align-items: center; }
        .search-input-wrapper { position: relative; flex: 1; }
        .search-input-wrapper input { width: 100%; background: var(--surface-2); border: 1px solid var(--border); padding: 13px 16px 13px 44px; border-radius: 999px; color: var(--txt-1); font-family: var(--font-body); font-size: 15px; outline: none; transition: border-color 0.25s, background 0.25s, box-shadow 0.25s; }
        .search-input-wrapper input:focus { border-color: var(--accent); background: var(--surface-3); box-shadow: 0 0 0 3px var(--accent-dim), 0 8px 24px rgba(0,0,0,0.4); }
        .search-input-wrapper input::placeholder { color: var(--txt-3); }
        .search-input-wrapper .si-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--accent); font-size: 14px; pointer-events: none; transition: color 0.2s; }
        .search-input-wrapper input:focus ~ .si-icon, .search-input-wrapper:focus-within .si-icon { color: var(--accent); }
        .search-clear-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 22px; height: 22px; border-radius: 50%; background: var(--txt-3); border: none; color: var(--bg); font-size: 0.65rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.18s, transform 0.18s var(--ease-bounce), opacity 0.18s; opacity: 0; pointer-events: none; }
        .search-clear-btn.visible { opacity: 1; pointer-events: auto; }
        .search-clear-btn:hover { background: var(--accent); transform: translateY(-50%) scale(1.15); }
        .search-clear-btn:active { transform: translateY(-50%) scale(0.9); }
        .search-input-wrapper:has(.search-clear-btn.visible) input { padding-right: 44px; }
        .player-bar { position: relative; background: rgba(8, 8, 11, 0.98); backdrop-filter: blur(32px); -webkit-backdrop-filter: blur(32px); border-top: 1px solid var(--border); display: flex; flex-direction: column; padding: 0; z-index: 200; overflow: hidden; width: 100%; max-width: 100vw; }
        .player-progress-top { width: 100%; height: 3px; background: var(--surface-3); cursor: pointer; flex-shrink: 0; position: relative; }
        .player-progress-top-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width 0.1s linear; border-radius: 0 2px 2px 0; }
        .player-progress-top:hover { height: 5px; }
        .player-progress-top:hover .player-progress-top-fill { filter: brightness(1.2); }
        .player-main-row { display: flex; align-items: center; gap: 6px; padding: 0 8px 0 10px; height: 69px; overflow: hidden; width: 100%; min-width: 0; }
        .player-close-btn { position: relative; z-index: 20; flex-shrink: 0; width: 28px; height: 28px; border-radius: 50%; background: var(--surface-3); border: 1px solid var(--border); color: var(--txt-3); font-size: 0.7rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.18s var(--ease-bounce); }
        .player-close-btn:hover { background: rgba(255,85,114,0.2); color: #ff5572; border-color: rgba(255,85,114,0.3); transform: scale(1.12); }
        .player-close-btn:active { transform: scale(0.9); }
        .now-playing-mini { display: flex; align-items: center; gap: 9px; cursor: pointer; min-width: 0; max-width: 100%; flex: 1 1 auto; overflow: hidden; }
        .now-playing-art { position: relative; flex-shrink: 0; width: 40px; height: 40px; }
        .now-playing-art img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; box-shadow: 0 4px 14px rgba(0,0,0,0.6); transition: transform 0.3s var(--ease-bounce); }
        .now-playing-mini:hover .now-playing-art img { transform: scale(1.07) rotate(-2deg); }
        .playing-indicator { position: absolute; inset: 0; border-radius: 8px; border: 2px solid var(--accent); opacity: 0; transition: opacity 0.3s; }
        .playing-indicator.active { opacity: 1; animation: pulse-border 2s ease-in-out infinite; }
        @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 0 0 var(--accent-glow); } 50% { box-shadow: 0 0 0 5px rgba(255,60,110,0); } }
        .track-info { min-width: 0; flex: 1 1 auto; overflow: hidden; overflow-wrap: break-word; max-width: 100%; }
        .track-info .ti-title, .track-info .ti-artist { display: block; max-width: 100%; }
        .track-info .ti-title { font-family: var(--font-display); font-size: 0.8rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 1; letter-spacing: -0.01em; max-width: 100%; }
        .track-info .ti-artist { font-size: 0.67rem; color: var(--txt-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 1; margin-top: 1px; max-width: 100%; }
        .ctrl-btn { background: none; border: none; color: var(--txt-3); cursor: pointer; padding: 6px; font-size: 0.95rem; transition: color 0.2s, transform 0.15s var(--ease-bounce), text-shadow 0.2s; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; }
        .ctrl-btn::after { content: ''; position: absolute; inset: 0; border-radius: 50%; background: rgba(255,255,255,0.06); opacity: 0; transform: scale(0.7); transition: opacity 0.2s, transform 0.2s var(--ease-bounce); }
        .ctrl-btn:hover { color: var(--txt-1); transform: scale(1.15); }
        .ctrl-btn:hover::after { opacity: 1; transform: scale(1); }
        .ctrl-btn:active { transform: scale(0.88); }
        .ctrl-btn.liked { color: var(--accent); text-shadow: 0 0 12px var(--accent-glow); }
        .ctrl-btn.shuffle-active { color: var(--shuffle-color); text-shadow: 0 0 12px var(--shuffle-glow); }
        .ctrl-btn.shuffle-active::after { background: rgba(167,139,250,0.1); }
        .ctrl-btn.repeat-off { color: var(--txt-3); }
        .ctrl-btn.repeat-once { color: var(--repeat-once); text-shadow: 0 0 12px var(--repeat-once-glow); }
        .ctrl-btn.repeat-once::after { background: rgba(251,191,36,0.1); opacity: 1; transform: scale(1); }
        .ctrl-btn.repeat-one { color: var(--accent); text-shadow: 0 0 12px var(--accent-glow); animation: repeat-one-pulse 2s ease-in-out infinite; }
        .ctrl-btn.repeat-one::after { background: var(--accent-dim); opacity: 1; transform: scale(1); }
        @keyframes repeat-one-pulse { 0%, 100% { text-shadow: 0 0 8px var(--accent-glow); } 50% { text-shadow: 0 0 20px var(--accent-glow), 0 0 40px rgba(255,60,110,0.15); } }
        .repeat-badge { position: absolute; top: -2px; right: -2px; width: 14px; height: 14px; border-radius: 50%; background: var(--repeat-once); color: #000; font-size: 0.5rem; font-weight: 800; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .btn-play-main { width: 42px; height: 42px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; border-radius: 50%; color: white; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 18px var(--accent-glow); transition: transform 0.18s var(--ease-bounce), box-shadow 0.18s; position: relative; flex-shrink: 0; }
        .btn-play-main::before { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 2px solid rgba(255,60,110,0.3); opacity: 0; transform: scale(0.8); transition: opacity 0.3s, transform 0.3s var(--ease-bounce); }
        .btn-play-main.is-playing::before { opacity: 1; transform: scale(1); animation: play-ring 2.5s ease-in-out infinite; }
        @keyframes play-ring { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.15); opacity: 0.1; } }
        .btn-play-main:hover { transform: scale(1.1); box-shadow: 0 6px 26px var(--accent-glow); }
        .btn-play-main:active { transform: scale(0.93); }
        .btn-play-main i { pointer-events: none; }
        .btn-play-main .fa-play { margin-left: 2px; }
        .ctrl-btn.skip-btn { color: var(--txt-2); font-size: 1.1rem; }
        .ctrl-btn.skip-btn:hover { color: var(--txt-1); transform: scale(1.2); }
        .bottom-nav { background: rgba(8, 8, 11, 0.98); backdrop-filter: blur(32px); -webkit-backdrop-filter: blur(32px); border-top: 1px solid var(--border); display: grid; grid-template-columns: repeat(4, 1fr); align-items: center; z-index: 300; padding-bottom: var(--safe-b); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 10px 4px; background: none; border: none; color: var(--txt-3); cursor: pointer; transition: color 0.2s; position: relative; }
        .nav-item::before { content: ''; position: absolute; inset: 6px 12px; border-radius: 999px; background: var(--accent-dim); opacity: 0; transform: scaleX(0.5) scaleY(0.8); transition: opacity 0.25s, transform 0.25s var(--ease-bounce); }
        .nav-item::after { content: ''; position: absolute; bottom: 6px; width: 4px; height: 4px; border-radius: 50%; background: var(--accent); opacity: 0; transform: scale(0); transition: opacity 0.25s, transform 0.25s var(--ease-bounce); }
        .nav-item.active { color: var(--accent); }
        .nav-item.active::after { opacity: 1; transform: scale(1); }
        .nav-item.active::before { opacity: 1; transform: scaleX(1) scaleY(1); }
        .nav-item i { font-size: 1.2rem; transition: transform 0.25s var(--ease-bounce); position: relative; z-index: 1; }
        .nav-item.active i { transform: translateY(-2px) scale(1.1); }
        .nav-item:hover:not(.active) i { transform: scale(1.08) translateY(-1px); color: var(--txt-1); }
        .nav-item span { font-size: 0.62rem; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; position: relative; z-index: 1; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 24px 16px 12px; }
        .section-title { font-family: var(--font-display); font-size: 1.25rem; font-weight: 800; letter-spacing: -0.03em; line-height: 1; }
        .section-title span { color: var(--accent); }
        .section-link { font-size: 0.8rem; font-weight: 600; color: var(--txt-2); text-decoration: none; padding: 6px 12px; border-radius: 999px; border: 1px solid var(--border); background: var(--surface-glass); transition: color 0.2s, border-color 0.2s, background 0.2s, transform 0.15s var(--ease-bounce); cursor: pointer; }
        .section-link:hover { color: var(--accent); border-color: var(--border-accent); background: var(--accent-dim); transform: scale(1.04); }
        .section-link:active { transform: scale(0.97); }
        .explore-hero { margin: 4px 16px 24px; border-radius: var(--radius-lg); padding: 28px 24px; position: relative; overflow: hidden; min-height: 160px; display: flex; flex-direction: column; justify-content: flex-end; cursor: pointer; }
        .explore-hero-bg { position: absolute; inset: 0; background-image: linear-gradient(135deg, rgba(255,60,110,0.6) 0%, rgba(255,138,0,0.4) 50%, rgba(20,20,30,0.6) 100%), url('{% static "fundonovidade.jpg" %}'); background-size: cover; background-position: center; transition: transform 0.6s var(--ease-out); }
        .explore-hero:hover .explore-hero-bg { transform: scale(1.04); }
        .explore-hero::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(7,7,9,0.85) 0%, rgba(7,7,9,0.1) 60%); }
        .explore-hero-content { position: relative; z-index: 2; }
        .hero-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--accent); color: white; font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; padding: 4px 10px; border-radius: 999px; margin-bottom: 10px; }
        .hero-title { font-family: var(--font-display); font-size: 1.55rem; font-weight: 800; letter-spacing: -0.04em; line-height: 1.1; margin-bottom: 6px; }
        .hero-sub { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 16px; }
        .hero-btn { display: inline-flex; align-items: center; gap: 8px; background: white; color: #0a0a0f; font-family: var(--font-display); font-size: 0.85rem; font-weight: 700; padding: 10px 20px; border-radius: 999px; border: none; cursor: pointer; transition: transform 0.18s var(--ease-bounce), box-shadow 0.18s; letter-spacing: -0.01em; }
        .hero-btn:hover { transform: scale(1.06); box-shadow: 0 8px 28px rgba(255,255,255,0.3); }
        .hero-btn:active { transform: scale(0.96); }
        .genre-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 0 16px; }
        @media (min-width: 480px) { .genre-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 640px) { .genre-grid { grid-template-columns: repeat(4, 1fr); } }
        .genre-card { position: relative; border-radius: var(--radius-md); min-height: 88px; cursor: pointer; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; padding: 12px 10px; transform: translateZ(0); transition: transform 0.25s var(--ease-bounce), box-shadow 0.25s; }
        .genre-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 60%); opacity: 0; transition: opacity 0.3s; z-index: 3; }
        .genre-card:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 14px 36px rgba(0,0,0,0.6); }
        .genre-card:hover::before { opacity: 1; }
        .genre-card:active { transform: scale(0.96); }
        .genre-card .gc-bg { position: absolute; inset: 0; object-fit: cover; width: 100%; height: 100%; filter: brightness(0.6) saturate(1.1); transition: transform 0.4s var(--ease-out), filter 0.3s; }
        .genre-card:hover .gc-bg { transform: scale(1.1); filter: brightness(0.7) saturate(1.3); }
        .genre-spinner { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); color: var(--txt-1); z-index: 4; pointer-events: none; font-size: 1.4rem; }
        .genre-card.loading { cursor: progress; opacity: 0.65; pointer-events: none; }
        .genre-card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.78) 0%, rgba(0,0,0,0.05) 70%); }
        .genre-card .gc-emoji { position: absolute; top: 10px; right: 10px; font-size: 2rem; z-index: 2; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.5)); line-height: 1; transition: transform 0.3s var(--ease-bounce); }
        .genre-card:hover .gc-emoji { transform: scale(1.2) rotate(5deg); }
        .genre-card .gc-name { font-family: var(--font-display); font-size: 0.88rem; font-weight: 800; color: white; letter-spacing: -0.02em; line-height: 1.2; z-index: 2; text-shadow: 0 2px 8px rgba(0,0,0,0.7); transition: transform 0.2s var(--ease-bounce); }
        .genre-card:hover .gc-name { transform: translateY(-2px); }
        .scroll-row { display: flex; gap: 10px; overflow-x: auto; padding: 4px 16px 12px; scrollbar-width: none; }
        .scroll-row::-webkit-scrollbar { display: none; }
        .scroll-card { flex-shrink: 0; width: 128px; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px; cursor: pointer; transition: background 0.15s, transform 0.25s var(--ease-bounce), box-shadow 0.25s, border-color 0.2s; }
        .scroll-card:hover { background: var(--surface-3); transform: translateY(-5px) scale(1.02); box-shadow: 0 12px 28px rgba(0,0,0,0.5), 0 0 0 1px var(--border-accent); border-color: var(--border-accent); }
        .scroll-card:active { transform: scale(0.96); }
        .scroll-add-btn { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.55); border: none; border-radius: 50%; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; opacity: 0; transition: opacity 0.2s, transform 0.18s var(--ease-bounce), background 0.18s; cursor: pointer; }
        .scroll-card:hover .scroll-add-btn { opacity: 1; }
        .scroll-add-btn:hover { background: var(--accent); transform: scale(1.15); }
        .scroll-add-btn:active { transform: scale(0.9); }
        .scroll-card img { width: 100%; aspect-ratio: 1; border-radius: var(--radius-sm); object-fit: cover; margin-bottom: 8px; transition: transform 0.3s var(--ease-bounce); }
        .scroll-card:hover img { transform: scale(1.04); }
        .scroll-card .s-title { font-family: var(--font-display); font-size: 0.78rem; font-weight: 700; line-height: 1.25; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; letter-spacing: -0.01em; }
        .scroll-card .s-sub { font-size: 0.68rem; color: var(--txt-2); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        @keyframes shimmer { 0% { background-position: -600px 0; } 100% { background-position: 600px 0; } }
        .skeleton { background: linear-gradient(90deg, var(--surface-2) 25%, var(--surface-3) 50%, var(--surface-2) 75%); background-size: 1200px 100%; animation: shimmer 1.6s ease-in-out infinite; border-radius: var(--radius-md); }
        .music-list { display: flex; flex-direction: column; gap: 6px; padding: 0 16px; }
        .list-item { display: grid; grid-template-columns: 48px 1fr auto; gap: 12px; align-items: center; background: var(--surface-2); border: 1px solid var(--border); padding: 10px 12px; border-radius: var(--radius-md); cursor: pointer; transition: background 0.15s, border-color 0.2s, transform 0.18s var(--ease-bounce), box-shadow 0.2s; position: relative; overflow: hidden; }
        .list-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--accent), var(--accent-2)); transform: scaleY(0); transition: transform 0.2s var(--ease-out); transform-origin: center; }
        .list-item::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, rgba(255,60,110,0.03), transparent); opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .list-item.now-playing { background: rgba(255,60,110,0.08); border-color: var(--border-accent); box-shadow: 0 4px 20px rgba(255,60,110,0.1); }
        .list-item.now-playing::before { transform: scaleY(1); }
        .list-item:hover { background: var(--surface-3); transform: translateX(3px); border-color: rgba(255,255,255,0.1); }
        .list-item:hover::after { opacity: 1; }
        .list-item:active { transform: scale(0.99) translateX(1px); }
        .list-thumb img { width: 48px; height: 48px; border-radius: var(--radius-sm); object-fit: cover; transition: transform 0.3s var(--ease-bounce); }
        .list-item:hover .list-thumb img { transform: scale(1.06); }
        .list-info { min-width: 0; }
        .list-title { font-family: var(--font-display); font-weight: 700; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: -0.02em; }
        .list-artist { font-size: 0.75rem; color: var(--txt-2); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-actions { display: flex; gap: 4px; align-items: center; }
        .list-actions button { background: var(--surface-glass); border: 1px solid var(--border); color: var(--txt-2); cursor: pointer; width: 34px; height: 34px; border-radius: 50%; font-size: 0.82rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s var(--ease-bounce); position: relative; overflow: hidden; }
        .list-actions button:hover { background: var(--accent); border-color: var(--accent); color: white; transform: scale(1.15); box-shadow: 0 4px 12px var(--accent-glow); }
        .list-actions button:active { transform: scale(0.9); }
        .grid-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 0 16px; }
        @media (min-width: 480px) { .grid-cards { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 640px) { .grid-cards { grid-template-columns: repeat(4, 1fr); } }
        /* album row for search results: horizontal scroll one-per view */
        .album-row { display:flex; gap:10px; overflow-x:auto; padding:0 16px; }
        .album-row .card-music { flex:0 0 140px; }
        .card-music { background: var(--surface-2); padding: 10px; border-radius: var(--radius-md); cursor: pointer; border: 1px solid var(--border); transition: all 0.22s var(--ease-bounce); position: relative; overflow: hidden; }
        .card-music:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(0,0,0,0.55), 0 0 0 1px var(--border-accent); background: var(--surface-3); }
        .card-music:active { transform: scale(0.97); }
        .card-music img { width: 100%; aspect-ratio: 1; border-radius: var(--radius-sm); object-fit: cover; margin-bottom: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.5); transition: transform 0.3s var(--ease-bounce), box-shadow 0.3s; }
        .card-music:hover img { transform: scale(1.04); box-shadow: 0 10px 28px rgba(0,0,0,0.6); }
        .play-btn-float { position: absolute; right: 10px; bottom: 42px; width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 18px var(--accent-glow); cursor: pointer; transition: all 0.22s var(--ease-bounce); opacity: 0; transform: translateY(6px) scale(0.8); }
        .play-btn-float.add-album { right: 52px; background: var(--surface-2); border: 1px solid var(--border); box-shadow: none; transform: translateY(6px) scale(0.8); }
        .play-btn-float.add-album:hover { background: var(--surface-3); border-color: var(--border-accent); }
        .play-btn-float.add-album i { color: var(--txt-1); margin-left: 0; font-size: 0.8rem; }
        .card-music:hover .play-btn-float { opacity: 1; transform: translateY(0) scale(1); }
        .play-btn-float:hover { transform: scale(1.15) !important; box-shadow: 0 6px 24px var(--accent-glow); }
        .play-btn-float:active { transform: scale(0.9) !important; }
        .play-btn-float i { color: white; font-size: 0.9rem; margin-left: 2px; }
        .track-title { font-family: var(--font-display); font-weight: 700; font-size: 0.82rem; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; letter-spacing: -0.01em; }
        .track-artist { font-size: 0.72rem; color: var(--txt-2); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .expanded-track-panel { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.92); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; align-items: stretch; }
        .expanded-inner { background: var(--surface-1); border-radius: 0; padding: 0 0 calc(var(--safe-b) + 24px); width: 100%; height: 100%; max-height: 100vh; overflow-y: auto; display: flex; flex-direction: column; border-top: none; -webkit-overflow-scrolling: touch; padding-top: calc(var(--safe-t) + 8px); }
        .close-expanded-btn {
            position: fixed;
            top: calc(var(--safe-t, 0px) + 8px);
            right: 12px;
            width: 34px;
            height: 34px;
            z-index: 3100;
            background: rgba(0,0,0,0.6);
            color: white;
        }
        .panel-drag-handle { display: none; }
        .panel-art-section { padding: 20px 20px 0; display: flex; justify-content: center; }
        .panel-art-wrap { position: relative; width: min(72vw, 300px); height: min(72vw, 300px); }
        .panel-art-bg { position: absolute; inset: -20px; background: radial-gradient(ellipse at center, var(--accent-glow), transparent 70%); filter: blur(24px); opacity: 0.6; border-radius: 50%; animation: art-pulse 3s ease-in-out infinite; }
        @keyframes art-pulse { 0%, 100% { transform: scale(0.95); opacity: 0.5; } 50% { transform: scale(1.05); opacity: 0.7; } }
        .panel-art-wrap img { width: 100%; height: 100%; border-radius: 18px; object-fit: cover; box-shadow: 0 24px 56px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.08); position: relative; z-index: 2; }
        .panel-body { padding: 20px 24px 0; display: flex; flex-direction: column; gap: 16px; }
        .panel-track-info { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
        .panel-track-texts { flex: 1; min-width: 0; }
        .panel-track-texts h2 { font-family: var(--font-display); font-size: 1.4rem; font-weight: 800; letter-spacing: -0.04em; line-height: 1.15; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .panel-track-texts p { font-size: 0.9rem; color: var(--txt-2); margin-top: 4px; }
        .panel-action-btns { display: flex; gap: 6px; flex-shrink: 0; }
        .panel-icon-btn { width: 40px; height: 40px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 50%; color: var(--txt-2); font-size: 1rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.18s var(--ease-bounce); position: relative; overflow: hidden; }
        .panel-icon-btn:hover { color: var(--txt-1); background: var(--surface-3); transform: scale(1.1); }
        .panel-icon-btn:active { transform: scale(0.93); }
        .panel-icon-btn.liked { color: var(--accent); border-color: var(--border-accent); background: var(--accent-dim); box-shadow: 0 0 16px var(--accent-glow); }
        .queue-ctx-pill { display: inline-flex; align-items: center; gap: 6px; padding: 5px 14px; border-radius: 999px; background: var(--accent-dim); border: 1px solid var(--border-accent); font-size: 0.72rem; color: var(--accent); align-self: center; font-weight: 600; }
        .progress-section { display: flex; flex-direction: column; gap: 8px; }
        .progress-bar-wrap { position: relative; height: 4px; background: var(--surface-3); border-radius: 2px; cursor: pointer; overflow: hidden; transition: height 0.2s var(--ease-bounce); }
        .progress-bar-wrap:hover { height: 6px; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius: 2px; transition: width 0.1s linear; }
        .progress-times { display: flex; justify-content: space-between; font-size: 0.72rem; color: var(--txt-2); }
        .panel-controls { display: flex; align-items: center; justify-content: space-between; padding: 0 8px; }
        .panel-ctrl-btn { background: none; border: none; color: var(--txt-2); cursor: pointer; padding: 10px; font-size: 1.2rem; transition: color 0.2s, transform 0.15s var(--ease-bounce); border-radius: 50%; position: relative; overflow: hidden; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .panel-ctrl-btn::after { content: ''; position: absolute; inset: 0; border-radius: 50%; background: rgba(255,255,255,0.06); opacity: 0; transition: opacity 0.2s; }
        .panel-ctrl-btn:hover { color: var(--txt-1); transform: scale(1.15); }
        .panel-ctrl-btn:hover::after { opacity: 1; }
        .panel-ctrl-btn:active { transform: scale(0.88); }
        .panel-ctrl-btn.shuffle-active { color: var(--shuffle-color); text-shadow: 0 0 12px var(--shuffle-glow); }
        .panel-ctrl-btn.repeat-once { color: var(--repeat-once); }
        .panel-ctrl-btn.repeat-one { color: var(--accent); animation: repeat-one-pulse 2s ease-in-out infinite; }
        .panel-play-btn { width: 64px; height: 64px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; border-radius: 50%; color: white; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 8px 28px var(--accent-glow); transition: transform 0.18s var(--ease-bounce), box-shadow 0.18s; position: relative; }
        .panel-play-btn::before { content: ''; position: absolute; inset: -6px; border-radius: 50%; border: 2px solid rgba(255,60,110,0.25); opacity: 0; transition: opacity 0.3s; }
        .panel-play-btn.is-playing::before { opacity: 1; animation: play-ring 2.5s ease-in-out infinite; }
        .panel-play-btn:hover { transform: scale(1.1); box-shadow: 0 12px 36px var(--accent-glow); }
        .panel-play-btn:active { transform: scale(0.94); }
        .panel-play-btn i { pointer-events: none; }
        .panel-play-btn .fa-play { margin-left: 3px; }
        .volume-section { display: flex; align-items: center; gap: 10px; color: var(--txt-2); }
        .volume-section i { font-size: 0.9rem; flex-shrink: 0; }
        .vol-bar-wrap { flex: 1; height: 4px; background: var(--surface-3); border-radius: 2px; cursor: pointer; overflow: hidden; transition: height 0.2s; }
        .vol-bar-wrap:hover { height: 6px; }
        .vol-bar-fill { height: 100%; background: var(--txt-2); border-radius: 2px; }
        .panel-action-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .panel-act-btn { padding: 13px; border-radius: var(--radius-lg); border: 1px solid var(--border); background: var(--surface-2); color: var(--txt-2); font-family: var(--font-body); font-weight: 600; font-size: 0.82rem; cursor: pointer; transition: all 0.18s var(--ease-bounce); display: flex; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden; }
        .panel-act-btn:hover { background: var(--surface-3); color: var(--txt-1); border-color: rgba(255,255,255,0.14); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.3); }
        .panel-act-btn:active { transform: scale(0.97); }
        .panel-act-btn.primary { background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 6px 18px var(--accent-glow); }
        .panel-act-btn.primary:hover { box-shadow: 0 10px 28px var(--accent-glow); transform: translateY(-2px); }
        .queue-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: var(--accent-dim); border: 1px solid var(--border-accent); border-radius: 999px; font-size: 0.72rem; color: var(--accent); font-weight: 600; margin: 0 16px 10px; }
        .queue-item { display: grid; grid-template-columns: 28px 42px 1fr auto; gap: 10px; align-items: center; padding: 10px 12px; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 6px; transition: background 0.15s, border-color 0.15s, transform 0.18s var(--ease-bounce); width:100%; box-sizing:border-box; }
        /* simple animated equalizer bars for playing track */
        .playing-icon { display:inline-block; position:relative; width:16px; height:16px; }
        .playing-icon span { position:absolute; bottom:0; width:3px; background:var(--accent); animation:play-bar 0.8s infinite ease-in-out; }
        .playing-icon span:nth-child(1){ left:0; animation-delay:0s; }
        .playing-icon span:nth-child(2){ left:5px; animation-delay:0.2s; }
        .playing-icon span:nth-child(3){ left:10px; animation-delay:0.4s; }
        @keyframes play-bar { 0%,100% { height:4px;} 50% { height:100%; } }
        
        .queue-item:hover { background: var(--surface-3); transform: translateX(2px); }
        .queue-item.now-playing { background: var(--accent-dim); border-color: var(--border-accent); border-left: 3px solid var(--accent); box-shadow: 0 4px 16px rgba(255,60,110,0.1); }
        .queue-index { width: 26px; height: 26px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.72rem; }
        .queue-thumb { width: 42px; height: 42px; border-radius: 8px; object-fit: cover; }
        .queue-actions { display: flex; gap: 4px; }
        .queue-actions button { background: var(--surface-glass); border: 1px solid var(--border); color: var(--txt-2); cursor: pointer; font-size: 0.9rem; width: 36px; height: 36px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; transition: all 0.15s var(--ease-bounce); position: relative; overflow: hidden; }
        .queue-actions button:hover { background: var(--surface-3); color: var(--txt-1); transform: scale(1.12); }
        .queue-actions button:active { transform: scale(0.92); }
        .playlist-list { display: flex; flex-direction: column; gap: 8px; padding: 0 16px; }
        .playlist-card { display: flex; align-items: center; gap: 14px; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px; cursor: pointer; transition: all 0.18s var(--ease-out); position: relative; overflow: hidden; }
        .playlist-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, var(--accent-dim), transparent); opacity: 0; transition: opacity 0.25s; pointer-events: none; }
        .playlist-card:hover::before { opacity: 1; }
        .playlist-card:hover { border-color: var(--border-accent); transform: translateX(4px); box-shadow: 0 4px 16px rgba(255,60,110,0.08); }
        .playlist-card:active { transform: scale(0.99); }
        .playlist-option { position: relative; }
        .pl-main { padding-right: 88px; }
        .pl-actions { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); z-index: 20; display:flex; gap:8px; align-items:center; }
        .pl-actions .btn-icon { min-width:44px; height:40px; padding:8px; border-radius:8px; }
        .playlist-icon { width: 52px; height: 52px; border-radius: var(--radius-sm); flex-shrink: 0; background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: white; box-shadow: 0 4px 14px var(--accent-glow); transition: transform 0.2s var(--ease-bounce), box-shadow 0.2s; }
        .playlist-card:hover .playlist-icon { transform: scale(1.08) rotate(-3deg); box-shadow: 0 6px 20px var(--accent-glow); }
        /* grid of small album covers used in playlist previews */
        .playlist-art-grid { width:52px; height:52px; border-radius: var(--radius-sm); overflow:hidden; display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr; gap:2px; background: var(--surface-3); flex-shrink:0; }
        .playlist-art-grid img { width:100%; height:100%; object-fit:cover; display:block; }
        .playlist-info { min-width: 0; flex: 1; position: relative; z-index: 1; }
        .playlist-name { font-family: var(--font-display); font-weight: 700; font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; letter-spacing: -0.02em; }
        .playlist-count { font-size: 0.78rem; color: var(--txt-2); margin-top: 3px; }
        .section-cta { display: inline-flex; align-items: center; gap: 7px; padding: 8px 14px; border-radius: 999px; background: var(--accent-dim); color: var(--accent); border: 1px solid var(--border-accent); font-weight: 700; font-size: 0.82rem; text-decoration: none; cursor: pointer; transition: all 0.18s var(--ease-bounce); position: relative; overflow: hidden; }
        .section-cta:hover { background: var(--accent); color: white; transform: scale(1.06); box-shadow: 0 6px 22px var(--accent-glow); }
        .section-cta:active { transform: scale(0.97); }
        .section-cta.filled { background: var(--accent); color: white; box-shadow: 0 4px 16px var(--accent-glow); }
        .btn-danger { color: #ff5572; border-color: rgba(255,85,114,0.25); background: rgba(255,85,114,0.08); }
        .btn-danger:hover { background: rgba(255,85,114,0.18); color: white; }
        .btn-icon { display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px; padding: 6px 8px; background: var(--surface-glass); border: 1px solid var(--border); border-radius: 8px; color: var(--txt-2); cursor: pointer; transition: all 0.12s var(--ease-bounce); font-size: 0.95rem; user-select: none; pointer-events: auto; position: relative; overflow: hidden; }
        .btn-icon:hover { color: var(--txt-1); background: var(--surface-3); transform: scale(1.05); }
        .btn-icon:active { transform: scale(0.97); }
        .shared-panel .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 10px; font-weight: 700; font-family: var(--font-display); cursor: pointer; border: 1px solid var(--border); transition: all 0.16s var(--ease-out); background: var(--surface-2); color: var(--txt-1); }
        .shared-panel .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; box-shadow: 0 6px 18px var(--accent-glow); border-color: transparent; }
        .shared-panel .btn.primary:hover { transform: translateY(-2px); box-shadow: 0 10px 28px var(--accent-glow); }
        .shared-panel .btn.secondary { background: var(--surface-3); color: var(--txt-2); border-color: var(--border); }
        .shared-panel .btn.secondary:hover { background: var(--surface-2); color: var(--txt-1); }
        .shared-panel .btn i { font-size: 0.95rem; }
        .shared-panel .now-playing { background: var(--accent-dim); border-color: var(--border-accent); border-left: 3px solid var(--accent); box-shadow: 0 4px 16px rgba(255,60,110,0.1); transform: translateX(2px); }
        .shared-panel .now-playing img { box-shadow: 0 6px 20px rgba(255,60,110,0.06); }
        .shared-panel .now-playing .now-badge, .shared-panel .now-playing::after { content: 'Tocando'; font-size: 0.72rem; color: var(--txt-2); margin-left: 8px; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,0.02); align-self: center; }
        .profile-header { padding: 36px 16px 24px; display: flex; flex-direction: column; align-items: center; gap: 12px; text-align: center; color: var(--green); }
        .profile-avatar { width: 84px; height: 84px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 2.2rem; font-weight: 800; color: white; box-shadow: 0 8px 28px var(--accent-glow), 0 0 0 3px rgba(255,60,110,0.18); animation: avatar-float 4s ease-in-out infinite; }
        @keyframes avatar-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .profile-name { font-family: var(--font-display); font-size: 1.4rem; font-weight: 800; letter-spacing: -0.03em; color: var(--green); }
        .profile-meta { font-size: 0.85rem; color: var(--green); }
        .profile-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); border-radius: var(--radius-md); overflow: hidden; margin: 0 16px; }
        .profile-sub-card { margin: 12px 16px; padding: 14px 16px; background: var(--surface-1); border: 1px solid var(--border); border-radius: 12px; text-align: center; color: var(--txt-1); display: flex; flex-direction: column; align-items: center; gap: 6px; box-shadow: none !important; filter: none !important; -webkit-backdrop-filter: none !important; backdrop-filter: none !important; }
        .profile-sub-card .plan-name { font-weight: 700; font-size: 1.1rem; }
        .profile-sub-card .plan-end { font-size: 0.9rem; color: var(--txt-2); }
        .profile-sub-card .plan-icon { font-size: 1.4rem; color: var(--green); }
        .stat-box { background: var(--surface-1); padding: 18px 8px; text-align: center; transition: background 0.2s; }
        .stat-box:hover { background: var(--surface-2); }
        .stat-num { font-family: var(--font-display); font-size: 1.5rem; font-weight: 800; color: var(--accent); letter-spacing: -0.04em; }
        .stat-label { font-size: 0.68rem; color: var(--txt-2); margin-top: 3px; text-transform: uppercase; letter-spacing: 0.06em; }
        .profile-actions { display: flex; flex-direction: column; gap: 8px; padding: 20px 16px 0; }
        .profile-action-btn { display: flex; align-items: center; gap: 14px; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 16px; cursor: pointer; font-family: var(--font-body); font-size: 0.9rem; font-weight: 600; color: var(--txt-1); text-decoration: none; transition: all 0.15s var(--ease-bounce); position: relative; overflow: hidden; }
        .profile-action-btn i { color: var(--accent); width: 20px; text-align: center; transition: transform 0.2s var(--ease-bounce); }
        .profile-action-btn:hover { background: var(--surface-3); transform: translateX(4px); border-color: rgba(255,255,255,0.1); }
        .profile-action-btn:hover i { transform: scale(1.2); }
        .profile-action-btn.danger { color: #ff5572; }
        .profile-action-btn.danger i { color: #ff5572; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 4000; display: flex; align-items: flex-end; justify-content: center; }
        .modal { background: var(--surface-1); border-radius: 24px 24px 0 0; padding: 20px 18px 28px; width: 100%; max-height: 82vh; overflow-y: auto; border-top: 1px solid var(--border); box-shadow: 0 -20px 60px rgba(0,0,0,0.7); -webkit-overflow-scrolling: touch; }
        .panel-overlay { align-items: stretch; }
        .panel-modal { width: 100%; height: 100vh; max-width: none; max-height: none; border-radius: 0; padding: 18px 18px 28px; overflow-y: auto; box-shadow: none; display: flex; flex-direction: column; }
        .panel-modal .modal-drag-handle { display: none; }
        .panel-back-btn { position: fixed; top: calc(12px + env(safe-area-inset-top, 0px)); left: 12px; z-index: 4500; padding: 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.4); color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.5); transition: all 0.18s var(--ease-bounce); }
        .panel-back-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }
        .panel-back-btn:active { transform: scale(0.93); }
        .modal-drag-handle { width: 36px; height: 4px; background: var(--surface-3); border-radius: 2px; margin: 0 auto 18px; }
        .modal h3 { font-family: var(--font-display); font-size: 1.3rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 16px; }
        .modal-input { width: 100%; padding: 14px 16px; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--txt-1); font-family: var(--font-body); font-size: 15px; outline: none; margin-bottom: 10px; transition: border-color 0.2s, box-shadow 0.2s; }
        .modal-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 16px; }
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: var(--radius-xl); font-family: var(--font-display); font-weight: 700; font-size: 0.92rem; cursor: pointer; transition: all 0.18s var(--ease-bounce); letter-spacing: -0.01em; position: relative; overflow: hidden; }
        .modal-btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; box-shadow: 0 4px 18px var(--accent-glow); }
        .modal-btn.primary:hover { box-shadow: 0 8px 28px var(--accent-glow); transform: translateY(-1px); }
        .modal-btn.primary:active { transform: scale(0.97); }
        .modal-btn.secondary { background: var(--surface-2); border: 1px solid var(--border); color: var(--txt-2); }
        .modal-btn.secondary:hover { background: var(--surface-3); color: var(--txt-1); }
        .modal-btn:disabled { opacity: 0.45; pointer-events: none; }
        .playlist-option { display: flex; align-items: center; gap: 14px; padding: 13px; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 8px; cursor: pointer; transition: all 0.15s var(--ease-bounce); }
        .pl-main.adding { opacity: 0.6; pointer-events: none; }
        .pl-spinner { display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; }
        .playlist-option:hover { border-color: var(--border-accent); background: var(--accent-dim); transform: translateX(3px); }
        .playlist-option .pl-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: flex; align-items: center; justify-content: center; font-size: 1rem; color: white; flex-shrink: 0; }
        .playlist-option .pl-name { font-family: var(--font-display); font-weight: 700; font-size: 0.9rem; letter-spacing: -0.02em; }
        .playlist-option .pl-count { font-size: 0.75rem; color: var(--txt-2); margin-top: 2px; }
        .create-pl-inline { display: flex; align-items: center; gap: 14px; padding: 13px; background: var(--accent-dim); border: 1px dashed var(--border-accent); border-radius: var(--radius-md); margin-bottom: 14px; cursor: pointer; transition: all 0.15s var(--ease-bounce); }
        .create-pl-inline:hover { background: rgba(255,60,110,0.18); transform: scale(1.01); }
        .create-pl-inline .pl-icon { background: rgba(255,60,110,0.2); color: var(--accent); }
        .create-pl-inline .pl-name { font-family: var(--font-display); font-weight: 700; color: var(--accent); }
        .new-pl-form { background: var(--accent-dim); border: 1px solid var(--border-accent); border-radius: var(--radius-md); padding: 14px; margin-bottom: 12px; }
        .new-pl-form .form-title { font-family: var(--font-display); font-size: 0.82rem; font-weight: 700; color: var(--accent); margin-bottom: 10px; }
        .album-modal-header { display: flex; gap: 14px; margin-bottom: 18px; padding-bottom: 18px; border-bottom: 1px solid var(--border); }
        .album-modal-header img { width: 88px; height: 88px; border-radius: var(--radius-md); object-fit: cover; flex-shrink: 0; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        .album-modal-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .album-modal-info h4 { font-family: var(--font-display); font-size: 1.05rem; font-weight: 800; letter-spacing: -0.03em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .album-modal-info p { font-size: 0.78rem; color: var(--txt-2); margin-top: 4px; }
        .album-play-btn { display: inline-flex; align-items: center; gap: 8px; margin-top: 12px; padding: 9px 20px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; border: none; border-radius: 999px; font-family: var(--font-display); font-weight: 700; font-size: 0.82rem; cursor: pointer; transition: all 0.18s var(--ease-bounce); box-shadow: 0 4px 14px var(--accent-glow); }
        .album-play-btn:hover { transform: scale(1.06); box-shadow: 0 8px 26px var(--accent-glow); }
        .album-play-btn:active { transform: scale(0.97); }
        .album-play-btn:disabled { opacity: 0.5; pointer-events: none; }
        .auth-gate-banner { margin: 12px 16px; padding: 14px 16px; background: var(--accent-dim); border: 1px solid var(--border-accent); border-radius: var(--radius-md); display: flex; align-items: center; gap: 12px; font-size: 0.88rem; }
        .auth-gate-banner i { color: var(--accent); flex-shrink: 0; }
        .auth-gate-banner a { color: var(--accent); font-weight: 700; text-decoration: none; margin-left: auto; flex-shrink: 0; }
        .notification { position: fixed; bottom: calc(var(--player-h) + var(--nav-h) + 14px + var(--safe-b)); left: 14px; right: 14px; padding: 13px 20px; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius-xl); color: var(--txt-1); font-weight: 600; font-size: 0.88rem; z-index: 5000; box-shadow: 0 12px 36px rgba(0,0,0,0.6); text-align: center; backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .inline-loader { display: flex; justify-content: center; align-items: center; padding: 10px 0; color: var(--accent); font-size: 1.2rem; }
        .notification::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
        .notification.error::before { background: #ff5572; }
        .notification.success::before { background: #00d68f; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 56px 20px; color: var(--txt-2); text-align: center; }
        .empty-state-icon { width: 72px; height: 72px; border-radius: 50%; background: var(--surface-2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-bottom: 18px; color: var(--txt-3); }
        .empty-state h3 { font-family: var(--font-display); font-size: 1.1rem; font-weight: 700; color: var(--txt-1); margin-bottom: 6px; letter-spacing: -0.02em; }
        .empty-state p { font-size: 0.85rem; }
        .search-hero { padding: 16px; display: flex; justify-content: center; }
        .search-hero-inner { position: relative; width: 100%; max-width: 520px; border-radius: var(--radius-lg); overflow: hidden; }
        .search-hero-inner img { width: 100%; display: block; border-radius: var(--radius-lg); opacity: 0.9; }
        .search-hero-overlay { position: absolute; inset: 0; border-radius: var(--radius-lg); background: linear-gradient(to bottom, rgba(7,7,9,0.1) 0%, rgba(7,7,9,0.72) 100%); display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 34px 20px 18px; text-align: center; }
        .search-hero-overlay h3 { font-family: var(--font-display); font-size: 1.3rem; font-weight: 800; letter-spacing: -0.04em; margin-bottom: 4px; }
        .search-hero-overlay p { font-size: 0.85rem; color: rgba(255,255,255,0.75); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-up { animation: fadeUp 0.4s var(--ease-out) both; }
        .fade-up-1 { animation-delay: 0.05s; }
        .fade-up-2 { animation-delay: 0.1s; }
        .fade-up-3 { animation-delay: 0.15s; }
        .fade-up-4 { animation-delay: 0.2s; }
        [x-cloak] { display: none !important; }
        button, a, .card-music, .list-item, .queue-item, .genre-card, .scroll-card, .playlist-card, .playlist-option { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        @supports (-webkit-touch-callout: none) { .app-grid, body { height: -webkit-fill-available; } }
        .fa-spin { animation: spin 0.8s linear infinite; }
        
        @keyframes eq { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }
        .cache-badge { font-size: 0.62rem; color: var(--txt-3); padding: 2px 6px; border-radius: 4px; background: var(--surface-3); border: 1px solid var(--border); vertical-align: middle; margin-left: 6px; opacity: 0.7; }

        /* welcome overlay styles (dark purple / black) */
        .welcome-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            /* dark purple-to-black gradient with subtle shifting animation */
            background: linear-gradient(135deg, #1a002e, #000, #1a002e);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
            color: #fff;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .welcome-content { text-align: center; max-width: 90%; }
        .welcome-content h1 { font-size: 3rem; margin-bottom: 1rem; }
        .welcome-content p { font-size: 1.5rem; margin-bottom: 1.5rem; }
        .welcome-button {
            font-size: 1rem;
            padding: 0.75rem 1.5rem;
            background: #4c1d95; /* dark purple button */
            color: #fff;
            border: 2px solid #a855f7;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        .welcome-button:hover { background: #6d28d9; transform: scale(1.05); }
        .welcome-button:active { transform: scale(0.95); }

        /* links inside overlay text (register) get gradient highlight */
        .overlay-text a {
            color: #fff;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-weight: 600;
        }
        .overlay-text a:hover { opacity: 0.9; }
    </style>
</head>
<body x-data="app()" x-init="init()" @keydown.escape="closeModal()">

    {% if show_welcome %}
<div id="welcome-overlay" class="welcome-overlay" style="background:
              /* top & bottom purple/black fades */
              linear-gradient(to bottom,#1a002e 0%,#000 10%,transparent 25%,transparent 75%,#000 90%,#1a002e 100%),
              /* actual image centered */
              url('{% static "fundoiniciodotestegratis.jpeg" %}') center/contain no-repeat,
              /* fallback solid black */
              #000;
            background-repeat: no-repeat;
            background-size: auto, contain !important, auto;
            background-position: top center, center center, bottom center;
            cursor:pointer;">
    <!-- image-only welcome, click anywhere to dismiss -->
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('welcome-overlay');
        if (overlay) {
            overlay.addEventListener('click', () => { overlay.style.display='none'; });
        }
    });
</script>
{% endif %}

<!-- preview limit full-screen overlay (hidden by default). only the image is shown;
     clicking anywhere takes the user to registration -->
<div id="preview-overlay" style="display:none; position:fixed; inset:0; z-index:10000; overflow:hidden;">
    <a href="{% if user.is_authenticated %}{% url 'assinatura' %}{% else %}/register/{% endif %}"
       style="display:block;width:100%;height:100%;
              /* choose image depending on auth status */
              background: url('{% static user.is_authenticated|yesno:"fundomensagemdeplano.jpeg,fundomensagem30seg.jpeg" %}') center/contain no-repeat,
                          linear-gradient(to bottom,
                                          #1a002e 0%,
                                          #000 10%,
                                          transparent 25%,
                                          transparent 75%,
                                          #000 90%,
                                          #1a002e 100%);
              background-repeat: no-repeat;
              background-size: contain, auto;">
        <!-- gradient provides dark purple/black bars top & bottom -->
    </a>
</div>

<!-- hidden audio for premium notification -->
<audio id="preview-audio" src="{% static 'Premium_Na_Batida.mp3' %}" preload="auto"></audio>

<script>
function showPreviewOverlay(msg) {
    const ov = document.getElementById('preview-overlay');
    if (ov) ov.style.display = 'flex';
    // attempt to play notification sound; ignore errors if autoplay blocked
    const pa = document.getElementById('preview-audio');
    if (pa) {
        pa.currentTime = 0;
        pa.play().catch(() => {});
    }
}
</script>
    <form style="display:none">{% csrf_token %}</form>

    <!-- Gesture Feedback Overlay -->
    <div class="gesture-feedback" x-show="gestureFeedback.show" x-text="gestureFeedback.text" x-cloak></div>

    <!-- Overlay for drawers -->
    <div class="overlay" :class="{ 'active': queueDrawerActive || panelOpen }" @click="closeAllDrawers()"></div>



    <!-- Queue Drawer -->
    <div class="queue-drawer" :class="{ 'active': queueDrawerActive }">
        <div class="queue-header">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;">
                <i class="fa-solid fa-list-music" style="color:var(--accent)"></i>
                <span>Ultima Fila Selecionada</span>
            </h3>
            <button class="btn-icon" @click="queueDrawerActive = false">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <!-- explanation of queue -->
        <div class="queue-explanation" style="padding:0 16px 8px; color:var(--txt-2); font-size:0.85rem;">
            A fila é simplesmente a lista de reprodução atual — ela muda conforme o que você tocou por último (álbum, pesquisa, playlist, etc.). Toque em qualquer música para pular diretamente para ela.
        </div>
        <div class="queue-body">
            <template x-for="(track, index) in currentQueue" :key="'qd-'+track.id+'-'+index">
                <div class="swipe-delete-container" x-data="{ startX: 0, currentX: 0, isDragging: false }"
                     @touchstart="startX = $event.touches[0].clientX; isDragging = true"
                     @touchmove="if(isDragging){ currentX = $event.touches[0].clientX - startX; if(currentX < 0) currentX = 0; $refs.content.style.transform = 'translateX('+currentX+'px)'; }"
                     @touchend="if(currentX > 50 && currentTrack?.id !== track.id){ $dispatch('remove-from-queue', index); } $refs.content.style.transform = ''; isDragging = false; currentX = 0">
                    <div class="swipe-delete-content queue-item" :class="{ 'now-playing': currentTrack?.id === track.id }" x-ref="content">
                        <span class="queue-index" x-text="index + 1"></span>
                        <img :src="track.thumb || ''" class="queue-thumb" alt="">
                        <div style="min-width:0;">
                            <div class="track-title" style="font-weight:600; overflow:hidden; text-overflow:ellipsis;" x-text="track.title"></div>
                            <div class="track-artist" style="font-size:0.7rem; color:var(--txt-2);" x-text="track.artist"></div>
                        </div>
                        <div class="queue-actions">
                            <button class="btn-icon" @click.stop="playFromQueue(index)">
                                <template x-if="currentTrack?.id === track.id">
                                    <span class="playing-icon"><span></span><span></span><span></span></span>
                                </template>
                                <template x-if="currentTrack?.id !== track.id">
                                    <i class="fa-solid fa-play"></i>
                                </template>
                            </button>
                        </div>
                    </div>
                    <div class="swipe-delete-action" x-show="currentTrack?.id !== track.id">
                        <i class="fa-solid fa-trash"></i>
                    </div>
                </div>
            </template>
            <div class="empty-state" x-show="currentQueue.length === 0">
                <div class="empty-state-icon"><i class="fa-solid fa-music"></i></div>
                <h3>Fila vazia</h3>
                <p>Adicione músicas para começar</p>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet (Expanded Player) -->
   <div class="bottom-sheet" :class="{ 'active': bottomSheetActive, 'dragging': sheetDragging }" 
     x-ref="bottomSheet" @touchstart="sheetTouchStart" @touchmove="sheetTouchMove" @touchend="sheetTouchEnd">
    <div style="position:relative; display:flex; align-items:center; justify-content:center; padding-top:12px; padding-bottom:4px;">
        <div class="sheet-handle" style="margin:0;"></div>
        <button class="panel-icon-btn ripple-host"
                @click.stop="bottomSheetActive = false; addRipple($event)"
                title="Fechar"
                style="position:absolute; right:16px; top:50%; transform:translateY(-50%);">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
    <div class="sheet-content">
            <div style="text-align:center; margin-bottom:20px;">
                <img :src="currentTrack?.thumb || ''" 
                     style="width: min(80vw, 280px); height: min(80vw, 280px); border-radius: 20px; object-fit: cover; box-shadow: 0 20px 40px rgba(0,0,0,0.6);">
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <div style="min-width:0; flex:1;">
                    <h2 style="font-family:var(--font-display); font-size:1.5rem; font-weight:800; letter-spacing:-0.04em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" x-text="currentTrack?.title"></h2>
                    <p style="color:var(--txt-2); font-size:1rem;" x-text="currentTrack?.artist"></p>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="panel-icon-btn" :class="likedTracks.includes(currentTrack?.id) ? 'liked' : ''" @click="toggleLike(currentTrack)">
                        <i :class="likedTracks.includes(currentTrack?.id) ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                    </button>
                </div>
            </div>

            <div class="progress-section" style="margin-bottom:16px;">
                <div class="progress-bar-wrap" @click="seek($event)">
                    <div class="progress-bar-fill" :style="{ width: progress + '%' }"></div>
                </div>
                <div class="progress-times">
                    <span x-text="formatTime(currentTime)"></span>
                    <span x-text="formatTime(duration)"></span>
                </div>
            </div>

            <div class="panel-controls" style="margin-bottom:20px;">
                <button class="panel-ctrl-btn" :class="shuffle ? 'shuffle-active' : ''" @click="shuffle = !shuffle">
                    <i class="fa-solid fa-shuffle"></i>
                </button>
                <button class="panel-ctrl-btn" @click="previous(true)">
                    <i class="fa-solid fa-backward-step"></i>
                </button>
                <button class="panel-play-btn" :class="isPlaying ? 'is-playing' : ''" @click="togglePlay()">
                    <i :class="(!hasActivePlan && currentTime >= previewLimit) ? 'fa-solid fa-lock' : (isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play')"></i>
                </button>
                <button class="panel-ctrl-btn" @click="next(true)">
                    <i class="fa-solid fa-forward-step"></i>
                </button>
                <button class="panel-ctrl-btn" :class="repeatModeClass" @click="cycleRepeat()">
                    <i class="fa-solid fa-repeat"></i>
                    <span class="repeat-badge" x-show="repeatMode === 'once'">1x</span>
                </button>
            </div>

            <div class="panel-action-row">
                <button class="panel-act-btn" @click="shareCurrentTrack()">
                    <i class="fa-solid fa-share-alt"></i> Compartilhar
                </button>
                <button class="panel-act-btn" @click="openAlbumForCurrentTrack()">
                    <i class="fa-solid fa-compact-disc"></i> Álbum
                </button>
                <button class="panel-act-btn" @click="showRecommendations(currentTrack)">
                    <i class="fa-solid fa-star"></i> Similares
                </button>
            </div>

            <div style="margin-top:20px; display:flex; justify-content:space-around; padding:10px 0; border-top:1px solid var(--border);">
                <button class="btn-icon" @click="showAddToPlaylistModal(currentTrack)" style="flex-direction:column; gap:4px; height:auto;">
                    <i class="fa-solid fa-plus-circle"></i>
                    <span style="font-size:0.7rem;">Adicionar</span>
                </button>
                <button class="btn-icon" @click="queueDrawerActive = true; bottomSheetActive = false" style="flex-direction:column; gap:4px; height:auto;">
                    <i class="fa-solid fa-list"></i>
                    <span style="font-size:0.7rem;">Fila</span>
                </button>

            </div>
        </div>
    </div>

    <div class="app-grid"
         :class="{ 'player-hidden': !currentTrack }">

    <main class="main-view" id="mainScroll" x-ref="mainScroll" @scroll.passive="handleScroll">

        <!-- Pull to Refresh Spinner -->
        <div class="ptr-spinner" :style="{ transform: 'translateY(' + ptrOffset + 'px)' }" x-show="ptrActive">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </div>

        <!-- SEARCH BAR -->
        <header class="search-bar">
            <div class="search-input-wrapper">
                <input type="text" x-model="query"
                       @input.debounce.500ms="search(query)"
                       @focus="activeNav = 'search'"
                       placeholder="Buscar músicas, artistas, álbuns…">
                <i class="fa-solid fa-magnifying-glass si-icon"></i>
                <button class="search-clear-btn"
                        :class="{ 'visible': query.trim() !== '' }"
                        @click="clearSearch()"
                        type="button"
                        aria-label="Limpar busca">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <button class="btn-icon queue-btn" :class="{ open: queueDrawerActive }" @click="queueDrawerActive = !queueDrawerActive" title="Fila de músicas" aria-expanded="false" :aria-expanded="queueDrawerActive">
                <i class="fa-solid fa-music"></i>
            </button>
        </header>

        <!-- Shared playlist panel -->
        <div class="shared-panel" x-show="showSharedPanel && activeNav === 'explorar'" x-cloak style="max-width:1000px;margin:12px auto;" x-transition>
            <div style="background:var(--surface-2);border:1px solid var(--border);padding:12px;border-radius:12px;display:flex;align-items:center;gap:12px;">
                <div style="flex:1;min-width:0;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                        <div style="min-width:0;">
                            <div style="font-weight:800;font-size:1rem;">{{ 'Playlist compartilhada' }}</div>
                            <div style="color:var(--txt-2);font-size:0.92rem;">
                                <span x-text="sharedPlaylist?.name || 'Compartilhada'"></span>
                                <div style="font-size:0.86rem; color:var(--txt-3); margin-top:6px; display:flex; align-items:center; gap:8px;">
                                    <i class="fa-solid fa-user" style="font-size:0.82rem; color:var(--txt-2);"></i>
                                    <span x-text="sharedPlaylist?.owner || 'Desconhecido'"></span>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button class="btn secondary" title="Fechar painel compartilhado" @click="showSharedPanel = false; try { if (isPlaying && audio) { audio.pause(); isPlaying = false; } if (trackDetailOpen) { trackDetailOpen = false; } } catch(e) { console.warn('close shared panel:', e); }">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="shared-list" style="margin-top:10px;padding-bottom:6px;">
                        <template x-for="(t,i) in (sharedPlaylist && sharedPlaylist.tracks ? sharedPlaylist.tracks : [])" :key="t.id">
                               <div :class="{ 'now-playing': currentTrack && String(currentTrack.id) === String(t.id) }"
                                   style="display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;background:var(--surface-3);cursor:pointer;width:100%;"
                                   @click="selectTrack(t,i,sharedPlaylist.tracks,'shared')">
                                <img :src="t.thumb || '/static/classicacapa.jpg'" alt="Capa" style="width:56px;height:56px;border-radius:8px;object-fit:cover;flex-shrink:0;">
                                <div style="min-width:0;">
                                    <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" x-text="(i+1) + '. ' + t.title"></div>
                                    <div style="color:var(--txt-2);font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" x-text="t.artist"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXPANDED TRACK PANEL (original, can be hidden) -->
        <section x-show="trackDetailOpen"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="expanded-track-panel" x-cloak
                 @click.self="closeTrackDetail()"
                 x-effect="document.body.style.overflow = trackDetailOpen ? 'hidden' : ''">

            <!-- close button fixed top-right -->
            <button class="panel-icon-btn ripple-host close-expanded-btn" 
                    @click.stop="closeTrackDetail(); addRipple($event)" 
                    title="Fechar">
                <i class="fa-solid fa-xmark"></i>
            </button>

            <div class="expanded-inner" role="dialog" aria-modal="true"
                 x-transition:enter="transition ease-out duration-350"
                 x-transition:enter-start="transform translate-y-full"
                 x-transition:enter-end="transform translate-y-0">

                <div class="panel-drag-handle"></div>

                <div class="panel-art-section">
                    <div class="panel-art-wrap">
                        <div class="panel-art-bg" :style="isPlaying ? '' : 'animation:none;opacity:0.3'"></div>
                        <img :src="trackDetail.thumb || currentTrack?.thumb || ''" alt="Capa">
                    </div>
                </div>

                <div class="panel-body">
                    <div class="queue-ctx-pill" x-show="currentQueueLabel">
                        <i class="fa-solid fa-list-music"></i>
                        <span x-text="currentQueueLabel"></span>
                        <span style="opacity:.6;"
                              x-show="currentQueueIndex >= 0 && currentQueue.length > 1"
                              x-text="' · ' + (currentQueueIndex + 1) + ' / ' + currentQueue.length"></span>
                    </div>

                    <div class="panel-track-info">
                        <div class="panel-track-texts">
                            <h2 x-text="trackDetail.title || currentTrack?.title"></h2>
                            <p x-text="trackDetail.artist || currentTrack?.artist"></p>
                        </div>
                        <div class="panel-action-btns">
                            <button class="panel-icon-btn ripple-host" :class="likedTracks.includes(currentTrack?.id) ? 'liked' : ''"
                                    @click.stop="toggleLike(currentTrack); addRipple($event)">
                                <i :class="likedTracks.includes(currentTrack?.id) ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                            </button>
                            <button class="panel-icon-btn ripple-host" @click.stop="showAddToPlaylistModal(currentTrack); addRipple($event)">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-bar-wrap" @click.stop="seek($event)">
                            <div class="progress-bar-fill" :style="{ width: progress + '%' }"></div>
                        </div>
                        <div class="progress-times">
                            <span x-text="formatTime(currentTime)"></span>
                            <span x-text="formatTime(duration)"></span>
                        </div>
                    </div>

                    <div class="panel-controls">
                        <!-- Shuffle -->
                        <button class="panel-ctrl-btn ripple-host"
                                :class="shuffle ? 'shuffle-active' : ''"
                                @click.stop="shuffle = !shuffle; addRipple($event)"
                                :title="shuffle ? 'Aleatório ligado' : 'Aleatório desligado'">
                            <i class="fa-solid fa-shuffle"></i>
                        </button>

                        <button class="panel-ctrl-btn ripple-host" @click.stop="previous(true); addRipple($event)">
                            <i class="fa-solid fa-backward-step"></i>
                        </button>

                        <button class="panel-play-btn ripple-host"
                                :class="isPlaying ? 'is-playing' : ''"
                                @click="togglePlay(); addRipple($event)">
                            <i :class="(!hasActivePlan && currentTime >= previewLimit)
                                        ? 'fa-solid fa-lock'
                                        : (isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play')">
                            </i>
                        </button>

                        <button class="panel-ctrl-btn ripple-host" @click.stop="next(true); addRipple($event)">
                            <i class="fa-solid fa-forward-step"></i>
                        </button>

                        <!-- Repeat com 3 estados -->
                        <button class="panel-ctrl-btn ripple-host"
                                :class="repeatModeClass"
                                @click.stop="cycleRepeat(); addRipple($event)"
                                :title="repeatTitle">
                            <i :class="repeatIcon"></i>
                            <span class="repeat-badge" x-show="repeatMode === 'once'">1x</span>
                        </button>
                    </div>

                    <div class="panel-action-row">
                        <button class="panel-act-btn ripple-host" @click.stop="shareCurrentTrack(); addRipple($event)">
                            <i class="fa-solid fa-share-alt"></i> Compartilhar
                        </button>
                        <button class="panel-act-btn ripple-host" @click.stop="openAlbumForCurrentTrack(); addRipple($event)">
                            <i class="fa-solid fa-compact-disc"></i> Álbum
                        </button>
                        <button class="panel-act-btn primary ripple-host" :disabled="recommendationsLoading" @click.stop="showRecommendations(currentTrack); addRipple($event)">
                            <span x-show="!recommendationsLoading"><i class="fa-solid fa-star"></i> Similares</span>
                            <span x-show="recommendationsLoading"><i class="fa-solid fa-spinner fa-spin"></i> …</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ─── ABA: EXPLORAR ─────────────────────────────────────── -->
        <div x-show="activeNav === 'explorar'" x-cloak>

            <div class="explore-hero fade-up" style="margin-top:8px;" @click="loadExplorarFeatured()">
                <div class="explore-hero-bg"></div>
                <div class="explore-hero-content">
                    <div class="hero-badge"><i class="fa-solid fa-fire"></i> Destaque</div>
                    <h2 class="hero-title">Descoberta<br>do dia</h2>
                    <p class="hero-sub">Músicas selecionadas pra você agora</p>
                    <button class="hero-btn ripple-host" @click.stop="loadExplorarFeatured(); addRipple($event)">
                        <i class="fa-solid fa-shuffle"></i> Tocar mix
                    </button>
                </div>
            </div>

            <div class="section-header fade-up fade-up-3" id="explore-section">
                <h2 class="section-title">Em <span>Alta</span></h2>
                <span x-show="explorarLoading && explorarTracks.length === 0" style="color:var(--txt-3);font-size:0.8rem;">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> carregando
                </span>
            </div>

            <template x-if="explorarLoading && explorarTracks.length === 0">
                <div class="scroll-row">
                    <template x-for="i in 5" :key="'sk-' + i">
                        <div class="scroll-card skeleton" style="height:175px;"></div>
                    </template>
                </div>
            </template>

            <template x-if="explorarTracks.length > 0">
                <div class="swiper-container swiper-explorar" x-init="initSwiper($el)">
                    <div class="swiper-wrapper">
                        <template x-for="(track, i) in explorarTracks" :key="'exp-' + (track.id ? String(track.id) : i)">
                            <div class="swiper-slide">
                                <div class="scroll-card" @click="selectTrack(track, i, explorarTracks, 'explorar')" style="position:relative;">
                                    <img :src="track.thumb || track.capa || track.thumbnail || '/static/classicacapa.jpg'" loading="lazy" alt="">
                                    <div class="s-title" x-text="track.title || track.titulo"></div>
                                    <div class="s-sub" x-text="resolveArtist(track)"></div>
                                    <button class="scroll-add-btn" @click.stop="showAddToPlaylistModal(track)" title="Adicionar à playlist">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <div class="section-header fade-up fade-up-1">
                <h2 class="section-title">Por <span>gênero</span></h2>
            </div>
            <!-- loading text while a genre request is in progress -->
            <div class="genre-loading-text" x-show="loading && activeGenre" style="color:var(--txt-3);font-size:0.85rem;margin:6px 0;">
                <i class="fa-solid fa-circle-notch fa-spin"></i>
                Procurando <strong x-text="activeGenre?.name || ''"></strong>...
            </div>
            <div class="genre-grid fade-up fade-up-2">
                <template x-for="g in generos" :key="g.slug">
                    <!-- add loading indicator inside each card -->
                    <div class="genre-card"
                         :style="{ background: g.gradient }"
                         @click="exploreGenre(g)"
                         :class="{'loading': loading && activeGenre?.slug === g.slug}">
                        <template x-if="g.image">
                            <img :src="g.image" class="gc-bg" alt="">
                        </template>
                        <template x-if="!g.image">
                            <span class="gc-emoji" x-text="g.emoji"></span>
                        </template>
                        <span class="gc-name" x-text="g.name"></span>

                        <!-- spinner overlay when this genre is being fetched -->
                        <span class="genre-spinner" x-show="loading && activeGenre?.slug === g.slug">
                            <i class="fa-solid fa-circle-notch fa-spin"></i>
                        </span>
                    </div>
                </template>
            </div>
            <template x-if="genreResults.songs?.length">
                <div>
                    <div class="section-header">
                        <h2 class="section-title" x-text="activeGenre?.name || 'Gênero'"></h2>
                        <button class="section-link" @click="genreResults = {}; activeGenre = null">Limpar</button>
                    </div>
                    <div class="queue-badge" x-show="currentQueueType === 'genre'">
                        <i class="fa-solid fa-music"></i> Fila ativa — <span x-text="activeGenre?.name"></span>
                    </div>
                    <div class="music-list">
                        <template x-for="(track, i) in genreResults.songs" :key="'gr-' + (track.id ? String(track.id) : i)">
                            <div class="list-item" :class="{'now-playing': currentTrack?.id === track.id}"
                                 @click="selectTrack(track, i, genreResults.songs, 'genre')" style="position:relative;">
                                <div class="list-thumb"><img :src="track.thumb || track.capa || track.thumbnail || '/static/classicacapa.jpg'" loading="lazy" alt=""></div>
                                <div class="list-info">
                                    <div class="list-title" x-text="track.title || track.titulo"></div>
                                    <div class="list-artist" x-text="track.artist || track.artista"></div>
                                </div>
                                <div class="list-actions">
                                    <button class="ripple-host" @click.stop="selectTrack(track, i, genreResults.songs, 'genre'); addRipple($event)">
                                        <i class="fa-solid fa-play"></i>
                                    </button>
                                    <button class="ripple-host" @click.stop="showAddToPlaylistModal(track); addRipple($event)">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <!-- ─── ABA: PESQUISAR ─────────────────────────────────────── -->
        <div x-show="activeNav === 'search'" x-cloak>
            <div id="music-section" style="min-height:1px;"></div>

            <div class="search-hero" x-show="activeNav === 'search' && !loading && !query.trim()" x-cloak>
                <div class="search-hero-inner">
                    <img src="{% static 'fundosecaopesquisaa.WebP' %}" alt="">
                    <div class="search-hero-overlay">
                        <h3>Buscar músicas</h3>
                        <p>Digite no campo acima para começar</p>
                    </div>
                </div>
            </div>

            <div x-show="query.trim() !== ''">
                <!-- ÁLBUNS -->
                <template x-if="query.trim() !== '' && Array.isArray(searchResults.albums) && searchResults.albums.filter(a => a && (a.title || a.id || a.thumb)).length">
                    <div>
                        <div class="section-header" style="margin-top:20px;">
                            <h2 class="section-title">Álbuns</h2>
                        </div>
                        <div class="album-row">
                            <template x-for="(album, i) in searchResults.albums" :key="'alb-' + (album.id || album.browseId || i)">
                                <div class="card-music" @click="openAlbum(album.id || album.browseId, album.title, album.thumb, album.track_count)">
                                    <img :src="album.thumb" loading="lazy">
                                    <div class="play-btn-float"
                                         @click.stop="openAlbum(album.id || album.browseId, album.title, album.thumb, album.track_count, true)">
                                        <i class="fa-solid fa-play" x-show="albumLoadingId !== (album.id || album.browseId)"></i>
                                        <i class="fa-solid fa-spinner fa-spin" x-show="albumLoadingId === (album.id || album.browseId)"></i>
                                    </div>
                                    <div class="play-btn-float add-album"
                                         @click.stop="openAlbum(album.id || album.browseId, album.title, album.thumb, album.track_count)"
                                         title="Ver faixas do álbum">
                                        <i class="fa-solid fa-list-music"></i>
                                    </div>
                                    <p class="track-title" x-text="album.title"></p>
                                    <p class="track-artist" x-text="album.artist"></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
                <div class="section-header">
                    <h2 class="section-title">Músicas</h2>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <span x-show="searchCached && !loading" style="font-size:0.68rem;color:var(--txt-3);">
                            <i class="fa-solid fa-bolt"></i> cache
                        </span>
                        <div x-show="loading" style="color:var(--txt-3);font-size:0.8rem;">
                            <i class="fa-solid fa-circle-notch fa-spin"></i>
                        </div>
                    </div>
                </div>
                <div class="queue-badge" x-show="currentQueueType === 'search'">
                    <i class="fa-solid fa-magnifying-glass"></i> Fila ativa — resultados
                </div>

                <div class="music-list">
                    <!-- inline loader when results are being fetched -->
                    <div class="inline-loader" x-show="loading" x-cloak>
                        <i class="fa fa-microphone fa-pulse"></i>
                    </div>
                    <template x-if="loading && !searchResults.songs?.length">
                        <template x-for="i in 6" :key="'skel-' + i">
                            <div class="list-item skeleton" style="height:58px;"></div>
                        </template>
                    </template>

                    <template x-if="searchResults.songs?.length">
                        <template x-for="(track, i) in searchResults.songs" :key="'sr-' + (track.id ? String(track.id) : i)">
                            <div class="list-item" :class="{'now-playing': currentTrack?.id === track.id}"
                                 @click="selectTrack(track, i, searchResults.songs, 'search')">
                                <div class="list-thumb"><img :src="track.thumb" loading="lazy" alt=""></div>
                                <div class="list-info">
                                    <div class="list-title" x-text="track.title"></div>
                                    <div class="list-artist" x-text="track.artist"></div>
                                </div>
                                <div class="list-actions">
                                    <button class="ripple-host" @click.stop="selectTrack(track, i, searchResults.songs, 'search'); addRipple($event)">
                                        <template x-if="currentTrack?.id === track.id">
                                            <span class="playing-icon"><span></span><span></span><span></span></span>
                                        </template>
                                        <template x-if="currentTrack?.id !== track.id">
                                            <i class="fa-solid fa-play"></i>
                                        </template>
                                    </button>
                                    <button class="ripple-host" @click.stop="showAddToPlaylistModal(track); addRipple($event)">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>
            </div>



            <div class="empty-state"
                 x-show="!loading && !searchResults.songs?.length && !searchResults.albums?.length && query.trim()"
                 x-cloak>
                <div class="empty-state-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                <h3>Nenhum resultado</h3>
                <p>Tente um termo diferente</p>
            </div>
        </div>

        <!-- ─── ABA: PLAYLISTS ─────────────────────────────────────── -->
        <div x-show="activeNav === 'library'" x-cloak>
            <div class="section-header">
                <h2 class="section-title">Minhas <i  style="color:var(--accent);margin:0 4px;" ></i><span>Playlists </span></h2>
                {% if user.is_authenticated %}
                <button class="section-cta ripple-host" @click="showCreatePlaylistModal = true; addRipple($event)">
                    <i class="fa-solid fa-plus"></i> Nova
                </button>
                {% else %}
                <a class="section-cta" href="{% url 'login' %}">
                    <i class="fa-solid fa-plus"></i> Nova
                </a>
                {% endif %}
            </div>

            {% if not user.is_authenticated %}
            <div class="auth-gate-banner">
                <i class="fa-solid fa-lock"></i>
                <span>Faça login para criar e gerenciar playlists</span>
                <a href="{% url 'login' %}">Entrar</a>
            </div>

            {% else %}
            <div class="playlist-list" x-show="userPlaylists.length > 0">
                <template x-for="(pl, i) in userPlaylists" :key="'upl-' + (pl.id || i)">
                    <div class="playlist-card" @click="openPlaylist(pl.id)">
                        <template x-if="pl.covers && pl.covers.some(u => u)">
                            <div class="playlist-art-grid">
                                <template x-for="(url,j) in pl.covers.slice(0,4)" :key="j">
                                    <img :src="url || '{% static 'classicacapa.jpg' %}'" loading="lazy">
                                </template>
                            </div>
                        </template>
                        <template x-if="!(pl.covers && pl.covers.some(u => u))">
                            <div class="playlist-icon">
                                <i :class="(pl.nome || '').toLowerCase().includes('curtidas') ? 'fa-solid fa-heart' : 'fa-solid fa-music'"></i>
                            </div>
                        </template>
                        <div class="playlist-info">
                            <div class="playlist-name" x-text="pl.nome"></div>
                            <div class="playlist-count" x-text="(pl.total_musicas ?? 0) + ' músicas'"></div>
                        </div>
                        <button type="button" class="btn-icon btn-danger ripple-host" @click.stop @mousedown.stop @touchstart.stop="confirmDeletePlaylist(pl); addRipple($event)" title="Excluir" aria-label="Excluir playlist">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button type="button" class="btn-icon btn-secondary ripple-host" title="Compartilhar" @click.stop="playlistShareCopy(pl); addRipple($event)">
                            <i class="fa-solid fa-link"></i>
                        </button>
                    </div>
                </template>
            </div>

            <div class="section-header" style="margin-top:24px;" x-show="openedPlaylistId && playlist.length > 0">
                <h2 class="section-title"><span x-text="openedPlaylistName || 'Playlist'"></span></h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="section-cta filled ripple-host" @click="playPlaylistAtual(); addRipple($event)">
                        <template x-if="currentQueueType === 'playlist' && openedPlaylistId">
                            <span class="playing-icon"><span></span><span></span><span></span></span>
                        </template>
                        <template x-if="!(currentQueueType === 'playlist' && openedPlaylistId)">
                            <i class="fa-solid fa-play"></i>
                        </template>
                        Tocar
                    </button>
                    <button class="section-cta ripple-host" @click.stop="confirmDeletePlaylist({ id: openedPlaylistId, nome: openedPlaylistName }); addRipple($event)"
                            x-show="userPlaylists.some(p => p.id === openedPlaylistId)">
                        <i class="fa-solid fa-trash" style="color:#ff5572;margin-right:6px"></i> Excluir
                    </button>
                </div>
            </div>
            <!-- preview grid of first four track covers when a playlist is opened -->
            <div class="opened-art-grid" x-show="openedPlaylistId && playlist.length > 0">
                <div class="playlist-art-grid" style="margin:0 16px 12px 16px;">
                    <template x-for="(t,i) in playlist.slice(0,4)" :key="i">
                        <img :src="t.thumb || t.thumbnail || t.capa || (t.youtube_id ? 'https://i.ytimg.com/vi/'+t.youtube_id+'/mqdefault.jpg' : '{% static 'classicacapa.jpg' %}')" loading="lazy">
                    </template>
                </div>
            </div>

            <div style="padding:0 16px;" x-show="openedPlaylistId && playlist.length > 0">
                <template x-for="(track, index) in playlist" :key="'q-' + (track.id ? String(track.id) : 'idx-' + index)">
                    <div class="queue-item" :class="{'now-playing': currentTrack?.id === track.id}">
                        <span class="queue-index" x-text="index + 1"></span>
                        <img :src="track.thumb || ''" class="queue-thumb" alt="">
                        <div style="min-width:0;flex:1;">
                            <div style="font-family:var(--font-display);font-size:0.88rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;letter-spacing:-0.02em;" x-text="track.title || track.titulo || track.nome || ''"></div>
                            <div style="font-size:0.72rem;color:var(--txt-2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" x-text="track.artist || track.artista_nome || track.artista || ''"></div>
                        </div>
                        <div class="queue-actions">
                            <button class="ripple-host" @click="playTrackAtIndex(index); addRipple($event)"><i class="fa-solid fa-play"></i></button>
                            <button class="ripple-host" @click="openedPlaylistId ? removeTrackFromPlaylist(openedPlaylistId, track, index) : removeFromPlaylist(index); addRipple($event)"
                                    style="color:#ff5572;">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <div class="empty-state" x-show="userPlaylists.length === 0">
                <div class="empty-state-icon" style="background:transparent;border:none;">
                    <i class="fa-solid fa-music" style="color:var(--accent);font-size:2.4rem;"></i>
                </div>
                <h3>Sem playlists ainda</h3>
                <p>Crie uma nova playlist usando o botão acima</p>
            </div>
            {% endif %}
        </div>

        <!-- ─── ABA: PERFIL ─────────────────────────────────────────── -->
        <div x-show="activeNav === 'perfil'" x-cloak>
            {% if user.is_authenticated %}
            <div class="profile-header fade-up">
                <div class="profile-avatar">{{ user.username|first|upper }}</div>
                <div class="profile-name">{{ user.username }}</div>
                <div class="profile-meta">{{ user.email }}</div>
            </div>
            <div class="profile-stats fade-up fade-up-1">
                <div class="stat-box">
                    <div class="stat-num" x-text="IS_AUTHENTICATED ? favoritosList.length : likedTracks.length"></div>
                    <div class="stat-label">Curtidas</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" x-text="userPlaylists.length"></div>
                    <div class="stat-label">Playlists</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" x-text="userPlaylists.reduce((s,p) => s + (p && p.total_musicas ? Number(p.total_musicas) : 0), 0)"></div>
                    <div class="stat-label">Total de músicas</div>
                </div>
            </div>

            <!-- Assinaturas -->
            {% if assinatura_ativa %}
            <div id="subscription-placeholder" class="profile-sub-card">
                <i class="fa fa-circle-check plan-icon"></i>
                <div class="plan-name">{{ assinatura_ativa.plano_id|default:'Plano Mensal Premium' }}</div>
                <div class="plan-end">Vigente até {{ assinatura_ativa.periodo_termina_em|date:'d/m/Y' }}</div>
            </div>
            {% else %}
            <div id="subscription-placeholder" class="profile-sub-card" style="color:var(--txt-2);">
                <i class="fa fa-circle-xmark plan-icon" style="color:#ff5572;"></i>
                <div class="plan-name">Plano inativo</div>
                <div class="plan-end">Faça upgrade em "Assinatura"</div>
            </div>
            {% endif %}

            <div style="padding:0 16px;margin-top:12px;" x-show="favoritosList && favoritosList.length">
                <!-- favorite section removed -->
            </div>

            <div class="profile-actions fade-up fade-up-2">
                <a href="{% url 'profile_edit' %}" class="profile-action-btn">
                    <i class="fa-solid fa-user-gear"></i> Editar perfil
                </a>
                <a href="{% url 'assinatura' %}" id="profile-sub-link" class="profile-action-btn">
                    <i class="fa-solid fa-ticket"></i> Assinatura
                </a>
                <div class="profile-action-btn" @click="openLibrary()">
                    <i class="fa-solid fa-list-ul"></i> Minhas playlists
                </div>
                <div class="profile-action-btn" @click="clearLocalData()">
                    <i class="fa-solid fa-broom"></i> Limpar dados locais (Melhorar Processamento)
                </div>
                <a href="{% url 'logout' %}" class="profile-action-btn danger">
                    <i class="fa-solid fa-right-from-bracket"></i> Sair
                </a>
            </div>
            {% else %}
            <div class="empty-state" style="padding-top:70px;">
                <div class="empty-state-icon"><i class="fa-solid fa-circle-user"></i></div>
                <h3>Faça login para continuar</h3>
                <p style="margin-bottom:24px;">Curtidas e playlists são exclusivas para usuários logados.</p>
                <a href="{% url 'login' %}" style="background:linear-gradient(135deg,var(--accent),var(--accent-2));color:white;border:none;border-radius:999px;padding:13px 32px;font-family:var(--font-display);font-weight:700;font-size:0.92rem;text-decoration:none;display:inline-block;box-shadow:0 6px 20px var(--accent-glow);letter-spacing:-0.02em;">
                    Entrar agora
                </a>
            </div>
            {% endif %}
        </div>

    </main>

    <!-- ═══════════════════════════════════════════════════════════════
         MINI PLAYER — UMA LINHA COMPACTA E LIMPA
    ═══════════════════════════════════════════════════════════════ -->
    <footer class="player-bar"
            x-show="currentTrack"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform translate-y-full"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform translate-y-full">

        <!-- Gesture area to open bottom sheet -->
        <div class="player-gesture-area" @click="$event.target.closest('.player-close-btn') || (bottomSheetActive = true)"></div>

        <!-- Barra de progresso clicável no topo -->
        <div class="player-progress-top" @click="seekFromBar($event)">
            <div class="player-progress-top-fill" :style="{ width: progress + '%' }"></div>
        </div>

        <!-- Linha única principal -->
        <div class="player-main-row">

            <!-- Capa + Título + Artista (clica pra abrir painel) -->
            <div class="now-playing-mini" @click.stop="bottomSheetActive = true">
                <div class="now-playing-art">
                    <img :src="currentTrack?.thumb || ''" alt="Capa">
                    <div class="playing-indicator" :class="isPlaying ? 'active' : ''"></div>
                </div>
                <div class="track-info">
                    <p class="ti-title" x-text="currentTrack?.title"></p>
                    <p class="ti-artist" x-text="currentTrack?.artist"></p>
                </div>
            </div>

            <!-- Controles: ◀ | ▶/II | ▶ -->
            <div style="display:flex;align-items:center;gap:4px;flex-shrink:0;">

                <!-- Anterior -->
                <button class="ctrl-btn skip-btn ripple-host"
                        @click.stop="previous(true); addRipple($event)"
                        title="Anterior">
                    <i class="fa-solid fa-backward-step"></i>
                </button>

                <!-- Play / Pause -->
                <button class="btn-play-main ripple-host"
                        :class="isPlaying ? 'is-playing' : ''"
                        @click.stop="if(!( !hasActivePlan && currentTime >= previewLimit )){ togglePlay(); addRipple($event); }">
                    <i :class="(!hasActivePlan && currentTime >= previewLimit)
                                ? 'fa-solid fa-lock'
                                : (isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play')"></i>
                </button>

                <!-- Próxima -->
                <button class="ctrl-btn skip-btn ripple-host"
                        @click.stop="next(true); addRipple($event)"
                        title="Próxima">
                    <i class="fa-solid fa-forward-step"></i>
                </button>


            </div>

            <!-- X — fechar player -->
            <button class="player-close-btn ripple-host"
                    @click.stop="currentTrack = null; isPlaying = false; audio && audio.pause(); bottomSheetActive = false; trackDetailOpen = false; panelOpen = false; addRipple($event)"
                    title="Fechar player">
                <i class="fa-solid fa-xmark"></i>
            </button>

        </div>
    </footer>

    <!-- ─── BOTTOM NAV ──────────────────────────────────────────────── -->
    <nav class="bottom-nav">
        <button class="nav-item" :class="{'active': activeNav === 'explorar'}" @click="activeNav === 'explorar' ? window.location.href='/' : (activeNav = 'explorar', loadExplorar())">
            <i class="fa-solid fa-compass"></i><span>Explorar</span>
        </button>
        <button class="nav-item" :class="{'active': activeNav === 'search'}" @click="activeNav = 'search'">
            <i class="fa-solid fa-magnifying-glass"></i><span>Buscar</span>
        </button>
        <button class="nav-item" :class="{'active': activeNav === 'library'}" @click="openLibrary()">
            <i class="fa-solid fa-lines-leaning"></i><span>Playlists</span>
        </button>
        <button class="nav-item" :class="{'active': activeNav === 'perfil'}" @click="activeNav = 'perfil'">
            <i class="fa-solid fa-circle-user"></i><span>Perfil</span>
        </button>
    </nav>
</div>


<!-- ─── ALBUM / RECOMENDAÇÕES PANEL ──────────────────────────────── -->
<div class="modal-overlay panel-overlay" x-show="panelOpen" x-cloak @click.self="closePanel()">
    <button class="panel-back-btn btn-icon ripple-host" @click="closePanel(); addRipple($event)" title="Voltar">
        <i class="fa-solid fa-arrow-left"></i>
    </button>

    <div class="modal panel-modal">
        <div class="modal-drag-handle"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3 style="margin:0;display:flex;align-items:center;">
                <i class="fa-solid fa-heart" style="color:var(--accent);margin-right:6px;" x-show="panelTitle === 'Curtidas'"></i>
                <span x-text="panelTitle"></span>
            </h3>
            <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn-icon ripple-host" @click.stop="confirmClearFavorites(); addRipple($event)" x-show="panelTitle === 'Curtidas' && (favoritosList && favoritosList.length)" title="Limpar curtidas">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
                <button @click="closePanel()" class="btn-icon ripple-host">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>

        <div x-show="albumData" x-cloak>
            <div class="album-modal-header">
                <img :src="albumData?.thumb" alt="">
                <div class="album-modal-info">
                    <h4 x-text="albumData?.title"></h4>
                    <p x-text="(albumData?.tracks?.length || 0) + ' faixas'"></p>
                    <button class="album-play-btn ripple-host"
                            :disabled="albumLoadingId === (albumData?.id || albumData?.browseId)"
                            @click="playAlbum(); addRipple($event)">
                        <i class="fa-solid fa-play" x-show="albumLoadingId !== (albumData?.id || albumData?.browseId)"></i>
                        <i class="fa-solid fa-spinner fa-spin" x-show="albumLoadingId === (albumData?.id || albumData?.browseId)"></i>
                        <span x-show="albumLoadingId !== (albumData?.id || albumData?.browseId)">Tocar álbum</span>
                        <span x-show="albumLoadingId === (albumData?.id || albumData?.browseId)">Aguarde…</span>
                    </button>
                </div>
            </div>

            <div>
                <template x-for="(track, idx) in (albumData?.tracks || [])" :key="'at-' + (track.id ? String(track.id) : idx)">
                    <div class="queue-item" :class="{'now-playing': currentTrack?.id === track.id}"
                         style="grid-template-columns:28px 42px 1fr auto;cursor:pointer;"
                         @click="playAlbumTrack(idx)">
                        <span class="queue-index" style="width:26px;height:26px;font-size:0.7rem;" x-text="idx + 1"></span>
                        <img :src="track.thumb || albumData?.thumb" class="queue-thumb" alt="">
                        <div style="min-width:0;">
                            <div style="font-family:var(--font-display);font-size:0.85rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;letter-spacing:-0.02em;" x-text="track.title"></div>
                            <div style="font-size:0.72rem;color:var(--txt-2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" x-text="track.artist"></div>
                        </div>
                        <div class="queue-actions">
                            <button class="ripple-host" @click.stop="playAlbumTrack(idx); addRipple($event)">
                                <template x-if="currentTrack?.id === track.id">
                                    <span class="playing-icon"><span></span><span></span><span></span></span>
                                </template>
                                <template x-if="currentTrack?.id !== track.id">
                                    <i class="fa-solid fa-play" x-show="!(albumLoadingId && albumTrackLoadingIndex === idx)"></i>
                                </template>
                                <i class="fa-solid fa-spinner fa-spin" x-show="albumLoadingId && albumTrackLoadingIndex === idx"></i>
                            </button>
                            <button class="ripple-host" @click.stop="addAlbumTrackToPlaylist(idx); addRipple($event)">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div x-html="panelContent" x-show="!albumData"></div>
    </div>
</div>

<!-- ─── MODAL: ADICIONAR À PLAYLIST ─────────────────────────────── -->
<div x-show="showPlaylistModal" class="modal-overlay" x-cloak @click.self="showPlaylistModal = false; showInlineCreate = false;">
    <div class="modal">
        <div class="modal-drag-handle"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <h3 style="margin:0;">Salvar em Playlist</h3>
            <button @click="showPlaylistModal=false; showInlineCreate=false;" class="btn-icon ripple-host">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div x-show="selectedTrackForPlaylist"
             style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:14px;">
            <img :src="selectedTrackForPlaylist?.thumb || ''"
                 style="width:42px;height:42px;border-radius:8px;object-fit:cover;flex-shrink:0;" alt="">
            <div style="min-width:0;flex:1;">
                <div style="font-family:var(--font-display);font-weight:700;font-size:0.88rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                     x-text="selectedTrackForPlaylist?.title"></div>
                <div style="font-size:0.72rem;color:var(--txt-2);" x-text="selectedTrackForPlaylist?.artist"></div>
            </div>
        </div>

        <template x-if="!showInlineCreate">
            <div class="create-pl-inline" @click="showInlineCreate = true">
                <div class="pl-icon"><i class="fa-solid fa-plus"></i></div>
                <div><div class="pl-name">Nova playlist</div></div>
            </div>
        </template>

        <template x-if="showInlineCreate">
            <div class="new-pl-form">
                <div class="form-title"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>Nova playlist</div>
                <input type="text" x-model="newPlaylistName" placeholder="Nome da playlist" class="modal-input"
                       @keyup.enter="createPlaylistAndAdd()" x-ref="newPlaylistInput"
                       x-init="$nextTick(() => $refs.newPlaylistInput?.focus())">
                <textarea x-model="newPlaylistDescription" placeholder="Descrição (opcional)" class="modal-input" rows="2"></textarea>
                <div style="display:flex;gap:8px;">
                    <button class="modal-btn primary" style="flex:1;" @click="createPlaylistAndAdd()" :disabled="!newPlaylistName.trim()">
                        <i class="fa-solid fa-check"></i> Criar e adicionar
                    </button>
                    <button class="modal-btn secondary" style="flex:none;padding:14px 18px;" @click="showInlineCreate=false">Cancelar</button>
                </div>
            </div>
        </template>

        <div x-show="(userPlaylists || []).length > 0">
            <p style="font-size:0.72rem;color:var(--txt-2);font-weight:600;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:10px;">Suas playlists</p>
            <input type="text" x-model="playlistFilter" placeholder="Filtrar playlists…"
                   style="width:100%;padding:8px 12px;margin-bottom:12px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);color:var(--txt-1);font-size:0.9rem;">
            <template x-for="(pl, i) in (userPlaylists || []).filter(p => !playlistFilter.trim() || (p.nome || '').toLowerCase().includes(playlistFilter.toLowerCase()))" :key="'mpl-' + (pl && pl.id ? pl.id : i)">
                <div class="playlist-option">
                    <div class="pl-main" :class="{ 'adding': addingPlaylistId === pl.id }" @click="addToPlaylist(pl.id)" style="display:flex;align-items:center;gap:14px;flex:1;cursor:pointer;">
                        <template x-if="pl.covers && pl.covers.some(u => u)">
                                <div class="playlist-art-grid" style="width:40px;height:40px;">
                                    <template x-for="(url,j) in pl.covers.slice(0,4)" :key="j">
                                        <img :src="url || '{% static 'classicacapa.jpg' %}'" loading="lazy">
                                    </template>
                                </div>
                            </template>
                            <template x-if="!(pl.covers && pl.covers.some(u => u))">
                                <div class="pl-icon"><i class="fa-solid fa-music"></i></div>
                            </template>
                        <div class="pl-info">
                            <div class="pl-name" x-text="pl.nome"></div>
                            <div class="pl-count" x-text="(pl.total_musicas ?? 0) + ' músicas'"></div>
                        </div>
                        <template x-if="addingPlaylistId === pl.id">
                            <div class="pl-spinner" style="margin-left:auto;">
                                <i class="fa-solid fa-spinner fa-spin" style="color:var(--accent);"></i>
                            </div>
                        </template>
                    </div>
                    <div class="pl-actions" style="display:flex;gap:8px;align-items:center;margin-left:8px;">
                        <button type="button" class="btn-icon btn-secondary ripple-host" @click.stop="addToPlaylist(pl.id); addRipple($event)">
                            <i class="fa-solid fa-plus" style="color:var(--accent);font-size:0.85rem"></i>
                        </button>
                        <button type="button" class="btn-icon btn-danger ripple-host" @click.stop @mousedown.stop @touchstart.stop="confirmDeletePlaylist(pl); addRipple($event)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button type="button" class="btn-icon btn-secondary ripple-host" title="Compartilhar" @click.stop="playlistShareCopy(pl); addRipple($event)">
                            <i class="fa-solid fa-link"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <div class="empty-state" x-show="userPlaylists.length === 0 && !showInlineCreate">
            <div class="empty-state-icon" style="background:transparent;border:none;">
                <i class="fa-solid fa-music" style="font-size:2.4rem;color:var(--accent);"></i>
            </div>
            <div>Nenhuma playlist ainda. Crie a primeira acima!</div>
        </div>
    </div>
</div>

<!-- ─── MODAL: CRIAR PLAYLIST ────────────────────────────────────── -->
<div x-show="showCreatePlaylistModal" class="modal-overlay" x-cloak @click.self="showCreatePlaylistModal = false">
    <div class="modal">
        <div class="modal-drag-handle"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;">Nova Playlist</h3>
            <button @click="showCreatePlaylistModal=false" class="btn-icon ripple-host">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <input type="text" x-model="newPlaylistName" placeholder="Nome da playlist" class="modal-input" @keyup.enter="createPlaylist()">
        <textarea x-model="newPlaylistDescription" placeholder="Descrição (opcional)" class="modal-input" rows="3"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn primary ripple-host" @click="createPlaylist(); addRipple($event)" :disabled="!newPlaylistName.trim()">
                <i class="fa-solid fa-check"></i> Criar
            </button>
            <button class="modal-btn secondary" @click="showCreatePlaylistModal = false">Cancelar</button>
        </div>
    </div>
</div>

<!-- ─── CONFIRMATION MODAL ───────────── -->
<div x-show="confirmModalVisible" class="modal-overlay" x-cloak @keydown.escape.window="closeConfirmModal()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-modal-title">
        <div class="modal-drag-handle"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 id="confirm-modal-title" style="margin:0;" x-text="confirmModalTitle || 'Confirmar'"></h3>
            <button @click="closeConfirmModal()" class="btn-icon ripple-host" aria-label="Fechar">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div style="margin-bottom:16px;color:var(--txt-2);white-space:pre-wrap;" x-text="confirmModalMessage"></div>
        <div class="modal-buttons">
            <button class="modal-btn primary ripple-host" @click="confirmModalConfirm(); addRipple($event)">
                <i class="fa-solid fa-check"></i> Confirmar
            </button>
            <button class="modal-btn secondary" @click="closeConfirmModal()">Cancelar</button>
        </div>
    </div>
</div>

<!-- ─── SHARE OPTIONS MODAL ───────────── -->
<div x-show="shareModalVisible" class="modal-overlay" x-cloak @keydown.escape.window="shareModalVisible=false" @click.self="shareModalVisible=false">
    <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-drag-handle"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0;">Compartilhar</h3>
            <button @click="shareModalVisible=false" class="btn-icon ripple-host" aria-label="Fechar">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div style="margin:16px 0;text-align:center;">
            <p x-text="shareModalTitle"></p>
        </div>
        <div class="modal-buttons" style="justify-content:center;flex-wrap:wrap;gap:16px;">
            <a class="modal-btn secondary" href="#" target="_blank"
               x-bind:href="'https://api.whatsapp.com/send?text=' + encodeURIComponent(shareModalTitle + ' ' + shareModalUrl)">
                <i class="fa-brands fa-whatsapp"></i> WhatsApp
            </a>
            <a class="modal-btn secondary" href="#" target="_blank"
               x-bind:href="'https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareModalTitle) + '&url=' + encodeURIComponent(shareModalUrl)">
                <i class="fa-brands fa-twitter"></i> Twitter
            </a>
            <a class="modal-btn secondary" href="#" target="_blank"
               x-bind:href="'https://www.instagram.com/?url=' + encodeURIComponent(shareModalUrl)">
                <i class="fa-brands fa-instagram"></i> Instagram
            </a>
            <button class="modal-btn secondary" @click="navigator.clipboard.writeText(shareModalUrl); showNotification('Link copiado para a área de transferência','success'); shareModalVisible=false;">
                <i class="fa-solid fa-copy"></i> Copiar link
            </button>
        </div>
    </div>
</div>

<!-- ─── TOAST NOTIFICATION ──────────────────────────────────────── -->
<div class="notification" :class="notification.type"
     x-show="notification.show"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 transform translate-y-4"
     x-transition:enter-end="opacity-100 transform translate-y-0"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     x-cloak>
    <span x-html="notification.message"></span>
</div>

<audio id="main-audio" preload="auto"
       @timeupdate="updateProgress"
       @loadedmetadata="updateMetadata"
       @ended="next()"
       @waiting="showNotification('Bufferizando…','info')"
       @playing="hideNotification()"
       @error="handleAudioError"></audio>

{{ musicas_list|default:'[]'|json_script:"ds-musicas-list" }}
{{ featured|default:'{}'|json_script:"ds-featured" }}
{{ results|default:'[]'|json_script:"ds-results" }}
{{ albums|default:'[]'|json_script:"ds-albums" }}
{{ explorar_default|default:'{}'|json_script:"ds-explorar-default" }}
{{ playlists_usuario|default:'[]'|json_script:"ds-playlists" }}
{{ favoritos_usuario|default:'[]'|json_script:"ds-favoritos" }}

<script>
    // ═══════════════════════════════════════════════════════════════
    // ASYNC CACHE LAYER
    // ═══════════════════════════════════════════════════════════════

    const CACHE_TTL = {
        search:    1000 * 60 * 10,
        album:     1000 * 60 * 30,
        explorar:  1000 * 60 * 15,
        genre:     1000 * 60 * 15,
        recs:      1000 * 60 * 20,
        streaming: 1000 * 60 * 45,
        playlist:  1000 * 60 * 5,
        state:     Infinity
    };

    const AppCache = {
        _mem: {},
        _key(ns, k) { return `mdy_${ns}_${encodeURIComponent(String(k || ''))}`.slice(0, 200); },
        get(ns, k) {
            const key = this._key(ns, k);
            const ttl = CACHE_TTL[ns];
            if (this._mem[key]) {
                if (ttl === Infinity || Date.now() - this._mem[key].ts < ttl) return this._mem[key].data;
                delete this._mem[key];
            }
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return null;
                const obj = JSON.parse(raw);
                if (ttl !== Infinity && Date.now() - obj.ts > ttl) { localStorage.removeItem(key); return null; }
                this._mem[key] = obj;
                return obj.data;
            } catch(e) { return null; }
        },
        set(ns, k, data) {
            const key = this._key(ns, k);
            const obj = { ts: Date.now(), data };
            this._mem[key] = obj;
            try {
                localStorage.setItem(key, JSON.stringify(obj));
            } catch(e) {
                this._evict(ns);
                try { localStorage.setItem(key, JSON.stringify(obj)); } catch(e2) {}
            }
        },
        del(ns, k) {
            const key = this._key(ns, k);
            delete this._mem[key];
            try { localStorage.removeItem(key); } catch(e) {}
        },
        _evict(ns) {
            const prefix = `mdy_${ns}_`;
            const candidates = [];
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k && k.startsWith(prefix)) {
                    try { const obj = JSON.parse(localStorage.getItem(k)); candidates.push({ k, ts: obj.ts || 0 }); }
                    catch(e) { candidates.push({ k, ts: 0 }); }
                }
            }
            candidates.sort((a, b) => a.ts - b.ts).slice(0, 5).forEach(c => localStorage.removeItem(c.k));
        },
        savePlayerState(state) { this.set('state', 'player', state); },
        loadPlayerState() { return this.get('state', 'player'); }
    };

    const InFlight = {
        _map: {},
        get(key) { return this._map[key] || null; },
        set(key, promise) {
            this._map[key] = promise;
            promise.finally(() => { delete this._map[key]; });
            return promise;
        }
    };

    async function cachedFetch(url, ns, cacheKey, opts = {}) {
        const cached = AppCache.get(ns, cacheKey);
        if (cached !== null) {
            if (!opts.noBackground) queueMicrotask(() => silentFetch(url, ns, cacheKey, opts).catch(() => {}));
            return { data: cached, fromCache: true };
        }
        const data = await silentFetch(url, ns, cacheKey, opts);
        return { data, fromCache: false };
    }

    async function silentFetch(url, ns, cacheKey, opts = {}, retries = 2) {
        const ifKey = `${ns}:${cacheKey}`;
        const inflight = InFlight.get(ifKey);
        if (inflight) return inflight;
        const p = (async () => {
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    const r = await fetch(url, { credentials: 'same-origin', ...(opts.fetchOpts || {}) });
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    const data = await r.json();
                    AppCache.set(ns, cacheKey, data);
                    return data;
                } catch(e) {
                    if (attempt === retries) throw e;
                    await new Promise(res => setTimeout(res, 400 * Math.pow(2, attempt)));
                }
            }
        })();
        return InFlight.set(ifKey, p);
    }

    // ═══════════════════════════════════════════════════════════════
    // BOOTSTRAP DATA
    // ═══════════════════════════════════════════════════════════════
    function _ds(id, fallback) {
        try {
            const el = document.getElementById(id);
            if (!el) return fallback;
            const raw = el.textContent;
            if (!raw || raw === 'null' || raw.trim() === '') return fallback;
            return JSON.parse(raw);
        } catch(e) { console.error('_ds error', id, e); return fallback; }
    }

    const MUSICAS_LIST = _ds('ds-musicas-list', []);
    const FEATURED     = _ds('ds-featured', {});

    const SEARCH_RESULTS = {
        songs:  Array.isArray(_ds('ds-results', [])) ? _ds('ds-results', []) : [],
        albums: Array.isArray(_ds('ds-albums', []))  ? _ds('ds-albums', [])  : []
    };

    const USER_PLAYLISTS = (() => {
        const d = _ds('ds-playlists', []);
        return Array.isArray(d) ? d : [];
    })();

    const USER_FAVORITES = (() => {
        const d = _ds('ds-favoritos', []);
        return Array.isArray(d) ? d : [];
    })();

    const IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};
    const REGISTER_URL = '{% url "register" %}';

    // ═══════════════════════════════════════════════════════════════
    // UTILITIES
    // ═══════════════════════════════════════════════════════════════
    function resolveArtist(t, fallback = 'Artista desconhecido') {
        if (t.artista_nome) return t.artista_nome;
        if (t.artist && typeof t.artist === 'string') return t.artist;
        if (t.artista && typeof t.artista === 'string') return t.artista;
        if (t.artist != null && typeof t.artist !== 'string') return String(t.artist);
        if (t.artista != null && typeof t.artista !== 'string') return String(t.artista);
        const r = t.artists;
        if (!r) return fallback;
        if (Array.isArray(r)) return r.map(a => (typeof a === 'object' ? a.name : a) || '').filter(Boolean).join(', ');
        if (typeof r === 'string') return r;
        return fallback;
    }

    function normalizeTrack(t) {
        if (!t || typeof t !== 'object') return null;
        const ytId = t.youtube_id || t.videoId || t.video_id ||
            (t.id && typeof t.id === 'string' && /^[A-Za-z0-9_-]{11}$/.test(t.id) ? t.id : null);
        const rawId = t.id != null ? t.id : null;
        const canonicalId = ytId || (rawId != null ? String(rawId) : null);
        if (!canonicalId) return null;
        const baseAudio = t.audio_url || t.stream_url || '';
        const fallbackAudio = ytId ? '/api/streaming-url/?video_id=' + encodeURIComponent(ytId) : '';
        const finalAudio = baseAudio || fallbackAudio;
        return {
            id:         canonicalId,
            youtube_id: ytId || '',
            title:      t.title || t.titulo || t.nome || t.name || 'Sem título',
            artist:     resolveArtist(t),
            thumb:      t.thumb || t.thumbnail || t.capa || '',
            audio_url:  finalAudio,
            arquivo:    t.arquivo || '',
            album:      (typeof t.album === 'string' ? t.album : '') || '',
            albumId:    t.album_browseId || t.albumId || t.album_id || t.browseId || '',
        };
    }

    const QUEUE_LABELS = {
        explorar: 'Explorar', genre: 'Gênero', search: 'Busca',
        album: 'Álbum', playlist: 'Playlist', favorite: 'Curtidas', single: ''
    };

    const GENEROS = [
        { slug:'pop',        name:'Pop',        emoji:'✨', gradient:'linear-gradient(135deg,#ec4899,#f97316)', image: '{% static "popcapa.jpg" %}',       json_url: '{% static "genres/pop.json" %}' },
        { slug:'rock',       name:'Rock',       emoji:'🎸', gradient:'linear-gradient(135deg,#1f2937,#dc2626)', image: '{% static "rock_capa.jpg" %}',       json_url: '{% static "genres/rock.json" %}' },
        { slug:'sertanejo',  name:'Sertanejo',  emoji:'🤠', gradient:'linear-gradient(135deg,#d97706,#b45309)', image: '{% static "sertanejocapa.jpg" %}',   json_url: '{% static "genres/sertanejo.json" %}' },
        { slug:'funk',       name:'Funk',       emoji:'🔥', gradient:'linear-gradient(135deg,#16a34a,#15803d)', image: '{% static "funkcapa.jpg" %}',         json_url: '{% static "genres/funk.json" %}' },
        { slug:'jazz',       name:'Jazz',       emoji:'🎷', gradient:'linear-gradient(135deg,#1d4ed8,#1e3a8a)', image: '{% static "jazzcapa.jpg" %}',         json_url: '{% static "genres/jazz.json" %}' },
        { slug:'eletrônico', name:'Eletrônico', emoji:'⚡', gradient:'linear-gradient(135deg,#0ea5e9,#7c3aed)', image: '{% static "eletrocapa.jpg" %}',       json_url: '{% static "genres/eletronico.json" %}' },
        { slug:'r&b',        name:'R&B / Soul', emoji:'🎤', gradient:'linear-gradient(135deg,#7c3aed,#db2777)', image: '{% static "rbcapa.jpg" %}',           json_url: '{% static "genres/rb.json" %}' },
        { slug:'pagode',     name:'Pagode',     emoji:'🥁', gradient:'linear-gradient(135deg,#ea580c,#c2410c)', image: '{% static "pagode.jpg" %}',           json_url: '{% static "genres/pagode.json" %}' },
        { slug:'hip-hop',    name:'Hip-Hop',    emoji:'🎧', gradient:'linear-gradient(135deg,#374151,#111827)', image: '{% static "hiphop.jpg" %}',           json_url: '{% static "genres/hip-hop.json" %}' },
        { slug:'mpb',        name:'MPB',        emoji:'🌿', gradient:'linear-gradient(135deg,#059669,#047857)', image: '{% static "mpb.jpg" %}',             json_url: '{% static "genres/mpb.json" %}' },
        { slug:'clássico',   name:'Clássico',   emoji:'🎻', gradient:'linear-gradient(135deg,#92400e,#78350f)', image: '{% static "classicacapa.jpg" %}',    json_url: '{% static "genres/classico.json" %}' },
        { slug:'gospel',     name:'Gospel',     emoji:'🙏', gradient:'linear-gradient(135deg,#6d28d9,#4c1d95)', image: '{% static "gospel.jpg" %}',          json_url: '{% static "genres/gospel.json" %}' },
    ];

    // ═══════════════════════════════════════════════════════════════
    // ALPINE APP
    // ═══════════════════════════════════════════════════════════════
    function app() {
        return {
            query:         new URLSearchParams(window.location.search).get('q') || '',
            hasQuery:      !!new URLSearchParams(window.location.search).get('q'),
            loading:       false,

            hasActivePlan: {{ assinatura_ativa|yesno:"true,false" }},
            _previewWarned: false,
            previewLimit: 30,
            searchCached:  false,
            recommendationsLoading: false,
            albumLoadingId: null,
            albumTrackLoadingIndex: -1,
            musicasList:   MUSICAS_LIST,
            featured:      FEATURED,
            searchResults: SEARCH_RESULTS,

            // Gesture and UI state
            gestureFeedback: { show: false, text: '' },
            bottomSheetActive: false,
            sheetDragging: false,
            sheetStartY: 0,
            sheetCurrentY: 0,
            queueDrawerActive: false,
            ptrActive: false,
            ptrOffset: 0,
            ptrStartY: 0,

            audio: null,
            playlist: [],
            currentTrack: null,
            currentTrackIndex: -1,
            isPlaying: false,
            currentTime: 0,
            duration: 0,
            progress: 0,
            volume: 100,
            shuffle: false,
            repeatMode: 'off', // 'off', 'once', 'one'

            currentQueue: [],
            currentQueueType: 'playlist',
            currentQueueIndex: -1,

            get currentQueueLabel() {
                if (this.currentQueueType === 'playlist') {
                    if (this.openedPlaylistName) return this.openedPlaylistName;
                    return 'Últimas tocadas';
                }
                if (this.currentQueueType === 'album' && this.albumData?.title) return this.albumData.title;
                return QUEUE_LABELS[this.currentQueueType] || '';
            },

            // ─── GETTERS PARA REPEAT ──────────────────────────────────
            get repeatModeClass() {
                if (this.repeatMode === 'one')  return 'repeat-one';
                if (this.repeatMode === 'once') return 'repeat-once';
                return 'repeat-off';
            },

            get repeatIcon() {
                if (this.repeatMode === 'one') return 'fa-solid fa-repeat';
                return 'fa-solid fa-repeat';
            },

            get repeatTitle() {
                if (this.repeatMode === 'off')  return 'Repetição: desligada';
                if (this.repeatMode === 'once') return 'Repetir 1 vez';
                return 'Repetir continuamente';
            },

            // ─── GESTURE HANDLERS ─────────────────────────────────────
            sheetTouchStart(e) {
                if (e.touches[0].clientY < 100) return;
                this.sheetDragging = true;
                this.sheetStartY = e.touches[0].clientY;
                this.$refs.bottomSheet.style.transition = 'none';
            },

            sheetTouchMove(e) {
                if (!this.sheetDragging) return;
                const deltaY = e.touches[0].clientY - this.sheetStartY;
                if (deltaY > 0) {
                    this.sheetCurrentY = deltaY;
                    this.$refs.bottomSheet.style.transform = `translateY(${deltaY}px)`;
                }
            },

            sheetTouchEnd() {
                if (!this.sheetDragging) return;
                this.sheetDragging = false;
                this.$refs.bottomSheet.style.transition = '';
                this.$refs.bottomSheet.style.transform = '';
                if (this.sheetCurrentY > 150) {
                    this.bottomSheetActive = false;
                }
                this.sheetCurrentY = 0;
            },

            handleScroll(e) {
                const scrollTop = this.$refs.mainScroll.scrollTop;
                if (scrollTop <= 0 && !this.ptrActive) {
                    this.ptrStartY = e.touches ? e.touches[0].clientY : 0;
                }
            },

            // Swipe to refresh (simplified)
            initPullToRefresh() {
                const el = this.$refs.mainScroll;
                let touchStart = 0;
                el.addEventListener('touchstart', (e) => {
                    if (el.scrollTop <= 0) {
                        touchStart = e.touches[0].clientY;
                    }
                }, { passive: true });
                
                el.addEventListener('touchmove', (e) => {
                    if (touchStart > 0 && el.scrollTop <= 0) {
                        const delta = e.touches[0].clientY - touchStart;
                        if (delta > 0 && delta < 100) {
                            this.ptrActive = true;
                            this.ptrOffset = delta * 0.5;
                        }
                    }
                }, { passive: true });

                el.addEventListener('touchend', () => {
                    if (this.ptrActive) {
                        if (this.ptrOffset > 40) {
                            this.refreshCurrentTab();
                            this.showGestureFeedback('Atualizando...');
                        }
                        this.ptrActive = false;
                        this.ptrOffset = 0;
                    }
                    touchStart = 0;
                });
            },

            showGestureFeedback(text) {
                this.gestureFeedback = { show: true, text };
                setTimeout(() => {
                    this.gestureFeedback.show = false;
                }, 1000);
            },

            refreshCurrentTab() {
                if (this.activeNav === 'explorar') {
                    this.loadExplorar(true);
                } else if (this.activeNav === 'search') {
                    this.search(this.query);
                } else if (this.activeNav === 'library') {
                    this.openLibrary(true);
                }
                this.showNotification('Conteúdo atualizado', 'success');
            },

            closeAllDrawers() {
                this.queueDrawerActive = false;
                this.panelOpen = false;
                this.bottomSheetActive = false;
            },

            playFromQueue(index) {
                if (index >= 0 && index < this.currentQueue.length) {
                    this.selectTrack(this.currentQueue[index], index, this.currentQueue, this.currentQueueType);
                }
            },

            initSwiper(el) {
                if (!el || el.swiper) return;
                new Swiper(el, {
                    slidesPerView: 'auto',
                    spaceBetween: 10,
                    freeMode: true,
                    grabCursor: true,
                    touchRatio: 1.5,
                });
            },

            async _resolveStreamUrl(track) {
                if (!track) return null;
                if (track.arquivo && track.arquivo.startsWith('/media/')) return track.arquivo;
                let au = track.audio_url;
                if (au) {
                    if (au.startsWith('http') && au.indexOf('/api/') === -1) return au;
                    if (au.startsWith('/api/streaming-url') || au.startsWith('/api/stream/url')) {
                        try {
                            const r = await fetch(au, { credentials: 'same-origin' });
                            if (r.ok) {
                                const d = await r.json();
                                if (d && d.stream_url) return d.stream_url;
                            }
                        } catch (e) { console.warn('resolveStreamUrl fetch error', e); }
                    }
                }
                const vid = track.youtube_id ||
                    (track.id && /^[A-Za-z0-9_-]{11}$/.test(String(track.id)) ? String(track.id) : null);
                if (vid) {
                    const fetchUrl = '/api/streaming-url/?video_id=' + encodeURIComponent(vid);
                    try {
                        const r = await fetch(fetchUrl, { credentials: 'same-origin' });
                        if (r.ok) {
                            const d = await r.json();
                            if (d && d.stream_url) return d.stream_url;
                        }
                    } catch (e) { console.warn('resolveStreamUrl fetch error', e); }
                }
                return null;
            },

            activeNav: 'explorar',
            trackDetailOpen: false,
            trackDetail: {},
            panelOpen: false,
            panelTitle: '',
            panelContent: '',

            userPlaylists: USER_PLAYLISTS,
            showPlaylistModal: false,
            showCreatePlaylistModal: false,
            showInlineCreate: false,
            newPlaylistName: '',
            newPlaylistDescription: '',
            selectedTrackForPlaylist: null,
            openedPlaylistId: null,
            openedPlaylistName: null,
            playlistFilter: '',
            addingPlaylistId: null,

            confirmModalVisible: false,
            confirmModalTitle: '',
            confirmModalMessage: '',
            confirmModalAction: null,
            confirmModalPayload: null,

            shareModalVisible: false,
            shareModalUrl: '',
            shareModalTitle: '',
            shareModalText: '',

            likedTracks: [],
            favoritosList: [],
            albumData: null,

            notification: { show: false, message: '', type: 'info' },

            generos: GENEROS,
            explorarLoading: false,
            explorarTracks: (() => {
                let raw = JSON.parse(document.getElementById('ds-explorar-default')?.textContent || '[]') || [];
                if (raw && typeof raw === 'object' && !Array.isArray(raw)) {
                    try { raw = Object.values(raw).flat(); } catch(e) { raw = []; }
                }
                return raw;
            })(),
            genreResults: {},
            activeGenre: null,
            sharedPlaylist: null,
            showSharedPanel: false,

            // ─── RIPPLE EFFECT ─────────────────────────────────────────
            addRipple(event) {
                const btn = event.currentTarget;
                if (!btn || !btn.classList.contains('ripple-host')) return;
                const rect = btn.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height) * 2;
                const x = (event.clientX || rect.left + rect.width / 2) - rect.left - size / 2;
                const y = (event.clientY || rect.top + rect.height / 2) - rect.top - size / 2;
                const ripple = document.createElement('span');
                ripple.classList.add('ripple-wave');
                ripple.style.cssText = `width:${size}px;height:${size}px;left:${x}px;top:${y}px;`;
                btn.appendChild(ripple);
                ripple.addEventListener('animationend', () => ripple.remove());
            },

            // ─── INIT ─────────────────────────────────────────────────
            init() {
                this.audio = document.getElementById('main-audio');
                this.audio.volume = 1;
                this.loadLikedTracks();
                this._restorePlayerState();
                this._initFavoritos();

                // if url contains openAlbumId param, open that album right away
                const urlParams = new URLSearchParams(window.location.search);
                const openId = urlParams.get('openAlbumId');
                if (openId) {
                    // album panel will fetch data itself
                    this.openAlbum(openId, '', '', 0);
                }

                if (this.hasQuery) { this.activeNav = 'search'; this.search(this.query); }
                else { this.loadExplorar(); }
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    document.body.style.height = window.innerHeight + 'px';
                }
                setInterval(() => { this._savePlayerState(); }, 5000);
                window.appStore = this;

                // set up media session action handlers so controls work with screen off
                if ('mediaSession' in navigator) {
                    try {
                        navigator.mediaSession.setActionHandler('play', () => { this.togglePlay(); });
                        navigator.mediaSession.setActionHandler('pause', () => { this.togglePlay(); });
                        navigator.mediaSession.setActionHandler('previoustrack', () => { this.previous(); });
                        navigator.mediaSession.setActionHandler('nexttrack', () => { this.next(); });
                        navigator.mediaSession.setActionHandler('stop', () => { this.audio.pause(); this.isPlaying = false; if (navigator.mediaSession) navigator.mediaSession.playbackState = 'paused'; });
                        navigator.mediaSession.setActionHandler('seekbackward', (details) => { this.audio.currentTime = Math.max(0, this.audio.currentTime - (details.seekOffset || 10)); });
                        navigator.mediaSession.setActionHandler('seekforward', (details) => { this.audio.currentTime = Math.min(this.audio.duration || 0, this.audio.currentTime + (details.seekOffset || 10)); });
                    } catch(e) {
                        console.warn('MediaSession handler setup failed', e);
                    }
                }

                // keep overlay visible while navigation occurs


                // Update browser title when track changes
                this.$watch('currentTrack', (val) => {
                    document.title = val ? ( (val.title || '') + (val.artist ? ' - ' + val.artist : '') ) : 'Beatflow';
                    // update lock‑screen / notification metadata via MediaSession API
                    if ('mediaSession' in navigator) {
                        if (val) {
                            navigator.mediaSession.metadata = new MediaMetadata({
                                title: val.title || '',
                                artist: val.artist || '',
                                album: val.album || '',
                                artwork: [
                                    { src: val.thumb || '/static/icones.ico', sizes: '512x512', type: 'image/png' }
                                ]
                            });
                        } else {
                            navigator.mediaSession.metadata = null;
                        }
                        navigator.mediaSession.playbackState = this.isPlaying ? 'playing' : 'paused';
                    }
                });

                // Receive shared playlist from the public share page
                const _handleSharedPlaylist = (payload) => {
                    try {
                        let tracks = [];
                        let startIndex = 0;
                        if (!payload) return;
                        if (Array.isArray(payload)) tracks = payload;
                        else if (payload.tracks && Array.isArray(payload.tracks)) {
                            tracks = payload.tracks;
                            if (typeof payload.startIndex === 'number') startIndex = payload.startIndex;
                        } else return;

                        const q = tracks.map(t => normalizeTrack(t)).filter(Boolean);
                        if (!q || q.length === 0) return;
                        this.currentQueue = q.slice();
                        this.currentQueueType = 'shared';
                        this.currentQueueIndex = (startIndex >= 0 && startIndex < q.length) ? startIndex : 0;
                        this.playlist = q.slice();
                        this.currentTrack = q[this.currentQueueIndex] || q[0];
                        this.currentTrackIndex = this.currentQueueIndex;
                        this.trackDetail = this.currentTrack;
                        this._savePlayerState();
                        this.sharedPlaylist = { name: payload.nome || 'Playlist compartilhada', id: payload.id || null, tracks: q, owner: payload.owner || payload.usuario || null };
                        this.activeNav = 'explorar';
                        this.showSharedPanel = true;
                        if (typeof this.selectTrack === 'function') {
                            const p = this.selectTrack(q[this.currentQueueIndex], this.currentQueueIndex, q, 'shared');
                            if (p && typeof p.catch === 'function') {
                                p.catch(err => {
                                    console.warn('autoplay blocked or play error', err);
                                    this.isPlaying = false;
                                    this.showNotification('A reprodução automática foi bloqueada. Clique em play para iniciar.', 'info');
                                });
                            }
                        }
                    } catch(err) { console.error('handleSharedPlaylist error', err); }
                };

                const _msgListener = (e) => {
                    try { if (e.origin !== window.location.origin) return; } catch(_) {}
                    const d = e.data;
                    if (!d) return;
                    if (d.type === 'beatflow_playPlaylist') {
                        _handleSharedPlaylist(d);
                    } else if (d.tracks) {
                        _handleSharedPlaylist(d);
                    }
                };

                const _storageListener = (e) => {
                    if (e.key === 'beatflow_shared_playlist') {
                        if (!e.newValue) return;
                        try {
                            const payload = JSON.parse(e.newValue);
                            if (payload) _handleSharedPlaylist(payload);
                            localStorage.removeItem('beatflow_shared_playlist');
                        } catch(err) { console.error('storage shared playlist parse error', err); }
                    } else if (e.key === 'beatflow_shared_track') {
                        if (!e.newValue) return;
                        try {
                            const t = JSON.parse(e.newValue);
                            if (t) {
                                this.selectTrack(t, 0, [t], 'shared');
                                this.trackDetailOpen = true;
                            }
                            localStorage.removeItem('beatflow_shared_track');
                        } catch(err) { console.error('storage shared track parse error', err); }
                    }
                };

                window.addEventListener('message', _msgListener);
                window.addEventListener('storage', _storageListener);

                try {
                    let pending = localStorage.getItem('beatflow_shared_playlist');
                    if (pending) {
                        const payload = JSON.parse(pending);
                        if (payload) _handleSharedPlaylist(payload);
                        localStorage.removeItem('beatflow_shared_playlist');
                    }
                    pending = localStorage.getItem('beatflow_shared_track');
                    if (pending) {
                        const t = JSON.parse(pending);
                        if (t) {
                            this.selectTrack(t, 0, [t], 'shared');
                            this.trackDetailOpen = true;
                        }
                        localStorage.removeItem('beatflow_shared_track');
                    }
                } catch(_) {}

                // Initialize gesture handlers
                this.$nextTick(() => {
                    this.initPullToRefresh();
                });
            },

            // ─── PERSISTÊNCIA DE ESTADO ────────────────────────────────
            _savePlayerState() {
                if (!this.currentTrack) return;
                AppCache.savePlayerState({
                    currentTrack:      this.currentTrack,
                    trackDetail:       this.trackDetail,
                    currentQueue:      this.currentQueue,
                    currentQueueType:  this.currentQueueType,
                    currentQueueIndex: this.currentQueueIndex,
                    playlist:          this.playlist,
                    volume:            this.volume,
                    currentTime:       this.audio?.currentTime || 0,
                    shuffle:           this.shuffle,
                    repeatMode:        this.repeatMode,
                });
            },

            _restorePlayerState() {
                try {
                    const s = AppCache.loadPlayerState();
                    if (!s || !s.currentTrack) { this.loadPlaylist(); return; }
                    this.playlist          = (s.playlist || []).map(t => normalizeTrack(t)).filter(Boolean);
                    this.currentTrack      = normalizeTrack(s.currentTrack);
                    this.trackDetail       = this.currentTrack;
                    this.currentQueue      = (s.currentQueue || []).map(t => normalizeTrack(t)).filter(Boolean);
                    this.currentQueueType  = s.currentQueueType || 'playlist';
                    this.currentQueueIndex = s.currentQueueIndex || 0;
                    this.openedPlaylistId = null;
                    this.openedPlaylistName = null;
                    this.volume            = 100;
                    this.shuffle           = s.shuffle || false;
                    this.repeatMode        = s.repeatMode || 'off';
                    this._savedCurrentTime = s.currentTime || 0;
                    if (this.audio) { this.audio.volume = 1; }
                } catch(e) {
                    console.warn('_restorePlayerState error:', e);
                    this.loadPlaylist();
                }
            },

            _initFavoritos() {
                try {
                    if (USER_FAVORITES && Array.isArray(USER_FAVORITES)) {
                        this.favoritosList = USER_FAVORITES
                            .map(f => f && f.musica ? normalizeTrack(f.musica) : null)
                            .filter(Boolean);
                        if (IS_AUTHENTICATED && this.favoritosList.length) {
                            const serverIds = this.favoritosList.map(t => t.id).filter(Boolean);
                            this.likedTracks = Array.from(new Set([...(this.likedTracks || []), ...serverIds]));
                            localStorage.setItem('likedTracks', JSON.stringify(this.likedTracks));
                        }
                    }
                    if (this.favoritosList.length) AppCache.set('state', 'favoritos', this.favoritosList);
                } catch(e) {
                    const cached = AppCache.get('state', 'favoritos');
                    if (cached) this.favoritosList = cached;
                }
                if (IS_AUTHENTICATED) {
                    const idx = this.userPlaylists.findIndex(p => (p.nome || '').toLowerCase().includes('curtidas'));
                    const favEntry = { id: '__fav__', nome: 'Curtidas', total_musicas: this.favoritosList.length };
                    if (idx === -1) {
                        this.userPlaylists.unshift(favEntry);
                    } else {
                        this.userPlaylists[idx].total_musicas = this.favoritosList.length;
                    }
                }
            },

            // ─── SELECT / PLAY ─────────────────────────────────────────
            async selectTrack(track, index = null, sourceList = null, queueType = 'single') {
                if (!this.hasActivePlan) {
                    let msg = 'Reproduzindo versão limitada (30s). Assine um plano para ouvir completo';
                    if (!IS_AUTHENTICATED) {
                        msg += ` <a href="${REGISTER_URL}">Cadastre-se</a> para receber 1 dia grátis de teste`;
                    }
                    this.showNotification(msg, 'info');
                }
                const normalized = normalizeTrack(track);
                if (!normalized) return;
                if (sourceList && Array.isArray(sourceList) && sourceList.length > 0) {
                    this.currentQueue = sourceList.map(t => normalizeTrack(t)).filter(Boolean);
                    this.currentQueueType = queueType;
                    this.currentQueueIndex = index !== null ? index : 0;
                } else {
                    const existsInPlaylist = this.playlist.findIndex(t => t.id === normalized.id);
                    if (existsInPlaylist === -1) this.playlist.push(normalized);
                    this.currentQueue = [...this.playlist];
                    this.currentQueueType = 'playlist';
                    this.currentQueueIndex = this.currentQueue.findIndex(t => t.id === normalized.id);
                }
                const existingIdx = this.playlist.findIndex(t => t.id === normalized.id);
                if (existingIdx === -1) { this.playlist.push(normalized); this.currentTrackIndex = this.playlist.length - 1; }
                else { this.currentTrackIndex = existingIdx; }
                this.currentTrack = normalized;
                this.trackDetail = normalized;
                this._previewWarned = false;
                this.currentTime = 0;
                this.progress = 0;
                await this._playSrc(normalized);
                this.bottomSheetActive = true;
                this._savePlayerState();
            },

            async playTrackAtIndex(index) {
                if (index < 0 || index >= this.playlist.length) return;
                this.currentTrackIndex = index;
                this.currentTrack = this.playlist[index];
                this.trackDetail = this.currentTrack;
                const qi = this.currentQueue.findIndex(t => t.id === this.currentTrack.id);
                if (qi !== -1) { this.currentQueueIndex = qi; }
                else { this.currentQueue = [...this.playlist]; this.currentQueueType = 'playlist'; this.currentQueueIndex = index; }
                this._previewWarned = false;
                this.currentTime = 0;
                this.progress = 0;
                await this._playSrc(this.currentTrack);
                this.bottomSheetActive = true;
                this._savePlayerState();
            },

            async _playSrc(track) {
                if (this.audio && !this.audio.paused) {
                    try { this.audio.pause(); } catch(e) { /* ignore */ }
                }
                let src = null;
                if (track.arquivo && track.arquivo.startsWith('/media/')) { src = track.arquivo; }
                if (!src && track.audio_url) {
                    const au = track.audio_url;
                    if (au.startsWith('http') && au.indexOf('/api/') === -1) { src = au; }
                    else if (au.startsWith('/api/streaming-url') || au.startsWith('/api/stream/url')) {
                        const cached = AppCache.get('streaming', au);
                        if (cached) { src = cached; }
                        else {
                            try {
                                this.showNotification('Carregando…', 'info');
                                const r = await fetch(au);
                                const d = await r.json();
                                if (d?.stream_url) { src = d.stream_url; AppCache.set('streaming', au, src); }
                            } catch(e) { console.warn('_playSrc audio_url fetch:', e); }
                        }
                    }
                }
                if (!src) {
                    const vid = track.youtube_id ||
                        (track.id && /^[A-Za-z0-9_-]{11}$/.test(String(track.id)) ? String(track.id) : null);
                    if (vid) {
                        const fetchUrl = '/api/streaming-url/?video_id=' + encodeURIComponent(vid);
                        const cached2 = AppCache.get('streaming', fetchUrl);
                        if (cached2) { src = cached2; }
                        else {
                            try {
                                const r2 = await fetch(fetchUrl);
                                const d2 = await r2.json();
                                if (d2?.stream_url) { src = d2.stream_url; AppCache.set('streaming', fetchUrl, src); }
                            } catch(e) { console.warn('_playSrc streaming fetch:', e); }
                        }
                    }
                }
                if (!src) {
                    console.warn('_playSrc: no source for track', track);
                    return false;
                }
                try {
                    this.audio.src = src;
                    await this.audio.play();
                    this.isPlaying = true;
                    return true;
                } catch(e) {
                    console.warn('_playSrc play() aborted:', e);
                    this.isPlaying = false;
                    return false;
                }
            },

            // ─── EXPLORAR ──────────────────────────────────────────────
            async loadExplorar(force = false) {
                if (!force && this.explorarTracks && this.explorarTracks.length) {
                    this.explorarLoading = false;
                    return;
                }
                if (this.explorarLoading && this.explorarTracks.length > 0) return;
                this.explorarLoading = true;
                const cached = AppCache.get('explorar', 'top-brasil');
                if (cached) {
                    const seen = new Set();
                    this.explorarTracks = (cached.songs || [])
                        .map(t => normalizeTrack(t))
                        .filter(t => { if (!t || !t.id || seen.has(t.id)) return false; seen.add(t.id); return true; });
                }
                this.explorarLoading = false;
            },

            async loadExplorarFeatured() {
                if (!this.explorarTracks.length) return;
                const shuffled = [...this.explorarTracks].sort(() => Math.random() - 0.5);
                this.currentQueue = shuffled;
                this.currentQueueType = 'explorar';
                this.currentQueueIndex = 0;
                await this.selectTrack(shuffled[0], 0, shuffled, 'explorar');
            },

            async exploreGenre(genre) {
    this.activeGenre = genre;
    this.genreResults = {};
    this.loading = true;

    // ── Verificar cache ────────────────────────────────────────────
    let cached = AppCache.get('genre', genre.slug);

    // Migrar cache antigo (objeto artista->tracks) para o novo formato
    if (cached && typeof cached === 'object' && !cached.songs) {
        const songs = Object.values(cached)
            .flat()
            .map(t => normalizeTrack(t))
            .filter(Boolean);
        cached = { songs };
        AppCache.set('genre', genre.slug, cached);
    }

    // Sempre renormalizar songs do cache (garante thumb/title corretos)
    if (cached && Array.isArray(cached.songs) && cached.songs.length) {
        cached.songs = cached.songs.map(t => normalizeTrack(t)).filter(Boolean);
        this.genreResults = cached;
    }

    if (!genre.json_url) {
        this.loading = false;
        if (!cached || !cached.songs?.length) {
            this.showNotification('Nenhum arquivo configurado para: ' + genre.name, 'info');
        }
        return;
    }

    try {
        const r = await fetch(encodeURI(genre.json_url));

        if (!r.ok) throw new Error('HTTP ' + r.status);

        const raw = await r.json();

        // ── Normalizar qualquer formato de entrada ─────────────────
        // Suportado:
        //   [ track, track, ... ]                    → array flat
        //   { "Artista": [tracks], ... }              → objeto artista->tracks
        //   { songs: [tracks] }                       → objeto com chave songs
        //   { tracks: [tracks] }                      → objeto com chave tracks
        let flatTracks = [];

        if (Array.isArray(raw)) {
            flatTracks = raw;
        } else if (raw && typeof raw === 'object') {
            if (Array.isArray(raw.songs)) {
                flatTracks = raw.songs;
            } else if (Array.isArray(raw.tracks)) {
                flatTracks = raw.tracks;
            } else {
                // Objeto com artistas como chaves — achata todos os arrays
                flatTracks = Object.values(raw).reduce((acc, val) => {
                    if (Array.isArray(val)) return acc.concat(val);
                    if (val && typeof val === 'object') {
                        if (Array.isArray(val.tracks)) return acc.concat(val.tracks);
                        if (Array.isArray(val.songs))  return acc.concat(val.songs);
                    }
                    return acc;
                }, []);
            }
        }

        // ── Normalizar e deduplicar por id ─────────────────────────
        const seen = new Set();
        const songs = flatTracks
            .map(t => normalizeTrack(t))
            .filter(t => {
                if (!t || !t.id || seen.has(t.id)) return false;
                seen.add(t.id);
                return true;
            });

        if (!songs.length) {
            this.loading = false;
            if (!cached?.songs?.length) {
                this.showNotification('Nenhuma música encontrada para: ' + genre.name, 'info');
            }
            return;
        }

        const result = { songs };
        this.genreResults = result;
        AppCache.set('genre', genre.slug, result);

        this.showNotification(genre.name + ' — ' + songs.length + ' músicas ✓', 'success');

    } catch (err) {
        console.warn('[exploreGenre] Falha ao carregar "' + genre.slug + '":', err);
        // Se não tem cache, avisar o usuário; se tem, continua mostrando o cache silenciosamente
        if (!cached?.songs?.length) {
            this.showNotification('Erro ao carregar músicas de ' + genre.name, 'error');
        }
    }

    this.loading = false;
    setTimeout(() => {
        document.getElementById('mainScroll')?.scrollTo({ top: 9999, behavior: 'smooth' });
    }, 200);
},

            // ─── NEXT / PREVIOUS ───────────────────────────────────────
            async next(manual = false) {
                if (!manual) {
                    if (this.repeatMode === 'one') {
                        this.audio.currentTime = 0;
                        await this.audio.play();
                        return;
                    }
                    if (this.repeatMode === 'once') {
                        this.audio.currentTime = 0;
                        await this.audio.play();
                        this.repeatMode = 'off';
                        return;
                    }
                }
                const queue = this._activeQueue();
                if (!queue.length) return;
                let cur = this._currentIndexInQueue(queue);
                let ni = this.shuffle ? this._randomOther(cur, queue.length) : cur + 1;
                if (ni >= queue.length) ni = 0;
                await this._playFromQueue(queue, ni);
            },

            async previous(force = false) {
                if (!force && this.audio.currentTime > 3) { this.audio.currentTime = 0; return; }
                const queue = this._activeQueue();
                if (!queue.length) return;
                let cur = this._currentIndexInQueue(queue);
                let pi = this.shuffle ? this._randomOther(cur, queue.length) : cur - 1;
                if (pi < 0) pi = queue.length - 1;
                await this._playFromQueue(queue, pi);
            },

            _activeQueue() {
                if (this.currentQueueType === 'album' && this.albumData?.tracks?.length) return this.albumData.tracks;
                return this.currentQueue.length ? this.currentQueue : this.playlist;
            },
            _currentIndexInQueue(queue) {
                if (!this.currentTrack) return 0;
                const i = queue.findIndex(t => t.id === this.currentTrack.id);
                return i !== -1 ? i : 0;
            },
            _randomOther(cur, len) {
                if (len <= 1) return 0;
                let r; do { r = Math.floor(Math.random() * len); } while (r === cur);
                return r;
            },
            async _playFromQueue(queue, idx) {
                const track = queue[idx];
                if (!track) return;
                const normalized = normalizeTrack(track);
                if (!normalized) return;
                this.currentQueueIndex = idx;
                this.currentTrack = normalized;
                this.trackDetail = normalized;
                this._previewWarned = false;
                this.currentTime = 0;
                this.progress = 0;
                const pi = this.playlist.findIndex(t => t.id === normalized.id);
                if (pi !== -1) { this.currentTrackIndex = pi; }
                else { this.playlist.push(normalized); this.currentTrackIndex = this.playlist.length - 1; }
                await this._playSrc(normalized);
                this._savePlayerState();
            },

            async togglePlay() {
                if (!this.hasActivePlan && this.currentTime >= this.previewLimit) {
                    if (!this._previewWarned) {
                        this._previewWarned = true;
                        let msg = 'Você atingiu 30 segundos de reprodução.';
                        if (IS_AUTHENTICATED) {
                            msg += ' Assine um plano para continuar ouvindo';
                        } else {
                            msg += ' Obtenha seu plano grátis usando o botão abaixo.';
                        }
                        this.showNotification(msg, 'error');
                        if (typeof showPreviewOverlay === 'function') showPreviewOverlay(msg);
                    }
                    return;
                }
                if (!this.currentTrack) {
                    if (this.playlist.length > 0) this.playTrackAtIndex(0);
                    return;
                }
                if (!this.audio.src || this.audio.src === window.location.href) {
                    const savedTime = this._savedCurrentTime || 0;
                    const ok = await this._playSrc(this.currentTrack);
                    if (ok && savedTime > 5) {
                        this.audio.currentTime = savedTime;
                    }
                    return;
                }
                if (this.isPlaying) {
                    this.audio.pause();
                    this.isPlaying = false;
                } else {
                    this.audio.play().then(() => { this.isPlaying = true; }).catch(console.error);
                }
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = this.isPlaying ? 'playing' : 'paused';
                }
            },

            updateProgress() {
                if (this.audio.duration) {
                    this.currentTime = this.audio.currentTime;
                    this.duration    = this.audio.duration;
                    this.progress    = (this.currentTime / this.duration) * 100;
                }
                if (!this.hasActivePlan && this.currentTime >= this.previewLimit) {
                    this.audio.pause();
                    this.isPlaying = false;
                    this.progress = 0;
                    if (!this._previewWarned) {
                        this._previewWarned = true;
                        let msg = 'Você atingiu 30 segundos de reprodução.';
                        if (IS_AUTHENTICATED) {
                            msg += ' Assine um plano para continuar ouvindo';
                        } else {
                            msg += ' Obtenha seu plano grátis usando o botão abaixo.';
                        }
                        this.showNotification(msg, 'error');
                        if (typeof showPreviewOverlay === 'function') showPreviewOverlay(msg);
                    }
                }
            },
            updateMetadata() { this.duration = this.audio.duration; },

            // ─── CYCLE REPEAT — 3 estados ──────────────────────────────
            cycleRepeat() {
                const order = ['off', 'once', 'one'];
                let idx = order.indexOf(this.repeatMode);
                idx = (idx + 1) % order.length;
                this.repeatMode = order[idx];
                const msgs = {
                    off:  '🔁 Repetição desligada',
                    once: '🔂 Repetir 1 vez',
                    one:  '🔁 Repetindo continuamente',
                };
                this.showNotification(msgs[this.repeatMode], 'info');
                this._savePlayerState();
            },

            seek(e) {
                const r = e.currentTarget.getBoundingClientRect();
                let t = ((e.clientX - r.left) / r.width) * this.audio.duration;
                if (!this.hasActivePlan && t > 30) t = 30;
                this.audio.currentTime = t;
            },

            seekFromBar(e) {
                const r = e.currentTarget.getBoundingClientRect();
                if (this.audio && this.audio.duration) {
                    let t = ((e.clientX - r.left) / r.width) * this.audio.duration;
                    if (!this.hasActivePlan && t > 30) t = 30;
                    this.audio.currentTime = t;
                }
            },

            formatTime(s) {
                if (!s || isNaN(s)) return '0:00';
                return Math.floor(s / 60) + ':' + String(Math.floor(s % 60)).padStart(2, '0');
            },

            // ─── LIKES ─────────────────────────────────────────────────
            toggleLike(track) {
                if (!track) return;
                if (!IS_AUTHENTICATED) { this.showNotification('Faça login para curtir músicas', 'error'); return; }
                const i = this.likedTracks.indexOf(track.id);
                const method = i === -1 ? 'POST' : 'DELETE';
                const endpoint = i === -1 ? '/api/favorites/' : '/api/favorites/?musica_id=' + track.id;
                if (i === -1) { this.likedTracks.push(track.id); this.showNotification('Curtido! ♥', 'success'); }
                else { this.likedTracks.splice(i, 1); this.showNotification('Removido dos curtidos', 'info'); }
                localStorage.setItem('likedTracks', JSON.stringify(this.likedTracks));
                fetch(endpoint, {
                    method, credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken() },
                    body: method === 'POST' ? JSON.stringify({ musica_id: track.id }) : undefined
                }).then(async r => {
                    if (!r.ok) {
                        if (i === -1) { const idx = this.likedTracks.indexOf(track.id); if (idx !== -1) this.likedTracks.splice(idx, 1); }
                        else { if (!this.likedTracks.includes(track.id)) this.likedTracks.push(track.id); }
                        localStorage.setItem('likedTracks', JSON.stringify(this.likedTracks));
                        const d = await r.json().catch(() => null);
                        this.showNotification((d && (d.error || d.message)) || 'Erro ao atualizar curtida', 'error');
                        return;
                    }
                    if (method === 'POST') {
                        const d = await r.json().catch(() => null);
                        const n = normalizeTrack((d && d.musica) ? d.musica : track);
                        if (n && !this.favoritosList.some(t => t.id === n.id)) this.favoritosList.unshift(n);
                    } else {
                        const idx = this.favoritosList.findIndex(t => t.id === track.id);
                        if (idx !== -1) this.favoritosList.splice(idx, 1);
                    }
                    AppCache.set('state', 'favoritos', this.favoritosList);
                    const favPl = this.userPlaylists.find(p => (p.nome||'').toLowerCase().includes('curtidas'));
                    if (favPl) favPl.total_musicas = this.favoritosList.length;
                }).catch(err => {
                    if (i === -1) { const idx = this.likedTracks.indexOf(track.id); if (idx !== -1) this.likedTracks.splice(idx, 1); }
                    else { if (!this.likedTracks.includes(track.id)) this.likedTracks.push(track.id); }
                    localStorage.setItem('likedTracks', JSON.stringify(this.likedTracks));
                    this.showNotification('Erro de conexão', 'error');
                    console.error('toggleLike error:', err);
                });
            },

            loadLikedTracks() {
                try { this.likedTracks = JSON.parse(localStorage.getItem('likedTracks') || '[]'); }
                catch(e) { this.likedTracks = []; }
            },

            // ─── SEARCH ────────────────────────────────────────────────
            search(query) {
                if (!query?.trim()) return;
                this.loading = true;
                this.activeNav = 'search';
                const url = new URL(window.location);
                url.searchParams.set('q', query);
                window.history.pushState({}, '', url);
                const cacheKey = query.trim().toLowerCase();
                const cached = AppCache.get('search', cacheKey);
                if (cached) {
                    this.searchResults = {
                        songs:  Array.isArray(cached.songs)  ? cached.songs  : [],
                        albums: Array.isArray(cached.albums) ? cached.albums : []
                    };
                    this.searchCached = true;
                } else {
                    this.searchCached = false;
                }
                cachedFetch('/api/search/?q=' + encodeURIComponent(query), 'search', cacheKey, { noBackground: true })
                    .then(({ data }) => {
                        this.searchResults = {
                            songs:  Array.isArray(data.songs)  ? data.songs  : [],
                            albums: Array.isArray(data.albums) ? data.albums : []
                        };
                        this.searchCached = false;
                    })
                    .catch(() => { if (!cached) this.showNotification('Erro de conexão', 'error'); })
                    .finally(() => { this.loading = false; });
            },

            // ─── PLAYLISTS ─────────────────────────────────────────────
            _checkAuth(msg = 'É necessário fazer login para usar playlists') {
                if (!IS_AUTHENTICATED) { this.showNotification(msg, 'error'); return false; }
                return true;
            },

            addToPlaylist(playlistId) {
                if (!this.selectedTrackForPlaylist || !this._checkAuth()) return;
                if (!this.selectedTrackForPlaylist.id) {
                    this.showNotification('Música inválida', 'error');
                    this.showPlaylistModal = false;
                    return;
                }
                if (!playlistId) { this.showNotification('Playlist inválida', 'error'); return; }
                const exists = Array.isArray(this.userPlaylists) && this.userPlaylists.some(p => p && p.id === playlistId);
                if (!exists) { this.showNotification('Playlist não encontrada', 'error'); this.showPlaylistModal = false; return; }
                this.addingPlaylistId = playlistId;
                this.showPlaylistModal = false;
                fetch('/api/playlists/' + playlistId + '/add/', {
                    method: 'POST', credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken() },
                    body: JSON.stringify({ musica_id: this.selectedTrackForPlaylist.id })
                }).then(async r => {
                    if (r.status === 401 || r.status === 403) { this.showNotification('Login necessário', 'error'); throw new Error('forbidden'); }
                    if (r.status === 400) { const d = await r.json().catch(() => null); this.showNotification((d && d.error) || 'Música já está na playlist', 'info'); throw new Error('bad-request'); }
                    if (!r.ok) throw new Error('request-failed');
                    return r.json();
                }).then(d => {
                    if (d && d.success) {
                        this.showNotification('Adicionada à playlist! ✓', 'success');
                        const pl = this.userPlaylists.find(p => p.id === playlistId);
                        if (pl) pl.total_musicas = (pl.total_musicas || 0) + 1;
                        AppCache.del('playlist', playlistId);
                        if (d.item && this.openedPlaylistId === playlistId) {
                            const m = d.item.musica || d.item;
                            const n = normalizeTrack(m);
                            if (n && !this.playlist.some(t => t.id === n.id)) this.playlist.push(n);
                        }
                    } else { this.showNotification((d && d.error) || 'Erro ao adicionar', 'error'); }
                }).catch(e => {
                    if (['forbidden','bad-request','not-found'].includes(e.message)) return;
                    this.showNotification('Erro de conexão', 'error');
                }).finally(() => {
                    this.showInlineCreate = false;
                    this.selectedTrackForPlaylist = null;
                    this.addingPlaylistId = null;
                });
            },

            async playlistShareCopy(pl) {
                if (!this._checkAuth('É necessário estar logado para compartilhar')) return;
                try {
                    if (pl && pl.is_shared && pl.share_uuid) {
                        const url = window.location.origin + '/share/' + pl.share_uuid + '/';
                        const text = pl.nome || '';
                        if(navigator.share){
                            navigator.share({ title: pl.nome, text, url }).catch(()=>{
                                this.openShareModal(url, text);
                            });
                        } else {
                            this.openShareModal(url, text);
                        }
                        return;
                    }

                    const res = await fetch('/api/playlists/' + pl.id + '/share/toggle/', {
                        method: 'POST', credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken() },
                        body: JSON.stringify({ enable: true })
                    });
                    if (!res.ok) {
                        if (res.status === 401 || res.status === 403) { this.showNotification('Login necessário', 'error'); return; }
                        throw new Error('request-failed');
                    }
                    const data = await res.json();
                    if (data && data.share_url) {
                        const found = this.userPlaylists.find(x => x && x.id === pl.id);
                        if (found) { found.is_shared = true; found.share_uuid = found.share_uuid || (data.share_url.split('/share/')[1] || '').replace('/', ''); }
                        const shareUrl = data.share_url;
                        const text = pl.nome || '';
                        if(navigator.share){
                            navigator.share({ title: pl.nome, text, url: shareUrl }).catch(()=>{
                                this.openShareModal(shareUrl, text);
                            });
                        } else {
                            this.openShareModal(shareUrl, text);
                        }
                    } else {
                        this.showNotification('Não foi possível gerar link', 'error');
                    }
                } catch (err) {
                    console.error('playlistShareCopy error', err);
                    this.showNotification('Erro de conexão', 'error');
                }
            },

            createPlaylist() {
                if (!this.newPlaylistName.trim() || !this._checkAuth()) return;
                fetch('/api/playlists/', {
                    method: 'POST', credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken() },
                    body: JSON.stringify({ nome: this.newPlaylistName, descricao: this.newPlaylistDescription })
                }).then(async r => {
                    if (r.status === 401 || r.status === 403) { this.showNotification('Login necessário', 'error'); throw new Error('forbidden'); }
                    return r.json();
                }).then(d => {
                    if (d.success && d.playlist_id) {
                        this.userPlaylists.push({ id: d.playlist_id, nome: this.newPlaylistName, descricao: this.newPlaylistDescription, total_musicas: 0 });
                        this.showNotification('Playlist criada! 🎵', 'success');
                        this.showCreatePlaylistModal = false;
                        this.newPlaylistName = this.newPlaylistDescription = '';
                    } else { this.showNotification(d.error || 'Erro ao criar', 'error'); }
                }).catch(e => { if (e.message !== 'forbidden') this.showNotification('Erro de conexão', 'error'); });
            },

            createPlaylistAndAdd() {
                if (!this.newPlaylistName.trim() || !this.selectedTrackForPlaylist || !this._checkAuth()) return;
                fetch('/api/playlists/', {
                    method: 'POST', credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken() },
                    body: JSON.stringify({ nome: this.newPlaylistName, descricao: this.newPlaylistDescription })
                }).then(async r => {
                    if (r.status === 401 || r.status === 403) { this.showNotification('Login necessário', 'error'); throw new Error('forbidden'); }
                    return r.json();
                }).then(d => {
                    if (d.success && d.playlist_id) {
                        this.userPlaylists.push({ id: d.playlist_id, nome: this.newPlaylistName, descricao: this.newPlaylistDescription, total_musicas: 0 });
                        this.newPlaylistName = this.newPlaylistDescription = '';
                        this.showInlineCreate = false;
                        this.addToPlaylist(d.playlist_id);
                    } else { this.showNotification(d.error || 'Erro ao criar', 'error'); }
                }).catch(e => { if (e.message !== 'forbidden') this.showNotification('Erro de conexão', 'error'); });
            },

            openPlaylist(playlistId) {
                if (!this._checkAuth()) return;
                if (playlistId === '__fav__' || String(playlistId).toLowerCase().includes('curtidas')) {
                    const tracks = [...this.favoritosList];
                    this.playlist = tracks;
                    this.currentQueue = [...tracks];
                    this.currentQueueType = 'favorite';
                    this.currentQueueIndex = -1;
                    this.openedPlaylistId = playlistId;
                    this.openedPlaylistName = 'Curtidas';
                    this.activeNav = 'library';
                    return;
                }
                const cached = AppCache.get('playlist', playlistId);
                if (cached) {
                    const tracks = (cached.musicas || [])
                        .map(item => { const raw = (item && item.musica) ? item.musica : item; return normalizeTrack(raw); })
                        .filter(Boolean)
                        .filter((t, i, arr) => arr.findIndex(x => x.id === t.id) === i);
                    if (tracks.length) {
                        this.playlist = tracks;
                        this.currentQueue = [...tracks];
                        this.currentQueueType = 'playlist';
                        this.currentQueueIndex = -1;
                        this.openedPlaylistId = playlistId;
                        this.openedPlaylistName = cached.nome || cached.title || 'Playlist';
                        this.activeNav = 'library';
                    }
                }
                this.loading = true;
                silentFetch('/api/playlists/' + playlistId + '/', 'playlist', playlistId)
                    .then(d => {
                        const itens = d.musicas || [];
                        const tracks = itens
                            .map(item => { const raw = (item && item.musica) ? item.musica : item; return normalizeTrack(raw); })
                            .filter(Boolean)
                            .filter((t, i, arr) => arr.findIndex(x => x.id === t.id) === i);
                        this.$nextTick(() => {
                            this.playlist = tracks;
                            this.currentQueue = [...tracks];
                            this.currentQueueType = 'playlist';
                            this.currentQueueIndex = -1;
                            this.openedPlaylistId = playlistId;
                            this.openedPlaylistName = d.nome || d.title || 'Playlist';
                            this.activeNav = 'library';
                            this._savePlayerState();
                            if (!cached) this.showNotification('"' + (d.nome || 'Playlist') + '" carregada (' + tracks.length + ' músicas)', 'success');
                        });
                    })
                    .catch(e => { if (!cached) this.showNotification('Erro ao carregar playlist', 'error'); })
                    .finally(() => { this.loading = false; });
            },

            removeFromPlaylist(index) {
                if (index < 0 || index >= this.playlist.length) return;
                const removed = this.playlist[index];
                if (this.currentTrack?.id === removed.id) {
                    if (this.isPlaying) { this.audio.pause(); this.isPlaying = false; }
                    this.currentTrack = null;
                    this.currentTrackIndex = -1;
                }
                this.playlist.splice(index, 1);
                if (this.currentQueueType === 'playlist') this.currentQueue = [...this.playlist];
                this._savePlayerState();
                if (this.currentTrackIndex >= index) this.currentTrackIndex--;
                this.showNotification('Removida da fila', 'info');
            },

            playPlaylistAtual() {
                if (this.playlist.length > 0) {
                    this.currentQueue = [...this.playlist];
                    this.currentQueueType = 'playlist';
                    this.currentQueueIndex = 0;
                    this.playTrackAtIndex(0);
                }
            },

            confirmDeletePlaylist(pl) {
                if (!this._checkAuth()) return;
                let playlistId, playlistName;
                if (typeof pl === 'object' && pl !== null) {
                    playlistId = pl.id; playlistName = pl.nome || pl.name || 'Playlist';
                } else {
                    const found = this.userPlaylists.find(p => p.id === pl);
                    playlistId = pl; playlistName = found ? (found.nome || 'Playlist') : 'Playlist';
                }
                if (!playlistId) { this.showNotification('ID da playlist inválido', 'error'); return; }
                this.openConfirmModal(
                    'Excluir playlist',
                    `Excluir a playlist "${playlistName}"? Esta ação não pode ser desfeita.`,
                    () => this.deletePlaylist(playlistId)
                );
            },

            deletePlaylist(playlistId) {
                if (!this._checkAuth()) return;
                fetch('/api/playlists/' + playlistId + '/', {
                    method: 'DELETE', credentials: 'same-origin',
                    headers: { 'X-CSRFToken': this.csrfToken() }
                }).then(async r => {
                    if (r.status === 401 || r.status === 403) { this.showNotification('Sem permissão', 'error'); return; }
                    if (!r.ok) { const d = await r.json().catch(() => null); this.showNotification((d && d.error) || 'Erro ao excluir', 'error'); return; }
                    this.userPlaylists = this.userPlaylists.filter(p => p && p.id !== playlistId);
                    AppCache.del('playlist', playlistId);
                    if (this.openedPlaylistId === playlistId) {
                        this.openedPlaylistId = null; this.openedPlaylistName = null;
                        this.playlist = []; this.currentQueue = [];
                        if (this.currentTrack) { this.audio.pause(); this.isPlaying = false; this.currentTrack = null; }
                        this._savePlayerState();
                    }
                    this.showNotification('Playlist excluída', 'success');
                }).catch(() => { this.showNotification('Erro de conexão', 'error'); });
            },

            confirmClearFavorites() {
                if (!this._checkAuth()) return;
                this.openConfirmModal(
                    'Remover todas as curtidas',
                    'Remover todas as músicas curtidas? Esta ação não pode ser desfeita.',
                    () => this.clearFavorites()
                );
            },

            clearFavorites() {
                if (!this._checkAuth()) return;
                fetch('/api/favorites/?clear_all=1', {
                    method: 'DELETE', credentials: 'same-origin',
                    headers: { 'X-CSRFToken': this.csrfToken() }
                }).then(async r => {
                    if (r.status === 401 || r.status === 403) { this.showNotification('Sem permissão', 'error'); return; }
                    if (!r.ok) { const d = await r.json().catch(() => null); this.showNotification((d && d.error) || 'Erro ao limpar favoritos', 'error'); return; }
                    this.favoritosList = []; this.likedTracks = [];
                    localStorage.setItem('likedTracks', JSON.stringify(this.likedTracks));
                    AppCache.del('state', 'favoritos');
                    this.showNotification('Curtidas limpas', 'success');
                }).catch(() => { this.showNotification('Erro de conexão', 'error'); });
            },

            removeTrackFromPlaylist(playlistId, track, localIndex) {
                if (!this._checkAuth()) return;
                fetch('/api/playlists/' + playlistId + '/remove/', {
                    method: 'DELETE', credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken() },
                    body: JSON.stringify({ musica_id: track.id })
                }).then(async r => {
                    if (r.status === 401 || r.status === 403) { this.showNotification('Sem permissão', 'error'); return; }
                    if (!r.ok) { const d = await r.json().catch(() => null); this.showNotification((d && d.error) || 'Erro ao remover', 'error'); return; }
                    const pl = this.userPlaylists.find(p => p && p.id === playlistId);
                    if (pl && pl.total_musicas > 0) pl.total_musicas--;
                    AppCache.del('playlist', playlistId);
                    this.removeFromPlaylist(localIndex);
                    this.showNotification('Música removida da playlist', 'success');
                }).catch(() => { this.showNotification('Erro de conexão', 'error'); });
            },

            showAddToPlaylistModal(track) {
                if (!IS_AUTHENTICATED) {
                    this.showNotification('Faça login para adicionar a playlists', 'error');
                    setTimeout(() => { window.location.href = "{% url 'login' %}"; }, 1200);
                    return;
                }
                let norm = normalizeTrack(track) || track || {};
                if (!norm.id && track && track.youtube_id) norm.id = track.youtube_id;
                this.selectedTrackForPlaylist = norm;
                if (Array.isArray(this.userPlaylists) && this.userPlaylists.length === 1) {
                    const only = this.userPlaylists[0];
                    this.addToPlaylist(only.id);
                    return;
                }
                this.playlistFilter = '';
                this.showInlineCreate = false;
                this.newPlaylistName = '';
                this.newPlaylistDescription = '';
                this.showPlaylistModal = true;
            },

            async openLibrary(force = false) {
                this.activeNav = 'library';
                if (!IS_AUTHENTICATED) return;
                const cached = AppCache.get('state', 'userPlaylists');
                if (!force && cached && Array.isArray(cached)) this.userPlaylists = cached;
                this.loading = true;
                try {
                    const data = await silentFetch('/api/playlists/', 'state', 'userPlaylists');
                    if (Array.isArray(data)) { this.userPlaylists = data; AppCache.set('state', 'userPlaylists', data); }
                } catch(e) {
                    if (!cached) this.showNotification('Erro ao carregar playlists', 'error');
                } finally { this.loading = false; }
            },

            // ─── ÁLBUM ─────────────────────────────────────────────────
            async openAlbum(albumId, title, thumb, trackCount, playFirst = false) {
                if (!albumId) return;
                const cached = AppCache.get('album', albumId);
                if (cached) {
                    this.albumData = cached;
                    this.panelTitle = cached.title;
                    this.panelContent = '';
                    this.panelOpen = true;
                    if (playFirst && cached.tracks?.length > 0) setTimeout(() => this.playAlbumTrack(0), 300);
                    queueMicrotask(() => this._fetchAlbum(albumId, title, thumb).catch(() => {}));
                    return;
                }
                this.albumLoadingId = albumId;
                this.loading = true;
                await this._fetchAlbum(albumId, title, thumb, playFirst);
                this.loading = false;
                if (this.albumLoadingId === albumId) this.albumLoadingId = null;
            },

            async _fetchAlbum(albumId, title, thumb, playFirst = false) {
                try {
                    const data = await silentFetch('/api/album/' + albumId + '/', 'album', albumId);
                    const raw = data.musicas || data.tracks || data.faixas || [];
                    const tracks = raw.map(f => {
                        const n = normalizeTrack(f);
                        if (n && !n.thumb) n.thumb = thumb;
                        if (n && !n.album) n.album = title || '';
                        return n;
                    }).filter(Boolean);
                    const albumObj = { id: albumId, title: title || data.title, thumb, tracks };
                    AppCache.set('album', albumId, albumObj);
                    this.albumData = albumObj;
                    this.panelTitle = albumObj.title;
                    this.panelContent = '';
                    this.panelOpen = true;
                    if (playFirst && tracks.length > 0) setTimeout(() => this.playAlbumTrack(0), 300);
                } catch(e) {
                    if (!this.albumData) this.showNotification('Erro ao carregar álbum', 'error');
                }
            },

            async playAlbumTrack(idx) {
                if (!this.albumData?.tracks?.[idx]) { this.showNotification('Faixa não encontrada', 'error'); return; }
                const track = normalizeTrack(this.albumData.tracks[idx]);
                if (!track) return;
                if (!track.thumb) track.thumb = this.albumData.thumb;
                this.albumLoadingId = this.albumData?.id || null;
                this.albumTrackLoadingIndex = idx;
                this.currentQueue = this.albumData.tracks.map(t => normalizeTrack(t)).filter(Boolean);
                this.currentQueueType = 'album';
                this.currentQueueIndex = idx;
                if (!this.playlist.some(t => t.id === track.id)) this.playlist.push(track);
                this.currentTrackIndex = this.playlist.findIndex(t => t.id === track.id);
                this.currentTrack = track;
                this.trackDetail = track;
                this.panelOpen = false;
                this.bottomSheetActive = true;
                try { await this._playSrc(track); }
                finally {
                    if (this.albumTrackLoadingIndex === idx) this.albumTrackLoadingIndex = -1;
                    if (this.albumLoadingId === (this.albumData?.id)) this.albumLoadingId = null;
                }
                this._savePlayerState();
            },

            playAlbum() { if (this.albumData?.tracks?.length) this.playAlbumTrack(0); },

            addAlbumTrackToPlaylist(idx) {
                if (!this.albumData?.tracks?.[idx]) return;
                const t = normalizeTrack(this.albumData.tracks[idx]);
                if (!t) return;
                if (!t.thumb) t.thumb = this.albumData.thumb;
                this.showAddToPlaylistModal(t);
            },

            async addAlbumToPlaylist(albumId, title, thumb) {
                if (!albumId) return;
                try {
                    const data = await silentFetch('/api/album/' + albumId + '/', 'album', albumId);
                    const raw = data.musicas || data.tracks || data.faixas || [];
                    raw.forEach(f => {
                        const n = normalizeTrack(f);
                        if (!n) return;
                        if (!n.thumb) n.thumb = thumb;
                        if (!n.album) n.album = title || '';
                        if (!this.playlist.some(p => p.id === n.id)) this.playlist.push(n);
                    });
                    this._savePlayerState();
                    this.showNotification('Álbum adicionado à fila', 'success');
                } catch(e) {
                    this.showNotification('Erro ao adicionar álbum', 'error');
                }
            },

            async openAlbumForCurrentTrack() {
                const track = (this.trackDetail?.id ? this.trackDetail : null) || this.currentTrack;
                if (!track) { this.showNotification('Nenhuma faixa ativa', 'info'); return; }
                if (this.albumData?.tracks?.some(t => t.id === track.id)) { this.panelTitle = this.albumData.title; this.panelOpen = true; return; }
                const albumId = track.albumId || track.album_id || track.browseId;
                if (albumId) { this.openAlbum(albumId, track.album || '', track.thumb, 0); return; }
                const q = (track.album || (track.title + ' ' + track.artist)).trim();
                if (!q) { this.showNotification('Álbum não identificado', 'error'); return; }
                this.showNotification('Procurando álbum…', 'info');
                try {
                    const { data } = await cachedFetch('/api/search/?q=' + encodeURIComponent(q), 'search', q.toLowerCase());
                    const albums = data.albums || [];
                    const found = albums.find(a => a.title?.toLowerCase() === track.album?.toLowerCase()) || albums[0];
                    if (found) { this.openAlbum(found.id, found.title, found.thumb, found.track_count); return; }
                    this.showNotification('Álbum não encontrado', 'error');
                } catch { this.showNotification('Erro ao buscar álbum', 'error'); }
                finally { this.hideNotification(); }
            },

            // ─── RECOMENDAÇÕES ─────────────────────────────────────────
            showRecommendations(track) {
                if (!track) return;
                this.loading = true;
                this.recommendationsLoading = true;
                this.albumData = null;
                const vid = (track.youtube_id && String(track.youtube_id).trim()) ? String(track.youtube_id).trim() :
                    (track.id && /^[A-Za-z0-9_-]{11}$/.test(String(track.id)) ? String(track.id) : '');
                const cacheKey = 'rec_' + (vid || track.title || '');
                const cached = AppCache.get('recs', cacheKey);
                if (cached) {
                    this._renderRecommendations(cached);
                    this.loading = false; this.recommendationsLoading = false;
                    queueMicrotask(() => this._fetchRecommendations(vid, track, cacheKey).catch(() => {}));
                    return;
                }
                this._fetchRecommendations(vid, track, cacheKey)
                    .finally(() => { this.loading = false; this.recommendationsLoading = false; });
            },

            async _fetchRecommendations(vid, track, cacheKey) {
                let fetchUrl;
                if (vid) { fetchUrl = '/api/recommendations/' + encodeURIComponent(vid) + '/?limit=24'; }
                else {
                    const tp = encodeURIComponent(track.title || '');
                    const ap = encodeURIComponent(track.artist || '');
                    fetchUrl = '/api/recommendations/?limit=24' + (tp ? '&title=' + tp : '') + (ap ? '&artists=' + ap : '');
                }
                try {
                    const data = await silentFetch(fetchUrl, 'recs', cacheKey);
                    const recs = Array.isArray(data.recommendations) ? data.recommendations : [];
                    if (!recs.length) { this.showNotification('Nenhuma recomendação encontrada', 'info'); return; }
                    AppCache.set('recs', cacheKey, data);
                    this._renderRecommendations(data);
                } catch(err) { this.showNotification('Erro ao carregar recomendações', 'error'); }
            },

            _renderRecommendations(data) {
                const recs = Array.isArray(data.recommendations) ? data.recommendations : [];
                if (!recs.length) return;
                let html = '<div class="music-list">';
                recs.forEach(rec => {
                    const esc = v => (v || '').toString().replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const id = esc(rec.id || '');
                    const titulo = esc(rec.titulo || '');
                    const artista = esc(rec.artista_nome || '');
                    const capa = esc(rec.capa || '');
                    const audio = esc(rec.audio_url || '');
                    const tobj = `{id:'${id}',title:'${titulo}',artist:'${artista}',thumb:'${capa}',audio_url:'${audio}',youtube_id:'${id}'}`;
                    html += `<div class="list-item" onclick="window.appStore.selectTrack(${tobj});window.appStore.panelOpen=false;window.appStore.bottomSheetActive=true;">` +
                        `<div class="list-thumb"><img src="${capa}" loading="lazy"></div>` +
                        `<div class="list-info"><div class="list-title">${titulo}</div><div class="list-artist">${artista}</div></div>` +
                        `<div class="list-actions">` +
                        `<button class="ripple-host" onclick="event.stopPropagation();window.appStore.selectTrack(${tobj});window.appStore.panelOpen=false;window.appStore.bottomSheetActive=true;window.appStore.addRipple(event);"><i class="fa-solid fa-play"></i></button>` +
                        `<button class="ripple-host" onclick="event.stopPropagation();window.appStore.showAddToPlaylistModal(${tobj});window.appStore.addRipple(event);"><i class="fa-solid fa-plus"></i></button>` +
                        `</div></div>`;
                });
                html += '</div>';
                this.panelTitle = 'Músicas similares';
                this.panelContent = html;
                this.panelOpen = true;
            },

            openFavoritesPanel() {
                const favs = (this.favoritosList || []);
                if (!favs.length) { this.showNotification('Nenhuma música curtida ainda', 'info'); return; }
                let html = '<div class="music-list">';
                favs.forEach((t, idx) => {
                    const esc = v => (v || '').toString().replace(/'/g, "\\'").replace(/\"/g, '&quot;');
                    const id = esc(t.id || ''); const title = esc(t.title || t.titulo || t.nome || '');
                    const artist = esc(t.artist || t.artista_nome || t.artista || ''); const thumb = esc(t.thumb || t.capa || '');
                    const tobj = `{id:'${id}',title:'${title}',artist:'${artist}',thumb:'${thumb}',youtube_id:'${t.youtube_id || ''}'}`;
                    html += `<div class="list-item" onclick="window.appStore.selectTrack(${tobj}, ${idx}, window.appStore.favoritosList, 'favorite');window.appStore.panelOpen=false;window.appStore.bottomSheetActive=true;">` +
                        `<div class="list-thumb"><img src="${thumb}" loading="lazy"></div>` +
                        `<div class="list-info"><div class="list-title">${title}</div><div class="list-artist">${artist}</div></div>` +
                        `<div class="list-actions">` +
                        `<button class="ripple-host" onclick="event.stopPropagation();window.appStore.selectTrack(${tobj}, ${idx}, window.appStore.favoritosList, 'favorite');window.appStore.addRipple(event);"><i class="fa-solid fa-play"></i></button>` +
                        `<button class="ripple-host" onclick="event.stopPropagation();window.appStore.toggleLike(${tobj});window.appStore.addRipple(event);"><i class="fa-solid fa-heart"></i></button>` +
                        `</div></div>`;
                });
                html += '</div>';
                this.panelTitle = 'Curtidas';
                this.panelContent = html;
                this.panelOpen = true;
            },

            // ─── NOTIFICAÇÕES ──────────────────────────────────────────
            showNotification(msg, type = 'info') {
                const buffering = msg && msg.toString().toLowerCase().includes('bufferiz');
                const text = buffering ? 'Preparando áudio…' : msg;
                this.notification = { show: true, message: text, type };
                clearTimeout(this._nt);
                this._nt = setTimeout(() => { this.hideNotification(); }, 3200);
            },
            hideNotification() { 
                this.notification.show = false; 
            },
            openShareModal(url, title = '', text = ''){
                this.shareModalUrl = url;
                this.shareModalTitle = title;
                this.shareModalText = text;
                this.shareModalVisible = true;
            },

            shareCurrentTrack(){
                if(!this.currentTrack) return;
                const t = this.currentTrack;
                const params = new URLSearchParams({
                    id: t.id || '',
                    title: t.title || '',
                    artist: t.artist || '',
                    thumb: t.thumb || ''
                });
                fetch('/short/track/?' + params.toString())
                    .then(r => r.json())
                    .then(data => {
                        if(data.url){
                            const shareUrl = data.url;
                            const shareText = `${t.title} – ${t.artist}`;
                            if(navigator.share){
                                navigator.share({ title: t.title, text: shareText, url: shareUrl })
                                    .catch(() => {
                                        this.openShareModal(shareUrl, shareText);
                                    });
                            } else {
                                this.openShareModal(shareUrl, shareText);
                            }
                        } else {
                            this.showNotification('Erro ao gerar link curto', 'error');
                        }
                    }).catch(()=>{
                        this.showNotification('Erro ao gerar link curto', 'error');
                    });
            },

            // ─── CONFIRM MODAL ─────────────────────────────────────────
            openConfirmModal(title, message, action = null, payload = null) {
                this.confirmModalTitle = title || 'Confirmar';
                this.confirmModalMessage = message || '';
                this.confirmModalAction = typeof action === 'function' ? action : null;
                this.confirmModalPayload = payload === undefined ? null : payload;
                this.confirmModalVisible = true;
                this.$nextTick(() => {
                    const btn = document.querySelector('.modal .modal-btn.primary');
                    if (btn) btn.focus();
                });
            },
            closeConfirmModal() {
                this.confirmModalVisible = false;
                this.confirmModalTitle = '';
                this.confirmModalMessage = '';
                this.confirmModalAction = null;
                this.confirmModalPayload = null;
            },
            confirmModalConfirm() {
                try { if (typeof this.confirmModalAction === 'function') this.confirmModalAction(this.confirmModalPayload); }
                catch (err) { console.error('confirmModalConfirm error', err); }
                finally { this.closeConfirmModal(); }
            },

            handleAudioError() {
                console.error('handleAudioError:', this.audio?.error);
                this.showNotification('Erro ao carregar áudio', 'error');
                this.isPlaying = false;
            },

            // ─── UTILS ─────────────────────────────────────────────────
            getCookie(name) {
                let v = null;
                document.cookie.split(';').forEach(c => {
                    c = c.trim();
                    if (c.startsWith(name + '=')) v = decodeURIComponent(c.slice(name.length + 1));
                });
                return v;
            },
            csrfToken() {
                return this.getCookie('csrftoken') ||
                    document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || null;
            },

            savePlaylist() { this._savePlayerState(); },

            loadPlaylist() {
                try {
                    const raw = JSON.parse(localStorage.getItem('currentPlaylist') || '[]');
                    if (!raw.length) return;
                    const numericIds = [], youtubeIds = [];
                    raw.forEach(item => {
                        const id = (typeof item === 'object') ? (item.id || '') : String(item);
                        const ytId = (typeof item === 'object') ? (item.youtube_id || '') : '';
                        if (ytId && /^[A-Za-z0-9_-]{11}$/.test(ytId)) youtubeIds.push(ytId);
                        else if (id && /^[A-Za-z0-9_-]{11}$/.test(id)) youtubeIds.push(id);
                        else if (id && /^\d+$/.test(id)) numericIds.push(id);
                    });
                    const allIds = [...numericIds, ...youtubeIds];
                    if (!allIds.length) return;
                    fetch('/api/musicas/by-ids/?ids=' + allIds.join(','))
                        .then(r => r.json())
                        .then(d => {
                            if (d && d.success && d.musicas) {
                                const tracks = d.musicas.map(m => normalizeTrack(m)).filter(Boolean)
                                    .filter((t, i, arr) => arr.findIndex(x => x.id === t.id) === i);
                                this.$nextTick(() => {
                                    this.playlist = tracks;
                                    this.currentQueue = [...tracks];
                                    this.currentQueueType = 'playlist';
                                    this.openedPlaylistId = null;
                                    this.openedPlaylistName = null;
                                });
                            }
                        }).catch(e => console.error('loadPlaylist fetch error:', e));
                } catch(e) { console.error('loadPlaylist parse error:', e); }
            },

            clearLocalData() {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && (k.startsWith('mdy_') || k === 'currentPlaylist' || k === 'likedTracks')) keys.push(k);
                }
                keys.forEach(k => localStorage.removeItem(k));
                AppCache._mem = {};
                if (this.isPlaying) { this.audio.pause(); this.isPlaying = false; }
                this.playlist = []; this.likedTracks = []; this.currentTrack = null;
                this.currentTrackIndex = -1; this.currentQueue = [];
                this.showNotification('Dados locais apagados', 'info');
            },

            closeTrackDetail() { this.trackDetailOpen = false; },
            closeModal() {
                this.showPlaylistModal = false;
                this.showCreatePlaylistModal = false;
                this.showInlineCreate = false;
                this.panelOpen = false;
                this.trackDetailOpen = false;
                this.bottomSheetActive = false;
                this.queueDrawerActive = false;
            },
            closePanel() {
                this.panelOpen = false;
                this.albumData = null;
                this.albumLoadingId = null;
                this.albumTrackLoadingIndex = -1;
                this.panelContent = '';
            },

            clearSearch() {
                this.query = '';
                this.searchResults = { songs: [], albums: [] };
                this.searchCached = false;
                this.loading = false;
                const url = new URL(window.location);
                url.searchParams.delete('q');
                window.history.replaceState({}, '', url);
                try { sessionStorage.removeItem('lastSearchQuery'); sessionStorage.removeItem('lastSearchResults'); } catch(e) {}
                this.$nextTick(() => { document.querySelector('.search-bar input')?.focus(); });
            },
        };
    }
</script>

{% if messages %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const msgs = [
        {% for m in messages %}
        { text: "{{ m|escapejs }}", tags: "{{ m.tags }}" },
        {% endfor %}
    ];
    function _mapTagToType(tags) {
        if (!tags) return 'success';
        if (tags.indexOf('error') !== -1 || tags.indexOf('danger') !== -1) return 'error';
        if (tags.indexOf('warning') !== -1) return 'error';
        return 'success';
    }
    (function tryShow() {
        if (window.appStore && typeof window.appStore.showNotification === 'function') {
            msgs.forEach(m => { window.appStore.showNotification(m.text, _mapTagToType(m.tags || '')); });
        } else {
            setTimeout(tryShow, 120);
        }
    })();
});
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js" defer></script>
</body>
</html>
