<!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dark Duck Intelligence - Assistente de IA avançado">
    <meta name="theme-color" content="#1a1a2e">
    <title>Dark Duck Intelligence</title>
    
    <!-- Preconnect para performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Prism.js para código -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">

    <style>
        /* ============================================
           CSS CUSTOM PROPERTIES (DESIGN TOKENS)
           ============================================ */
        :root {
            /* Colors - Dark Theme */
            --color-bg-primary: #0f0f1a;
            --color-bg-secondary: #1a1a2e;
            --color-bg-tertiary: #252542;
            --color-bg-elevated: #2d2d4a;
            
            --color-surface: rgba(255, 255, 255, 0.03);
            --color-surface-hover: rgba(255, 255, 255, 0.06);
            --color-surface-active: rgba(255, 255, 255, 0.1);
            
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            
            --color-text-primary: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-text-muted: rgba(255, 255, 255, 0.5);
            --color-text-disabled: rgba(255, 255, 255, 0.3);
            
            /* Accent Colors */
            --color-accent-primary: #8b5cf6;
            --color-accent-secondary: #a78bfa;
            --color-accent-gradient: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #3b82f6 100%);
            --color-accent-glow: rgba(139, 92, 246, 0.4);
            
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 30px var(--color-accent-glow);
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Typography */
            --font-sans: 'Roboto', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
            
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 2rem;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Layout */
            --sidebar-width: 300px;
            --header-height: 64px;
            --input-height: 140px;
            
            /* Z-Index */
            --z-base: 1;
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-overlay: 300;
            --z-modal: 400;
            --z-toast: 500;
        }

        /* Light Theme */
        [data-theme="light"] {
            --color-bg-primary: #f8fafc;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #f1f5f9;
            --color-bg-elevated: #ffffff;
            
            --color-surface: rgba(0, 0, 0, 0.02);
            --color-surface-hover: rgba(0, 0, 0, 0.04);
            --color-surface-active: rgba(0, 0, 0, 0.06);
            
            --color-border: rgba(0, 0, 0, 0.08);
            --color-border-hover: rgba(0, 0, 0, 0.15);
            
            --color-text-primary: #1e293b;
            --color-text-secondary: #475569;
            --color-text-muted: #94a3b8;
            --color-text-disabled: #cbd5e1;
            
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.15);
        }

        /* ============================================
           RESET & BASE STYLES
           ============================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            line-height: 1.6;
            color: var(--color-text-primary);
            background: var(--color-bg-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        a {
            color: var(--color-accent-primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--color-accent-secondary);
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
        }

        input, textarea {
            font-family: inherit;
            font-size: inherit;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-border-hover);
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
        }

        /* Selection */
        ::selection {
            background: var(--color-accent-primary);
            color: white;
        }

        /* ============================================
           ANIMATIONS
           ============================================ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--color-accent-glow); }
            50% { box-shadow: 0 0 40px var(--color-accent-glow); }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* ============================================
           LAYOUT - MAIN STRUCTURE
           ============================================ */
        .app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .app__sidebar {
            width: var(--sidebar-width);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: var(--color-bg-secondary);
            border-right: 1px solid var(--color-border);
            transition: transform var(--transition-base), width var(--transition-base);
            z-index: var(--z-sticky);
        }

        .app__sidebar.is-collapsed {
            transform: translateX(-100%);
            width: 0;
            border: none;
        }

        .app__main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--color-bg-primary);
            position: relative;
        }

        /* Background Pattern */
        .app__main::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* ============================================
           SIDEBAR COMPONENTS
           ============================================ */
        .sidebar {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: var(--space-4);
        }

        /* Sidebar Header */
        .sidebar__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--space-4);
        }

        .sidebar__brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .sidebar__logo {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            object-fit: cover;
            border: 2px solid var(--color-border);
            transition: var(--transition-base);
        }

        .sidebar__logo:hover {
            border-color: var(--color-accent-primary);
            transform: scale(1.05);
        }

        .sidebar__title {
            font-size: var(--text-lg);
            font-weight: 700;
            background: var(--color-accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar__toggle {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            transition: var(--transition-fast);
        }

        .sidebar__toggle:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-primary);
        }

        /* New Chat Button */
        .sidebar__new-chat {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--color-accent-gradient);
            color: white;
            font-weight: 600;
            border-radius: var(--radius-md);
            transition: var(--transition-base);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-4);
        }

        .sidebar__new-chat:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .sidebar__new-chat:active {
            transform: translateY(0);
        }

        /* Search */
        .sidebar__search {
            position: relative;
            margin-bottom: var(--space-4);
        }

        .sidebar__search-icon {
            position: absolute;
            left: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            pointer-events: none;
        }

        .sidebar__search-input {
            width: 100%;
            padding: var(--space-3) var(--space-3) var(--space-3) var(--space-10);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            transition: var(--transition-fast);
        }

        .sidebar__search-input::placeholder {
            color: var(--color-text-muted);
        }

        .sidebar__search-input:focus {
            background: var(--color-surface-hover);
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Filter Buttons */
        .sidebar__filters {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .sidebar__filter-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            font-size: var(--text-xs);
            font-weight: 500;
            transition: var(--transition-fast);
        }

        .sidebar__filter-btn:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-border-hover);
        }

        .sidebar__filter-btn.is-active {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            color: white;
        }

        /* Conversations List */
        .sidebar__conversations {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            margin: 0 calc(var(--space-4) * -1);
            padding: 0 var(--space-4);
        }

        .conversation-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            animation: fadeInUp var(--transition-base) ease-out;
        }

        .conversation-item:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-border);
            transform: translateX(4px);
        }

        .conversation-item.is-active {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .conversation-item.is-active .conversation-item__title,
        .conversation-item.is-active .conversation-item__preview,
        .conversation-item.is-active .conversation-item__meta {
            color: white;
        }

        .conversation-item.is-cancelled {
            opacity: 0.5;
            border-left: 3px solid var(--color-error);
        }

        .conversation-item__avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid var(--color-border);
        }

        .conversation-item__content {
            flex: 1;
            min-width: 0;
        }

        .conversation-item__title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-item__preview {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: var(--space-1);
        }

        .conversation-item__meta {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-top: var(--space-1);
        }

        .conversation-item__delete {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-error);
            color: white;
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            opacity: 0;
            transform: scale(0.8);
            transition: var(--transition-fast);
        }

        .conversation-item:hover .conversation-item__delete {
            opacity: 1;
            transform: scale(1);
        }

        .conversation-item__delete:hover {
            background: #dc2626;
        }

        /* Sidebar Footer */
        .sidebar__footer {
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-border);
            margin-top: auto;
        }

        .sidebar__footer-text {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-align: center;
        }

        .sidebar__footer-brand {
            font-weight: 600;
            color: var(--color-accent-primary);
        }

        /* ============================================
           MAIN CONTENT AREA
           ============================================ */
        .main {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            z-index: var(--z-base);
        }

        /* Header */
        .main__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-6);
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            min-height: var(--header-height);
            position: relative;
            z-index: var(--z-sticky);
        }

        .header__left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .header__toggle {
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            transition: var(--transition-fast);
        }

        .header__toggle:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-primary);
        }

        .header__status {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .header__token-count {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .header__token-count i {
            color: var(--color-accent-primary);
        }

        .header__center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .header__title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            padding: var(--space-2) var(--space-4);
            background: var(--color-surface);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header__title:hover {
            background: var(--color-surface-hover);
        }

        .header__title.is-editing {
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-accent-primary);
        }

        .header__right {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .header__action {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            transition: var(--transition-fast);
        }

        .header__action:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-primary);
        }

        .header__action--share {
            background: var(--color-accent-primary);
            color: white;
        }

        .header__action--share:hover {
            background: var(--color-accent-secondary);
            color: white;
        }

        .header__action--cancel {
            background: var(--color-error);
            color: white;
            display: none;
        }

        .header__action--cancel.is-visible {
            display: flex;
        }

        .header__action--cancel:hover {
            background: #dc2626;
        }

        /* Messages Container */
        .main__messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--space-6);
            padding-bottom: calc(var(--input-height) + var(--space-8));
        }

        .messages {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }

        /* Messages Spacer */
        .messages-spacer {
            height: 200px;
            flex-shrink: 0;
        }

        /* Welcome State */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--space-12);
            animation: fadeIn var(--transition-slow) ease-out;
        }

        .welcome__logo {
            width: 120px;
            height: 120px;
            border-radius: var(--radius-xl);
            object-fit: cover;
            border: 3px solid var(--color-border);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-lg);
            transition: var(--transition-base);
        }

        .welcome__logo:hover {
            transform: scale(1.05);
            border-color: var(--color-accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .welcome__title {
            font-size: var(--text-3xl);
            font-weight: 800;
            background: var(--color-accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
        }

        .welcome__name {
            color: var(--color-accent-primary);
            font-weight: 900;
        }

        .welcome__tokens {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
            font-weight: 600;
        }

        .welcome__subtitle {
            font-size: var(--text-lg);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
        }

        .welcome__suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            width: 100%;
            max-width: 700px;
        }

        .welcome__suggestion {
            padding: var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            text-align: left;
            transition: var(--transition-fast);
            cursor: pointer;
        }

        .welcome__suggestion:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-accent-primary);
            transform: translateY(-2px);
        }

        .welcome__suggestion-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-accent-gradient);
            border-radius: var(--radius-md);
            color: white;
            font-size: var(--text-lg);
            margin-bottom: var(--space-3);
        }

        .welcome__suggestion-title {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-1);
        }

        .welcome__suggestion-desc {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }

        /* Anonymous Notice */
        .anonymous-notice {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            text-align: center;
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            margin-top: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .anonymous-notice i {
            margin-right: var(--space-2);
            color: var(--color-accent-primary);
        }

        /* Message Styles */
        .message {
            display: flex;
            gap: var(--space-2); /* Reduzido de var(--space-3) para aproximar mais */
            animation: fadeInUp var(--transition-base) ease-out;
            margin-bottom: var(--space-1); /* Adicionado margem inferior menor */
        }

        .message--user {
            flex-direction: row-reverse;
        }

        .message__avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-sm);
        }

        .message--user .message__avatar {
            background: var(--color-accent-gradient);
            color: white;
        }

        .message--ai .message__avatar {
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            color: var(--color-text-secondary);
        }

        .message__content {
            max-width: 80%;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .message--user .message__content {
            align-items: flex-end;
        }

        .message__bubble {
            padding: var(--space-3); /* Reduzido de var(--space-4) */
            border-radius: var(--radius-lg);
            line-height: 1.7;
            word-wrap: break-word;
            position: relative;
        }

        .message--user .message__bubble {
            background: var(--color-accent-gradient);
            color: white;
            border-bottom-right-radius: var(--radius-sm);
        }

        .message--ai .message__bubble {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            border-bottom-left-radius: var(--radius-sm);
        }

        /* Code styling in messages */
        .message__bubble pre {
            background: var(--color-surface);
            padding: var(--space-2);
            border-radius: var(--radius-md);
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 0.9em;
            margin: var(--space-2) 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message__bubble code {
            background: var(--color-surface);
            padding: 2px 4px;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.9em;
        }

        .message__bubble pre code {
            background: none;
            padding: 0;
        }

        /* Links in messages */
        .message__bubble a {
            color: var(--color-accent-primary);
            text-decoration: underline;
        }

        .message--user .message__bubble a {
            color: rgba(255, 255, 255, 0.9);
        }

        .message__actions {
            display: flex;
            gap: var(--space-2);
            opacity: 0;
            transition: var(--transition-fast);
        }

        .message:hover .message__actions {
            opacity: 1;
        }

        .message__action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-muted);
            font-size: var(--text-xs);
            transition: var(--transition-fast);
        }

        .message__action:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-primary);
            border-color: var(--color-border-hover);
        }

        .message__action--like.is-active {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        .message__action--dislike.is-active {
            background: var(--color-error);
            border-color: var(--color-error);
            color: white;
        }

        .message__timestamp {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-top: 0;
        }

        .message--ai .message__timestamp {
            text-align: left;
        }

        .message--user .message__timestamp {
            text-align: right;
        }

        /* Code blocks */
        .code-block {
            margin: var(--space-2) 0;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .code-block__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--color-bg-secondary);
            padding: var(--space-1) var(--space-2);
            border-bottom: 1px solid var(--color-border);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        .code-block__language {
            font-weight: 600;
            text-transform: uppercase;
        }

        .code-block__copy {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            font-size: var(--text-sm);
        }

        .code-block__copy:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-primary);
        }

        .code-block__content {
            background: var(--color-surface);
            overflow: hidden;
        }

        .code-block__content pre {
            margin: 0;
            padding: var(--space-2);
            overflow-x: auto;
            font-size: var(--text-sm);
            line-height: 1.5;
        }

        /* Message - Deleted State */
        .message--deleted .message__bubble {
            background: var(--color-surface);
            border: 1px dashed var(--color-border);
            color: var(--color-text-muted);
            font-style: italic;
        }

        /* Loading Indicator */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            animation: fadeIn var(--transition-base);
        }

        .loading-indicator__dots {
            display: flex;
            gap: var(--space-1);
        }

        .loading-indicator__dot {
            width: 8px;
            height: 8px;
            background: var(--color-accent-primary);
            border-radius: var(--radius-full);
            animation: typing 1.4s infinite ease-in-out;
        }

        .loading-indicator__dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-indicator__dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .loading-indicator__text {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        .loading-avatar {
            animation: glow 2s ease-in-out infinite;
            border-radius: 50%;
        }

        .loading-avatar img {
            border-radius: 50%;
        }

        /* ============================================
           INPUT AREA
           ============================================ */
        .main__input {
            position: fixed;
            bottom: 0;
            left: var(--sidebar-width);
            right: 0;
            padding: var(--space-4) var(--space-6);
            background: linear-gradient(to top, var(--color-bg-primary) 80%, transparent);
            z-index: var(--z-sticky);
            transition: left var(--transition-base);
        }

        .app__sidebar.is-collapsed ~ .app__main .main__input {
            left: 0;
        }

        .input-container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* File Preview */
        .input__files {
            display: none;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .input__files.has-files {
            display: flex;
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
        }

        .file-preview__icon {
            color: var(--color-accent-primary);
        }

        .file-preview__name {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-preview__remove {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-error);
            border-radius: var(--radius-full);
            color: white;
            font-size: 10px;
            cursor: pointer;
        }

        /* Input Field */
        .input__field {
            display: flex;
            align-items: flex-end;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-xl);
            transition: var(--transition-fast);
            box-shadow: var(--shadow-lg);
        }

        .input__field:focus-within {
            border-color: var(--color-accent-primary);
            box-shadow: var(--shadow-lg), 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .input__btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            transition: var(--transition-fast);
            flex-shrink: 0;
        }

        .input__btn:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-primary);
        }

        .input__btn--attach {
            color: var(--color-text-muted);
        }

        .input__btn--voice {
            color: var(--color-text-muted);
        }

        .input__btn--voice.is-recording {
            background: var(--color-error);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .input__textarea {
            flex: 1;
            min-height: 24px;
            max-height: 150px;
            padding: var(--space-2) 0;
            background: transparent;
            border: none;
            color: var(--color-text-primary);
            font-size: var(--text-base);
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        .input__textarea::placeholder {
            color: var(--color-text-muted);
        }

        .input__btn--send {
            background: var(--color-accent-gradient);
            color: white;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            display: none;
        }

        .input__btn--send:not(.hidden) {
            display: flex;
        }

        .input__btn--send:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .input__btn--send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input__btn--cancel {
            background: var(--color-error);
            color: white;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            display: none;
        }

        .input__btn--cancel.is-visible {
            display: flex;
        }

        .input__btn--cancel:hover {
            background: var(--color-error-hover);
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        /* Toolbar */
        .input__toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: var(--space-3);
            padding: 0 var(--space-2);
        }

        .toolbar__left {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .toolbar__btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-size: var(--text-xs);
            font-weight: 500;
            transition: var(--transition-fast);
        }

        .toolbar__btn:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-border-hover);
        }

        .toolbar__btn.is-active {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            color: white;
        }

        .toolbar__btn-avatar {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            object-fit: cover;
        }

        .toolbar__right {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* Brand Footer */
        .input__brand {
            text-align: center;
            margin-top: var(--space-3);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        .input__brand-name {
            font-weight: 600;
            color: var(--color-accent-primary);
        }

        /* ============================================
           MODALS
           ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--space-4);
        }

        .modal-overlay.is-open {
            display: flex;
            animation: fadeIn var(--transition-fast);
        }

        .modal {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            overflow: hidden;
            animation: scaleIn var(--transition-base);
        }

        .modal__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--color-border);
        }

        .modal__title {
            font-size: var(--text-lg);
            font-weight: 700;
        }

        .modal__close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            transition: var(--transition-fast);
        }

        .modal__close:hover {
            background: var(--color-error);
            color: white;
        }

        .modal__body {
            padding: var(--space-6);
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal__footer {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--color-border);
        }

        .modal__btn {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-weight: 600;
            transition: var(--transition-fast);
        }

        .modal__btn--secondary {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .modal__btn--secondary:hover {
            background: var(--color-surface-hover);
        }

        .modal__btn--primary {
            background: var(--color-accent-gradient);
            color: white;
        }

        .modal__btn--primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .modal__btn--danger {
            background: var(--color-error);
            color: white;
        }

        .modal__btn--danger:hover {
            background: #dc2626;
        }

        /* Personality Modal */
        .personality-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .personality-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .personality-item:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-border-hover);
        }

        .personality-item.is-selected {
            border-color: var(--color-accent-primary);
            background: rgba(139, 92, 246, 0.1);
        }

        .personality-item__avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            object-fit: cover;
            flex-shrink: 0;
        }

        .personality-item__info {
            flex: 1;
        }

        .personality-item__name {
            font-weight: 600;
            margin-bottom: var(--space-1);
        }

        .personality-item__desc {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }

        /* Share Modal */
        .share-input-group {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .share-input {
            flex: 1;
            padding: var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: var(--text-sm);
        }

        .share-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-2);
        }

        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            font-weight: 500;
            color: white;
            transition: var(--transition-fast);
        }

        .share-btn:hover {
            transform: translateY(-2px);
        }

        .share-btn--whatsapp { background: #25d366; }
        .share-btn--twitter { background: #1da1f2; }
        .share-btn--facebook { background: #1877f2; }
        .share-btn--copy { 
            background: var(--color-surface);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        /* Link Redirect Modal Styles */
        .link-preview {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            overflow: hidden;
        }

        .link-preview__icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-accent-gradient);
            border-radius: var(--radius-md);
            color: white;
            font-size: var(--text-xl);
            flex-shrink: 0;
        }

        .link-preview__content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .link-preview__url {
            font-size: var(--text-sm);
            color: var(--color-accent-primary);
            word-break: break-all;
            line-height: 1.4;
        }

        .link-preview__domain {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .link-warning {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3);
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-md);
            color: var(--color-warning);
            font-size: var(--text-sm);
        }

        .link-warning i {
            font-size: var(--text-lg);
        }

        /* ============================================
           TOAST NOTIFICATIONS
           ============================================ */
        .toast-container {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            z-index: var(--z-toast);
        }

        .toast {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            animation: slideInRight var(--transition-base);
            min-width: 300px;
        }

        .toast--success {
            border-left: 4px solid var(--color-success);
        }

        .toast--error {
            border-left: 4px solid var(--color-error);
        }

        .toast--warning {
            border-left: 4px solid var(--color-warning);
        }

        .toast--info {
            border-left: 4px solid var(--color-info);
        }

        .toast__icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .toast--success .toast__icon {
            background: rgba(16, 185, 129, 0.2);
            color: var(--color-success);
        }

        .toast--error .toast__icon {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-error);
        }

        .toast__content {
            flex: 1;
        }

        .toast__title {
            font-weight: 600;
            margin-bottom: var(--space-1);
        }

        .toast__message {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        .toast__close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .toast__close:hover {
            background: var(--color-surface);
            color: var(--color-text-primary);
        }

        /* ============================================
           CODE BLOCKS
           ============================================ */
        .code-block {
            margin: var(--space-4) 0;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: #1e1e2e;
            border: 1px solid var(--color-border);
        }

        .code-block__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--color-border);
        }

        .code-block__language {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-accent-primary);
        }

        .code-block__actions {
            display: flex;
            gap: var(--space-2);
        }

        .code-block__btn {
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface);
            border-radius: var(--radius-sm);
            color: var(--color-text-secondary);
            font-size: var(--text-xs);
            display: flex;
            align-items: center;
            gap: var(--space-1);
            transition: var(--transition-fast);
        }

        .code-block__btn:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-primary);
        }

        .code-block__btn.is-copied {
            background: var(--color-success);
            color: white;
        }

        .code-block__content {
            padding: var(--space-4);
            overflow-x: auto;
        }

        .code-block__content pre {
            margin: 0;
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            line-height: 1.6;
        }

        .code-block__content code {
            font-family: inherit;
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 280px;
            }
        }

        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
            }

            .app__sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: var(--z-overlay);
                transform: translateX(-100%);
                width: 85%;
                max-width: 320px;
            }

            .app__sidebar.is-open {
                transform: translateX(0);
            }

            .sidebar-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: calc(var(--z-overlay) - 1);
                display: none;
            }

            .sidebar-backdrop.is-visible {
                display: block;
                animation: fadeIn var(--transition-fast);
            }

            .header__toggle {
                display: flex;
            }

            .header__center {
                position: static;
                transform: none;
                flex: 1;
                margin: 0 var(--space-3);
            }

            .header__title {
                max-width: none;
                font-size: var(--text-base);
            }

            .main__input {
                left: 0;
                padding: var(--space-3);
            }

            .input__toolbar {
                flex-wrap: wrap;
                gap: var(--space-2);
            }

            .toolbar__left {
                flex-wrap: wrap;
                width: 100%;
                justify-content: center;
            }

            .message__content {
                max-width: 90%;
            }

            .welcome__suggestions {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }

            .welcome__suggestion {
                padding: var(--space-3);
            }

            .modal {
                max-width: none;
                margin: var(--space-4);
                max-height: calc(100vh - var(--space-8));
            }

            .toast-container {
                left: var(--space-4);
                right: var(--space-4);
                bottom: var(--space-4);
            }

            .toast {
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            .main__header {
                padding: var(--space-3);
            }

            .main__messages {
                padding: var(--space-4);
            }

            .message {
                gap: var(--space-2);
            }

            .message__avatar {
                width: 32px;
                height: 32px;
            }

            .message__bubble {
                padding: var(--space-3);
                font-size: var(--text-base);
            }

            .message__content {
                max-width: 95%;
            }

            .input__field {
                padding: var(--space-2);
                border-radius: var(--radius-lg);
            }

            .input__btn {
                width: 44px;
                height: 44px;
            }

            .header__action {
                width: 44px;
                height: 44px;
            }

            .toolbar__btn {
                padding: var(--space-3);
                font-size: var(--text-sm);
            }

            .welcome__logo {
                width: 100px;
                height: 100px;
            }

            .welcome__title {
                font-size: var(--text-2xl);
            }

            .welcome__subtitle {
                font-size: var(--text-base);
            }
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .hidden { display: none !important; }
        .invisible { visibility: hidden; }

        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }

        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }

        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-bounce { animation: bounce 1s infinite; }
    </style>
</head>
<body>
    <!-- App Container -->
    <div class="app" id="app">
        <!-- Sidebar -->
        <aside class="app__sidebar" id="sidebar">
            <div class="sidebar">
                <!-- Sidebar Header -->
                <header class="sidebar__header">
                    <div class="sidebar__brand">
                        <img src="/static/logo1.jpg" alt="Dark Duck Logo" class="sidebar__logo" id="sidebarLogo">
                        <span class="sidebar__title">Dark Duck AI</span>
                    </div>
                    <button class="sidebar__toggle" id="sidebarToggle" aria-label="Fechar menu">
                        <i class="fas fa-times"></i>
                    </button>
                </header>

                <!-- New Chat Button -->
                <button class="sidebar__new-chat" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                    <span>Nova Conversa</span>
                </button>

                <!-- Search -->
                <div class="sidebar__search">
                    <i class="fas fa-search sidebar__search-icon"></i>
                    <input 
                        type="text" 
                        class="sidebar__search-input" 
                        id="searchInput"
                        placeholder="Buscar conversas..."
                        autocomplete="off"
                    >
                </div>

                <!-- Filters -->
                <div class="sidebar__filters">
                    <button class="sidebar__filter-btn is-active" id="filterMyConversations" data-filter="my">
                        <i class="fas fa-user"></i>
                        <span>Minhas</span>
                    </button>
                    <button class="sidebar__filter-btn" id="filterAnonymous" data-filter="anonymous">
                        <i class="fas fa-user-secret"></i>
                        <span>Anônimas</span>
                    </button>
                </div>

                <!-- Conversations List -->
                <div class="sidebar__conversations" id="conversationsContainer">
                    <ul class="conversation-list" id="conversationList">
                        <!-- Conversations will be loaded here -->
                    </ul>
                    
                    <!-- Loading State -->
                    <div class="loading-indicator hidden" id="conversationsLoading">
                        <div class="loading-indicator__dots">
                            <span class="loading-indicator__dot"></span>
                            <span class="loading-indicator__dot"></span>
                            <span class="loading-indicator__dot"></span>
                        </div>
                        <span class="loading-indicator__text">Carregando...</span>
                    </div>
                </div>

                <!-- Sidebar Footer -->
                <footer class="sidebar__footer">
                    <p class="sidebar__footer-text">
                        <span class="sidebar__footer-brand">Dark Duck Intelligence™</span>
                    </p>
                </footer>
            </div>
        </aside>

        <!-- Sidebar Backdrop (Mobile) -->
        <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

        <!-- Main Content -->
        <div class="app__main">
            <div class="main">
                <!-- Header -->
                <header class="main__header" id="mainHeader">
                    <div class="header__left">
                        <button class="header__toggle" id="menuToggle" aria-label="Abrir menu">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="header__status">
                            <span class="header__token-count" id="tokenCount">
                                <i class="fas fa-coins"></i>
                                <span id="tokenCountValue">Ilimitado</span>
                            </span>
                        </div>
                    </div>

                    <div class="header__center">
                        <h1 class="header__title" id="conversationTitle" title="Clique para editar">
                            Inicie uma conversa
                        </h1>
                    </div>

                    <div class="header__right">
                        <button class="header__action header__action--share hidden" id="shareBtn" aria-label="Compartilhar">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="header__action" id="themeToggle" aria-label="Alternar tema">
                            <i class="fas fa-moon" id="themeIcon"></i>
                        </button>
                    </div>
                </header>

                <!-- Messages -->
                <div class="main__messages" id="messagesContainer">
                    <div class="messages" id="messagesList">
                        <!-- Welcome State -->
                        <div class="welcome" id="welcomeState">
                            <img src="/static/logo1.jpg" alt="Dark Duck" class="welcome__logo">
                            <h2 class="welcome__title">Olá! Sou o <span class="welcome__name">Dark Duck</span></h2>
                            <p class="welcome__subtitle">Como posso ajudar você hoje?</p>
                            <p class="welcome__tokens">Tokens: Ilimitado</p>
                            
                            <div class="welcome__suggestions">
   



                                <button class="welcome__suggestion" data-suggestion="Tire minhas dúvidas">
                                    <div class="welcome__suggestion-icon">
                                        <i class="fas fa-lightbulb"></i>
                                    </div>
                                    <div class="welcome__suggestion-title">Perguntas</div>
                                    <div class="welcome__suggestion-desc">Tire dúvidas sobre qualquer assunto</div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Anonymous Notice -->
                    <div class="anonymous-notice" id="anonymousNotice" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        Esta conversa é de um usuário anônimo. Você pode visualizá-la, mas não pode responder.
                    </div>
                </div>

                <!-- Input Area -->
                <footer class="main__input" id="inputArea">
                    <div class="input-container">
                        <!-- File Previews -->
                        <div class="input__files" id="filePreviews"></div>

                        <!-- Input Field -->
                        <div class="input__field" id="inputField">
                            <button class="input__btn input__btn--attach" id="attachBtn" type="button" aria-label="Anexar arquivo">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="file" id="fileInput" multiple hidden>

                            <textarea 
                                class="input__textarea" 
                                id="messageInput"
                                placeholder="Digite sua mensagem..."
                                rows="1"
                                maxlength="10000"
                            ></textarea>

                            <button class="input__btn input__btn--cancel" id="cancelResponseBtn" type="button" aria-label="Cancelar resposta">
                                <i class="fas fa-stop"></i>
                            </button>

                            <button class="input__btn input__btn--voice" id="voiceBtn" type="button" aria-label="Gravar áudio">
                                <i class="fas fa-microphone"></i>
                            </button>

                            <button class="input__btn input__btn--send" id="sendBtn" type="button" aria-label="Enviar mensagem">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <!-- Toolbar -->
                        <div class="input__toolbar">
                            <div class="toolbar__left">
                                <button class="toolbar__btn" id="personalityBtn">
                                    <img src="/static/logo1.jpg" alt="" class="toolbar__btn-avatar" id="personalityAvatar">
                                    <span id="personalityName">DUCK-PRO-02</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                
                                <button class="toolbar__btn" id="webSearchBtn">
                                    <i class="fas fa-globe"></i>
                                    <span>Web</span>
                                </button>
                                
                                <button class="toolbar__btn" id="clearChatBtn">
                                    <i class="fas fa-trash-alt"></i>
                                    <span>Limpar</span>
                                </button>
                            </div>

                           
                        </div>


                    </div>
                </footer>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <header class="modal__header">
                <h2 class="modal__title">Compartilhar Conversa</h2>
                <button class="modal__close" id="shareModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </header>
            <div class="modal__body">
                <div class="share-input-group">
                    <input type="text" class="share-input" id="shareLink" readonly>
                    <button class="modal__btn modal__btn--primary" id="copyShareLink">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="share-buttons">
                    <button class="share-btn share-btn--whatsapp" data-platform="whatsapp">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="share-btn share-btn--twitter" data-platform="twitter">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                    <button class="share-btn share-btn--facebook" data-platform="facebook">
                        <i class="fab fa-facebook"></i> Facebook
                    </button>
                    <button class="share-btn share-btn--copy" data-platform="copy">
                        <i class="fas fa-link"></i> Copiar Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Personality Modal -->
    <div class="modal-overlay" id="personalityModal">
        <div class="modal">
            <header class="modal__header">
                <h2 class="modal__title">Escolher Modelo</h2>
                <button class="modal__close" id="personalityModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </header>
            <div class="modal__body">
                <div class="personality-list" id="personalityList">
                    <!-- Personalities will be loaded here -->
                </div>
            </div>
            <footer class="modal__footer">
                <button class="modal__btn modal__btn--secondary" id="personalityModalCancel">
                    Cancelar
                </button>
            </footer>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <header class="modal__header">
                <h2 class="modal__title">Excluir Conversa</h2>
                <button class="modal__close" id="deleteModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </header>
            <div class="modal__body">
                <p>Tem certeza que deseja excluir esta conversa?</p>
                <p style="margin-top: var(--space-2); color: var(--color-text-muted); font-size: var(--text-sm);">
                    Esta ação não pode ser desfeita.
                </p>
            </div>
            <footer class="modal__footer">
                <button class="modal__btn modal__btn--secondary" id="deleteModalCancel">
                    Cancelar
                </button>
                <button class="modal__btn modal__btn--danger" id="deleteModalConfirm">
                    <i class="fas fa-trash-alt"></i> Excluir
                </button>
            </footer>
        </div>
    </div>

    <!-- Clear Chat Modal -->
    <div class="modal-overlay" id="clearChatModal">
        <div class="modal">
            <header class="modal__header">
                <h2 class="modal__title">Limpar Conversa</h2>
                <button class="modal__close" id="clearChatModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </header>
            <div class="modal__body">
                <p>Tem certeza que deseja limpar todas as mensagens desta conversa?</p>
            </div>
            <footer class="modal__footer">
                <button class="modal__btn modal__btn--secondary" id="clearChatModalCancel">
                    Cancelar
                </button>
                <button class="modal__btn modal__btn--danger" id="clearChatModalConfirm">
                    <i class="fas fa-trash-alt"></i> Limpar
                </button>
            </footer>
        </div>
    </div>

    <!-- Voice Recording Modal -->
    <div class="modal-overlay" id="voiceModal">
        <div class="modal">
            <header class="modal__header">
                <h2 class="modal__title">Gravação de Voz</h2>
                <button class="modal__close" id="voiceModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </header>
            <div class="modal__body text-center">
                <div style="margin-bottom: var(--space-6);">
                    <i class="fas fa-microphone" style="font-size: 48px; color: var(--color-accent-primary);"></i>
                </div>
                <canvas id="voiceCanvas" width="400" height="100" style="width: 100%; background: var(--color-surface); border-radius: var(--radius-md);"></canvas>
                <p id="voiceTranscript" style="margin-top: var(--space-4); min-height: 50px; color: var(--color-text-secondary);">
                    Clique em iniciar para gravar...
                </p>
            </div>
            <footer class="modal__footer" style="justify-content: center;">
                <button class="modal__btn modal__btn--primary" id="startVoiceBtn">
                    <i class="fas fa-play"></i> Iniciar
                </button>
                <button class="modal__btn modal__btn--danger hidden" id="stopVoiceBtn">
                    <i class="fas fa-stop"></i> Parar
                </button>
                <button class="modal__btn modal__btn--primary hidden" id="sendVoiceBtn">
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </footer>
        </div>
    </div>

    <!-- Link Redirect Modal -->
    <div class="modal-overlay" id="linkRedirectModal">
        <div class="modal">
            <header class="modal__header">
                <h2 class="modal__title">
                    <i class="fas fa-external-link-alt" style="margin-right: var(--space-2); color: var(--color-warning);"></i>
                    Link Externo
                </h2>
                <button class="modal__close" id="linkRedirectModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </header>
            <div class="modal__body">
                <p style="margin-bottom: var(--space-4);">Você está prestes a ser redirecionado para um link externo:</p>
                <div class="link-preview" id="linkPreviewContainer">
                    <div class="link-preview__icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="link-preview__content">
                        <span class="link-preview__url" id="linkPreviewUrl"></span>
                        <span class="link-preview__domain" id="linkPreviewDomain"></span>
                    </div>
                </div>
                <div class="link-warning">
                    <i class="fas fa-shield-alt"></i>
                    <span>Verifique se você confia neste site antes de continuar.</span>
                </div>
            </div>
            <footer class="modal__footer">
                <button class="modal__btn modal__btn--secondary" id="linkRedirectCancel">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <button class="modal__btn modal__btn--primary" id="linkRedirectConfirm">
                    <i class="fas fa-external-link-alt"></i> Continuar
                </button>
            </footer>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
        /**
         * Dark Duck Intelligence - Modern Chat Application
         * Version 2.0 - Complete Rewrite
         */

        // ============================================
        // APP STATE
        // ============================================
        const AppState = {
            currentConversationId: null,
            currentPersonality: null,
            isLoading: false,
            isRecording: false,
            webSearchEnabled: false,
            attachedFiles: [],
            conversations: [],
            personalities: [],
            theme: localStorage.getItem('theme') || 'dark',
            csrfToken: '{{ csrf_token }}',
            isConversationOwner: true,
            conversationOwnerName: '',
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const DOM = {
            // App Structure
            app: document.getElementById('app'),
            sidebar: document.getElementById('sidebar'),
            sidebarBackdrop: document.getElementById('sidebarBackdrop'),
            
            // Sidebar Elements
            sidebarToggle: document.getElementById('sidebarToggle'),
            menuToggle: document.getElementById('menuToggle'),
            newChatBtn: document.getElementById('newChatBtn'),
            searchInput: document.getElementById('searchInput'),
            conversationList: document.getElementById('conversationList'),
            conversationsLoading: document.getElementById('conversationsLoading'),
            filterMyConversations: document.getElementById('filterMyConversations'),
            filterAnonymous: document.getElementById('filterAnonymous'),
            
            // Main Header
            conversationTitle: document.getElementById('conversationTitle'),
            tokenCount: document.getElementById('tokenCountValue'),
            cancelResponseBtn: document.getElementById('cancelResponseBtn'),
            shareBtn: document.getElementById('shareBtn'),
            themeToggle: document.getElementById('themeToggle'),
            themeIcon: document.getElementById('themeIcon'),
            
            // Messages
            messagesContainer: document.getElementById('messagesContainer'),
            messagesList: document.getElementById('messagesList'),
            welcomeState: document.getElementById('welcomeState'),
            
            // Input
            inputField: document.getElementById('inputField'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            attachBtn: document.getElementById('attachBtn'),
            fileInput: document.getElementById('fileInput'),
            filePreviews: document.getElementById('filePreviews'),
            voiceBtn: document.getElementById('voiceBtn'),
            
            // Toolbar
            personalityBtn: document.getElementById('personalityBtn'),
            personalityAvatar: document.getElementById('personalityAvatar'),
            personalityName: document.getElementById('personalityName'),
            webSearchBtn: document.getElementById('webSearchBtn'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            
            // Modals
            shareModal: document.getElementById('shareModal'),
            shareLink: document.getElementById('shareLink'),
            personalityModal: document.getElementById('personalityModal'),
            personalityList: document.getElementById('personalityList'),
            deleteModal: document.getElementById('deleteModal'),
            clearChatModal: document.getElementById('clearChatModal'),
            voiceModal: document.getElementById('voiceModal'),
            voiceCanvas: document.getElementById('voiceCanvas'),
            voiceTranscript: document.getElementById('voiceTranscript'),
            linkRedirectModal: document.getElementById('linkRedirectModal'),
            linkPreviewUrl: document.getElementById('linkPreviewUrl'),
            linkPreviewDomain: document.getElementById('linkPreviewDomain'),
            
            // Toast
            toastContainer: document.getElementById('toastContainer'),
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const Utils = {
            // Format date
            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },
            
            // Debounce function
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // Escape HTML
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            // Generate unique ID
            generateId() {
                return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            },
            
            // Truncate text
            truncate(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },
            
            // Auto-resize textarea
            autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            },
        };

        // ============================================
        // API SERVICE
        // ============================================
        const API = {
            async fetch(url, options = {}) {
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': AppState.csrfToken,
                    },
                };
                
                const response = await fetch(url, { ...defaultOptions, ...options });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            },
            
            // Conversations
            async getConversations(filter = 'my') {
                // Usar query parameter para filtrar
                const onlyMine = filter === 'my' ? 'true' : 'false';
                return this.fetch(`/api/conversas/?only_mine=${onlyMine}`);
            },
            
            async getConversation(id) {
                return this.fetch(`/api/conversa/${id}/`);
            },
            
            async deleteConversation(id) {
                return this.fetch(`/api/conversa/${id}/cancelar/`, {
                    method: 'POST',
                });
            },
            
            async updateConversationTitle(id, title) {
                return this.fetch(`/api/conversa/${id}/titulo/`, {
                    method: 'POST',
                    body: JSON.stringify({ titulo: title }),
                });
            },
            
            async clearConversation(id) {
                return this.fetch(`/api/conversa/${id}/limpar/`, {
                    method: 'POST',
                });
            },
            
            // Messages
            async sendMessage(conversationId, message, files = [], webSearch = false) {
                const formData = new FormData();
                formData.append('mensagem', message);
                formData.append('busca_web', webSearch ? 'true' : 'false');
                if (conversationId) {
                    formData.append('conversa_id', conversationId);
                }
                formData.append('personalidade', AppState.currentPersonality?.nome || '');
                
                files.forEach(file => {
                    formData.append('arquivos', file);
                });
                
                // Usar o endpoint de streaming
                return fetch('/api/chat/stream/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': AppState.csrfToken,
                    },
                    body: formData,
                });
            },
            
            async deleteMessage(conversationId, messageId) {
                return this.fetch(`/api/mensagem/${messageId}/excluir/`, {
                    method: 'POST',
                });
            },
            
            // Personalities
            async getPersonalities() {
                return this.fetch('/api/personalidades/');
            },
            
            async setPersonality(conversationId, personalityId) {
                return this.fetch(`/api/conversa/${conversationId}/personalidade/`, {
                    method: 'POST',
                    body: JSON.stringify({ personalidade_id: personalityId }),
                });
            },
        };

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        const Toast = {
            show(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast toast--${type}`;
                
                const icons = {
                    success: 'fa-check',
                    error: 'fa-times',
                    warning: 'fa-exclamation',
                    info: 'fa-info',
                };
                
                toast.innerHTML = `
                    <span class="toast__icon">
                        <i class="fas ${icons[type]}"></i>
                    </span>
                    <div class="toast__content">
                        <p class="toast__message">${message}</p>
                    </div>
                    <button class="toast__close">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                DOM.toastContainer.appendChild(toast);
                
                const closeBtn = toast.querySelector('.toast__close');
                closeBtn.addEventListener('click', () => this.remove(toast));
                
                if (duration > 0) {
                    setTimeout(() => this.remove(toast), duration);
                }
                
                return toast;
            },
            
            remove(toast) {
                toast.style.animation = 'fadeIn 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            },
            
            success(message) { return this.show(message, 'success'); },
            error(message) { return this.show(message, 'error'); },
            warning(message) { return this.show(message, 'warning'); },
            info(message) { return this.show(message, 'info'); },
        };

        // ============================================
        // MODAL MANAGER
        // ============================================
        const Modal = {
            open(modalElement) {
                modalElement.classList.add('is-open');
                document.body.style.overflow = 'hidden';
            },
            
            close(modalElement) {
                modalElement.classList.remove('is-open');
                document.body.style.overflow = '';
            },
            
            setupCloseHandlers(modalElement, closeSelectors) {
                closeSelectors.forEach(selector => {
                    const element = modalElement.querySelector(selector) || document.getElementById(selector.replace('#', ''));
                    if (element) {
                        element.addEventListener('click', () => this.close(modalElement));
                    }
                });
                
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        this.close(modalElement);
                    }
                });
            },
        };

        // ============================================
        // SIDEBAR CONTROLLER
        // ============================================
        const Sidebar = {
            init() {
                this.bindEvents();
                this.loadConversations();
            },
            
            bindEvents() {
                // Toggle sidebar
                DOM.sidebarToggle.addEventListener('click', () => this.close());
                DOM.menuToggle.addEventListener('click', () => this.open());
                DOM.sidebarBackdrop.addEventListener('click', () => this.close());
                
                // New chat
                DOM.newChatBtn.addEventListener('click', () => this.createNewConversation());
                
                // Search
                DOM.searchInput.addEventListener('input', Utils.debounce((e) => {
                    this.filterConversations(e.target.value);
                }, 300));
                
                // Filters
                DOM.filterMyConversations.addEventListener('click', () => this.setFilter('my'));
                DOM.filterAnonymous.addEventListener('click', () => this.setFilter('anonymous'));
            },
            
            open() {
                DOM.sidebar.classList.add('is-open');
                DOM.sidebarBackdrop.classList.add('is-visible');
            },
            
            close() {
                DOM.sidebar.classList.remove('is-open');
                DOM.sidebarBackdrop.classList.remove('is-visible');
            },
            
            async loadConversations(filter = 'my') {
                try {
                    DOM.conversationsLoading.classList.remove('hidden');
                    DOM.conversationList.innerHTML = '';
                    
                    const data = await API.getConversations(filter);
                    AppState.conversations = data.conversas || [];
                    
                    this.renderConversations(AppState.conversations);
                } catch (error) {
                    console.error('Error loading conversations:', error);
                    Toast.error('Erro ao carregar conversas');
                } finally {
                    DOM.conversationsLoading.classList.add('hidden');
                }
            },
            
            renderConversations(conversations) {
                if (conversations.length === 0) {
                    DOM.conversationList.innerHTML = `
                        <li style="text-align: center; padding: var(--space-6); color: var(--color-text-muted);">
                            <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: var(--space-3); display: block;"></i>
                            Nenhuma conversa encontrada
                        </li>
                    `;
                    return;
                }
                
                DOM.conversationList.innerHTML = conversations.map(conv => `
                    <li class="conversation-item ${conv.cancelled ? 'is-cancelled' : ''} ${conv.id === AppState.currentConversationId ? 'is-active' : ''}" 
                        data-id="${conv.id}">
                        <img src="${conv.personalidade_imagem || '/static/logo1.jpg'}" 
                             alt="" class="conversation-item__avatar">
                        <div class="conversation-item__content">
                            <h3 class="conversation-item__title">${Utils.escapeHtml(conv.titulo || 'Nova Conversa')}</h3>
                            <p class="conversation-item__preview">${Utils.escapeHtml(Utils.truncate(conv.ultima_mensagem || '', 50))}</p>
                            <span class="conversation-item__meta">${Utils.formatDate(conv.atualizado_em)} • ${conv.token_count ? `${conv.token_count} tokens` : 'Ilimitado'}</span>
                        </div>
                        <button class="conversation-item__delete" data-id="${conv.id}" title="Excluir">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </li>
                `).join('');
                
                // Bind click events
                DOM.conversationList.querySelectorAll('.conversation-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.conversation-item__delete')) {
                            Chat.loadConversation(item.dataset.id);
                        }
                    });
                });
                
                DOM.conversationList.querySelectorAll('.conversation-item__delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.confirmDelete(btn.dataset.id);
                    });
                });
            },
            
            filterConversations(query) {
                const filtered = AppState.conversations.filter(conv => 
                    conv.titulo?.toLowerCase().includes(query.toLowerCase()) ||
                    conv.ultima_mensagem?.toLowerCase().includes(query.toLowerCase())
                );
                this.renderConversations(filtered);
            },
            
            setFilter(filter) {
                DOM.filterMyConversations.classList.toggle('is-active', filter === 'my');
                DOM.filterAnonymous.classList.toggle('is-active', filter === 'anonymous');
                this.loadConversations(filter);
            },
            
            async createNewConversation() {
                // Apenas redirecionar para a página inicial
                window.location.href = '/';
            },
            
            confirmDelete(conversationId) {
                AppState.conversationToDelete = conversationId;
                Modal.open(DOM.deleteModal);
            },
            
            async deleteConversation(conversationId) {
                try {
                    await API.deleteConversation(conversationId);
                    
                    if (AppState.currentConversationId === conversationId) {
                        Chat.showWelcome();
                    }
                    
                    await this.loadConversations();
                    Toast.success('Conversa excluída');
                } catch (error) {
                    console.error('Error deleting conversation:', error);
                    Toast.error('Erro ao excluir conversa');
                }
            },
            
            setActiveConversation(conversationId) {
                DOM.conversationList.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.toggle('is-active', item.dataset.id === conversationId);
                });
            },
        };

        // ============================================
        // CHAT CONTROLLER
        // ============================================
        const Chat = {
            init() {
                this.bindEvents();
                this.loadPersonalities();
            },
            
            bindEvents() {
                // Message input
                DOM.messageInput.addEventListener('input', () => {
                    Utils.autoResize(DOM.messageInput);
                    this.updateInputButtons();
                });
                
                // Inicializar estado dos botões
                this.updateInputButtons();
                
                DOM.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Send button
                DOM.sendBtn.addEventListener('click', () => this.sendMessage());
                
                // Cancel response
                DOM.cancelResponseBtn.addEventListener('click', () => this.cancelResponse());
                
                // File attachment
                DOM.attachBtn.addEventListener('click', () => DOM.fileInput.click());
                DOM.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                
                // Voice recording
                DOM.voiceBtn.addEventListener('click', () => Modal.open(DOM.voiceModal));
                
                // Toolbar buttons
                DOM.personalityBtn.addEventListener('click', () => Modal.open(DOM.personalityModal));
                DOM.webSearchBtn.addEventListener('click', () => this.toggleWebSearch());
                DOM.clearChatBtn.addEventListener('click', () => Modal.open(DOM.clearChatModal));
                
                // Share button
                DOM.shareBtn.addEventListener('click', () => this.showShareModal());
                
                // Welcome suggestions
                document.querySelectorAll('.welcome__suggestion').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const suggestion = btn.dataset.suggestion;
                        DOM.messageInput.value = suggestion;
                        Utils.autoResize(DOM.messageInput);
                        DOM.messageInput.focus();
                    });
                });
                
                // Title editing
                DOM.conversationTitle.addEventListener('click', () => this.editTitle());
            },
            
            async loadConversation(conversationId) {
                try {
                    AppState.isLoading = true;
                    AppState.currentConversationId = conversationId;
                    
                    const data = await API.getConversation(conversationId);
                    
                    // Update state
                    AppState.isConversationOwner = data.is_owner !== false;
                    AppState.conversationOwnerName = data.owner_name || '';
                    
                    // Update UI
                    DOM.conversationTitle.textContent = data.titulo || 'Nova Conversa';
                    DOM.shareBtn.classList.remove('hidden');
                    DOM.tokenCount.textContent = data.token_count ? `${data.token_count} tokens` : 'Ilimitado';
                    
                    // Render messages
                    this.renderMessages(data.mensagens || []);
                    
                    // Update sidebar
                    Sidebar.setActiveConversation(conversationId);
                    Sidebar.close();
                    
                    // Update personality
                    if (data.personalidade) {
                        this.setPersonality(data.personalidade);
                    }

                    // --- NOVO: esconder input se não for dono ou se cancelada ---
                    const inputArea = document.getElementById('inputArea');
                    if (inputArea) {
                        if (!data.is_owner || data.excluida) {
                            inputArea.style.display = 'none';
                        } else {
                            inputArea.style.display = '';
                        }
                    }

                    // --- NOVO: mostrar aviso se não for dono ---
                    const anonymousNotice = document.getElementById('anonymousNotice');
                    if (anonymousNotice) {
                        if (!data.is_owner) {
                            anonymousNotice.style.display = 'block';
                        } else {
                            anonymousNotice.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    Toast.error('Erro ao carregar conversa');
                    this.showWelcome();
                } finally {
                    AppState.isLoading = false;
                }
            },
            
            renderMessages(messages) {
                DOM.welcomeState.classList.add('hidden');
                
                // Mostrar welcome state se não há mensagens (página inicial ou conversa vazia)
                if (messages.length === 0) {
                    DOM.messagesList.innerHTML = '';
                    DOM.welcomeState.classList.remove('hidden');
                    DOM.messagesList.appendChild(DOM.welcomeState);
                    return;
                }
                
                DOM.messagesList.innerHTML = messages.map(msg => this.createMessageHTML(msg)).join('');
                
                // Wrap code blocks for existing messages
                DOM.messagesList.querySelectorAll('pre').forEach(pre => {
                    if (pre.querySelector('code') && !pre.closest('.code-block')) {
                        const code = pre.querySelector('code');
                        const lang = code.className.match(/language-(\w+)/)?.[1] || 'code';
                        const codeBlock = document.createElement('div');
                        codeBlock.className = 'code-block';
                        codeBlock.innerHTML = `
                            <div class="code-block__header">
                                <span class="code-block__language">${lang.toUpperCase()}</span>
                                <button class="code-block__copy" title="Copiar código"><i class="fas fa-copy"></i></button>
                            </div>
                            <div class="code-block__content">
                                ${pre.outerHTML}
                            </div>
                        `;
                        pre.replaceWith(codeBlock);
                    }
                });
                
                // Garantir que o espaçador esteja sempre no final
                this.ensureSpacerAtEnd();
                
                // Scroll to bottom
                this.scrollToBottom();
                
                // Scroll to bottom
                this.scrollToBottom();
                
                // Process code blocks
                this.processCodeBlocks();
                
                // Bind message actions
                this.bindMessageActions();
            },
            
            createMessageHTML(msg) {
                const isUser = msg.papel === 'user';
                const timestamp = Utils.formatDate(msg.criado_em);
                
                if (msg.excluida) {
                    const avatarContent = isUser 
                        ? '<i class="fas fa-user"></i>' 
                        : `<img src="${AppState.currentPersonality?.imagem || '/static/logo1.jpg'}" alt="AI" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    return `
                        <div class="message message--${isUser ? 'user' : 'ai'} message--deleted" data-id="${msg.id}">
                            <div class="message__avatar">
                                ${avatarContent}
                            </div>
                            <div class="message__content">
                                <div class="message__bubble">
                                    <i class="fas fa-trash-alt"></i> Esta mensagem foi excluída
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                const avatarContent = isUser 
                    ? '<i class="fas fa-user"></i>' 
                    : `<img src="${msg.personalidade_imagem || AppState.currentPersonality?.imagem || '/static/logo1.jpg'}" alt="AI" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                
                return `
                    <div class="message message--${isUser ? 'user' : 'ai'}" data-id="${msg.id}">
                        <div class="message__avatar">
                            ${avatarContent}
                        </div>
                        <div class="message__content">
                            <div class="message__bubble">${msg.texto_html || Utils.escapeHtml(msg.texto_raw || '')}</div>
                            <div class="message__actions">
                                <button class="message__action message__action--copy" title="Copiar">
                                    <i class="fas fa-copy"></i>
                                </button>
                                ${!isUser ? `
                                    <button class="message__action message__action--like" title="Gostei">
                                        <i class="fas fa-thumbs-up"></i>
                                    </button>
                                    <button class="message__action message__action--dislike" title="Não gostei">
                                        <i class="fas fa-thumbs-down"></i>
                                    </button>
                                ` : ''}
                                ${AppState.isConversationOwner ? `
                                    <button class="message__action message__action--delete" title="Excluir">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                ` : ''}
                            </div>
                            <span class="message__timestamp">${timestamp}</span>
                        </div>
                    </div>
                `;
            },
            
            bindMessageActions() {
                // Copy action
                DOM.messagesList.querySelectorAll('.message__action--copy').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const message = e.target.closest('.message');
                        const text = message.querySelector('.message__bubble').textContent;
                        navigator.clipboard.writeText(text);
                        Toast.success('Copiado!');
                    });
                });
                
                // Delete action
                DOM.messagesList.querySelectorAll('.message__action--delete').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const message = e.target.closest('.message');
                        const messageId = message.dataset.id;
                        
                        try {
                            await API.deleteMessage(AppState.currentConversationId, messageId);
                            message.classList.add('message--deleted');
                            message.querySelector('.message__bubble').innerHTML = '<i class="fas fa-trash-alt"></i> Esta mensagem foi excluída';
                            message.querySelector('.message__actions').remove();
                            Toast.success('Mensagem excluída');
                        } catch (error) {
                            Toast.error('Erro ao excluir mensagem');
                        }
                    });
                });
            },
            
            async sendMessage() {
                const message = DOM.messageInput.value.trim();
                
                if (!message && AppState.attachedFiles.length === 0) return;
                if (AppState.isLoading) return;
                
                // Don't create conversation here - let the backend handle it
                // if (!AppState.currentConversationId) {
                //     await Sidebar.createNewConversation();
                //     if (!AppState.currentConversationId) return;
                // }
                
                try {
                    AppState.isLoading = true;
                    this.updateInputButtons();
                    DOM.cancelResponseBtn.classList.add('is-visible');
                    
                    // Add user message to UI immediately with unique ID
                    const userMessageId = 'user-msg-' + Date.now();
                    const userMessage = this.addMessageToUI({
                        id: userMessageId,
                        papel: 'user',
                        texto_raw: message,
                        criado_em: new Date().toISOString(),
                    });
                    
                    // Clear input
                    DOM.messageInput.value = '';
                    Utils.autoResize(DOM.messageInput);
                    
                    // Show loading indicator
                    this.showLoadingIndicator();
                    
                    // Send message (backend will create conversation if needed)
                    const response = await API.sendMessage(
                        AppState.currentConversationId, // Can be null
                        message,
                        AppState.attachedFiles,
                        AppState.webSearchEnabled
                    );
                    
                    // Clear files
                    this.clearFiles();
                    
                    // Handle streaming response
                    await this.handleStreamingResponse(response);
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    Toast.error('Erro ao enviar mensagem');
                    this.removeLoadingIndicator();
                } finally {
                    AppState.isLoading = false;
                    this.updateInputButtons();
                    DOM.cancelResponseBtn.classList.remove('is-visible');
                }
            },
            
            async handleStreamingResponse(response) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let aiMessageDiv = null;
                let fullText = '';
                let buffer = '';
                
                this.removeLoadingIndicator();
                
                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const events = buffer.split('\n\n');
                        buffer = events.pop() || '';  // Manter o último evento incompleto no buffer
                        
                        for (const event of events) {
                            if (!event.trim()) continue;
                            
                            const lines = event.split('\n');
                            let eventType = '';
                            let eventData = '';
                            
                            for (const line of lines) {
                                if (line.startsWith('event: ')) {
                                    eventType = line.slice(7);
                                } else if (line.startsWith('data: ')) {
                                    eventData = line.slice(6);
                                }
                            }
                            
                            if (!eventData) continue;
                            
                            try {
                                const data = JSON.parse(eventData);
                                
                                if (eventType === 'error') {
                                    Toast.error(typeof data === 'string' ? data : data.message || 'Erro desconhecido');
                                    return;
                                }
                                
                                if (eventType === 'chunk' && typeof data === 'string') {
                                    fullText += data;
                                    
                                    if (!aiMessageDiv) {
                                        // Transform the loading indicator into the AI message
                                        const loadingMessage = document.getElementById('loadingMessage');
                                        if (loadingMessage) {
                                            const contentDiv = loadingMessage.querySelector('.message__content');
                                            if (contentDiv) {
                                                contentDiv.innerHTML = '<div class="message__bubble"></div>';
                                                aiMessageDiv = loadingMessage;
                                                aiMessageDiv.removeAttribute('id'); // Remove loading id
                                            } else {
                                                // Fallback: remove loading and add new message
                                                this.removeLoadingIndicator();
                                                aiMessageDiv = this.addMessageToUI({
                                                    papel: 'model',
                                                    texto_raw: '',
                                                    criado_em: new Date().toISOString(),
                                                }, true);
                                            }
                                        } else {
                                            // Fallback
                                            this.removeLoadingIndicator();
                                            aiMessageDiv = this.addMessageToUI({
                                                papel: 'model',
                                                texto_raw: '',
                                                criado_em: new Date().toISOString(),
                                            }, true);
                                        }
                                    }
                                    
                                    // Processar linha por linha para melhor imersão
                                    await this.typeTextLineByLine(aiMessageDiv, data);
                                }
                                
                                if (eventType === 'done' && typeof data === 'object') {
                                    // Atualizar ID da mensagem e conversa
                                    if (data.conversa_id) {
                                        AppState.currentConversationId = data.conversa_id;
                                        // Atualizar lista de conversas se for uma nova conversa
                                        Sidebar.loadConversations();
                                    }
                                    if (aiMessageDiv && data.mensagem_id) {
                                        aiMessageDiv.dataset.id = data.mensagem_id;
                                    }
                                    
                                    // Atualizar título se necessário
                                    if (data.titulo) {
                                        DOM.conversationTitle.textContent = data.titulo;
                                    }
                                    
                                    // Processar blocos de código após mensagem completa
                                    this.processCodeBlocks();
                                    this.bindMessageActions();
                                    
                                    // Atualizar contagem de tokens
                                    if (data.tokens_utilizados) {
                                        DOM.tokenCount.textContent = `${data.tokens_utilizados} tokens`;
                                    }
                                    
                                    // Mostrar botão de compartilhar
                                    DOM.shareBtn.classList.remove('hidden');
                                }
                            } catch (e) {
                                console.warn('Failed to parse SSE data:', eventData, e);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Streaming error:', error);
                    Toast.error('Erro na resposta');
                }
            },
            
            async typeTextLineByLine(messageDiv, newText) {
                const bubble = messageDiv.querySelector('.message__bubble');
                const currentText = bubble.textContent || '';
                const fullNewText = currentText + newText;
                const lines = newText.split('\n');
                
                let currentDisplayText = currentText;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const isLastLine = i === lines.length - 1;
                    
                    // Adicionar linha completa com efeito de fade-in
                    const lineStartIndex = currentDisplayText.length;
                    currentDisplayText += line + (isLastLine ? '' : '\n');
                    
                    // Criar span para a nova linha com opacidade inicial 0
                    const lineSpan = document.createElement('span');
                    lineSpan.textContent = line;
                    lineSpan.style.opacity = '0';
                    lineSpan.style.transition = 'opacity 0.5s ease-in';
                    
                    // Adicionar quebra de linha se necessário
                    if (bubble.innerHTML) {
                        bubble.appendChild(document.createElement('br'));
                    }
                    bubble.appendChild(lineSpan);
                    
                    // Trigger fade-in
                    await this.delay(100);
                    lineSpan.style.opacity = '1';
                    
                    // Delay entre linhas
                    if (!isLastLine) {
                        await this.delay(300);
                    }
                    
                    // Rolar suavemente para o final
                    this.scrollToBottom();
                }
                
                // Aplicar formatação final após todas as linhas
                await this.delay(500);
                bubble.innerHTML = this.formatMessage(fullNewText);
            },
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },
            
            addMessageToUI(msg, isStreaming = false) {
                if (DOM.welcomeState.parentElement === DOM.messagesList) {
                    DOM.welcomeState.classList.add('hidden');
                }
                
                const messageHTML = this.createMessageHTML(msg);
                DOM.messagesList.insertAdjacentHTML('beforeend', messageHTML);
                
                // Garantir que o espaçador esteja sempre no final
                this.ensureSpacerAtEnd();
                
                const messageDiv = DOM.messagesList.lastElementChild.previousElementSibling; // O espaçador é o último
                this.scrollToBottom();
                
                return messageDiv;
            },
            
            ensureSpacerAtEnd() {
                // Remover espaçador existente se houver
                const existingSpacer = DOM.messagesList.querySelector('.messages-spacer');
                if (existingSpacer) {
                    existingSpacer.remove();
                }
                
                // Adicionar novo espaçador no final
                const spacer = document.createElement('div');
                spacer.className = 'messages-spacer';
                DOM.messagesList.appendChild(spacer);
            },
            
            formatMessage(text) {
                // Basic markdown-like formatting
                let html = Utils.escapeHtml(text);
                
                // Code blocks
                html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    return `<div class="code-block"><div class="code-block__header"><span class="code-block__language">${lang || 'code'}</span><button class="code-block__copy" title="Copiar código"><i class="fas fa-copy"></i></button></div><div class="code-block__content"><pre><code class="language-${lang || 'text'}">${code.trim()}</code></pre></div></div>`;
                });
                
                // Inline code
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // Bold
                html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                
                // Italic
                html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                
                // Line breaks
                html = html.replace(/\n/g, '<br>');
                
                return html;
            },
            
            showLoadingIndicator() {
                // Remover espaçador temporariamente para que o loading apareça logo após a última mensagem
                const existingSpacer = DOM.messagesList.querySelector('.messages-spacer');
                if (existingSpacer) {
                    existingSpacer.remove();
                }
                
                const personalityImg = '/static/WMDx.gif';
                const personalityName = AppState.currentPersonality?.nome || 'Dark Duck';
                const loadingHTML = `
                    <div class="message message--ai" id="loadingMessage">
                        <div class="message__avatar loading-avatar">
                            <img src="${personalityImg}" alt="${personalityName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        </div>
                        <div class="message__content">
                            <div class="loading-indicator">
                                <!-- Empty for now -->
                            </div>
                        </div>
                    </div>
                `;
                
                DOM.messagesList.insertAdjacentHTML('beforeend', loadingHTML);
                
                // Ensure the thinking indicator is visible by scrolling it into view
                const loadingElement = document.getElementById('loadingMessage');
                if (loadingElement) {
                    loadingElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            },
            
            removeLoadingIndicator() {
                const loading = document.getElementById('loadingMessage');
                if (loading) loading.remove();
                
                // Readicionar o espaçador após remover o loading
                this.ensureSpacerAtEnd();
            },
            
            cancelResponse() {
                // TODO: Implement cancel logic with AbortController
                AppState.isLoading = false;
                this.updateInputButtons();
                DOM.cancelResponseBtn.classList.remove('is-visible');
                this.removeLoadingIndicator();
                Toast.info('Resposta cancelada');
            },
            
            updateInputButtons() {
                const hasText = DOM.messageInput.value.trim().length > 0;
                const hasFiles = AppState.attachedFiles.length > 0;
                const shouldShowButtons = hasText || hasFiles;
                const isLoading = AppState.isLoading;
                
                if (shouldShowButtons && !isLoading) {
                    DOM.sendBtn.classList.remove('hidden');
                    DOM.voiceBtn.classList.add('hidden');
                } else if (!isLoading) {
                    DOM.sendBtn.classList.add('hidden');
                    DOM.voiceBtn.classList.remove('hidden');
                }
                
                // Mostrar botão de cancelar apenas quando está carregando
                if (isLoading) {
                    DOM.cancelResponseBtn.classList.add('is-visible');
                    DOM.sendBtn.classList.add('hidden');
                    DOM.voiceBtn.classList.add('hidden');
                } else {
                    DOM.cancelResponseBtn.classList.remove('is-visible');
                }
            },
            
            showWelcome() {
                AppState.currentConversationId = null;
                DOM.conversationTitle.textContent = 'Selecione uma Conversa';
                DOM.shareBtn.classList.add('hidden');
                DOM.tokenCount.textContent = 'Ilimitado';
                DOM.messagesList.innerHTML = '';
                DOM.welcomeState.classList.remove('hidden');
                DOM.messagesList.appendChild(DOM.welcomeState);
            },
            
            scrollToBottom() {
                // Delay para garantir que os elementos foram renderizados
                setTimeout(() => {
                    const container = DOM.messagesContainer;
                    
                    // Rolar suavemente para o final completo
                    container.scrollTo({
                        top: container.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 50);
            },
            
            processCodeBlocks() {
                DOM.messagesList.querySelectorAll('pre code:not(.highlighted)').forEach(block => {
                    Prism.highlightElement(block);
                    block.classList.add('highlighted');
                });
                
                // Bind copy buttons for code blocks
                DOM.messagesList.querySelectorAll('.code-block__copy').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const codeBlock = e.target.closest('.code-block');
                        const code = codeBlock.querySelector('code').textContent;
                        navigator.clipboard.writeText(code);
                        Toast.success('Código copiado!');
                    });
                });
            },
            
            // File handling
            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                AppState.attachedFiles = [...AppState.attachedFiles, ...files];
                this.renderFilePreviews();
            },
            
            renderFilePreviews() {
                if (AppState.attachedFiles.length === 0) {
                    DOM.filePreviews.classList.remove('has-files');
                    DOM.filePreviews.innerHTML = '';
                    return;
                }
                
                DOM.filePreviews.classList.add('has-files');
                DOM.filePreviews.innerHTML = AppState.attachedFiles.map((file, index) => `
                    <div class="file-preview" data-index="${index}">
                        <i class="fas fa-file file-preview__icon"></i>
                        <span class="file-preview__name">${Utils.truncate(file.name, 20)}</span>
                        <button class="file-preview__remove" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
                
                DOM.filePreviews.querySelectorAll('.file-preview__remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(btn.dataset.index);
                        AppState.attachedFiles.splice(index, 1);
                        this.renderFilePreviews();
                    });
                });
            },
            
            clearFiles() {
                AppState.attachedFiles = [];
                DOM.fileInput.value = '';
                this.renderFilePreviews();
            },
            
            // Web search toggle
            toggleWebSearch() {
                AppState.webSearchEnabled = !AppState.webSearchEnabled;
                DOM.webSearchBtn.classList.toggle('is-active', AppState.webSearchEnabled);
                Toast.info(AppState.webSearchEnabled ? 'Busca web ativada' : 'Busca web desativada');
            },
            
            // Personality
            async loadPersonalities() {
                try {
                    const data = await API.getPersonalities();
                    AppState.personalities = data.personalidades || [];
                    this.renderPersonalities();
                    
                    if (AppState.personalities.length > 0) {
                        this.setPersonality(AppState.personalities[0]);
                    }
                } catch (error) {
                    console.error('Error loading personalities:', error);
                }
            },
            
            renderPersonalities() {
                DOM.personalityList.innerHTML = AppState.personalities.map(p => `
                    <div class="personality-item ${p.id === AppState.currentPersonality?.id ? 'is-selected' : ''}" 
                         data-id="${p.id}">
                        <img src="${p.imagem || '/static/logo1.jpg'}" alt="" class="personality-item__avatar">
                        <div class="personality-item__info">
                            <h4 class="personality-item__name">${p.nome}</h4>
                            <p class="personality-item__desc">${p.descricao || ''}</p>
                        </div>
                    </div>
                `).join('');
                
                DOM.personalityList.querySelectorAll('.personality-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const personality = AppState.personalities.find(p => p.id == item.dataset.id);
                        if (personality) {
                            this.setPersonality(personality);
                            Modal.close(DOM.personalityModal);
                        }
                    });
                });
            },
            
            setPersonality(personality) {
                AppState.currentPersonality = personality;
                DOM.personalityAvatar.src = personality.imagem || '/static/logo1.jpg';
                DOM.personalityName.textContent = personality.nome || 'DUCK-PRO-02';
                
                // Update selection in modal
                DOM.personalityList.querySelectorAll('.personality-item').forEach(item => {
                    item.classList.toggle('is-selected', item.dataset.id == personality.id);
                });
            },
            
            // Share
            showShareModal() {
                if (!AppState.currentConversationId) return;
                
                const shareUrl = `${window.location.origin}/c/${AppState.currentConversationId}`;
                DOM.shareLink.value = shareUrl;
                Modal.open(DOM.shareModal);
            },
            
            // Title editing
            editTitle() {
                if (!AppState.currentConversationId || !AppState.isConversationOwner) return;
                
                const currentTitle = DOM.conversationTitle.textContent;
                DOM.conversationTitle.classList.add('is-editing');
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentTitle;
                input.style.cssText = 'width: 100%; background: transparent; border: none; color: inherit; font: inherit; text-align: center; outline: none;';
                
                DOM.conversationTitle.innerHTML = '';
                DOM.conversationTitle.appendChild(input);
                input.focus();
                input.select();
                
                const saveTitle = async () => {
                    const newTitle = input.value.trim() || currentTitle;
                    DOM.conversationTitle.textContent = newTitle;
                    DOM.conversationTitle.classList.remove('is-editing');
                    
                    if (newTitle !== currentTitle) {
                        try {
                            await API.updateConversationTitle(AppState.currentConversationId, newTitle);
                            Sidebar.loadConversations();
                            Toast.success('Título atualizado');
                        } catch (error) {
                            DOM.conversationTitle.textContent = currentTitle;
                            Toast.error('Erro ao atualizar título');
                        }
                    }
                };
                
                input.addEventListener('blur', saveTitle);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    } else if (e.key === 'Escape') {
                        DOM.conversationTitle.textContent = currentTitle;
                        DOM.conversationTitle.classList.remove('is-editing');
                    }
                });
            },
        };

        // ============================================
        // THEME CONTROLLER
        // ============================================
        const Theme = {
            init() {
                this.setTheme(AppState.theme);
                DOM.themeToggle.addEventListener('click', () => this.toggle());
            },
            
            setTheme(theme) {
                AppState.theme = theme;
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                DOM.themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            },
            
            toggle() {
                const newTheme = AppState.theme === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme);
            },
        };

        // ============================================
        // VOICE CONTROLLER
        // ============================================
        const Voice = {
            recognition: null,
            transcript: '',
            
            init() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'pt-BR';
                    
                    this.recognition.onresult = (event) => {
                        this.transcript = Array.from(event.results)
                            .map(result => result[0].transcript)
                            .join('');
                        DOM.voiceTranscript.textContent = this.transcript || 'Ouvindo...';
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.stop();
                    };
                    
                    this.recognition.onend = () => {
                        this.stop();
                    };
                }
                
                this.bindEvents();
            },
            
            bindEvents() {
                document.getElementById('startVoiceBtn').addEventListener('click', () => this.start());
                document.getElementById('stopVoiceBtn').addEventListener('click', () => this.stop());
                document.getElementById('sendVoiceBtn').addEventListener('click', () => this.send());
                
                Modal.setupCloseHandlers(DOM.voiceModal, ['#voiceModalClose']);
            },
            
            start() {
                if (!this.recognition) {
                    Toast.error('Reconhecimento de voz não suportado');
                    return;
                }
                
                this.transcript = '';
                DOM.voiceTranscript.textContent = 'Ouvindo...';
                AppState.isRecording = true;
                DOM.voiceBtn.classList.add('is-recording');
                
                document.getElementById('startVoiceBtn').classList.add('hidden');
                document.getElementById('stopVoiceBtn').classList.remove('hidden');
                document.getElementById('sendVoiceBtn').classList.add('hidden');
                
                this.recognition.start();
            },
            
            stop() {
                if (this.recognition) {
                    this.recognition.stop();
                }
                
                AppState.isRecording = false;
                DOM.voiceBtn.classList.remove('is-recording');
                
                document.getElementById('startVoiceBtn').classList.remove('hidden');
                document.getElementById('stopVoiceBtn').classList.add('hidden');
                
                if (this.transcript) {
                    document.getElementById('sendVoiceBtn').classList.remove('hidden');
                }
            },
            
            send() {
                if (this.transcript) {
                    DOM.messageInput.value = this.transcript;
                    Utils.autoResize(DOM.messageInput);
                    Modal.close(DOM.voiceModal);
                    
                    // Reset
                    this.transcript = '';
                    DOM.voiceTranscript.textContent = 'Clique em iniciar para gravar...';
                    document.getElementById('startVoiceBtn').classList.remove('hidden');
                    document.getElementById('stopVoiceBtn').classList.add('hidden');
                    document.getElementById('sendVoiceBtn').classList.add('hidden');
                }
            },
        };

        // ============================================
        // LINK REDIRECT CONTROLLER
        // ============================================
        const LinkRedirect = {
            pendingUrl: null,
            
            init() {
                this.bindEvents();
            },
            
            bindEvents() {
                // Setup modal close handlers
                Modal.setupCloseHandlers(DOM.linkRedirectModal, ['#linkRedirectModalClose', '#linkRedirectCancel']);
                
                // Confirm redirect button
                document.getElementById('linkRedirectConfirm').addEventListener('click', () => {
                    if (this.pendingUrl) {
                        window.open(this.pendingUrl, '_blank', 'noopener,noreferrer');
                        this.pendingUrl = null;
                    }
                    Modal.close(DOM.linkRedirectModal);
                });
                
                // Intercept clicks on links inside messages
                DOM.messagesContainer.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (link && link.href) {
                        e.preventDefault();
                        this.showRedirectModal(link.href);
                    }
                });
            },
            
            showRedirectModal(url) {
                this.pendingUrl = url;
                
                // Parse URL to get domain
                let domain = '';
                try {
                    const urlObj = new URL(url);
                    domain = urlObj.hostname;
                } catch (e) {
                    domain = 'Link externo';
                }
                
                // Update modal content
                DOM.linkPreviewUrl.textContent = url;
                DOM.linkPreviewDomain.textContent = domain;
                
                // Update icon based on domain
                const iconContainer = document.querySelector('.link-preview__icon i');
                if (iconContainer) {
                    if (url.includes('github.com')) {
                        iconContainer.className = 'fab fa-github';
                    } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        iconContainer.className = 'fab fa-youtube';
                    } else if (url.includes('twitter.com') || url.includes('x.com')) {
                        iconContainer.className = 'fab fa-twitter';
                    } else if (url.includes('linkedin.com')) {
                        iconContainer.className = 'fab fa-linkedin';
                    } else if (url.includes('facebook.com')) {
                        iconContainer.className = 'fab fa-facebook';
                    } else if (url.includes('instagram.com')) {
                        iconContainer.className = 'fab fa-instagram';
                    } else if (url.includes('stackoverflow.com')) {
                        iconContainer.className = 'fab fa-stack-overflow';
                    } else if (url.includes('wikipedia.org')) {
                        iconContainer.className = 'fab fa-wikipedia-w';
                    } else {
                        iconContainer.className = 'fas fa-globe';
                    }
                }
                
                Modal.open(DOM.linkRedirectModal);
            },
        };

        // ============================================
        // INITIALIZE APP
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Setup modals
            Modal.setupCloseHandlers(DOM.shareModal, ['#shareModalClose']);
            Modal.setupCloseHandlers(DOM.personalityModal, ['#personalityModalClose', '#personalityModalCancel']);
            Modal.setupCloseHandlers(DOM.deleteModal, ['#deleteModalClose', '#deleteModalCancel']);
            Modal.setupCloseHandlers(DOM.clearChatModal, ['#clearChatModalClose', '#clearChatModalCancel']);
            
            // Delete confirmation
            document.getElementById('deleteModalConfirm').addEventListener('click', async () => {
                if (AppState.conversationToDelete) {
                    await Sidebar.deleteConversation(AppState.conversationToDelete);
                    AppState.conversationToDelete = null;
                }
                Modal.close(DOM.deleteModal);
            });
            
            // Clear chat confirmation
            document.getElementById('clearChatModalConfirm').addEventListener('click', async () => {
                if (AppState.currentConversationId) {
                    try {
                        await API.clearConversation(AppState.currentConversationId);
                        Chat.loadConversation(AppState.currentConversationId);
                        Toast.success('Conversa limpa');
                    } catch (error) {
                        Toast.error('Erro ao limpar conversa');
                    }
                }
                Modal.close(DOM.clearChatModal);
            });
            
            // Copy share link
            document.getElementById('copyShareLink').addEventListener('click', () => {
                DOM.shareLink.select();
                navigator.clipboard.writeText(DOM.shareLink.value);
                Toast.success('Link copiado!');
            });
            
            // Share buttons
            document.querySelectorAll('.share-btn[data-platform]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const platform = btn.dataset.platform;
                    const url = DOM.shareLink.value;
                    const text = 'Confira esta conversa no Dark Duck AI!';
                    
                    const shareUrls = {
                        whatsapp: `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`,
                        twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
                        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
                        copy: null,
                    };
                    
                    if (platform === 'copy') {
                        navigator.clipboard.writeText(url);
                        Toast.success('Link copiado!');
                    } else if (shareUrls[platform]) {
                        window.open(shareUrls[platform], '_blank', 'width=600,height=400');
                    }
                });
            });
            
            // Initialize controllers
            Theme.init();
            Sidebar.init();
            Chat.init();
            Voice.init();
            LinkRedirect.init();
            
            console.log('🦆 Dark Duck Intelligence initialized!');
        });
    </script>
</body>
</html>
