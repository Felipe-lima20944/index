



<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Duck Intelligence</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Prism.js para destaque de sintaxe -->
    <!-- Biblioteca Prism.js: Usamos o Prism.js, uma biblioteca leve e popular para destacar sintaxe de código. Ela analisa o texto do código e identifica elementos como:
         - Palavras-chave (ex.: if, function, class) → Azul ou roxo.
         - Strings (ex.: "texto") → Verde ou amarelo.
         - Comentários (ex.: // comentário) → Cinza.
         - Números, operadores, etc. → Cores específicas. -->
    <link id="prism-dark-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css">
    <link id="prism-light-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-coy.min.css" disabled>
    <!-- Plugin de números de linha para Prism -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <style>
        /* ==================================== */
        /* VARIÁVEIS DE CORES E EFEITOS         */
        /* ==================================== */
        :root {
            --primary-gradient: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            --secondary-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --accent-gradient-red: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
            --accent-gradient-blue: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
            --accent-gradient-white: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            
            --success-gradient: linear-gradient(135deg, #34a853 0%, #2e7d32 100%);
            --warning-gradient: linear-gradient(135deg, #fbbc04 0%, #f57c00 100%);
            --danger-gradient: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
            --danger-gradient-hover: linear-gradient(135deg, #6a1b9a 0%, #4a148c 100%);
            
            --bg-main: linear-gradient(135deg, #ffff00 0%, #ffed4e 100%);
            --bg-secondary: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --bg-chat: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%);
            
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(218, 220, 224, 0.3);
            --glass-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.302), 0 4px 8px 3px rgba(60, 64, 67, 0.149);
            
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-muted: #80868b;
            --text-inverse: #ffffff;
            
            --border-color: rgba(218, 220, 224, 0.3);
            --hover-color: rgba(26, 115, 232, 0.04);
            
            --shadow-sm: 0 1px 2px 0 rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
            --shadow-md: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
            --shadow-lg: 0 2px 6px 2px rgba(60, 64, 67, 0.15), 0 8px 24px 4px rgba(60, 64, 67, 0.15);
            --shadow-xl: 0 4px 12px 4px rgba(60, 64, 67, 0.15), 0 16px 48px 8px rgba(60, 64, 67, 0.15);
            
            --blur-effect: none;
            --transition-smooth: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            --transition-bounce: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* ==================================== */
        /* ANIMAÇÕES E EFEITOS                  */
        /* ==================================== */
        @keyframes slideInUp {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        @keyframes blink-caret {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .typing-effect:after {
            content: '|';
            animation: blink-caret 0.75s step-end infinite;
        }

        #typing-text {
            font-family: 'JetBrains Mono', monospace;
        }

        /* ==================================== */
        /* ESTILOS GLOBAIS                      */
        /* ==================================== */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        font-family: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: 0.3px;
            background: var(--bg-main);
            background-image: radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-primary);
            line-height: 1.6;
            overflow: auto;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                url('/static/logo1.jpg') center 30% / 50% auto no-repeat;
            background-color: rgba(255, 255, 255, 0.76);
            background-size: 40% auto;
            pointer-events: none;
            z-index: 1;
        }
        body.no-gif::before {
            background: none !important;
        }
        .chat-wrapper {
            display: flex;
            flex-grow: 1;
            height: 100vh;
            overflow: hidden;
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            z-index: -1;
        }

        /* ==================================== */
        /* SIDEBAR APRIMORADA                   */
        /* ==================================== */
        .sidebar {
            width: 300px;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1rem;
            position: relative;
            transition: var(--transition-smooth);
            box-shadow: var(--glass-shadow);
            min-height: 100vh;
        }
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(255,255,255,0.05) 0%, 
                rgba(255,255,255,0.02) 50%, 
                rgba(255,255,255,0.05) 100%);
            pointer-events: none;
            z-index: -1;
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .logo-and-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid transparent;
            background-clip: padding-box;
            box-shadow: var(--shadow-lg);
            animation: none;
            transition: none;
        }
        .logo:hover {
            transform: scale(1.05);
        }
        h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--text-primary);
            animation: none;
        }
        .new-chat-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-inverse);
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s ease;
            box-shadow: none; /* remover sombra */
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
            animation: none;
        }
        .new-chat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        .new-chat-btn:hover::before {
            left: 100%;
        }
        .new-chat-btn:hover {
            /* sem transformação ou sombra, apenas alteração de cor */
            transform: none;
            box-shadow: none;
            filter: brightness(1.02);
        }
        .new-chat-btn:active {
            transform: translateY(-1px);
        }
        .new-chat-btn i {
            font-size: 1.2rem;
        }

        /* ==================================== */
        /* LISTA DE CONVERSAS DINÂMICA          */
        /* ==================================== */
        .conversation-list {
            list-style-type: none;
            padding: 0;
            margin-top: 1rem;
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        .conversation-list::-webkit-scrollbar {
            width: 6px;
        }
        .conversation-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        .conversation-list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: var(--transition-smooth);
        }
        .conversation-list::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        .conversation-item-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.25rem;
            background: transparent;
            border-radius: 0.75rem;
            border: 1px solid transparent;
            transition: var(--transition-smooth);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            animation: slideInUp 0.3s ease-out;
        }
        .conversation-item-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--glass-bg);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: -1;
            border-radius: 1.2rem;
        }
        .conversation-item-wrapper:hover::before {
            opacity: 1;
        }
        .conversation-item-wrapper:hover {
            transform: translateX(5px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .conversation-item-wrapper.active {
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            color: white;
            border: 1px solid rgba(167, 139, 250, 0.3);
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.3);
        }
        .conversation-item-wrapper.active::before {
            opacity: 0;
        }
        .conversation-item-wrapper.active .conversation-content h3,
        .conversation-item-wrapper.active .conversation-content p {
            color: white !important;
            opacity: 1 !important;
        }
        .conversation-item-wrapper.active .delete-conversa-btn {
            opacity: 1;
            transform: scale(1.05);
        }
        .conversation-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--glass-border);
            transition: var(--transition-smooth);
            flex-shrink: 0;
        }
        .conversation-item-wrapper:hover .conversation-avatar {
            transform: scale(1.1);
            border-color: var(--accent-gradient-blue, rgba(102, 126, 234, 0.6));
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }
        .conversation-content {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .conversation-content h3 {
            margin: 0 0 0.25rem 0;
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }
        .conversation-content p {
            margin: 0;
            font-size: 0.75rem;
            opacity: 0.7;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }
        .conversation-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.6;
        }
        .conversation-date {
            font-size: 0.8rem;
            opacity: 0.6;
        }
        .delete-conversa-btn {
            background: var(--danger-gradient);
            border: none;
            color: var(--text-inverse);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.4rem;
            opacity: 1;
            transition: var(--transition-smooth);
            border-radius: 0.5rem;
            transform: scale(1);
            margin-left: auto;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }
        .conversation-item-wrapper:hover .delete-conversa-btn {
            opacity: 1;
            transform: scale(1.05);
        }
        .delete-conversa-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        }

        .conversa-cancelada {
            opacity: 0.6;
            background: rgba(255, 107, 107, 0.1);
            border-left: 3px solid #ff6b6b;
        }

        .conversa-cancelada .conversation-content h3 {
            text-decoration: line-through;
            color: #ff6b6b;
        }

        .conversa-cancelada:hover {
            opacity: 0.8;
        }

        /* ==================================== */
        /* LOADING SPINNER                      */
        /* ==================================== */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
            font-size: 1rem;
            background: var(--glass-bg);
            border-radius: 1rem;
            border: 1px solid var(--glass-border);
            margin: 1rem 0;
        }
        .loading-spinner i {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--accent-gradient-blue, #667eea);
            animation: spin 1s linear infinite;
        }
        .loading-spinner span {
            font-weight: 500;
            opacity: 0.8;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ==================================== */
        /* ÁREA PRINCIPAL DO CHAT               */
        /* ==================================== */
        .chat-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-chat);
            backdrop-filter: var(--blur-effect);
            position: relative;
            overflow: auto;
            padding-bottom: 0.2rem; /* Aproxima ainda mais o input ao footer */
        }
        .chat-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255, 0, 0, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 0, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .chat-header-desktop {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: var(--shadow-sm);
            position: relative;
            z-index: 10;
        }

        .conversation-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            text-align: center;
            transition: var(--transition-smooth);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .conversation-title.editing {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--accent-gradient-blue);
        }
        .conversation-title.editing input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: inherit;
            font-weight: inherit;
            width: 100%;
            text-align: center;
        }
        .chat-header-desktop h2 {
            background: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: unset;
            background-clip: unset;
            color: var(--text-primary);
            animation: none;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 2rem 2rem 8rem 2rem;
            overflow-y: auto;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 0, 0, 0.3) transparent;
            position: relative;
            z-index: 5;
        }
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
        }

        /* ==================================== */
        /* MENSAGENS APRIMORADAS                */
        /* ==================================== */
        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 0.75rem;
            animation: slideInUp 0.3s ease-out;
            position: relative;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.model {
            justify-content: flex-start;
        }

        .message.model .avatar {
            margin-top: 0.25rem;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            max-width: calc(100% - 60px);
            position: relative;
        }

        .message-content a {
            color: #1a73e8;
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition-smooth);
        }

        .message-content a:hover {
            text-decoration: underline;
            color: #1557b0;
        }

        .collapsed {
            max-height: 200px;
            overflow: hidden;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            font-size: 1.1rem;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }
        .avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0.1;
            transition: opacity 0.3s ease;
        }
        .avatar:hover::before {
            opacity: 0.2;
        }
        .message.user .avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-inverse);
            animation: none;
        }
        .message.model .avatar {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            color: var(--text-primary);
            border: 2px solid var(--glass-border);
        }
        .content {
            max-width: 100%;
            padding: 1.25rem 1.5rem;
            border-radius: 1.5rem;
            line-height: 1.7;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-smooth);
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }
        .content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            pointer-events: none;
        }
        .message.user .content {
            background: #f5f5f5;
            color: #333;
            border-radius: 18px 18px 4px 18px;
            padding: 0.75rem 1rem;
            max-width: 100%;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .message.model .content {
            background: #ffffff;
            color: #333;
            border-radius: 4px 18px 18px 18px;
            padding: 0.75rem 1rem;
            border: 1px solid #e0e0e0;
            max-width: 100%;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        .content:hover {
            transform: translateY(0);
            box-shadow: var(--shadow-xl);
        }

        /* Popover de compartilhamento para cada mensagem */
        .share-msg-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            padding: 6px;
            border-radius: 6px;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .share-msg-btn:hover {
            background: var(--hover-color);
            color: var(--text-primary);
        }

        .share-popover {
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            padding: 6px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 9999;
            min-width: 180px;
        }

        .share-popover a, .share-popover button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            text-decoration: none;
            color: var(--text-primary);
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .share-popover a:hover, .share-popover button:hover {
            background: var(--hover-color);
        }

        /* Mostrar botões só quando a mensagem for clicada (com transição/fade) */
        .message .message-buttons {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.6s ease, max-height 0.6s ease;
            pointer-events: none;
            display: flex !important;
            align-items: center;
            gap: 0.5rem;
        }
        .message.show-buttons .message-buttons {
            opacity: 1;
            max-height: 200px; /* suficiente para o conteúdo */
            pointer-events: auto;
        }

        /* ==================================== */
        /* ==================================== */
        /* ÁREA DE INPUT COMPLETAMENTE NOVA E MELHORADA */
        /* ==================================== */

        .chat-input-area {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(218, 220, 224, 0.3);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            bottom: 10px;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .input-section {
            max-width: 900px;
            margin: 0 auto;
        }

        .file-preview-container {
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }

        .input-main-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .gemini-chat-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toolbar-icon-btn {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(218, 220, 224, 0.5);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .toolbar-icon-btn:hover {
            background: rgba(26, 115, 232, 0.1);
            border-color: var(--accent-gradient-blue);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.2);
        }

        .toolbar-icon-btn.active {
            background: linear-gradient(135deg, #8e24aa, #6a1b9a);
            color: white;
            border-color: #8e24aa;
            box-shadow: 0 0 15px rgba(142, 36, 170, 0.4);
        }

        .personality-avatar-small {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .btn-label {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .input-field-container {
            position: relative;
        }

        .input-field {
            display: flex;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(218, 220, 224, 0.4);
            border-radius: 25px;
            padding: 0.5rem 1rem;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .input-field:focus-within {
            border-color: var(--accent-gradient-blue);
            box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.1), 0 8px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .input-icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .input-icon-btn:hover {
            background: rgba(26, 115, 232, 0.1);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .message-textarea {
            flex: 1;
            min-height: 20px;
            max-height: 100px;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 400;
            resize: none;
            line-height: 1.4;
            font-family: inherit;
            padding: 0;
        }

        .message-textarea::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .send-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button i {
            font-size: 1.2rem;
        }

        .gemini-credit {
            text-align: center;
            margin-top: 0.25rem;
        }

        .gemini-credit span {
            font-size: 0.7rem;
            color: var(--text-muted);
            opacity: 0.7;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .chat-input-area {
                padding: 0.25rem 0.5rem;
                position: fixed;
                bottom: 10px;
                left: 0;
                right: 0;
            }

            .input-field {
                padding: 0.5rem 0.75rem;
                gap: 0.5rem;
            }

            .toolbar-icon-btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
            }

            .input-toolbar {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Animações */
        @keyframes inputGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.1); }
            50% { box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.1); }
        }

        .input-field.typing {
            animation: inputGlow 2s ease-in-out infinite;
        }

        .chat-form {
            width: 100%;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.25rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: var(--blur-effect);
            border: 2px solid var(--glass-border);
            border-radius: 1.5rem;
            padding: 0.125rem 0.25rem;
            transition: var(--transition-smooth);
            position: relative;
        }

        .input-wrapper:focus-within {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        .input-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 8px;
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 56px;
            flex-shrink: 0;
            gap: 2px;
        }

        .input-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent-gradient-blue);
            transform: scale(1.05);
        }

        .input-action-btn:active {
            transform: scale(0.95);
        }

        .btn-small-text {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 1px;
            text-align: center;
            line-height: 1;
            display: block;
            color: var(--text-secondary);
            opacity: 0.9;
        }

        .upload-btn {
            color: var(--text-secondary);
        }

        .audio-btn {
            position: relative;
        }

        .audio-btn.recording {
            color: #ff4444;
            animation: recording-pulse 1.5s infinite;
        }

        /* Mobile adjustments for input action buttons */
        @media (max-width: 480px) {
            .btn-small-text {
                display: none;
            }

            .input-action-btn {
                width: 44px;
                height: 44px;
                padding: 0.5rem;
            }
        }

        .audio-btn.recording::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            animation: recording-dot 1.5s infinite;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .send-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            box-shadow: var(--shadow-lg);
            transform: scale(1.05);
        }

        .cancel-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .cancel-btn:hover {
            background: linear-gradient(135deg, #ff5252 0%, #e74c3c 100%);
            box-shadow: var(--shadow-lg);
            transform: scale(1.05);
        }

        .text-input-container {
            flex: 1;
            position: relative;
            min-width: 0;
        }

        .message-textarea {
            width: 100%;
            min-height: 14px;
            max-height: 120px;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
            padding: 0;
            overflow-y: auto;
        }

        .message-textarea::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        .message-textarea:focus {
            outline: none;
        }

        .input-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Mensagem exibida quando o usuário NÃO é o dono da conversa */
        .chat-owner-message {
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.03);
            border: 2px dashed var(--glass-border);
            border-radius: 1rem;
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        .chat-owner-message p {
            margin: 0;
            flex: 1 1 auto;
            color: #8e24aa; /* Tom roxo */
        }
        .chat-owner-message p strong, .chat-owner-message #chat-owner-name {
            color: #8e24aa;
            font-weight: 700;
        }
        .chat-owner-message .create-conversation-btn {
            white-space: nowrap;
            padding: 0.5rem 0.9rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Barra de ferramentas (aprimorada) */
        .toolbar-section {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .toolbar-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0.25rem;
            border-radius: 0; /* cantos quadrados */
        }

        .create-conversation-section {
            text-align: center;
            padding: 0.5rem 0;
        }

        .create-conversation-section .create-conversation-btn {
            padding: 0.5rem 1rem;
            border-radius: 0; /* cantos quadrados */
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .create-conversation-section .create-conversation-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Botões da toolbar — visual compacto */
        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.4rem 0.6rem;
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 0; /* cantos quadrados */
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-bounce);
            font-size: 0.85rem;
            font-weight: 600;
            min-height: 34px;
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }

        .toolbar-btn:hover {
            /* remover efeito de crescimento: sem transform/scale */
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(241,243,245,0.95));
            color: var(--text-primary);
            border-color: rgba(102,126,234,0.06);
            /* manter sombra sutil, sem aumentar */
            box-shadow: var(--shadow-sm);
        }

        .toolbar-btn:focus {
            outline: 3px solid rgba(26,115,232,0.12);
            outline-offset: 2px;
        }

        .personality-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
            box-shadow: 0 1px 6px rgba(0,0,0,0.06);
        }

        .personality-name {
            font-weight: 700;
            /* Gradiente roxo bonito (com fallback) */
            color: #7b1fa2;
            background: linear-gradient(90deg, #8e24aa 0%, #6a1b9a 50%, #5e35b1 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 0.78rem; /* texto menor para caber */
            max-width: 110px;
            letter-spacing: 0.2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-shadow: 0 1px 0 rgba(255,255,255,0.02);
        }

        .toolbar-icon {
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: var(--transition-smooth);
        }

        .toolbar-btn:hover .toolbar-icon {
            color: var(--accent-gradient-blue);
        }

        .btn-text {
            display: inline-block;
        }

        .toolbar-indicator {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .input-toolbar { flex-direction: column; gap: 0.75rem; padding: 0.75rem 0; }
            .toolbar-buttons { width: 100%; justify-content: center; }
            .toolbar-btn { flex: 1; justify-content: center; min-width: 0; max-width: 160px; }
            .personality-name { max-width: 100px; }
        }

        @media (max-width: 480px) {
            .toolbar-buttons { flex-wrap: wrap; gap: 0.25rem; }
            .toolbar-btn { min-width: 72px; padding: 0.4rem 0.5rem; font-size: 0.82rem; }
            .personality-name { max-width: 80px; }
        }

        /* Estados específicos */
        .web-search-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(102,126,234,0.18);
        }

        .web-search-btn.active .toolbar-icon { color: white; }

        .clear-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,249,250,0.9));
            color: var(--text-primary);
            border-color: rgba(0,0,0,0.06); /* borda neutra */
            border-radius: 4px; /* borda levemente arredondada */
        }

        .clear-btn:hover {
            background: var(--danger-gradient-hover);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(106,27,154,0.18);
        }

        /* Utilitário para leitores de tela */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

        /* Popover de confirmação do botão Limpar */
        .clear-popover {
            background: #fff;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 0; /* cantos quadrados */
            padding: 0.6rem;
            min-width: 220px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            font-size: 0.88rem;
        }
        .clear-popover .clear-popover-inner p { margin: 0 0 0.5rem 0; color: var(--text-secondary); }
        .clear-popover .clear-popover-actions { display:flex; gap:0.5rem; justify-content:flex-end; }
        .clear-popover .clear-popover-actions .popover-yes,
        .clear-popover .clear-popover-actions .popover-no {
            padding: 0.35rem 0.6rem; border-radius: 6px; border: none; cursor: pointer; font-weight:600;
        }
        .clear-popover .clear-popover-actions .popover-yes { background: linear-gradient(135deg,#8e24aa,#6a1b9a); color:white; }
        .clear-popover .clear-popover-actions .popover-no { background: #f1f3f4; color: var(--text-primary); }

        .clear-btn:hover {
            background: rgba(255, 107, 107, 0.1);
            border-color: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        /* Animações */
        @keyframes recording-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes recording-dot {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* ==================================== */
        /* SUGESTÕES INICIAIS APRIMORADAS       */
        /* ==================================== */
        .initial-suggestions {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem;
            gap: 2rem;
            position: relative;
        }
        .initial-suggestions-logo {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: var(--shadow-xl);
            border: 4px solid var(--glass-border);
            animation: none;
            transition: var(--transition-smooth);
            position: relative;
        }
        .initial-suggestions-logo:hover {
            transform: scale(1.05);
        }
        .suggestions-prompt {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            animation: none;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            width: 100%;
            max-width: 800px;
        }
        .quick-action-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
            font-size: 0.95rem;
            cursor: pointer;
            color: var(--text-primary);
            transition: var(--transition-smooth);
            text-align: left;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            font-weight: 500;
        }
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(255, 0, 0, 0.3);
        }

        /* ==================================== */
        /* CONTROLES DE TEMA E MODAL            */
        /* ==================================== */
        .theme-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.1rem;
            transition: var(--transition-smooth);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: var(--shadow-md);
        }
        .theme-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-inverse);
        }

        .theme-btn.cancel-btn {
            background: var(--danger-gradient);
            color: white;
            border: none;
        }

        .theme-btn.cancel-btn:hover {
            background: var(--danger-gradient-hover);
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
        }

        /* ==================================== */
        /* LOADING E INDICADORES                */
        /* ==================================== */
        .loading-typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: black;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            font-weight: 500;
            color: white;
            animation: loadingPulse 2s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        #loader {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .loading-typing-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: loadingShimmer 3s infinite;
        }
        @keyframes loadingPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
        }
        @keyframes loadingShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .tech-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(26, 115, 232, 0.3);
            border-top: 2px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 10px rgba(26, 115, 232, 0.5);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==================================== */
        /* PERSONALIDADE SELECTOR               */
        /* ==================================== */
        .personality-selector {
            margin: 1.5rem 0;
        }
        .chat-input-area .personality-btn, .chat-input-area .busca-web-btn {
            display: inline-block;
            margin: 0;
            font-size: 11px;
            padding: 6px 10px;
        }
        .personality-btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            color: #495057;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .personality-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        .busca-web-btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            color: #495057;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .busca-web-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        .busca-web-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .personality-selector label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        #personalidade-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition-smooth);
            box-shadow: var(--shadow-sm);
        }
        #personalidade-select:focus {
            outline: none;
            border-color: rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
        }

        /* ==================================== */
        /* SEARCH CONTAINER                     */
        /* ==================================== */
        .search-container {
            position: relative;
            margin: 1rem 0;
        }
        .search-container i {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        #search-conversas {
            width: 100%;
            padding: 0.6rem 0.8rem 0.6rem 2.2rem;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            color: var(--text-primary);
            font-size: 0.8rem;
            transition: var(--transition-smooth);
            box-shadow: var(--shadow-sm);
        }
        #search-conversas:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        #search-conversas::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        /* ==================================== */
        /* FILTER BUTTON                        */
        /* ==================================== */
        .filter-btn {
            width: 100%;
            max-width: 180px;
            padding: 0.5rem 0.7rem;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            color: var(--text-primary);
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            cursor: pointer;
            transition: var(--transition-smooth);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }
        .filter-btn:hover {
            background: var(--glass-hover);
            border-color: #8e24aa;
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #8e24aa, #6a1b9a);
            border-color: #8e24aa;
            color: white;
            box-shadow: 0 4px 15px rgba(142, 36, 170, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        .filter-btn.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(142, 36, 170, 0.3), transparent);
            transition: left 0.5s;
        }
        .filter-btn.active:hover::before {
            left: 100%;
        }
        .filter-btn.active:hover {
            background: linear-gradient(135deg, #6a1b9a, #4a148c);
            border-color: #8e24aa;
            box-shadow: 0 6px 20px rgba(142, 36, 170, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        /* Anonymous conversations button specific styling */
        .anonymous-btn.active {
            background: linear-gradient(135deg, #8e24aa, #6a1b9a);
            border-color: #8e24aa;
            color: white;
            box-shadow: 0 4px 15px rgba(142, 36, 170, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        .anonymous-btn.active:hover {
            background: linear-gradient(135deg, #6a1b9a, #4a148c);
            border-color: #8e24aa;
            box-shadow: 0 6px 20px rgba(142, 36, 170, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        .anonymous-btn.active::before {
            background: linear-gradient(90deg, transparent, rgba(142, 36, 170, 0.3), transparent);
        }

        /* ==================================== */
        /* INFO BUTTON                          */
        /* ==================================== */
        .info-btn {
            width: 40px;
            height: 40px;
            padding: 0.5rem;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.5rem;
        }
        .info-btn:hover {
            background: var(--glass-hover);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        /* ==================================== */
        /* CONVERSATION CREATOR INFO            */
        /* ==================================== */
        .conversation-creator-info {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border-top: 1px solid var(--glass-border);
            margin-top: 1rem;
        }

        /* ==================================== */
        /* SIDEBAR FOOTER                       */
        /* ==================================== */
        .sidebar-footer {
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid var(--glass-border);
        }
        .developer-credit {
            text-align: center;
            padding: 0.5rem 0;
        }

        /* Mobile footer */
        @media (max-width: 768px) {
            .mobile-footer {
                display: block;
                padding: 0.5rem 0;
                text-align: center;
                border-top: 1px solid var(--glass-border);
                margin-top: 0.5rem;
            }
        }

        /* Desktop footer in toolbar */
        @media (min-width: 769px) {
            .desktop-footer {
                display: block;
                padding: 0.5rem 0;
                text-align: center;
                border-top: 1px solid #dee2e6;
                margin-top: 0.5rem;
                background: white;
            }
        }

        /* Main page footer */
        .main-page-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 10;
            border-top: 1px solid #dee2e6;
            padding: 0.5rem;
        }

        .modal-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }
        .modal-btn.confirm {
            background: var(--danger-gradient);
            color: var(--text-inverse);
        }
        .modal-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .modal-btn.cancel {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }
        .modal-btn.cancel:hover {
            background: var(--glass-bg);
            transform: translateY(-2px);
        }
        .modal-btn.secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }
        .modal-btn.secondary:hover {
            background: var(--glass-bg-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ==================================== */
        /* FEEDBACK BUTTONS                     */
        /* ==================================== */
        .feedback-container {
            margin-top: 0.5rem;
            opacity: 1;
            transition: var(--transition-smooth);
            align-self: flex-start;
        }
        .message.user .feedback-container {
            align-self: flex-end;
        }
        .feedback-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-start;
            position: relative;
        }
        .message.user .feedback-buttons {
            justify-content: flex-end;
            position: relative;
        }
        .feedback-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .feedback-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .feedback-btn.like.active {
            background: var(--success-gradient);
            color: var(--text-inverse);
            border-color: transparent;
        }
        .feedback-btn.dislike.active {
            background: var(--danger-gradient);
            color: var(--text-inverse);
            border-color: transparent;
        }
        .like-count, .dislike-count {
            font-size: 0.75rem;
            font-weight: 500;
        }
        .tts-container {
            margin-top: 0.5rem;
            text-align: left;
        }
        .tts-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            opacity: 0.7;
        }
        .tts-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .tts-btn.playing {
            background: var(--success-gradient);
            color: var(--text-inverse);
            border-color: transparent;
        }
        .delete-msg-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            opacity: 0.7;
        }
        .delete-msg-btn:hover {
            opacity: 1;
            background: var(--danger-gradient);
            color: var(--text-inverse);
            border-color: transparent;
            transform: scale(1.1);
        }
        .edit-msg-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            opacity: 0.7;
        }
        .edit-msg-btn:hover {
            opacity: 1;
            background: var(--warning-gradient);
            color: var(--text-inverse);
            border-color: transparent;
            transform: scale(1.1);
        }
        .share-msg-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            opacity: 0.7;
        }
        .share-msg-btn:hover {
            opacity: 1;
            background: var(--success-gradient);
            color: var(--text-inverse);
            border-color: transparent;
            transform: scale(1.1);
        }
        /* Share Overlay */
        .share-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .share-modal {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
        }
        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .share-header h3 {
            margin: 0;
            color: var(--text-primary);
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }
        .share-content {
            margin-bottom: 1rem;
        }
        .share-content p {
            margin: 0;
            color: var(--text-primary);
            font-style: italic;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .share-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .share-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition-smooth);
            flex: 1;
            justify-content: center;
        }
        .share-btn.whatsapp {
            background: #25d366;
            color: white;
        }
        .share-btn.twitter {
            background: #1da1f2;
            color: white;
        }
        .share-btn.facebook {
            background: #1877f2;
            color: white;
        }
        .share-btn.copy {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }
        .share-btn:hover {
            transform: scale(1.05);
        }
        .deleted-message {
            opacity: 0.6;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .deleted-message-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-style: italic;
            padding: 0.75rem;
        }
        .deleted-message-content i {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .tts-word.highlight {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            border-radius: 3px;
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.4);
            transition: all 0.1s ease;
            transform: scale(1.02);
        }
        .audio-visualizer {
            margin-left: 0.5rem;
            border-radius: 0.25rem;
        }

        /* ==================================== */
        /* MESSAGE REACTIONS AND AUDIO         */
        /* ==================================== */
        .message-reactions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.5rem;
            opacity: 0.8;
            transition: var(--transition-smooth);
        }
        
        .message-reactions:hover {
            opacity: 1;
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            border: 2px solid red; /* Debug border */
        }
        
        .audio-generate-btn, .audio-play-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .audio-generate-btn:hover, .audio-play-btn:hover {
            background: var(--accent-gradient-blue);
            color: var(--text-inverse);
            border-color: transparent;
            transform: scale(1.05);
        }
        
        .audio-play-btn.playing {
            background: var(--success-gradient);
            color: var(--text-inverse);
            border-color: transparent;
        }
        
        .audio-generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .reaction-buttons {
            display: flex;
            gap: 0.25rem;
        }
        
        .reaction-btn {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            opacity: 0.7;
        }
        
        .reaction-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: var(--glass-bg);
        }
        
        .reaction-btn.active {
            background: var(--accent-gradient-blue);
            color: var(--text-inverse);
            border-color: transparent;
            opacity: 1;
        }
        
        .message-rating {
            display: flex;
            align-items: center;
        }
        
        .stars {
            display: flex;
            gap: 0.125rem;
        }
        
        .stars i {
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition-smooth);
            opacity: 0.7;
        }
        
        .stars i:hover {
            opacity: 1;
            transform: scale(1.2);
            color: var(--warning-gradient);
        }
        
        .stars i.fas {
            color: #fbbc04;
            opacity: 1;
        }

        /* ==================================== */
        /* FILE PREVIEW                         */
        /* ==================================== */
        .file-preview-container {
            display: none;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border-radius: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--glass-border);
        }
        .file-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }
        .file-preview img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .file-icon {
            font-size: 1.5rem;
            color: var(--text-muted);
        }
        .file-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .remove-file-btn {
            background: var(--danger-gradient);
            border: none;
            color: var(--text-inverse);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: var(--transition-smooth);
            opacity: 0.8;
        }
        .remove-file-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* ==================================== */
        /* MODAL E TOAST                        */
        /* ==================================== */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: var(--blur-effect);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            animation: slideInUp 0.4s ease-out;
        }
        .modal-content h3 {
            margin: 0 0 1rem 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .modal-content p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        .modal-content input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .modal-content input[type="text"]:focus {
            outline: none;
            border-color: rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
        }
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-xl);
            display: none;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            z-index: 1001;
            animation: slideInUp 0.4s ease-out;
        }
        
        /* ==================================== */
        /* RESPONSIVIDADE APRIMORADA            */
        /* ==================================== */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
            }
            .chat-wrapper {
                flex-direction: column;
                height: 100vh;
                border-radius: 0;
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 320px;
                max-width: 90vw;
                transform: translateX(-100%);
                z-index: 1000;
                box-shadow: var(--shadow-xl);
                padding: 1.5rem 1rem;
                transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
                border-radius: 0 1rem 1rem 0;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.95);
                z-index: 999;
            }
            .sidebar-overlay.active {
                display: block;
            }
            .chat-main {
                width: 100%;
                overflow-y: auto;
            }
            .chat-header-desktop {
                display: none;
            }
            .chat-header-mobile {
                display: flex;
                justify-content: flex-start;
                align-items: center;
                gap: 1rem;
                padding: 1rem 1.5rem;
                background: var(--glass-bg);
                backdrop-filter: var(--blur-effect);
                border-bottom: 1px solid var(--glass-border);
                position: sticky;
                top: 0;
                z-index: 100;
            }
            .mobile-title-share {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                flex: 1;
                min-width: 0;
            }
            #conversa-titulo-mobile {
                flex: 1;
                min-width: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 1rem;
                font-weight: 600;
                margin: 0;
                color: var(--text-primary);
            }
            .menu-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
                color: var(--text-inverse);
                cursor: pointer;
                font-size: 1.1rem;
                padding: 0.75rem;
                border-radius: 0.5rem;
                transition: var(--transition-smooth);
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }
            .menu-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }
            .chat-messages {
                padding: 1rem 1rem 8rem 1rem;
                max-width: 100%;
            }
            .chat-input-area {
                padding: 1rem 0.5rem 2rem 0.5rem;
                position: fixed;
                bottom: 10px;
                left: 0;
                right: 0;
            }
            .input-and-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            .footer-buttons {
                justify-content: center;
            }
            #personalidade-avatar {
                width: 16px !important;
                height: 16px !important;
            }
            .chat-input-container {
                border-radius: 1.5rem;
                gap: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
            #mensagem-input {
                font-size: 0.9rem;
            }
            .upload-btn, .send-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            .initial-suggestions-logo {
                width: 120px;
                height: 120px;
            }
            .suggestions-prompt {
                font-size: 1.25rem;
            }
            .quick-actions {
                grid-template-columns: 1fr;
            }
            .quick-action-btn {
                padding: 1.25rem;
                font-size: 0.9rem;
            }
            .content {
                max-width: 85%;
                padding: 1rem 1.25rem;
                font-size: 0.9rem;
            }
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }

        /* ==================================== */
        /* DESKTOP OPTIMIZATION                 */
        /* ==================================== */
        @media (min-width: 1200px) {
            .sidebar {
                width: 450px;
            }
            .chat-messages {
                max-width: 1200px;
                padding: 2.5rem 2.5rem 8rem 2.5rem;
            }
            .chat-header-desktop {
                padding: 2rem 2.5rem;
            }
            .sidebar-header {
                margin-bottom: 2.5rem;
            }
            .conversation-list {
                margin-top: 2.5rem;
            }
            .chat-input-area {
                padding: 0.5rem 1rem 0.5rem 1rem;
                position: fixed;
                bottom: 10px;
                left: 0;
                right: 0;
            }
            .chat-input-container {
                padding: 0.5rem 1rem;
            }
            #mensagem-input {
                min-height: 40px;
                font-size: 0.9rem;
            }
            .modal-content {
                max-width: 350px;
                width: 70%;
            }
            body::before {
                background-size: 15% auto;
                background-color: transparent;
            }
        }

        /* ==================================== */
        /* UTILITÁRIOS                          */
        /* ==================================== */
        .flex {
            display: flex;
        }
        .items-center {
            align-items: center;
        }
        .gap-2 {
            gap: 0.5rem;
        }
        .mt-4 {
            margin-top: 1rem;
        }
        .mb-4 {
            margin-bottom: 1rem;
        }
        .text-center {
            text-align: center;
        }
        .flex-1 {
            flex: 1;
        }
        .font-semibold {
            font-weight: 600;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .text-xs {
            font-size: 0.75rem;
        }
        .mr-2 {
            margin-right: 0.5rem;
        }
        .markdown-container {
            line-height: 1.7;
        }
        /* Os estilos de Prism são carregados dinamicamente, então removemos os manuais */
        .markdown-container pre {
            border: none;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            background: #1e1e1e;
            position: relative;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        .code-wrapper {
            position: relative;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            background: #1e1e1e;
            transition: all 0.3s ease;
        }
        .code-wrapper:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        .code-wrapper.enhanced {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .code-wrapper pre {
            padding-top: 4rem;
        }
        .code-ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3rem;
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(45, 45, 45, 0.95) 100%);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 10;
        }
        .language-label {
            background: rgba(26, 115, 232, 0.2);
            color: #4dabf7;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid rgba(26, 115, 232, 0.3);
        }
        .code-action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .code-action-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 2.5rem;
            min-height: 2.5rem;
        }
        .code-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .code-action-btn:active {
            transform: translateY(0);
        }
        .code-action-btn.copy-btn:hover {
            background: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.3);
        }
        .code-action-btn.download-btn:hover {
            background: rgba(23, 162, 184, 0.2);
            border-color: rgba(23, 162, 184, 0.3);
        }
        .code-action-btn.wrap-btn:hover {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.3);
        }
        pre.code-wrap-enabled {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        pre.code-wrap-enabled code {
            white-space: pre-wrap !important;
        }
        .content.collapsed {
            max-height: 200px;
            overflow: hidden;
            position: relative;
        }
        .content.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to bottom, transparent, var(--bg-chat));
        }
        .expand-btn {
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .expand-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        .code-expand-btn {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .code-expand-btn:hover {
            background: rgba(255, 193, 7, 0.2);
            transform: translateY(-1px);
        }
        .code-expand-btn.enhanced {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
            margin: 0.5rem auto;
            display: block;
            width: fit-content;
        }
        pre.code-collapsed {
            max-height: 300px;
            overflow: hidden;
            position: relative;
        }
        pre.code-collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to bottom, transparent, #1e1e1e);
            pointer-events: none;
        }
        .markdown-container code:not(pre code) {
            background: rgba(0, 123, 255, 0.1);
            color: var(--text-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Inter', monospace;
            font-size: 0.85rem;
            font-weight: 500;
        }
        /* Estilos adicionais para temas de código */
        /* Fundo sempre preto via Prism */

        .typing-effect {
            display: inline;
        }
        .typing-effect:after {
            content: '|';
            animation: blink-caret 0.75s step-end infinite;
        }
        .message-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease;
        }
        .message-image:hover {
            transform: scale(1.02);
        }
        .file-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .file-content a:hover {
            text-decoration: underline;
        }
        .media-content + .text-content {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .message.user .media-content + .text-content {
            border-top-color: rgba(0, 0, 0, 0.1);
        }
        .message .timestamp {
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.25rem;
            opacity: 0.7;
        }

        .message.user .timestamp {
            align-self: flex-end;
            text-align: right;
        }

        .message.model .timestamp {
            align-self: flex-start;
            text-align: left;
        }

        /* ==================================== */
        /* PERSONALIDADE MODAL                  */
        /* ==================================== */
        #personalidade-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        #personalidade-modal.show {
            display: flex;
        }
        .personalidade-modal-content {
            background: #ffffff;
            border-radius: 0; /* cantos quadrados no modal */
            padding: 1.5rem;
            width: 100%;
            max-width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            animation: slideUpContent 0.3s ease-out forwards;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes slideUpContent {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        .personalidades-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        .personalidade-item {
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .personalidade-item:hover {
            border-color: rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
        }
        .personalidade-item.selected {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.1);
        }
        .personalidade-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .personalidade-item .personalidade-info {
            flex: 1;
            text-align: left;
        }
        .personalidade-item h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 300;
        }
        .personalidade-item p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 300;
        }

        .lixeira-modal-content {
            max-width: 600px;
            width: 90%;
        }

        .lixeira-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .lixeira-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .lixeira-item-info {
            flex: 1;
        }

        .lixeira-item-info h4 {
            margin: 0 0 0.25rem 0;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .lixeira-item-info p {
            margin: 0;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .lixeira-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .lixeira-item-actions button {
            padding: 0.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition-smooth);
        }

        .lixeira-item-actions .restore-btn {
            background: var(--accent-gradient-blue);
            color: white;
        }

        .lixeira-item-actions .restore-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .lixeira-item-actions .delete-btn {
            background: var(--danger-gradient);
            color: white;
        }

        .lixeira-item-actions .delete-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .modal-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .modal-actions .modal-btn {
            flex: 1;
        }

        .limpar-modal-content {
            max-width: 500px;
            width: 90%;
        }

        .limpar-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .limpar-option {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            background: var(--glass-bg);
        }

        .limpar-option:hover {
            border-color: var(--accent-color);
            background: var(--glass-bg-hover);
        }

        .limpar-option input[type="radio"] {
            margin-top: 0.25rem;
            accent-color: var(--accent-color);
        }

        .limpar-option .option-content {
            flex: 1;
        }

        .limpar-option .option-content h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .limpar-option .option-content p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .excluir-modal-content {
            max-width: 450px;
            width: 90%;
        }

        .excluir-conversa-info {
            text-align: center;
            margin: 1.5rem 0;
        }

        .conversa-info-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .conversa-info-header i {
            font-size: 2rem;
            color: var(--danger-color);
        }

        .conversa-info-header span {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .conversa-details {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            padding: 1.25rem;
        }

        .conversa-details h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .conversa-details p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .excluir-mensagem-info {
            text-align: center;
            margin: 1.5rem 0;
        }

        .mensagem-info-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .mensagem-info-header i {
            font-size: 2rem;
            color: var(--danger-gradient);
        }

        .mensagem-info-header span {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .mensagem-content-preview {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .mensagem-content-preview h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .mensagem-preview {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
        }

        /* Modal de Transcrição de Voz */
        .voice-modal-content {
            text-align: center;
            position: relative;
            max-width: 600px;
            padding: 2.5rem;
            border-radius: 1.5rem;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: var(--shadow-xl);
        }

        .close-modal-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .close-modal-btn:hover {
            background: var(--danger-gradient);
            color: white;
            transform: scale(1.1);
            border-color: transparent;
        }

        .voice-modal-header {
            margin-bottom: 2rem;
        }

        .voice-icon-container {
            margin-bottom: 1rem;
        }

        .voice-main-icon {
            font-size: 3rem;
            color: var(--accent-gradient-blue, #667eea);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.3));
        }

        .voice-modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-gradient-blue, #667eea) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .voice-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin: 0;
            opacity: 0.8;
        }

        .voice-recording-area {
            margin: 2rem 0;
        }

        .voice-visualizer-container {
            position: relative;
            margin: 2rem 0;
            border-radius: 1rem;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 2px solid var(--glass-border);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .voice-canvas {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%);
            display: block;
            border-radius: 0.75rem;
        }

        .voice-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .voice-control-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            box-shadow: var(--shadow-md);
            min-width: 140px;
            justify-content: center;
        }

        .start-btn {
            background: linear-gradient(135deg, #34a853 0%, #2e7d32 100%);
            color: white;
        }

        .start-btn:hover {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stop-btn {
            background: linear-gradient(135deg, #ea4335 0%, #d33b2c 100%);
            color: white;
        }

        .stop-btn:hover {
            background: linear-gradient(135deg, #d33b2c 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .send-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Estados de gravação */
        #voice-modal.recording .visualizer-overlay {
            opacity: 0;
            pointer-events: none;
        }

        #voice-modal.recording .voice-canvas {
            box-shadow: inset 0 0 30px rgba(102, 126, 234, 0.3);
        }

        /* ==================================== */
        /* TEMA GEMINI (BRANCO CLEAN)           */
        /* ==================================== */
        [data-theme="gemini"] {
            --primary-gradient: linear-gradient(135deg, #121212 0%, #1e1e1e 100%);
            --secondary-gradient: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            --accent-gradient-red: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
            --accent-gradient-blue: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
            --accent-gradient-white: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);

            --success-gradient: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            --warning-gradient: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            --danger-gradient: linear-gradient(135deg, #6a1b9a 0%, #4a148c 100%);

            --bg-main: linear-gradient(135deg, #121212 0%, #1e1e1e 100%);
            --bg-secondary: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            --bg-chat: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(46,46,46,0.95) 100%);

            --glass-bg: rgba(30, 30, 30, 0.9);
            --glass-border: rgba(81, 81, 81, 0.3);
            --glass-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 4px 8px 3px rgba(0, 0, 0, 0.3);

            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --text-inverse: #000000;

            --border-color: rgba(81, 81, 81, 0.3);
            --hover-color: rgba(142, 36, 170, 0.1);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5), 0 1px 3px 1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 4px 8px 3px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 2px 6px 2px rgba(0, 0, 0, 0.3), 0 8px 24px 4px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 4px 12px 4px rgba(0, 0, 0, 0.3), 0 16px 48px 8px rgba(0, 0, 0, 0.2);

            --blur-effect: none;
            --transition-smooth: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            --transition-bounce: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        [data-theme="gemini"] body {
            background: #121212;
        }

        [data-theme="gemini"] .sidebar {
            background: #1e1e1e;
            border-right: 1px solid #515151;
            box-shadow: none;
        }

        [data-theme="gemini"] .sidebar-header {
            background: #1e1e1e;
            border-bottom: 1px solid #515151;
        }

        [data-theme="gemini"] .conversation-item {
            border-radius: 8px;
            margin: 4px 8px;
        }

        [data-theme="gemini"] .conversation-item:hover {
            background: rgba(142, 36, 170, 0.1);
        }

        [data-theme="gemini"] .conversation-item.active {
            background: rgba(142, 36, 170, 0.1);
            border-left: 3px solid #8e24aa;
        }

        [data-theme="gemini"] .chat-messages {
            background: #1e1e1e;
        }

        [data-theme="gemini"] .message.model .content {
            background: #2a2a2a;
            border: 1px solid #515151;
            border-radius: 4px 18px 18px 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            color: #ffffff;
        }

        [data-theme="gemini"] .message.user .content {
            background: #8e24aa;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            color: #ffffff;
        }

        [data-theme="gemini"] .chat-input-container {
            background: #2a2a2a;
            border: 1px solid #515151;
            border-radius: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        [data-theme="gemini"] .chat-input-container textarea {
            background: transparent;
            border: none;
            color: #ffffff;
        }

        [data-theme="gemini"] .chat-input-container textarea::placeholder {
            color: #808080;
        }

        [data-theme="gemini"] .send-btn {
            background: #8e24aa;
            color: white;
            border-radius: 50%;
        }

        [data-theme="gemini"] .send-btn:hover {
            background: #6a1b9a;
        }

        [data-theme="gemini"] .feedback-btn {
            background: transparent;
            border: none;
            color: #b0b0b0;
            opacity: 0.7;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        [data-theme="gemini"] .feedback-btn:hover {
            background: rgba(142, 36, 170, 0.1);
            opacity: 1;
        }

        [data-theme="gemini"] .feedback-btn.like.active {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        [data-theme="gemini"] .feedback-btn.dislike.active {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        /* ==================================== */
        /* THEME: TECH (Tecnológico Claro/Escuro) */
        /* ==================================== */

        [data-theme="tech"] {
            --primary-gradient: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient-red: linear-gradient(135deg, #ff0080 0%, #ff4000 100%);
            --accent-gradient-blue: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            --accent-gradient-white: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);

            --success-gradient: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            --warning-gradient: linear-gradient(135deg, #ffaa00 0%, #ff6600 100%);
            --danger-gradient: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);

            --bg-main: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            --bg-secondary: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            --bg-chat: linear-gradient(135deg, rgba(10, 10, 15, 0.95) 0%, rgba(26, 26, 46, 0.95) 100%);

            --glass-bg: rgba(10, 10, 15, 0.85);
            --glass-border: rgba(0, 212, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 212, 255, 0.15);

            --text-primary: #e6f3ff;
            --text-secondary: #b8d4f0;
            --text-muted: #7c9cb8;
            --text-inverse: #0a0a0f;

            --border-color: rgba(0, 212, 255, 0.2);
            --hover-color: rgba(0, 212, 255, 0.1);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.6), 0 1px 3px 1px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);

            --blur-effect: blur(12px);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            --transition-bounce: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        [data-theme="tech"] body {
            background: #0a0a0f;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 0, 128, 0.05) 0%, transparent 50%),
                linear-gradient(45deg, rgba(0, 212, 255, 0.03) 0%, rgba(255, 0, 128, 0.02) 100%);
        }

        [data-theme="tech"] .sidebar {
            background: linear-gradient(180deg, #0f1419 0%, #1a2332 100%);
            border-right: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 2px 0 20px rgba(0, 212, 255, 0.1);
        }

        [data-theme="tech"] .sidebar-header {
            background: linear-gradient(135deg, #1a2332 0%, #2a3441 100%);
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        [data-theme="tech"] .conversation-item {
            background: rgba(26, 35, 50, 0.7);
            border: 1px solid rgba(0, 212, 255, 0.1);
            color: #e6f3ff;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        [data-theme="tech"] .conversation-item:hover {
            background: rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.4);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
        }

        [data-theme="tech"] .conversation-item.active {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border-color: #00d4ff;
            color: #0a0a0f;
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.4);
        }

        [data-theme="tech"] .chat-messages {
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
        }

        [data-theme="tech"] .message.model .content {
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            border: 1px solid rgba(0, 212, 255, 0.2);
            color: #e6f3ff;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
        }

        [data-theme="tech"] .message.user .content {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border: 1px solid rgba(0, 212, 255, 0.4);
            color: #0a0a0f;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.2);
        }

        [data-theme="tech"] .chat-input-container {
            background: linear-gradient(135deg, #1a2332 0%, #2a3441 100%);
            border: 1px solid rgba(0, 212, 255, 0.3);
            backdrop-filter: blur(15px);
        }

        [data-theme="tech"] .chat-input-container input {
            background: transparent;
            border: none;
            color: #e6f3ff;
        }

        [data-theme="tech"] .chat-input-container input::placeholder {
            color: #7c9cb8;
        }

        [data-theme="tech"] .send-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            border: none;
            color: #0a0a0f;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        [data-theme="tech"] .send-btn:hover {
            background: linear-gradient(135deg, #00cc66 0%, #009944 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        [data-theme="tech"] .new-chat-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: var(--text-inverse);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        [data-theme="tech"] .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        [data-theme="tech"] .live-mode-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            border: none;
            color: #0a0a0f;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        [data-theme="tech"] .live-mode-btn:hover {
            background: linear-gradient(135deg, #00cc66 0%, #009944 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        [data-theme="tech"] .theme-btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border: none;
            color: #e6f3ff;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
        }

        [data-theme="tech"] .theme-btn:hover {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 60, 114, 0.4);
        }

        [data-theme="tech"] .modal-content {
            background: linear-gradient(135deg, #1a2332 0%, #2a3441 100%);
            border: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
        }

        [data-theme="tech"] .personality-btn {
            background: linear-gradient(135deg, #ff0080 0%, #ff4000 100%);
            border: none;
            color: #e6f3ff;
            box-shadow: 0 4px 15px rgba(255, 0, 128, 0.3);
        }

        [data-theme="tech"] .personality-btn:hover {
            background: linear-gradient(135deg, #ff4000 0%, #ff0080 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 128, 0.4);
        }

        [data-theme="tech"] .feedback-btn {
            background: rgba(26, 35, 50, 0.8);
            border: 1px solid rgba(0, 212, 255, 0.2);
            color: #b8d4f0;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        [data-theme="tech"] .feedback-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.5);
        }

        [data-theme="tech"] .feedback-btn.like.active {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: #0a0a0f;
            border-color: #00ff88;
        }

        [data-theme="tech"] .feedback-btn.dislike.active {
            background: linear-gradient(135deg, #ff0080 0%, #ff4000 100%);
            color: #e6f3ff;
            border-color: #ff0080;
        }

        /* ==================================== */
        /* FEEDBACK COMMENT BOX                  */
        /* ==================================== */
        .feedback-comment-box {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            margin-top: 8px;
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        .feedback-comment-box.show {
            display: block;
        }

        .feedback-comment-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            background: #ffffff;
            color: #202124;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .feedback-comment-input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .feedback-comment-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .feedback-comment-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .feedback-comment-btn.cancel {
            background: #f1f3f4;
            color: #5f6368;
        }

        .feedback-comment-btn.cancel:hover {
            background: #e8eaed;
        }

        .feedback-comment-btn.submit {
            background: #1a73e8;
            color: white;
        }

        .feedback-comment-btn.submit:hover {
            background: #1557b0;
        }

        .message-buttons {
            position: relative;
        }

        .edited-indicator {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-style: italic;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #personalidade-btn {
            cursor: pointer;
            transition: all 0.2s;
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            min-height: 32px;
        }

        #personalidade-btn:hover {
            background: var(--glass-hover);
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }

/* Efeitos sonoros para TTS */
.audio-playing {
    animation: audioPulse 1.5s ease-in-out infinite;
    position: relative;
}

.audio-playing::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border: 2px solid var(--accent-color);
    border-radius: 50%;
    animation: audioWave 1.5s ease-in-out infinite;
    pointer-events: none;
}

@keyframes audioPulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.8;
    }
}

@keyframes audioWave {
    0%, 100% {
        transform: scale(1);
        opacity: 0.6;
    }
    50% {
        transform: scale(1.2);
        opacity: 0;
    }
}

        /* ==================================== */
        /* COMPONENTE: BLOCO DE CÓDIGO (UI)     */
        /* ==================================== */
        .code-block {
            background: linear-gradient(180deg, rgba(30,30,30,0.98), rgba(20,20,20,0.98));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            margin: 1.5rem 0;
            position: relative;
            transition: all 0.3s ease;
        }
        .code-block:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        .code-block .code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(90deg, rgba(102,126,234,0.15), rgba(255,255,255,0.03));
            border-bottom: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }
        .code-block .language-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #ffffff;
            font-size: 0.95rem;
        }
        .language-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .code-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .code-actions button {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
            color: #ffffff;
            cursor: pointer;
            padding: 0.5rem 0.8rem;
            border-radius: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .code-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            border-color: rgba(255,255,255,0.3);
        }
        .code-actions button:active {
            transform: translateY(0);
        }
        .code-actions button i {
            width: 16px;
            font-size: 0.9rem;
        }
        .code-actions button.success {
            background: linear-gradient(135deg, #34a853 0%, #2e7d32 100%);
            border-color: rgba(52, 168, 83, 0.5);
        }
        .code-actions button.success:hover {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        }

        .code-area {
            padding: 1.5rem;
            background: linear-gradient(180deg, #0f1720 0%, #1e293b 100%);
            position: relative;
        }
        .code-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        .code-area pre {
            margin: 0;
            white-space: pre;
            overflow-x: auto;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #e2e8f0;
            background: transparent;
            border: none;
            padding: 0;
        }
        .code-area pre.wrap {
            white-space: pre-wrap;
            word-break: break-word;
        }
        .code-area pre::-webkit-scrollbar {
            height: 6px;
        }
        .code-area pre::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        .code-area pre::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        .code-area pre.show-line-numbers {
            counter-reset: line;
            padding-left: 3rem;
            position: relative;
        }
        .code-area pre.show-line-numbers::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 2.5rem;
            height: 100%;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .code-area pre.show-line-numbers code {
            display: block;
            position: relative;
        }
        .code-area pre.show-line-numbers code::before {
            counter-increment: line;
            content: counter(line);
            position: absolute;
            left: -3rem;
            top: 0;
            width: 2rem;
            text-align: right;
            color: rgba(255,255,255,0.4);
            font-size: 0.8rem;
            font-weight: 500;
            user-select: none;
        }

        .code-footer {
            padding: 0.75rem 1rem;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            background: linear-gradient(90deg, rgba(0,0,0,0.3), rgba(0,0,0,0.1));
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .code-meta {
            font-weight: 500;
        }
        .code-meta strong {
            color: #667eea;
        }
        .code-hint {
            opacity: 0.8;
            font-style: italic;
        }

        /* Animações para feedback */
        @keyframes buttonPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .code-actions button.feedback {
            animation: buttonPulse 0.6s ease;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .code-block .code-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .code-actions {
                width: 100%;
                justify-content: center;
            }
            .code-actions button {
                flex: 1;
                justify-content: center;
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            .code-area {
                padding: 1rem;
            }
            .code-footer {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
        }

        /* Estilos para ícones roxos no header */
        .edit-title-icon,
        .edit-title-icon-mobile,
        #share-btn,
        #share-btn-mobile {
            color: white;
            background-color: #8e24aa;
            padding: 0.3rem;
            border-radius: 4px;
        }

    </style>
</head>
<body data-theme="black-red">
    <div class="chat-wrapper">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-and-title">
                    <h2 id="nome-ia-sidebar">Dark Duck Intelligence</h2>
                </div>
                <button id="toggle-sidebar-btn" class="menu-btn" title="Alternar menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <button id="nova-conversa-btn" class="new-chat-btn" data-url="/">
                <i class="fas fa-plus"></i>
                Nova Conversa
            </button>
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="search-conversas" placeholder="Buscar conversas...">
            </div>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button id="my-conversations-btn" class="filter-btn" title="Mostrar apenas minhas conversas">
                    <i class="fas fa-user"></i>
                    Minhas Conversas
                </button>
                <button id="anonymous-conversations-btn" class="filter-btn anonymous-btn" title="Mostrar conversas anônimas">
                    <i class="fas fa-user-secret"></i>
                    Conversas Anônimas
                </button>
            </div>
            <div class="conversation-list" id="conversas-lista">
                <div id="loading-conversas" class="loading-spinner" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Atualizando conversas...</span>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="developer-credit">
                                    <p style="margin: 0; opacity: 0.8; font-size: 0.75rem; text-align: center; color: #8e24aa;">
                                    <strong style="color: #8e24aa; font-size: 0.8rem; font-weight:600;">Plataforma Dark Duck Intelligence™</strong>
                                </p>
                </div>
            </div>
        </div>
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <main class="chat-main" id="chat-main">
            <header class="chat-header-desktop" id="chat-header-desktop">
                <div class="flex items-center gap-2">
                    <span id="response-time-indicator" class="status-indicator" style="display: none;">
                        <span id="response-time-text"></span>
                        <div class="loading-typing-indicator">
                            <div class="tech-spinner"></div>
                            <span>Rede Neural em ação</span>
                        </div>
                    </span>
                    <span id="token-count-sidebar" class="status-indicator">Tokens: 0</span>
                    <button id="cancel-response-btn" class="theme-btn cancel-btn" title="Cancelar Resposta" style="display: none;">
                        <i class="fas fa-stop"></i>
                    </button>
                    <i id="share-btn" class="fas fa-share-alt" title="Compartilhar Conversa" style="display: none;"></i>
                </div>
                <div id="conversa-titulo-container" class="conversation-title-container" style="display: none;">
                    <span id="conversa-titulo" class="conversation-title">Selecione uma Conversa</span>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Espaço para botões adicionais se necessário -->
                </div>
            </header>
            <header class="chat-header-mobile" id="chat-header-mobile" style="display: none;">
                <button id="toggle-sidebar-btn-mobile" class="menu-btn" title="Alternar menu">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="mobile-title-share">
                    <div id="conversa-titulo-mobile-container" class="conversation-title-container">
                        <span id="conversa-titulo-mobile">Selecione uma Conversa</span>
                    </div>
                    <i id="share-btn-mobile" class="fas fa-share-alt" title="Compartilhar Conversa"></i>
                </div>
            </header>
            <div class="chat-messages" id="mensagens-container">
                <div id="loader" class="loading-typing-indicator" style="display: none;">
                    <span>Rede Neural em ação</span>
                    <canvas id="neural-canvas" width="300" height="60"></canvas>
                </div>
                <div id="no-chat-message" class="initial-info-message">
                    <div class="message system">
                        <div class="message-avatar">
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author"><p>Bem-vindo ao <strong>Dark Duck</strong>!</span>
                            </div>
                            <div class="message-text">
                                <div id="welcome-text" style="text-align: center; margin-top: 10px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>


            <footer class="chat-input-area" id="chat-input-area">
                <div class="input-section">
                    <!-- Área de pré-visualização de arquivos -->
                    <div id="file-previews" class="file-preview-container"></div>

                    <!-- Design inspirado no Gemini -->
                    <div class="gemini-chat-input">
                        <!-- Campo de input principal -->
                        <div class="input-field-container">
                            <form id="chat-form" class="chat-form">
                                <div class="input-field">
                                    <button type="button" id="upload-btn" class="input-icon-btn" title="Anexar arquivos">
                                        <i class="fas fa-paperclip"></i>
                                    </button>

                                    <textarea
                                        id="mensagem-input"
                                        name="mensagem"
                                        placeholder="Digite sua mensagem..."
                                        required
                                        rows="1"
                                        maxlength="2000"
                                        class="message-textarea"
                                    ></textarea>

                                    <button type="button" id="audio-btn" class="input-icon-btn" title="Gravar áudio">
                                        <i class="fas fa-microphone"></i>
                                    </button>

                                    <button type="button" id="send-btn" class="send-button" title="Enviar">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>

                                    <button type="button" id="cancel-btn" class="input-icon-btn cancel-btn" title="Cancelar" style="display: none;">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                </div>
                            </form>
                            <input type="file" id="arquivo-input" style="display: none;" multiple>
                        </div>
                    </div>

                        <!-- Barra de ferramentas inferior -->
                        <div class="input-toolbar">
                            <div class="toolbar-left">
                                <button id="personalidade-btn" class="toolbar-icon-btn" title="Modelos">
                                    <img id="personalidade-avatar" src="" alt="Avatar do modelo" class="personality-avatar-small">
                                    <span id="personalidade-name">DUCK-PRO-02</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <button id="busca-web-btn" class="toolbar-icon-btn" title="Busca na web">
                                    <i class="fas fa-globe"></i>
                                    <span class="btn-label">Web</span>
                                </button>
                                <button id="clear-chat-btn" class="toolbar-icon-btn" title="Limpar conversa">
                                    <i class="fas fa-trash-alt"></i>
                                    <span class="btn-label">Limpar</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Mensagem para usuários não donos da conversa -->
                    <div id="chat-owner-message" class="chat-owner-message" aria-hidden="true" style="display: none;">
                        <p id="chat-owner-message-text">Essa conversa é de <strong id="chat-owner-name"></strong>. Crie as suas para interagir.</p>
                        <button id="create-conversation-btn" class="create-conversation-btn">Criar minha conversa</button>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Modal de Compartilhamento -->
    <div id="share-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Link Compartilhável</h3>
            <p>Copie o link abaixo para compartilhar esta conversa.</p>
            <div class="flex items-center gap-2 mb-4">
                <input type="text" id="share-link-input" readonly class="flex-1">
                <button id="copy-share-link-btn" class="modal-btn confirm">
                    Copiar
                </button>
            </div>
            <button id="close-share-modal-btn" class="modal-btn cancel">
                Fechar
            </button>
        </div>
    </div>

    <!-- Modal de Editar Título -->
    <div id="edit-title-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Editar Título da Conversa</h3>
            <p>Digite o novo título para esta conversa.</p>
            <div class="flex items-center gap-2 mb-4">
                <input type="text" id="edit-title-input" class="flex-1" placeholder="Novo título">
            </div>
            <div class="modal-actions">
                <button id="cancel-edit-title-btn" class="modal-btn cancel">
                    Cancelar
                </button>
                <button id="confirm-edit-title-btn" class="modal-btn confirm">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Aviso de Link -->
    <div id="link-warning-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Aviso de Link Externo</h3>
            <p>Você está prestes a acessar um link externo. Deseja continuar?</p>
            <div class="link-warning-url" id="link-warning-url" style="word-break: break-all; background: rgba(0,0,0,0.1); padding: 0.5rem; border-radius: 0.5rem; margin: 1rem 0; font-family: monospace; font-size: 0.9rem;"></div>
            <div class="modal-actions">
                <button id="cancel-link-btn" class="modal-btn cancel">
                    Cancelar
                </button>
                <button id="confirm-link-btn" class="modal-btn confirm">
                    <i class="fas fa-external-link-alt"></i> Acessar Link
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Personalidades -->
    <div id="personalidade-modal" class="modal-backdrop">
        <div class="modal-content personalidade-modal-content">
            <h3>Escolher Personalidade</h3>
            <div id="personalidades-list" class="personalidades-list">
                <!-- Personalidades serão carregadas aqui -->
            </div>
            <button id="close-personalidade-modal-btn" class="modal-btn cancel">
                Fechar
            </button>
        </div>
    </div>

    <!-- Modal de Exclusão de Conversa Individual -->
    <div id="excluir-conversa-modal" class="modal-backdrop">
        <div class="modal-content excluir-modal-content">
            <h3>Cancelar Conversa</h3>
            <div class="excluir-conversa-info">

                <div class="conversa-details">
                    <h4 id="excluir-conversa-titulo">Título da Conversa</h4>
                    <p>Tem certeza de que deseja continuar?</p>
                </div>
            </div>

            <div class="modal-actions">
                <button id="cancelar-excluir-conversa-btn" class="modal-btn cancel">
                    Cancelar
                </button>
                <button id="confirmar-excluir-conversa-btn" class="modal-btn confirm">
                    <i class="fas fa-trash-alt"></i>Excluir Conversa
                </button>
            </div>
        </div>
    </div>
        <div class="modal-content">
            <h3 id="custom-confirm-title">Confirmação</h3>
            <p id="custom-confirm-message"></p>
            <div class="flex gap-2">
                <button id="custom-confirm-ok-btn" class="modal-btn confirm flex-1">
                    Confirmar
                </button>
                <button id="custom-confirm-cancel-btn" class="modal-btn cancel flex-1">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Modal de Transcrição de Voz Aprimorado -->
    <div id="voice-modal" class="modal-backdrop">
        <div class="modal-content voice-modal-content">
            <button id="close-voice-modal" class="close-modal-btn" title="Fechar">
                <i class="fas fa-times"></i>
            </button>

            <div class="voice-modal-header">
                <div class="voice-icon-container">
                    <i class="fas fa-microphone voice-main-icon"></i>
                </div>
                <h3>Gravação de Voz</h3>
                <p class="voice-subtitle">Fale claramente para transcrever sua mensagem</p>
            </div>

            <div class="voice-recording-area">
                <div class="voice-visualizer-container">
                    <canvas id="voice-canvas" class="voice-canvas" width="500" height="140"></canvas>
                </div>
            </div>

            <div class="voice-controls">
                <button id="start-voice-btn" class="voice-control-btn start-btn">
                    <i class="fas fa-play"></i>
                    <span>Iniciar</span>
                </button>
                <button id="stop-voice-btn" class="voice-control-btn stop-btn" style="display: none;">
                    <i class="fas fa-stop"></i>
                    <span>Parar</span>
                </button>
                <button id="send-voice-btn" class="voice-control-btn send-btn" style="display: none;">
                    <i class="fas fa-paper-plane"></i>
                    <span>Enviar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Resposta por Voz -->
    <div id="response-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content voice-modal-content">
            <button id="close-response-modal" class="close-modal-btn" title="Fechar">&times;</button>
            <h3>Resposta da IA</h3>
            <p id="response-text"></p>
            <div class="modal-actions">
                <button id="close-response-btn" class="modal-btn cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para excluir mensagem -->
    <div id="excluir-mensagem-modal" class="modal-backdrop">
        <div class="modal-content excluir-modal-content">
            <h3>Excluir Mensagem</h3>
            <div class="excluir-mensagem-info">
                <div class="mensagem-info-header">
                    <span>Esta mensagem será excluída permanentemente.</span>
                </div>
                <div class="mensagem-content-preview">
                    <h4>Conteúdo da Mensagem:</h4>
                    <div id="mensagem-preview-content" class="mensagem-preview"></div>
                </div>
                <p>Tem certeza de que deseja continuar?</p>
            </div>

            <div class="modal-actions">
                <button id="cancelar-excluir-mensagem-btn" class="modal-btn cancel">
                    Cancelar
                </button>
                <button id="confirmar-excluir-mensagem-btn" class="modal-btn confirm">
                    <i class="fas fa-trash-alt"></i>Excluir Mensagem
                </button>
            </div>
        </div>
    </div>

    <!-- Modal da Lixeira -->
    <div id="lixeira-modal" class="modal-backdrop">
        <div class="modal-content lixeira-modal-content">
            <button id="close-lixeira-modal-btn" class="close-modal-btn" title="Fechar">&times;</button>
            <h3>Lixeira</h3>
            <p>Conversas excluídas são mantidas aqui por 30 dias antes de serem removidas permanentemente.</p>
            <div id="lixeira-list" class="lixeira-list">
                <!-- Conversas excluídas serão carregadas aqui -->
            </div>
            <div class="modal-actions">
                <button id="esvaziar-lixeira-btn" class="modal-btn danger">
                    <i class="fas fa-trash-alt"></i> Esvaziar Lixeira
                </button>
                <button id="close-lixeira-modal-btn-bottom" class="modal-btn cancel">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Informações -->
    <div id="info-modal" class="modal-backdrop">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <button id="close-info-modal" class="close-modal-btn" title="Fechar">&times;</button>
            <h3><i class="fas fa-shield-alt"></i> Segurança e Privacidade</h3>
            <div style="text-align: left; line-height: 1.6;">
                
                <div style="background: var(--glass-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--glass-border);">
                    <h4 style="color: var(--success-color); margin-top: 0;"><i class="fas fa-user-secret"></i> Anonimato e Privacidade</h4>
                    <ul style="margin-bottom: 0;">
                        <li><strong>Anonimato Total:</strong> Suas conversas são públicas, mas você permanece completamente anônimo</li>
                        <li><strong>Sem Identificação Pessoal:</strong> Nenhum perfil, email ou informação pessoal é associada às suas conversas</li>
                        <li><strong>Controle Total:</strong> Você pode excluir suas conversas e mensagens a qualquer momento</li>
                        <li><strong>Sessões Temporárias:</strong> Usuários não logados têm conversas identificadas apenas por sessão temporária</li>
                    </ul>
                </div>

                <div style="background: var(--glass-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--glass-border);">
                    <h4 style="color: var(--warning-color); margin-top: 0;"><i class="fas fa-eye"></i> Conversas Públicas</h4>
                    <ul style="margin-bottom: 0;">
                        <li><strong>Visibilidade Pública:</strong> Todas as conversas são visíveis para qualquer pessoa que acessar o sistema</li>
                        <li><strong>Descoberta Anônima:</strong> Use "Ver Conversas Anônimas" para explorar conteúdo de outros usuários</li>
                        <li><strong>Contribuição Comunitária:</strong> Suas conversas ajudam a enriquecer o conhecimento coletivo da IA</li>
                        <li><strong>Moderação Transparente:</strong> Conversas podem ser sinalizadas se violarem diretrizes de uso</li>
                    </ul>
                </div>

                <div style="background: var(--glass-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--glass-border);">
                    <h4 style="color: var(--info-color); margin-top: 0;"><i class="fas fa-question-circle"></i> Perguntas Frequentes</h4>
                    <div style="margin-bottom: 1rem;">
                        <strong>P: Alguém pode me identificar pelas minhas conversas?</strong><br>
                        <span style="color: var(--text-muted);">R: Não, você é completamente anônimo. Não há perfis, contas ou identificação pessoal.</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>P: Posso excluir minhas conversas?</strong><br>
                        <span style="color: var(--text-muted);">R: Sim, você pode excluir qualquer conversa ou mensagem que tenha criado.</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>P: Como funciona o anonimato?</strong><br>
                        <span style="color: var(--text-muted);">R: Suas conversas existem como conteúdo público anônimo, sem qualquer ligação com sua identidade.</span>
                    </div>
                    <div style="margin-bottom: 0;">
                        <strong>P: É seguro usar o sistema?</strong><br>
                        <span style="color: var(--text-muted);">R: Sim, sua privacidade é protegida pelo anonimato total e controle sobre seu conteúdo.</span>
                    </div>
                </div>

                <div style="background: rgba(138, 43, 226, 0.1); padding: 1rem; border-radius: 0.5rem; border: 1px solid rgba(138, 43, 226, 0.3);">
                    <h4 style="color: #8a2be2; margin-top: 0;"><i class="fas fa-lightbulb"></i> Sobre o Sistema</h4>
                    <ul style="margin-bottom: 0;">
                        <li>O sistema funciona como um repositório público de conhecimento conversacional</li>
                        <li>Suas contribuições ajudam a melhorar as respostas da IA para todos os usuários</li>
                        <li>O anonimato permite interação livre e sem julgamentos</li>
                        <li>Você tem controle total sobre o que contribui e pode remover conteúdo a qualquer momento</li>
                        <li>Use o botão "Minhas Conversas" para ver apenas seu conteúdo pessoal</li>
                    </ul>
                </div>

            </div>
            <div class="modal-actions" style="margin-top: 1.5rem;">
                <button id="close-info-modal-bottom" class="modal-btn cancel">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <input type="hidden" name="csrfmiddlewaretoken" id="csrf-token-input" value="G2fPnZfR8IKmME8T8W1dZAPJsZtpDJNE3p7JERoiEkRfydQ3cheQ2nDdZCh2G16P">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
            const toggleSidebarBtnMobile = document.getElementById('toggle-sidebar-btn-mobile');
            const darkBtn = document.getElementById('dark-mode-toggle');
            const darkBtnMobile = document.getElementById('dark-mode-toggle-mobile');
            const novaConversaBtn = document.getElementById('nova-conversa-btn');
            const conversasLista = document.getElementById('conversas-lista');
            const mensagensContainer = document.getElementById('mensagens-container');
            const mensagemInput = document.getElementById('mensagem-input');
            const chatForm = document.getElementById('chat-form');
            const loader = document.getElementById('loader');
            const noChatMessage = document.getElementById('no-chat-message');
            const conversaTitulo = document.getElementById('conversa-titulo');
            const conversaTituloMobile = document.getElementById('conversa-titulo-mobile');
            const tokenCountSidebar = document.getElementById('token-count-sidebar');
            const arquivoInput = document.getElementById('arquivo-input');
            const filePreviews = document.getElementById('file-previews');
            const iaLogoPlaceholder = document.getElementById('ia-logo-placeholder');
            const sendButton = document.getElementById('send-btn');
            const createConversationBtn = document.getElementById('create-conversation-btn');

            // Botão de criar conversa na mensagem substituta aciona o botão de nova conversa
            if (createConversationBtn && novaConversaBtn) {
                createConversationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    novaConversaBtn.click();
                });
            }
            
            // Check for message parameter in URL or context
            const urlParams = new URLSearchParams(window.location.search);
            const messageParam = urlParams.get('message') || '';
            if (messageParam && mensagemInput) {
                mensagemInput.value = decodeURIComponent(messageParam);
                // Auto-focus and adjust height
                mensagemInput.focus();
                mensagemInput.style.height = 'auto';
                mensagemInput.style.height = mensagemInput.scrollHeight + 'px';
                
                // Auto-submit instantly for faster response
                setTimeout(() => {
                    chatForm.dispatchEvent(new Event('submit'));
                }, 50);
            }
            
            if (sendButton) {
                sendButton.addEventListener('click', () => {
                    chatForm.dispatchEvent(new Event('submit'));
                });
            }
            const cancelButton = document.getElementById('cancel-btn');

            let isMobileView = false;
            const logoIaSidebar = document.getElementById('logo-ia-sidebar');
            const chatHeaderMobile = document.getElementById('chat-header-mobile');
            const csrfTokenInput = document.getElementById('csrf-token-input');
            const quickActionButtons = document.querySelectorAll('.quick-action-btn');
            const shareBtn = document.getElementById('share-btn');
            const shareModal = document.getElementById('share-modal');
            const shareLinkInput = document.getElementById('share-link-input');
            const copyShareLinkBtn = document.getElementById('copy-share-link-btn');
            const closeShareModalBtn = document.getElementById('close-share-modal-btn');
            
            const editTitleModal = document.getElementById('edit-title-modal');
            const editTitleInput = document.getElementById('edit-title-input');
            const cancelEditTitleBtn = document.getElementById('cancel-edit-title-btn');
            const confirmEditTitleBtn = document.getElementById('confirm-edit-title-btn');
            
            const buscaWebBtn = document.getElementById('busca-web-btn');
            
            // Map to track current TTS utterances per message
            const currentTTSUtterances = new Map();
            let isStoppingTTSManually = false;
            // Velocidade do destaque das palavras no TTS (multiplicador, 1 = padrão)
            let ttsHighlightSpeed = 1;
            // Tempos de pausa para pontuação no TTS (em ms)
            let ttsPauseEndOfSentence = 1300; // Pausa para fim de frase (! ? .)
            let ttsPauseComma = 600; // Pausa para vírgula, ponto e vírgula etc.
            let ttsPauseColon = 700; // Pausa para dois pontos (:)
            let ttsPauseNumber = 500; // Pausa extra para números
            
            // Novos elementos do modal de confirmação
            const customConfirmModal = document.getElementById('custom-confirm-modal');
            const customConfirmMessage = document.getElementById('custom-confirm-message');
            const customConfirmOkBtn = document.getElementById('custom-confirm-ok-btn');
            const customConfirmCancelBtn = document.getElementById('custom-confirm-cancel-btn');

            let currentConversationId = null;
            let attachedFiles = [];
            let isLoading = false;
            let personalidadesData = [];
            let selectedPersonality = null;
            let isBuscaWebEnabled = false; // Estado da busca na web
            let isLiveModeEnabled = localStorage.getItem('liveMode') === 'true'; // Estado do modo live
            let showOnlyMine = true; // Filtro para mostrar apenas conversas próprias
            let isConversationOwner = false; // Se o usuário atual é dono da conversa
            let conversationOwnerName = ''; // Nome do dono da conversa
            const themes = ['black-red', 'dark', 'cosmic', 'moderno-claro', 'gemini', 'tech'];

            const prismDarkTheme = document.getElementById('prism-dark-theme');
            const prismLightTheme = document.getElementById('prism-light-theme');
            const messagePrefill = '';
            const personalidadePrefill = '';
            const initialConversationId = '';

            function typeWriter(parts, container, speed = 20) {
                let partIndex = 0;
                let charIndex = 0;
                function type() {
                    if (partIndex < parts.length) {
                        const part = parts[partIndex];
                        if (charIndex === 0) {
                            const span = document.createElement('span');
                            span.style = part.style;
                            container.appendChild(span);
                        }
                        const currentSpan = container.lastChild;
                        if (charIndex < part.text.length) {
                            let char = part.text.charAt(charIndex);
                            if (char === '\n') {
                                currentSpan.innerHTML += '<br>';
                            } else {
                                currentSpan.innerHTML += char;
                            }
                            charIndex++;
                            setTimeout(type, speed);
                        } else {
                            partIndex++;
                            charIndex = 0;
                            setTimeout(type, speed);
                        }
                    } else {
                        container.classList.remove('typing-effect');
                    }
                }
                type();
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrfToken = csrfTokenInput ? csrfTokenInput.value : getCookie('csrftoken');

            function initTheme() {
                const storedTheme = localStorage.getItem('theme') || 'black-red';
                document.body.dataset.theme = storedTheme;
                updateThemeButtonIcon(storedTheme);
                updatePrismTheme(storedTheme);
            }

            function updatePrismTheme(theme) {
                // Sempre usar tema escuro para fundo preto
                prismDarkTheme.disabled = false;
                prismLightTheme.disabled = true;
            }

            function updateThemeButtonIcon(theme) {
                const isDarkTheme = ['dark', 'black-red', 'cosmic', 'tech'].includes(theme);
                const icon = isDarkTheme ? 'fa-sun' : 'fa-moon';
                
                [darkBtn, darkBtnMobile].forEach(btn => {
                    if (btn) {
                        btn.innerHTML = `<i class="fas ${icon}"></i>`;
                    }
                });
            }

            function toggleTheme() {
                const currentTheme = document.body.dataset.theme;
                const currentIndex = themes.indexOf(currentTheme);
                const nextIndex = (currentIndex + 1) % themes.length;
                const newTheme = themes[nextIndex];
                
                document.body.dataset.theme = newTheme;
                localStorage.setItem('theme', newTheme);
                updateThemeButtonIcon(newTheme);
                updatePrismTheme(newTheme);
            }

            [darkBtn, darkBtnMobile].forEach(btn => {
                if (btn) btn.addEventListener('click', toggleTheme);
            });
            
            initTheme();

            // Welcome image effect
            const welcomeImage = document.getElementById('welcome-image');
            const welcomeText = document.getElementById('welcome-text');
            if (welcomeImage && welcomeText) {
                // After 5 seconds, hide image and show text
                setTimeout(() => {
                    welcomeImage.style.display = 'none';
                    welcomeText.style.display = 'block';
                }, 5000);
            }

            function checkMobile() {
                isMobileView = window.innerWidth <= 768;
                if (isMobileView) {
                    chatHeaderMobile.style.display = 'flex';
                } else {
                    chatHeaderMobile.style.display = 'none';
                }
            }
            
            window.addEventListener('resize', checkMobile);
            checkMobile();

            // Ocultar botão de envio inicialmente
            if (sendButton) {
                sendButton.style.display = 'none';
            }

            // Funcionalidade de input de mensagem
            if (mensagemInput) {
                const audioIcon = document.getElementById('audio-btn');
                mensagemInput.addEventListener('input', () => {
                    const hasText = mensagemInput.value.trim().length > 0;
                    const hasFiles = attachedFiles.length > 0;
                    if (hasText || hasFiles) {
                        sendButton.style.display = '';
                    } else {
                        sendButton.style.display = 'none';
                    }
                    // Hide audio icon when there is text
                    if (audioIcon) {
                        audioIcon.style.display = hasText ? 'none' : '';
                    }
                    // Auto-resize textarea
                    mensagemInput.style.height = 'auto';
                    mensagemInput.style.height = mensagemInput.scrollHeight + 'px';
                });
                
                // Set initial state
                const initialHasText = mensagemInput.value.trim().length > 0;
                if (audioIcon) {
                    audioIcon.style.display = initialHasText ? 'none' : '';
                }
                
                // Set message prefill if available
                if (messagePrefill) {
                    mensagemInput.value = messagePrefill;
                    mensagemInput.dispatchEvent(new Event('input'));
                }

                mensagemInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (sendButton.style.display !== 'none') {
                            chatForm.dispatchEvent(new Event('submit'));
                        }
                    }
                });
            }

            async function loadPersonalidades() {
                try {
                    const response = await fetch('/api/personalidades/');
                    if (!response.ok) throw new Error('Não foi possível carregar as personalidades.');
                    const data = await response.json();
                    personalidadesData = data.personalidades;
                    if (personalidadesData.length > 0) {
                        if (personalidadePrefill) {
                            const pref = personalidadesData.find(p => p.nome === personalidadePrefill);
                            if (pref) {
                                selectedPersonality = pref;
                            } else {
                                selectedPersonality = personalidadesData[0];
                            }
                        } else {
                            selectedPersonality = personalidadesData[0];
                        }
                        updatePersonalityAvatar(selectedPersonality.foto_ia_url);
                        updatePersonalityName(selectedPersonality.nome);
                        updatePersonalityButton();
                    }
                } catch (error) {
                    console.error('Erro ao carregar personalidades:', error);
                    showToast('Erro ao carregar personalidades: ' + error.message, 'error');
                }
            }
            function updatePersonalityButton() {
                const btn = document.getElementById('personalidade-btn');
                const img = document.getElementById('personalidade-avatar');
                const nameSpan = document.getElementById('personalidade-name');
                if (btn && selectedPersonality) {
                    if (img) {
                        img.src = selectedPersonality.foto_ia_url || 'logos.jpeg';
                    }
                    if (nameSpan) {
                        nameSpan.textContent = selectedPersonality.nome;
                    }
                    if (mensagemInput) {
                        mensagemInput.placeholder = `Peça ao ${selectedPersonality.nome}`;
                    }
                }
            }

            function openPersonalidadeModal() {
                const modal = document.getElementById('personalidade-modal');
                const list = document.getElementById('personalidades-list');
                list.innerHTML = '';
                personalidadesData.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'personalidade-item';
                    if (selectedPersonality && selectedPersonality.nome === p.nome) {
                        item.classList.add('selected');
                    }
                    item.innerHTML = `
                        <img src="${p.foto_ia_url || 'logos.jpeg'}" alt="${p.nome}">
                        <div class="personalidade-info">
                            <h4>${p.nome}</h4>
                            <p>${p.descricao || 'Sem descrição'}</p>
                        </div>
                    `;
                        item.addEventListener('click', () => {
                        selectedPersonality = p;
                        updatePersonalityAvatar(p.foto_ia_url);
                        updatePersonalityName(p.nome);
                        updatePersonalityButton();
                        closePersonalidadeModal();
                        showToast('Personalidade alterada para ' + p.nome, 'success');
                        if (currentConversationId) {
                            const messageEl = document.createElement('div');
                            messageEl.classList.add('message', 'system');
                            messageEl.innerHTML = '<div class="message-avatar"><i class="fas fa-info-circle"></i></div><div class="message-content"><div class="message-text"><p>Personalidade alterada para <strong>' + p.nome + '</strong>.</p></div></div>';
                            mensagensContainer.insertBefore(messageEl, mensagensContainer.firstChild);
                            mensagensContainer.scrollTop = 0;
                        }
                    });
                    list.appendChild(item);
                });
                modal.classList.add('show');
                // atualizar estado ARIA
                const btn = document.getElementById('personalidade-btn');
                if (btn) btn.setAttribute('aria-expanded', 'true');
            }

            function closePersonalidadeModal() {
                const modal = document.getElementById('personalidade-modal');
                if (modal) {
                    modal.classList.remove('show');
                }
                const btn = document.getElementById('personalidade-btn');
                if (btn) btn.setAttribute('aria-expanded', 'false');
            }

            function togglePersonalidadeModal() {
                const modal = document.getElementById('personalidade-modal');
                if (!modal) return;
                if (modal.classList.contains('show')) {
                    closePersonalidadeModal();
                } else {
                    openPersonalidadeModal();
                }
            }

            function updatePersonalityAvatar(imageUrl) {
                if (iaLogoPlaceholder) iaLogoPlaceholder.src = imageUrl;
                if (logoIaSidebar) logoIaSidebar.src = imageUrl;
            }

            function updatePersonalityName(name) {
                const nomeIaSidebar = document.getElementById('nome-ia-sidebar');
                if (nomeIaSidebar) nomeIaSidebar.textContent = name;
            }

            async function loadConversations() {
                const loadingElement = document.getElementById('loading-conversas');
                if (loadingElement) loadingElement.style.display = 'flex';
                
                try {
                    const url = `/api/conversas/?only_mine=${showOnlyMine}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Não foi possível carregar as conversas.');
                    const data = await response.json();
                    
                    // Filtro adicional para garantir que "Conversas Anônimas" mostre apenas conversas de outros usuários
                    let conversasFiltradas = data.conversas;
                    if (!showOnlyMine) {
                        conversasFiltradas = data.conversas.filter(c => !c.is_owner);
                    }
                    
                    conversasLista.innerHTML = '';
                    if (conversasFiltradas.length === 0) {
                        conversasLista.innerHTML = `<p class="text-center" style="font-size: 0.875rem; color: var(--text-muted); margin-top: 1rem;">Nenhuma conversa encontrada.</p>`;
                        return;
                    }

                    conversasFiltradas.forEach(c => {
                        const item = document.createElement('div');
                        item.classList.add('conversation-item-wrapper');
                        if (c.excluida) {
                            item.classList.add('conversa-cancelada');
                        }
                        item.dataset.id = c.id;
                        
                        const personality = personalidadesData.find(p => p.nome === c.personalidade);
                        const avatarUrl = personality ? personality.foto_ia_url : 'logos.jpeg';

                        // Truncate title if too long
                        let tituloBase = c.titulo;
                        if (tituloBase.length > 20) {
                            tituloBase = tituloBase.substring(0, 17) + '...';
                        }
                        const tituloExibido = c.excluida ? `${tituloBase} (Cancelada)` : tituloBase;

                        const avatarHtml = c.excluida ? '' : `<img src="${avatarUrl}" alt="Avatar da IA" class="conversation-avatar">`;

                        // Format date
                        const date = new Date(c.criado_em);
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = String(date.getFullYear()).slice(-2);
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        const formattedDate = `${day}/${month}/${year} :${hours}:${minutes}`;

                        item.innerHTML = `
                            ${avatarHtml}
                            <div class="conversation-content">
                                <h3 class="font-semibold text-sm">${tituloExibido}</h3>
                                <p class="text-xs" style="color: var(--text-muted); margin-top: 0.25rem;">${c.is_owner ? 'sua conversa' : `conversa de ${c.usuario || 'Anônimo'}`} - ${c.personalidade || 'assistente'}${c.categoria ? ' - ' + c.categoria : ''}${c.excluida ? ' <span style="color: #ff6b6b;">[CANCELADA]</span>' : ''}</p>
                                <div class="conversation-meta">
                                    <span class="conversation-date">${formattedDate}</span>
                                </div>
                            </div>
                            ${!c.excluida && c.can_delete ? `<button class="delete-conversa-btn" data-id="${c.id}" title="Excluir conversa">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        `;
                        item.addEventListener('click', (e) => {
                            if (e.target.closest('.delete-conversa-btn')) return;
                            selectConversation(c.id);
                        });
                        const deleteBtn = item.querySelector('.delete-conversa-btn');
                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                openExcluirConversaModal(c.id);
                            });
                        }
                        conversasLista.appendChild(item);
                    });

                    // Highlight the current conversation if it exists
                    if (currentConversationId) {
                        const activeItem = document.querySelector(`[data-id="${currentConversationId}"]`);
                        if (activeItem) {
                            document.querySelectorAll('.conversation-item-wrapper').forEach(el => el.classList.remove('active'));
                            activeItem.classList.add('active');
                        }
                    }

                } catch (error) {
                    console.error('Erro ao carregar conversas:', error);
                    showToast('Erro ao carregar conversas: ' + error.message, 'error');
                } finally {
                    if (loadingElement) loadingElement.style.display = 'none';
                }
            }

            async function selectConversation(convoId, force = false) {
                if (!force && currentConversationId === convoId) return;

                currentConversationId = convoId;
                localStorage.setItem('lastConversationId', convoId);
                // Fechar sidebar automaticamente em dispositivos móveis
                if (isMobileView && sidebar.classList.contains('active')) {
                    toggleSidebar();
                }

                mensagensContainer.innerHTML = '';
                showLoading(true);
                noChatMessage.style.display = 'none';

                try {
                    const response = await fetch(`/api/conversa/${convoId}/`);
                    if (!response.ok) throw new Error('Conversa não encontrada.');
                    const data = await response.json();

                    // Definir se o usuário é dono da conversa
                    isConversationOwner = data.is_owner;
                    console.log('isConversationOwner:', isConversationOwner);
                    // Marcar no body para aplicar regras visuais/ocultamento quando não for dono
                    try {
                        document.body.classList.toggle('not-owner', !isConversationOwner);
                        document.body.classList.toggle('cancelled', data.excluida);
                        console.log('Body classes after toggle:', document.body.className);
                        // Também esconder diretamente a área de input
                        const chatInputArea = document.getElementById('chat-input-area');
                        if (chatInputArea) {
                            chatInputArea.style.display = isConversationOwner ? 'block' : 'none';
                            console.log('Set chat-input-area display to:', chatInputArea.style.display);
                        }
                    } catch (e) {
                        // body pode não existir em contextos raros; ignorar se erro
                    }
                    
                    // Mostrar mensagem sobre o criador da conversa se não for o dono
                    const creatorInfo = document.getElementById('conversation-creator-info');
                    const creatorName = document.getElementById('creator-name');
                    const chatInputArea = document.getElementById('chat-input-area');
                    const chatOwnerMessage = document.getElementById('chat-owner-message');
                    const chatOwnerNameSpan = document.getElementById('chat-owner-name');
                    const inputMainContainer = chatInputArea ? chatInputArea.querySelector('.input-main-container') : null;
                    const createConversationSection = document.querySelector('.create-conversation-section');
                    const chatForm = document.getElementById('chat-form');
                    const toolbarSection = chatInputArea ? chatInputArea.querySelector('.input-toolbar') : null;

                    // Esconder/mostrar a área de input baseada na propriedade
                    chatInputArea.style.display = isConversationOwner ? 'block' : 'none';

                    // Mostrar o nome do criador somente quando disponível
                    if (creatorInfo && creatorName) {
                        if (!isConversationOwner && data.usuario_dono) {
                            creatorName.textContent = data.usuario_dono;
                            creatorInfo.style.display = 'block';
                        } else {
                            creatorInfo.style.display = 'none';
                        }
                    }

                    // Em vez de remover o footer, alternamos entre o formulário e a mensagem substituta
                    if (chatOwnerMessage) {
                        if (!isConversationOwner) {
                            // Para não donos, mostrar footer, esconder input, mostrar crédito e mensagem
                            if (chatInputArea) chatInputArea.style.display = 'block';
                            const geminiChatInput = chatInputArea ? chatInputArea.querySelector('.gemini-chat-input') : null;
                            if (geminiChatInput) geminiChatInput.style.display = 'none';
                            const geminiCredit = chatInputArea ? chatInputArea.querySelector('.gemini-credit') : null;
                            if (geminiCredit) geminiCredit.style.display = 'none';
                            if (createConversationSection) createConversationSection.style.display = 'block';
                            chatOwnerMessage.style.display = 'flex';
                            const ownerText = document.getElementById('chat-owner-message-text');
                            if (ownerText) ownerText.textContent = `Powered by Dark Duck Intelligence™ - Esta conversa foi criada por ${data.usuario_dono || 'um usuário anônimo'}. Crie a sua própria conversa.`;
                            chatOwnerMessage.setAttribute('aria-hidden', 'false');
                            // Esconder o crédito também (já está escondido acima, mas garantir)
                            // const geminiCredit = document.querySelector('.gemini-credit');
                            // if (geminiCredit) geminiCredit.style.display = 'none';
                        } else {
                            if (chatInputArea) chatInputArea.style.display = 'block';
                            const geminiChatInput = chatInputArea ? chatInputArea.querySelector('.gemini-chat-input') : null;
                            if (geminiChatInput) geminiChatInput.style.display = 'block';
                            if (chatForm) chatForm.style.display = 'block';
                            if (toolbarSection) toolbarSection.style.display = 'block';
                            if (createConversationSection) createConversationSection.style.display = 'none';
                            chatOwnerMessage.style.display = 'none';
                            chatOwnerMessage.setAttribute('aria-hidden', 'true');
                        }
                    }
                    
                    // Controlar se o usuário pode enviar mensagens nesta conversa
                    if (mensagemInput) {
                        if (isConversationOwner) {
                            mensagemInput.disabled = false;
                            mensagemInput.placeholder = "Digite sua mensagem aqui...";
                            mensagemInput.style.opacity = "1";
                        } else {
                            mensagemInput.disabled = true;
                            mensagemInput.placeholder = "Você não pode enviar mensagens nesta conversa";
                            mensagemInput.style.opacity = "0.5";
                        }
                    }
                    
                    // Focar o input se for dono da conversa
                    if (isConversationOwner && mensagemInput) {
                        setTimeout(() => {
                            mensagemInput.focus();
                        }, 100);
                    }
                    
                    // Desabilitar também o botão de enviar
                    const sendBtn = document.getElementById('send-btn');
                    if (sendBtn) {
                        sendBtn.disabled = !isConversationOwner;
                        sendBtn.style.opacity = isConversationOwner ? "1" : "0.5";
                    }
                    
                    // Desabilitar o botão de áudio
                    const audioBtn = document.getElementById('audio-btn');
                    if (audioBtn) {
                        audioBtn.disabled = !isConversationOwner;
                        audioBtn.style.opacity = isConversationOwner ? "1" : "0.5";
                    }
                    
                    // Desabilitar o botão de upload
                    const uploadBtn = document.getElementById('upload-btn');
                    if (uploadBtn) {
                        uploadBtn.disabled = !isConversationOwner;
                        uploadBtn.style.opacity = isConversationOwner ? "1" : "0.5";
                    }
                    
                    // Desabilitar o formulário de chat se não for o dono
                    if (chatForm) {
                        chatForm.style.pointerEvents = isConversationOwner ? "auto" : "none";
                        chatForm.style.opacity = isConversationOwner ? "1" : "0.7";
                    }
                    
                    // Armazenar o nome do dono da conversa para mostrar em mensagens de outros usuários
                    conversationOwnerName = data.usuario_dono || 'Anônimo';

                    // Truncate title if too long
                    let tituloHeader = data.titulo;
                    if (tituloHeader.length > 20) {
                        tituloHeader = tituloHeader.substring(0, 17) + '...';
                    }

                    if (conversaTitulo) {
                        conversaTitulo.textContent = tituloHeader;
                        conversaTitulo.style.display = 'block';
                    }
                    if (conversaTituloMobile) conversaTituloMobile.textContent = tituloHeader;
                    
                    // Show title container and manage edit icon
                    const conversaTituloContainer = document.getElementById('conversa-titulo-container');
                    if (conversaTituloContainer) {
                        conversaTituloContainer.style.display = 'flex';
                        const existingIcon = conversaTituloContainer.querySelector('.edit-title-icon');
                        if (isConversationOwner) {
                            if (!existingIcon) {
                                const icon = document.createElement('i');
                                icon.className = 'fas fa-pencil-alt edit-title-icon';
                                icon.title = 'Editar título';
                                icon.style.fontSize = '0.8em';
                                icon.style.marginLeft = '0.5rem';
                                icon.style.cursor = 'pointer';
                                icon.style.opacity = '0.6';
                                conversaTituloContainer.appendChild(icon);
                                
                                // Add event listener to the icon
                                icon.addEventListener('click', () => {
                                    if (!currentConversationId) {
                                        showToast('Nenhuma conversa selecionada.', 'error');
                                        return;
                                    }
                                    const currentTitle = conversaTitulo.textContent;
                                    editTitleInput.value = currentTitle;
                                    editTitleModal.style.display = 'flex';
                                    editTitleInput.focus();
                                    editTitleInput.select();
                                });
                            }
                        } else {
                            if (existingIcon) {
                                existingIcon.remove();
                            }
                        }
                    }
                    
                    // Manage edit icon for mobile
                    const conversaTituloMobileContainer = document.getElementById('conversa-titulo-mobile-container');
                    if (conversaTituloMobileContainer) {
                        const existingMobileIcon = conversaTituloMobileContainer.querySelector('.edit-title-icon-mobile');
                        if (isConversationOwner) {
                            if (!existingMobileIcon) {
                                const icon = document.createElement('i');
                                icon.className = 'fas fa-pencil-alt edit-title-icon-mobile';
                                icon.title = 'Editar título';
                                icon.style.fontSize = '0.8em';
                                icon.style.marginLeft = '0.5rem';
                                icon.style.cursor = 'pointer';
                                icon.style.opacity = '0.6';
                                conversaTituloMobileContainer.appendChild(icon);
                                
                                // Add event listener to the mobile icon
                                icon.addEventListener('click', () => {
                                    if (!currentConversationId) {
                                        showToast('Nenhuma conversa selecionada.', 'error');
                                        return;
                                    }
                                    const currentTitle = conversaTituloMobile.textContent;
                                    editTitleInput.value = currentTitle;
                                    editTitleModal.style.display = 'flex';
                                    editTitleInput.focus();
                                    editTitleInput.select();
                                });
                            }
                        } else {
                            if (existingMobileIcon) {
                                existingMobileIcon.remove();
                            }
                        }
                    }
                    
                    if (tokenCountSidebar) tokenCountSidebar.textContent = `Tokens: ${data.total_tokens}`;
                    
                    if (data.personalidade_nome) {
                        selectedPersonality = personalidadesData.find(p => p.nome === data.personalidade_nome);
                        if (selectedPersonality) {
                            updatePersonalityAvatar(selectedPersonality.foto_ia_url);
                            updatePersonalityName(selectedPersonality.nome);
                        } else {
                            updatePersonalityAvatar('logos.jpeg');
                            updatePersonalityName('Dark Duck Intelligence');
                        }
                        updatePersonalityButton();
                    }

                    if (data.excluida) {
                        // Se a conversa estiver excluída, mostrar mensagem de cancelada
                        if (shareBtn) shareBtn.style.display = 'none';
                        if (shareBtnMobile) shareBtnMobile.style.display = 'none';
                        const cancelledMessage = document.createElement('div');
                        cancelledMessage.classList.add('message', 'system');
                        cancelledMessage.innerHTML = `
                            <div class="message-avatar">
                                <i class="fas fa-ban" style="color: #ff6b6b;"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-text">
                                    <p><strong>Esta conversa foi cancelada${data.usuario_dono ? ' por ' + data.usuario_dono : ' pelo usuário anônimo'}.</strong></p>
                                    <p>Apenas o dono da conversa pode restaurá-la.</p>
                                    ${isConversationOwner ? `<button class="restore-conversation-btn" data-id="${data.conversa_id}" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--success-gradient); color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                                        <i class="fas fa-undo"></i> Restaurar Conversa
                                    </button>` : ''}
                                </div>
                            </div>
                        `;
                        mensagensContainer.appendChild(cancelledMessage);
                        
                        // Adicionar event listener para o botão de restaurar
                        const restoreBtn = cancelledMessage.querySelector('.restore-conversation-btn');
                        if (restoreBtn) {
                            restoreBtn.addEventListener('click', () => restaurarConversa(data.conversa_id));
                        }
                        
                        // Esconder o formulário interno e mostrar mensagem substituta para conversas canceladas
                        const chatInputArea = document.querySelector('.chat-input-area');
                        const chatOwnerMessage = document.getElementById('chat-owner-message');
                        const createConversationSection = document.querySelector('.create-conversation-section');
                        const chatForm = document.getElementById('chat-form');
                        const toolbarSection = chatInputArea ? chatInputArea.querySelector('.input-toolbar') : null;
                        if (chatInputArea) {
                            if (isConversationOwner) {
                                // Garantir footer visível para conversas canceladas apenas para o dono
                                chatInputArea.style.display = 'block';
                                if (chatForm) chatForm.style.display = 'none';
                                if (toolbarSection) toolbarSection.style.display = 'none';
                                if (createConversationSection) createConversationSection.style.display = 'block';
                                if (chatOwnerMessage) {
                                    chatOwnerMessage.style.display = 'flex';
                                    const ownerName = data.usuario_dono || 'usuário anônimo';
                                    const ownerText = document.getElementById('chat-owner-message-text');
                                    if (ownerText) ownerText.textContent = `Cancelada por ${ownerName}. Dono pode restaurar.`;
                                    chatOwnerMessage.setAttribute('aria-hidden', 'false');
                                }
                                // Esconder o crédito para donos de conversas canceladas também
                                const geminiCredit = chatInputArea ? chatInputArea.querySelector('.gemini-credit') : null;
                                if (geminiCredit) geminiCredit.style.display = 'none';
                            } else {
                                // Para não donos, esconder completamente
                                chatInputArea.style.display = 'none';
                            }
                        }
                    } else {
                        // Só renderizar mensagens se a conversa não estiver excluída
                        if (shareBtn) shareBtn.style.display = 'inline-flex';
                        if (shareBtnMobile) shareBtnMobile.style.display = 'inline-flex';
                        for (const msg of data.mensagens) {
                            renderMessage(msg);
                        }
                        
                        // Mostrar ou ocultar o formulário interno / mensagem substituta para conversas ativas
                        const chatInputArea = document.querySelector('.chat-input-area');
                        const chatOwnerMessage = document.getElementById('chat-owner-message');
                        const inputMainContainer = chatInputArea ? chatInputArea.querySelector('.input-main-container') : null;
                        const createConversationSection = document.querySelector('.create-conversation-section');
                        const chatForm = document.getElementById('chat-form');
                        const toolbarSection = chatInputArea ? chatInputArea.querySelector('.toolbar-section') : null;
                        if (chatOwnerMessage) {
                            if (isConversationOwner) {
                                if (chatInputArea) chatInputArea.style.display = 'block';
                                if (chatForm) chatForm.style.display = 'block';
                                if (toolbarSection) toolbarSection.style.display = 'block';
                                if (createConversationSection) createConversationSection.style.display = 'none';
                                chatOwnerMessage.style.display = 'none';
                                chatOwnerMessage.setAttribute('aria-hidden', 'true');
                            } else {
                                if (chatInputArea) chatInputArea.style.display = 'block';
                                if (chatForm) chatForm.style.display = 'none';
                                if (toolbarSection) toolbarSection.style.display = 'none';
                                if (createConversationSection) createConversationSection.style.display = 'block';
                                chatOwnerMessage.style.display = 'flex';
                                const ownerText = document.getElementById('chat-owner-message-text');
                                if (ownerText) ownerText.textContent = `Essa conversa é de ${data.usuario_dono || 'um usuário anônimo'}.`;
                                chatOwnerMessage.setAttribute('aria-hidden', 'false');
                            }
                        }
                    }
                    
                    setTimeout(() => {
                        mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                        processCodeBlocks();
                        document.querySelectorAll('.message').forEach(messageEl => addExpandButtons(messageEl));
                    }, 100);

                    // Hide GIF background after conversation is loaded
                    document.body.classList.add('no-gif');

                    // Reset input and hide send button when entering conversation
                    // if (mensagemInput) mensagemInput.value = ''; // REMOVIDO: Não limpar input ao mudar de conversa
                    if (mensagemInput) {
                        mensagemInput.style.height = 'auto';
                        mensagemInput.style.height = mensagemInput.scrollHeight + 'px';
                    }
                    attachedFiles = [];
                    filePreviews.innerHTML = '';
                    filePreviews.style.display = 'none';
                    if (mensagemInput) mensagemInput.dispatchEvent(new Event('input'));
                    if (sendButton) sendButton.style.display = 'none';
                    if (audioIcon) audioIcon.style.display = '';

                    // Highlight the active conversation in the sidebar
                    setTimeout(() => {
                        const activeConvoItem = document.querySelector(`[data-id="${convoId}"]`);
                        if (activeConvoItem) {
                            document.querySelectorAll('.conversation-item-wrapper').forEach(el => el.classList.remove('active'));
                            activeConvoItem.classList.add('active');
                        }
                    }, 100);

                } catch (error) {
                    console.error('Erro ao carregar conversa:', error);
                    showToast('Erro ao carregar conversa: ' + error.message, 'error');
                    currentConversationId = null;
                    showInitialState();
                } finally {
                    isLoading = false;
                    loader.style.display = 'none';
                    cancelButton.style.display = 'none';
                    stopNeuralAnimation();
                    if (loader.parentNode) loader.parentNode.removeChild(loader);
                }
            }

            function showInitialState() {
                currentConversationId = null;
                mensagensContainer.innerHTML = '';
                const noChatDiv = document.getElementById('no-chat-message');
                if (noChatDiv) {
                    mensagensContainer.appendChild(noChatDiv);
                }
                if (conversaTitulo) {
                    conversaTitulo.textContent = 'Selecione uma Conversa';
                    conversaTitulo.style.display = 'none';
                }
                if (conversaTituloMobile) conversaTituloMobile.textContent = '';
                
                // Hide title container and remove edit icon
                const conversaTituloContainer = document.getElementById('conversa-titulo-container');
                if (conversaTituloContainer) {
                    const icon = conversaTituloContainer.querySelector('.edit-title-icon');
                    if (icon) icon.remove();
                    conversaTituloContainer.style.display = 'none';
                }
                
                // Remove edit icon for mobile
                const conversaTituloMobileContainer = document.getElementById('conversa-titulo-mobile-container');
                if (conversaTituloMobileContainer) {
                    const icon = conversaTituloMobileContainer.querySelector('.edit-title-icon-mobile');
                    if (icon) icon.remove();
                }
                
                if (tokenCountSidebar) tokenCountSidebar.textContent = 'Tokens: 0';
                if (shareBtn) shareBtn.style.display = 'none';
                if (shareBtnMobile) shareBtnMobile.style.display = 'none';
                loadPersonalidades();
            }

            function getFileExtension(language) {
                const extensions = {
                    'javascript': 'js',
                    'typescript': 'ts',
                    'python': 'py',
                    'html': 'html',
                    'css': 'css',
                    'json': 'json',
                    'sql': 'sql',
                    'bash': 'sh',
                    'php': 'php',
                    'java': 'java',
                    'cpp': 'cpp',
                    'c': 'c',
                    'text': 'txt'
                };
                return extensions[language] || 'txt';
            }

            function formatDuration(seconds) {
                return `${Math.round(seconds)} segundos`;
            }

            function processCodeBlocks() {
                // First, convert codehilite divs to proper pre code blocks
                document.querySelectorAll('div.codehilite:not(.processed)').forEach((codehiliteDiv) => {
                    // Extract text content from spans
                    const textContent = extractTextFromCodehilite(codehiliteDiv);

                    // Detect language from the content or class
                    let language = detectLanguageFromCodehilite(codehiliteDiv);

                    // Create proper pre code structure
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');

                    if (language) {
                        code.classList.add(`language-${language}`);
                    }

                    code.textContent = textContent;
                    pre.appendChild(code);

                    // Replace the codehilite div with the pre element
                    codehiliteDiv.parentNode.replaceChild(pre, codehiliteDiv);
                });

                // Now process all pre code blocks (both original and converted)
                document.querySelectorAll('pre code:not(.highlighted)').forEach((block) => {
                    const pre = block.parentElement;

                    // Skip if already processed
                    if (pre.classList.contains('code-processed')) return;

                    // Enhanced language detection
                    let language = detectCodeLanguage(block);

                    // Apply language class if detected
                    if (language && !block.classList.contains(`language-${language}`)) {
                        block.classList.add(`language-${language}`);
                    }

                    // Ensure line numbers for supported languages
                    if (shouldShowLineNumbers(language)) {
                        pre.classList.add('line-numbers');
                    }

                    // Apply Prism highlighting
                    try {
                        Prism.highlightElement(block);
                    } catch (error) {
                        console.warn('Prism highlighting failed:', error);
                        // Fallback: just mark as highlighted
                    }

                    block.classList.add('highlighted');
                    pre.classList.add('code-processed');
                });

                // Add enhanced UI elements
                addCodeWrapperUI();
            }

            function addCodeWrapperUI() {
                document.querySelectorAll('pre:not(.code-wrapper-processed)').forEach(pre => {
                    const code = pre.querySelector('code');
                    if (!code) return;

                    // Detect language
                    let language = 'text';
                    const classes = code.className.split(' ');
                    for (const cls of classes) {
                        if (cls.startsWith('language-')) {
                            language = cls.replace('language-', '');
                            break;
                        }
                    }

                    // Create wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-wrapper enhanced';

                    // Create UI overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'code-ui-overlay';

                    // Language label
                    const langLabel = document.createElement('div');
                    langLabel.className = 'language-label';
                    langLabel.textContent = getLanguageDisplayName(language);
                    overlay.appendChild(langLabel);

                    // Action buttons
                    const actions = document.createElement('div');
                    actions.className = 'code-action-buttons';

                    // Copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'code-action-btn copy-btn';
                    copyBtn.title = 'Copiar código';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(code.textContent);
                            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                            copyBtn.style.background = 'rgba(40, 167, 69, 0.2)';
                            copyBtn.style.borderColor = 'rgba(40, 167, 69, 0.3)';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                                copyBtn.style.background = '';
                                copyBtn.style.borderColor = '';
                            }, 2000);
                        } catch (err) {
                            console.error('Erro ao copiar:', err);
                            copyBtn.innerHTML = '<i class="fas fa-times"></i>';
                            copyBtn.style.background = 'rgba(220, 53, 69, 0.2)';
                            copyBtn.style.borderColor = 'rgba(220, 53, 69, 0.3)';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                                copyBtn.style.background = '';
                                copyBtn.style.borderColor = '';
                            }, 2000);
                        }
                    });
                    actions.appendChild(copyBtn);

                    // Wrap button
                    const wrapBtn = document.createElement('button');
                    wrapBtn.className = 'code-action-btn wrap-btn';
                    wrapBtn.title = 'Alternar quebra de linha';
                    wrapBtn.innerHTML = '<i class="fas fa-align-left"></i>';
                    wrapBtn.addEventListener('click', () => {
                        if (pre.classList.contains('code-wrap-enabled')) {
                            pre.classList.remove('code-wrap-enabled');
                            wrapBtn.innerHTML = '<i class="fas fa-align-left"></i>';
                            wrapBtn.title = 'Quebrar linhas';
                        } else {
                            pre.classList.add('code-wrap-enabled');
                            wrapBtn.innerHTML = '<i class="fas fa-align-justify"></i>';
                            wrapBtn.title = 'Não quebrar linhas';
                        }
                    });
                    actions.appendChild(wrapBtn);

                    // Download button
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'code-action-btn download-btn';
                    downloadBtn.title = 'Baixar código';
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                    downloadBtn.addEventListener('click', () => {
                        const blob = new Blob([code.textContent], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `codigo.${getFileExtension(language)}`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                        downloadBtn.innerHTML = '<i class="fas fa-check"></i>';
                        downloadBtn.style.background = 'rgba(40, 167, 69, 0.2)';
                        downloadBtn.style.borderColor = 'rgba(40, 167, 69, 0.3)';
                        setTimeout(() => {
                            downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                            downloadBtn.style.background = '';
                            downloadBtn.style.borderColor = '';
                        }, 2000);
                    });
                    actions.appendChild(downloadBtn);

                    overlay.appendChild(actions);
                    wrapper.appendChild(overlay);

                    // Replace pre with wrapper
                    pre.parentNode.replaceChild(wrapper, pre);

                    // Now append pre to wrapper
                    wrapper.appendChild(pre);

                    // Check if code is long and add expand button
                    const lines = code.textContent.split('\n').length;
                    if (lines > 20) {
                        pre.classList.add('code-collapsed');
                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'code-expand-btn';
                        expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Expandir código';
                        expandBtn.addEventListener('click', () => {
                            pre.classList.toggle('code-collapsed');
                            if (pre.classList.contains('code-collapsed')) {
                                expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Expandir código';
                            } else {
                                expandBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Recolher código';
                            }
                        });
                        wrapper.appendChild(expandBtn);
                    }

                    pre.classList.add('code-wrapper-processed');
                });
            }

            function extractTextFromCodehilite(codehiliteDiv) {
                // Use textContent to preserve line breaks between spans
                return codehiliteDiv.textContent.trim();
            }

            function detectLanguageFromCodehilite(codehiliteDiv) {
                // Check for language in class names
                const classes = codehiliteDiv.className.split(' ');
                for (const cls of classes) {
                    if (cls.startsWith('language-')) {
                        return cls.replace('language-', '');
                    }
                }

                // Try to detect from content
                const textContent = extractTextFromCodehilite(codehiliteDiv);

                // Quick language detection based on content
                if (textContent.includes('def ') || textContent.includes('import ') || textContent.includes('print(')) {
                    return 'python';
                }
                if (textContent.includes('function') || textContent.includes('const ') || textContent.includes('let ')) {
                    return 'javascript';
                }
                if (textContent.includes('<?php') || textContent.includes('echo ')) {
                    return 'php';
                }
                if (textContent.includes('<') && textContent.includes('>') && (textContent.includes('html') || textContent.includes('body'))) {
                    return 'html';
                }

                return 'text'; // Default fallback
            }
            
            function detectCodeLanguage(block) {
                // Check for explicit language class
                const classes = block.className.split(' ');
                for (const cls of classes) {
                    if (cls.startsWith('language-')) {
                        return cls.replace('language-', '');
                    }
                }
                
                // Advanced content-based detection
                const text = block.textContent.trim();
                const lines = text.split('\n').slice(0, 10); // Check first 10 lines
                
                // JavaScript/TypeScript patterns
                if (/\b(function|const|let|var|=>|import|export|class|interface)\b/.test(text) ||
                    /\$\{.*\}/.test(text) || text.includes('console.log')) {
                    return text.includes('interface') || text.includes(': string') || text.includes(': number') ? 'typescript' : 'javascript';
                }
                
                // Python patterns
                if (/\b(def |import |from |class |if __name__|\.py\b)/.test(text) ||
                    /^[\s]*#/.test(lines[0]) || /\bprint\(/.test(text)) {
                    return 'python';
                }
                
                // HTML patterns
                if (/<[^>]+>/.test(text) && (text.includes('<!DOCTYPE') || text.includes('<html') ||
                    text.includes('<div') || text.includes('<body'))) {
                    return 'html';
                }
                
                // CSS patterns
                if (/\{[^}]*\}/.test(text) && (text.includes('color:') || text.includes('background') ||
                    text.includes('@media') || text.includes('font-'))) {
                    return 'css';
                }
                
                // JSON patterns
                if ((text.startsWith('{') && text.endsWith('}')) || (text.startsWith('[') && text.endsWith(']'))) {
                    try {
                        JSON.parse(text);
                        return 'json';
                    } catch (e) {
                        // Not valid JSON
                    }
                }
                
                // SQL patterns
                if (/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\b/i.test(text)) {
                    return 'sql';
                }
                
                // Shell/Bash patterns
                if (text.includes('#!/bin/bash') || text.includes('#!/bin/sh') ||
                    /^\s*\$\s/.test(text) || /\b(echo|grep|sed|awk|curl|wget)\b/.test(text)) {
                    return 'bash';
                }
                
                // PHP patterns
                if (text.includes('<?php') || /\$\w+\s*=/.test(text) || /\becho\s/.test(text)) {
                    return 'php';
                }
                
                // Java patterns
                if (/\b(public|private|protected|class|void|static|final)\b/.test(text) &&
                    text.includes('System.out.println')) {
                    return 'java';
                }
                
                // C/C++ patterns
                if (/#include\s*<.*>/.test(text) || /\b(int|char|void|printf|scanf)\b/.test(text) &&
                    text.includes('#include')) {
                    return text.includes('cout') || text.includes('cin') ? 'cpp' : 'c';
                }
                
                // Default to text
                return 'text';
            }
            
            function shouldShowLineNumbers(language) {
                // Languages that benefit from line numbers
                const lineNumberLanguages = ['javascript', 'typescript', 'python', 'java', 'cpp', 'c', 'php', 'html', 'css', 'sql', 'bash', 'json'];
                return lineNumberLanguages.includes(language);
            }

            function renderMessageInstant(msg) {
                const isUser = msg.papel === 'user';
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', isUser ? 'user' : 'model');
                messageEl.dataset.messageId = msg.id;

                // Verificar se a mensagem foi excluída
                if (msg.excluida) {
                    messageEl.classList.add('deleted-message');
                    const date = new Date(msg.criado_em);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const timestamp = `${day}/${month}/${year} :${hours}:${minutes}`;
                    messageEl.innerHTML = `
                        <div class="deleted-message-content">
                            <i class="fas fa-trash-alt"></i>
                            <span>Esta mensagem foi excluída</span>
                        </div>
                        <div class="timestamp">${timestamp}</div>
                    `;
                    mensagensContainer.appendChild(messageEl);
                    mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                    return;
                }

                const date = new Date(msg.criado_em);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const timestamp = `${day}/${month}/${year} :${hours}:${minutes}`;

                // Versão simplificada e otimizada para velocidade
                if (isUser) {
                    const authorNameHtml = !isConversationOwner ? `<div class="message-author" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">${conversationOwnerName}</div>` : '';
                    const buttonsHtml = msg.id ? `
                        <div class="message-buttons" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 8px;">
                            <button class="share-msg-btn" data-message-id="${msg.id}" title="Compartilhar mensagem">
                                <i class="fas fa-share"></i>
                            </button>
                            ${isConversationOwner ? `<button class="edit-msg-btn" data-message-id="${msg.id}" title="Editar mensagem">
                                <i class="fas fa-edit"></i>
                            </button>` : ''}
                            ${isConversationOwner ? `<button class="delete-msg-btn" data-message-id="${msg.id}" title="Excluir mensagem">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    ` : '';
                    messageEl.innerHTML = `
                        ${authorNameHtml}
                        <div class="content markdown-container">${msg.texto_html || msg.texto_raw || ''}</div>
                        ${buttonsHtml}
                        ${msg.editada_em ? '<div class="edited-indicator">editada</div>' : ''}
                        <div class="timestamp">${timestamp}</div>
                    `;
                }

                mensagensContainer.appendChild(messageEl);
                mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
            }

            function renderMessage(msg) {
                const isUser = msg.papel === 'user';
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', isUser ? 'user' : 'model');
                messageEl.dataset.messageId = msg.id;

                // Verificar se a mensagem foi excluída
                if (msg.excluida) {
                    messageEl.classList.add('deleted-message');
                    const date = new Date(msg.criado_em);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const timestamp = `${day}/${month}/${year} :${hours}:${minutes}`;
                    messageEl.innerHTML = `
                        <div class="deleted-message-content">
                            <i class="fas fa-trash-alt"></i>
                            <span>Esta mensagem foi excluída</span>
                        </div>
                        <div class="timestamp">${timestamp}</div>
                    `;
                    mensagensContainer.appendChild(messageEl);
                    mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                    processCodeBlocks();
                    addExpandButtons(messageEl);
                    return;
                }

                let avatarHtml = '';
                if (!isUser) {
                    const avatarUrl = (selectedPersonality && selectedPersonality.foto_ia_url) ? selectedPersonality.foto_ia_url : 'logos.jpeg';
                    avatarHtml = `<div class="avatar"><img src="${avatarUrl}" alt="Logo Dark Duck Intelligence" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div>`;
                }

                let contentHtml = '';
                const date = new Date(msg.criado_em);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const timestamp = `${day}/${month}/${year} :${hours}:${minutes}`;

                // Priorizar exibição visual de mídia quando disponível
                if (msg.dados_conteudo) {
                    let mediaContent = '';
                    if (msg.tipo_conteudo === 'image') {
                        mediaContent = `<div class="content media-content"><img src="${msg.dados_conteudo}" alt="${msg.texto_raw || 'Imagem enviada'}" class="message-image" style="max-width: 100%; border-radius: 12px; box-shadow: var(--shadow-md);"></div>`;
                    } else if (msg.tipo_conteudo === 'audio') {
                        mediaContent = `<div class="content media-content"><audio controls src="${msg.dados_conteudo}" style="width: 100%; max-width: 300px;"></audio></div>`;
                    } else if (msg.tipo_conteudo === 'file') {
                        mediaContent = `<div class="content media-content file-content">
                                            <i class="fas fa-file-alt mr-2"></i>
                                            <a href="${msg.dados_conteudo}" target="_blank" style="color: inherit; text-decoration: none;">
                                                ${msg.texto_raw || 'Arquivo anexado'}
                                            </a>
                                       </div>`;
                    }

                    // Combinar mídia + texto se ambos existirem
                    if (msg.texto_html && msg.texto_html.trim()) {
                        contentHtml = `${mediaContent}<div class="content text-content markdown-container" style="margin-top: 8px;">${msg.texto_html}</div>`;
                    } else {
                        contentHtml = mediaContent;
                    }
                } else if (msg.texto_html) {
                    contentHtml = `<div class="content markdown-container">${msg.texto_html}</div>`;
                }

                let feedbackHtml = '';
                if (!isUser) {
                    feedbackHtml = `
                            <div class="feedback-buttons" style="display: flex; align-items: center; gap: 0.5rem;">
                                <button class="feedback-btn like" title="Gostei" data-message-id="${msg.id}">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="like-count">${msg.likes_count || 0}</span>
                                </button>
                                <button class="feedback-btn dislike" title="Não gostei" data-message-id="${msg.id}">
                                    <i class="fas fa-thumbs-down"></i>
                                    <span class="dislike-count">${msg.dislikes_count || 0}</span>
                                </button>
                            </div>
                    `;
                }

                // Estrutura simplificada
                if (isUser) {
                    const authorNameHtml = !isConversationOwner ? `<div class="message-author" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">${conversationOwnerName}</div>` : '';
                    messageEl.innerHTML = `
                        ${authorNameHtml}
                        ${contentHtml || `<div class="content markdown-container">${msg.texto_html || msg.texto_raw || ''}</div>`}
                        <div class="message-buttons" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 8px;">
                            ${isConversationOwner ? `<button class="edit-msg-btn" data-message-id="${msg.id}" title="Editar mensagem">
                                <i class="fas fa-edit"></i>
                            </button>` : ''}
                            ${isConversationOwner ? `<button class="delete-msg-btn" data-message-id="${msg.id}" title="Excluir mensagem">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                        ${msg.editada_em ? '<div class="edited-indicator">editada</div>' : ''}
                        <div class="timestamp">${timestamp}</div>
                    `;
                } else {
                    messageEl.innerHTML = `
                        ${avatarHtml}
                        <div class="message-content">
                            ${contentHtml || `<div class="content markdown-container">${msg.texto_html || msg.texto_raw || ''}</div>`}
                            <div class="message-disclaimer" style="font-size: 10px; color: #5f6368; margin-top: 8px; text-align: center; opacity: 0.7;">
                                A Duck Intelligence pode cometer erros. Por isso, é bom checar as respostas.
                            </div>
                        <div class="message-buttons" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 8px;">
                            <button class="share-msg-btn" data-message-id="${msg.id}" title="Compartilhar mensagem">
                                <i class="fas fa-share"></i>
                            </button>
                            <div class="tts-container">
                                <button class="tts-btn" data-message-id="${msg.id}" title="Ouvir mensagem">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                            ${isConversationOwner ? `<button class="delete-msg-btn" data-message-id="${msg.id}" title="Excluir mensagem">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                                ${feedbackHtml}
                            </div>
                            ${msg.tempo_resposta_ia ? `<div class="response-time" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Tempo resposta IA: ${formatDuration(msg.tempo_resposta_ia)}</div>` : ''}
                            <div class="timestamp">${timestamp}</div>
                        </div>
                    `;
                }

                mensagensContainer.appendChild(messageEl);
                mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                processCodeBlocks();
                addExpandButtons(messageEl);
            }

            async function renderMessageWithTypingEffect(msg) {
                const isUser = msg.papel === 'user';
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', isUser ? 'user' : 'model');
                messageEl.dataset.messageId = msg.id;

                let avatarHtml = '';
                if (!isUser) {
                    const avatarUrl = (selectedPersonality && selectedPersonality.foto_ia_url) ? selectedPersonality.foto_ia_url : 'logos.jpeg';
                    avatarHtml = `<div class="avatar"><img src="${avatarUrl}" alt="Logo Dark Duck Intelligence" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div>`;
                }

                let contentHtml = '';
                const date = new Date();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const timestamp = `${day}/${month}/${year} :${hours}:${minutes}`;

                // Priorizar exibição visual de mídia quando disponível
                if (msg.dados_conteudo) {
                    let mediaContent = '';
                    if (msg.tipo_conteudo === 'image') {
                        mediaContent = `<div class="content media-content"><img src="${msg.dados_conteudo}" alt="${msg.texto_raw || 'Imagem enviada'}" class="message-image" style="max-width: 100%; border-radius: 12px; box-shadow: var(--shadow-md);"></div>`;
                    } else if (msg.tipo_conteudo === 'audio') {
                        mediaContent = `<div class="content media-content"><audio controls src="${msg.dados_conteudo}" style="width: 100%; max-width: 300px;"></audio></div>`;
                    } else if (msg.tipo_conteudo === 'file') {
                        mediaContent = `<div class="content media-content file-content">
                                            <i class="fas fa-file-alt mr-2"></i>
                                            <a href="${msg.dados_conteudo}" target="_blank" style="color: inherit; text-decoration: none;">
                                                ${msg.texto_raw || 'Arquivo anexado'}
                                            </a>
                                       </div>`;
                    }

                    // Combinar mídia + texto se ambos existirem
                    if (msg.texto_html && msg.texto_html.trim()) {
                        contentHtml = `${mediaContent}<div class="content text-content markdown-container" style="margin-top: 8px;">${msg.texto_html}</div>`;
                    } else {
                        contentHtml = mediaContent;
                    }
                } else if (msg.texto_html) {
                    contentHtml = `<div class="content markdown-container">${msg.texto_html}</div>`;
                }

                let feedbackHtml = '';
                if (!isUser) {
                    const likeActive = msg.feedback === true ? 'active' : '';
                    const dislikeActive = msg.feedback === false ? 'active' : '';
                    feedbackHtml = `
                            <div class="feedback-buttons" style="display: flex; gap: 0.25rem;">
                                <button class="feedback-btn like ${likeActive}" title="Gostei" data-message-id="${msg.id}">
                                    <i class="fas fa-thumbs-up"></i>
                                </button>
                                <button class="feedback-btn dislike ${dislikeActive}" title="Não gostei" data-message-id="${msg.id}">
                                    <i class="fas fa-thumbs-down"></i>
                                </button>
                            </div>
                            <div class="feedback-comment-box" id="comment-box-${msg.id}" style="display: none;">
                                <textarea class="feedback-comment-input" placeholder="Conte-nos o que não gostou..." maxlength="500"></textarea>
                                <div class="feedback-comment-actions">
                                    <button class="feedback-comment-btn cancel" data-message-id="${msg.id}">Cancelar</button>
                                    <button class="feedback-comment-btn submit" data-message-id="${msg.id}">Enviar</button>
                                </div>
                            </div>
                    `;
                }

                // Estrutura simplificada
                if (isUser) {
                    const authorNameHtml = !isConversationOwner ? `<div class="message-author" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">${conversationOwnerName}</div>` : '';
                    messageEl.innerHTML = `
                        ${authorNameHtml}
                        ${contentHtml || `<div class="content markdown-container">${msg.texto_html || msg.texto_raw || ''}</div>`}
                        <div class="message-buttons" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 8px;">
                            ${isConversationOwner ? `<button class="edit-msg-btn" data-message-id="${msg.id}" title="Editar mensagem">
                                <i class="fas fa-edit"></i>
                            </button>` : ''}
                            ${isConversationOwner ? `<button class="delete-msg-btn" data-message-id="${msg.id}" title="Excluir mensagem">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                        ${msg.editada_em ? '<div class="edited-indicator">editada</div>' : ''}
                        <div class="timestamp">${timestamp}</div>
                    `;
                } else {
                    messageEl.innerHTML = `
                        ${avatarHtml}
                        <div class="message-content">
                            ${contentHtml || `<div class="content markdown-container">${msg.texto_html || msg.texto_raw || ''}</div>`}
                            <div class="message-disclaimer" style="font-size: 10px; color: #5f6368; margin-top: 8px; text-align: center; opacity: 0.7;">
                                A Duck Intelligence pode cometer erros. Por isso, é bom checar as respostas.
                            </div>
                            <div class="message-buttons" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 8px;">
                                <div class="tts-container">
                                    <button class="tts-btn" data-message-id="${msg.id}" title="Ouvir mensagem">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                                <button class="delete-msg-btn" data-message-id="${msg.id}" title="Excluir mensagem">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ${feedbackHtml}
                            </div>
                            <div class="timestamp">${timestamp}</div>
                        </div>
                    `;
                }

                mensagensContainer.appendChild(messageEl);

                // Para mensagens da IA, renderizar o HTML e digitar linha por linha em grupos de 2 linhas
                if (!isUser && msg.texto_html) {
                    const contentDiv = messageEl.querySelector('.content.markdown-container');

                    contentDiv.innerHTML = msg.texto_html;
                    processCodeBlocks();

                    // Enhanced typing effect for code blocks with better performance
                    const codeBlocks = contentDiv.querySelectorAll('pre code');
                    codeBlocks.forEach(block => {
                        const text = block.textContent;
                        const lines = text.split('\n');
                        block.textContent = '';
                        
                        let currentLine = 0;
                        let currentChar = 0;
                        const charsPerLine = lines.map(line => line.length);
                        
                        const typeCode = () => {
                            if (currentLine < lines.length) {
                                const line = lines[currentLine];
                                if (currentChar < line.length) {
                                    block.textContent += line[currentChar];
                                    currentChar++;
                                    mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                                    setTimeout(typeCode, 10); // Faster typing for code
                                } else {
                                    block.textContent += '\n';
                                    currentLine++;
                                    currentChar = 0;
                                    mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                                    setTimeout(typeCode, 50); // Pause between lines
                                }
                            } else {
                                // Re-highlight after typing
                                try {
                                    Prism.highlightElement(block);
                                } catch (error) {
                                    console.warn('Prism highlighting failed after typing:', error);
                                }
                                // Add UI after highlighting
                                processCodeBlocks();
                            }
                        };
                        typeCode();
                    });

                    // Typing effect for text content, 2 lines at a time
                    const textNodes = [];
                    const walker = document.createTreeWalker(contentDiv, NodeFilter.SHOW_TEXT, null, false);
                    let node;
                    while (node = walker.nextNode()) {
                        if (!node.parentElement.closest('pre') && node.textContent.trim()) {
                            textNodes.push(node);
                        }
                    }
                    textNodes.forEach(textNode => {
                        const text = textNode.textContent;
                        const lines = text.split('\n');
                        textNode.textContent = '';
                        let m = 0;
                        const typeText = () => {
                            if (m < lines.length) {
                                // Add up to 2 lines
                                const end = Math.min(m + 2, lines.length);
                                for (let i = m; i < end; i++) {
                                    textNode.textContent += lines[i] + '\n';
                                }
                                m = end;
                                mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                                setTimeout(typeText, 200); // Delay per group
                            }
                        };
                        typeText();
                    });
                }

                mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                processCodeBlocks();
                addExpandButtons(messageEl);
            }

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (isLoading) return;
                
                const mensagem = mensagemInput.value.trim();
                const personalidade = selectedPersonality ? selectedPersonality.nome : '';
                const sentAudio = attachedFiles.some(file => file.type && file.type.startsWith('audio/'));
                const usedVoice = userUsedVoice;
                userUsedVoice = false;
                
                if (!mensagem && attachedFiles.length === 0) {
                    return;
                }
                
                renderMessageInstant({
                    papel: 'user',
                    texto_html: mensagem,
                    tipo_conteudo: 'text',
                    criado_em: new Date().toISOString()
                });

                // Hide GIF after sending message
                document.body.classList.add('no-gif');

                showLoading(true);
                noChatMessage.style.display = 'none';
                
                const formData = new FormData();
                formData.append('mensagem', mensagem);
                formData.append('conversa_id', currentConversationId || '');
                formData.append('personalidade', personalidade);
                formData.append('busca_web', isBuscaWebEnabled ? 'true' : 'false');
                
                for (const file of attachedFiles) {
                    formData.append('arquivos', file);
                }
                
                try {
                    const response = await fetch('/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken,
                        },
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.erro || 'Erro ao enviar a mensagem.');
                    }
                    
                    const data = await response.json();
                    
                    if (data.conversa_id && data.conversa_id !== currentConversationId) {
                        currentConversationId = data.conversa_id;
                        if (shareBtn) shareBtn.style.display = 'inline-flex';
                        if (shareBtnMobile) shareBtnMobile.style.display = 'inline-flex';
                        loadConversations();
                        setTimeout(() => {
                           const newConvoItem = document.querySelector(`[data-id="${currentConversationId}"]`);
                           if (newConvoItem) {
                               document.querySelectorAll('.conversation-item-wrapper').forEach(el => el.classList.remove('active'));
                               newConvoItem.classList.add('active');
                           }
                        }, 500);
                    }
                    
                    showLoading(false);
                    
                    // Recarregar a conversa para atualizar todos os elementos após qualquer resposta da API
                    await selectConversation(currentConversationId, true);
                    
                    if (sentAudio || usedVoice) {
                        if (sentAudio) {
                            // For audio files, use response modal
                            responseText.innerHTML = data.resposta;
                            responseModal.style.display = 'flex';
                            // Auto-close after 10 seconds if there's response
                            if (data.resposta && data.resposta.trim()) {
                                setTimeout(() => {
                                    responseModal.style.display = 'none';
                                }, 10000);
                            }
                        } else if (usedVoice) {
                            // For voice input, update voice modal with response
                            const voiceModalContent = voiceModal.querySelector('.voice-modal-content h3');
                            const voiceModalP = voiceModal.querySelector('.voice-modal-content p');
                            const sendBtn = voiceModal.querySelector('#stop-voice-btn');
                            if (voiceModalContent) voiceModalContent.textContent = 'Resposta da IA';
                            if (voiceModalP) voiceModalP.innerHTML = data.resposta;
                            if (sendBtn) {
                                sendBtn.innerHTML = '<i class="fas fa-microphone"></i> Falar Novamente';
                                sendBtn.onclick = () => {
                                    // Reset modal for new input
                                    voiceModalContent.textContent = 'Fale sua mensagem';
                                    voiceModalP.textContent = 'Fale claramente e veja o texto aparecer em tempo real.';
                                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
                                    sendBtn.onclick = null; // reset
                                    // Restart recognition
                                    startVoiceRecognition();
                                };
                            }
                            // Keep modal open, user can close manually
                        }
                        
                        // Mostrar microfone novamente após resposta da IA
                        audioIcon.style.display = '';
                        if ('speechSynthesis' in window) {
                            console.log('Speaking response:', data.resposta);
                            // Strip HTML tags for TTS
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = data.resposta;
                            const plainText = tempDiv.textContent || tempDiv.innerText || '';
                            const utterance = new SpeechSynthesisUtterance(plainText);
                            const voices = speechSynthesis.getVoices();
                            const preferredVoice = voices.find(voice => (sentAudio ? voice.name.includes('Male') : voice.name.includes('Female')) && voice.lang.startsWith('pt')) ||
                                                   voices.find(voice => voice.lang === 'pt-BR') ||
                                                   voices.find(voice => voice.name.includes('Google')) ||
                                                   voices[0];
                            if (preferredVoice) utterance.voice = preferredVoice;
                            utterance.rate = 0.9;
                            utterance.pitch = sentAudio ? 0.9 : 1.1;
                            speechSynthesis.speak(utterance);
                        }
                    } else {
                        // Mostrar microfone novamente após resposta da IA
                        audioIcon.style.display = '';
                    }
                    
                    if (tokenCountSidebar) tokenCountSidebar.textContent = `Tokens: ${data.tokens_utilizados}`;
                    
                    setTimeout(() => {
                        mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                        processCodeBlocks();
                    }, 100);

                } catch (error) {
                    console.error('Erro:', error);
                    showToast('Erro ao enviar mensagem: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                    mensagemInput.value = '';
                    mensagemInput.style.height = 'auto';
                    arquivoInput.value = '';
                    attachedFiles = [];
                    filePreviews.innerHTML = '';
                    filePreviews.style.display = 'none';
                    sendButton.style.display = 'none';
                }
            });

            cancelButton.addEventListener('click', async () => {
                // Remove the last user message from UI
                const messages = mensagensContainer.querySelectorAll('.message.user');
                if (messages.length > 0) {
                    messages[messages.length - 1].remove();
                }
                
                // Reset form
                mensagemInput.value = '';
                mensagemInput.style.height = 'auto';
                arquivoInput.value = '';
                attachedFiles = [];
                filePreviews.innerHTML = '';
                filePreviews.style.display = 'none';
                sendButton.style.display = 'none';
                
                try {
                    const response = await fetch('/api/cancelar/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({})
                    });
                    
                    if (response.ok) {
                        showToast('Resposta cancelada.', 'info');
                        showLoading(false);
                    } else {
                        showToast('Erro ao cancelar resposta.', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao cancelar:', error);
                    showToast('Erro ao cancelar resposta.', 'error');
                }
            });

            // Funções para o modal de confirmação personalizado
            function showCustomConfirm(message, callback) {
                customConfirmMessage.textContent = message;
                customConfirmModal.style.display = 'flex';
                customConfirmOkBtn.onclick = () => {
                    callback();
                    customConfirmModal.style.display = 'none';
                };
                customConfirmCancelBtn.onclick = () => {
                    customConfirmModal.style.display = 'none';
                };
            }

            async function restoreConversation(conversaId) {
                showCustomConfirm('Deseja restaurar esta conversa?', async () => {
                    const loadingElement = document.getElementById('loading-conversas');
                    if (loadingElement) loadingElement.style.display = 'flex';
                    try {
                        const response = await fetch(`/api/conversa/${conversaId}/restaurar/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken,
                            }
                        });
                        const data = await response.json();
                        if (data.success) {
                            showToast('Conversa restaurada com sucesso!', 'success');
                            loadConversations(); // Recarregar lista
                            selectConversation(conversaId, true); // Selecionar e forçar recarregamento da conversa restaurada
                        } else {
                            showToast('Erro ao restaurar conversa: ' + data.error, 'error');
                        }
                    } catch (error) {
                        console.error('Erro ao restaurar conversa:', error);
                        showToast('Erro ao restaurar conversa', 'error');
                    } finally {
                        if (loadingElement) loadingElement.style.display = 'none';
                    }
                });
            }

            if (shareBtn) {
                shareBtn.addEventListener('click', async () => {
                    if (!currentConversationId) {
                        showToast('Nenhuma conversa selecionada para compartilhar.', 'error');
                        return;
                    }
                    try {
                        const response = await fetch(`/api/chat/compartilhar/${currentConversationId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ conversa_id: currentConversationId })
                        });
                        const data = await response.json();
                        if (response.ok && data.success) {
                            shareLinkInput.value = data.url_compartilhamento;
                            shareModal.style.display = 'flex';
                        } else {
                            throw new Error(data.error || 'Não foi possível gerar o link de compartilhamento.');
                        }
                    } catch (error) {
                        console.error('Erro ao gerar link de compartilhamento:', error);
                        showToast('Erro ao gerar link de compartilhamento: ' + error.message, 'error');
                    }
                });
            }

            const shareBtnMobile = document.getElementById('share-btn-mobile');
            if (shareBtnMobile) {
                shareBtnMobile.addEventListener('click', async () => {
                    if (!currentConversationId) {
                        showToast('Nenhuma conversa selecionada para compartilhar.', 'error');
                        return;
                    }
                    try {
                        const response = await fetch(`/api/chat/compartilhar/${currentConversationId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ conversa_id: currentConversationId })
                        });
                        const data = await response.json();
                        if (response.ok && data.success) {
                            shareLinkInput.value = data.url_compartilhamento;
                            shareModal.style.display = 'flex';
                        } else {
                            throw new Error(data.error || 'Não foi possível gerar o link de compartilhamento.');
                        }
                    } catch (error) {
                        console.error('Erro ao gerar link de compartilhamento:', error);
                        showToast('Erro ao gerar link de compartilhamento: ' + error.message, 'error');
                    }
                });
            }

            if (copyShareLinkBtn) {
                copyShareLinkBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(shareLinkInput.value);
                        showToast('Link copiado para a área de transferência!', 'success');
                        shareModal.style.display = 'none';
                    } catch (err) {
                        shareLinkInput.select();
                        document.execCommand('copy');
                        showToast('Link copiado para a área de transferência!', 'success');
                        shareModal.style.display = 'none';
                    }
                });
            }

            if (closeShareModalBtn) {
                closeShareModalBtn.addEventListener('click', () => shareModal.style.display = 'none');
            }

            // Popover de compartilhamento por mensagem (WhatsApp, Telegram, Twitter, Facebook, Instagram/Copiar)
            (function(){
                let openPopover = null;

                function closeOpenPopover() {
                    if (openPopover && openPopover.parentElement) {
                        openPopover.remove();
                    }
                    openPopover = null;
                }

                function getPlainTextFromMessageEl(messageEl) {
                    if (!messageEl) return '';
                    const content = messageEl.querySelector('.content');
                    if (!content) return messageEl.textContent || '';
                    const tmp = document.createElement('div');
                    tmp.innerHTML = content.innerHTML;
                    return (tmp.textContent || tmp.innerText || '').trim();
                }

                function createSharePopover(text, messageId) {
                    const encoded = encodeURIComponent(text);
                    const pop = document.createElement('div');
                    pop.className = 'share-popover';
                    pop.innerHTML = `
                        <a href="https://wa.me/?text=${encoded}" target="_blank" rel="noopener noreferrer"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                        <a href="https://t.me/share/url?text=${encoded}" target="_blank" rel="noopener noreferrer"><i class="fab fa-telegram"></i> Telegram</a>
                        <a href="https://twitter.com/intent/tweet?text=${encoded}" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i> Twitter</a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=&quote=${encoded}" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i> Facebook</a>
                        <button type="button" class="instagram-copy-btn"><i class="fab fa-instagram"></i> Instagram (copiar)</button>
                        <button type="button" class="copy-text-btn"><i class="fas fa-copy"></i> Copiar texto</button>
                        <button type="button" class="native-share-btn" style="display:none;"><i class="fas fa-share-alt"></i> Abrir apps</button>
                    `;

                    // Handlers
                    pop.querySelectorAll('.instagram-copy-btn, .copy-text-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            try {
                                await navigator.clipboard.writeText(text);
                                showToast('Texto copiado! Cole no Instagram ou onde desejar.', 'success');
                            } catch (err) {
                                const ta = document.createElement('textarea');
                                ta.value = text;
                                document.body.appendChild(ta);
                                ta.select();
                                document.execCommand('copy');
                                ta.remove();
                                showToast('Texto copiado! Cole no Instagram ou onde desejar.', 'success');
                            }
                            closeOpenPopover();
                        });
                    });

                    const nativeBtn = pop.querySelector('.native-share-btn');
                    if (navigator.share && nativeBtn) {
                        nativeBtn.style.display = '';
                        nativeBtn.addEventListener('click', async () => {
                            try {
                                await navigator.share({ text });
                            } catch (err) {
                                console.warn('Web Share falhou:', err);
                            }
                            closeOpenPopover();
                        });
                    }

                    pop.querySelectorAll('a').forEach(a => {
                        a.addEventListener('click', () => closeOpenPopover());
                    });

                    return pop;
                }

                document.addEventListener('click', (e) => {
                    // Se clicou num botão de compartilhar, tratar primeiro (evita toggle)
                    const shareBtn = e.target.closest('.share-msg-btn');
                    if (shareBtn) {
                        e.preventDefault();
                        const messageEl = shareBtn.closest('.message');
                        if (!messageEl) return;
                        const text = getPlainTextFromMessageEl(messageEl);
                        if (!text) {
                            showToast('Não há texto para compartilhar.', 'warning');
                            return;
                        }

                        // fechar popover aberto
                        closeOpenPopover();

                        const pop = createSharePopover(text, messageEl.dataset.messageId || '');
                        messageEl.appendChild(pop);
                        openPopover = pop;
                        return;
                    }

                    // Se clicou dentro dos próprios botões da mensagem (editar/excluir/tts), não alternar
                    if (e.target.closest('.message-buttons')) {
                        return;
                    }

                    // Se clicou numa mensagem, alternar a exibição dos botões (mostrar só para ela)
                    const message = e.target.closest('.message');
                    if (message) {
                        // fechar outros popovers e esconder botões de outras mensagens
                        document.querySelectorAll('.message.show-buttons').forEach(m => {
                            if (m !== message) m.classList.remove('show-buttons');
                        });
                        message.classList.toggle('show-buttons');
                        // não fechar popover global aqui
                        return;
                    }

                    // se clicou fora de qualquer mensagem ou popover, fechar tudo
                    if (!e.target.closest('.share-popover')) {
                        closeOpenPopover();
                    }
                    document.querySelectorAll('.message.show-buttons').forEach(m => m.classList.remove('show-buttons'));
                });
            })();



            if (cancelEditTitleBtn) {
                cancelEditTitleBtn.addEventListener('click', () => {
                    editTitleModal.style.display = 'none';
                });
            }

            if (confirmEditTitleBtn) {
                confirmEditTitleBtn.addEventListener('click', () => {
                    const newTitle = editTitleInput.value.trim();
                    if (!newTitle) {
                        showToast('O título não pode estar vazio.', 'warning');
                        return;
                    }
                    editTitleModal.style.display = 'none';
                    updateConversationTitle(currentConversationId, newTitle);
                });
            }

            if (editTitleInput) {
                editTitleInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        confirmEditTitleBtn.click();
                    } else if (e.key === 'Escape') {
                        cancelEditTitleBtn.click();
                    }
                });
            }

            if (buscaWebBtn) {
                buscaWebBtn.addEventListener('click', () => {
                    isBuscaWebEnabled = !isBuscaWebEnabled;
                    buscaWebBtn.classList.toggle('active', isBuscaWebEnabled);
                    buscaWebBtn.setAttribute('aria-pressed', String(isBuscaWebEnabled));
                    buscaWebBtn.innerHTML = isBuscaWebEnabled ? '<i class="fas fa-globe"></i> <span class="btn-label">Ativado</span>' : '<i class="fas fa-globe"></i> <span class="btn-label">Web</span>';
                    // Se ativou e há mensagem, enviar automaticamente
                    if (isBuscaWebEnabled && mensagemInput.value.trim()) {
                        chatForm.dispatchEvent(new Event('submit'));
                    }
                });
            }

            // Botão de limpar — agora limpa apenas o campo de escrita
            const clearChatBtn = document.getElementById('clear-chat-btn');
            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (mensagemInput) {
                        mensagemInput.value = '';
                        mensagemInput.focus();
                        // Atualiza estado de anexos apenas se necessário (mantemos anexos)
                        showToast('Campo de escrita limpo.', 'success');
                    }
                });
            }

            // Update button states based on input
            mensagemInput.addEventListener('input', () => {
                const value = mensagemInput.value.trim();
                if (buscaWebBtn) {
                    // Busca web stays as is
                }
            });

            quickActionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const prompt = button.dataset.prompt;
                    mensagemInput.value = prompt;
                    chatForm.dispatchEvent(new Event('submit'));
                });
            });

            const toggleSidebar = () => {
                const wasActive = sidebar.classList.contains('active');
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                const isNowActive = sidebar.classList.contains('active');
                
                // Auto-refresh conversations when sidebar opens
                if (isNowActive && !wasActive) {
                    loadConversations();
                }
            };
            
            if (toggleSidebarBtn) toggleSidebarBtn.addEventListener('click', toggleSidebar);
            if (toggleSidebarBtnMobile) toggleSidebarBtnMobile.addEventListener('click', toggleSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

            const searchInput = document.getElementById('search-conversas');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const items = document.querySelectorAll('.conversation-item-wrapper');
                    
                    items.forEach(item => {
                        const title = item.querySelector('h3').textContent.toLowerCase();
                        const personality = item.querySelector('p').textContent.toLowerCase();
                        
                        if (title.includes(searchTerm) || personality.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            
            // Botões de filtro de conversas
            const myConversationsBtn = document.getElementById('my-conversations-btn');
            const anonymousConversationsBtn = document.getElementById('anonymous-conversations-btn');

            // Função para atualizar o estado dos botões
            const updateFilterButtons = () => {
                if (showOnlyMine) {
                    myConversationsBtn.classList.add('active');
                    anonymousConversationsBtn.classList.remove('active');
                } else {
                    myConversationsBtn.classList.remove('active');
                    anonymousConversationsBtn.classList.add('active');
                }
            };

            // Inicializar estado dos botões
            updateFilterButtons();

            // Event listener para botão "Minhas Conversas"
            if (myConversationsBtn) {
                myConversationsBtn.addEventListener('click', () => {
                    if (!showOnlyMine) { // Só faz algo se não estiver já mostrando apenas minhas
                        showOnlyMine = true;
                        updateFilterButtons();
                        loadConversations();
                    }
                });
            }

            // Event listener para botão "Conversas Anônimas"
            if (anonymousConversationsBtn) {
                anonymousConversationsBtn.addEventListener('click', () => {
                    if (showOnlyMine) { // Só faz algo se não estiver já mostrando anônimas
                        showOnlyMine = false;
                        updateFilterButtons();
                        loadConversations();
                    }
                });
            }

            // Botão de informação
            const infoBtn = document.getElementById('info-btn');
            const infoModal = document.getElementById('info-modal');
            const closeInfoModal = document.getElementById('close-info-modal');
            const closeInfoModalBottom = document.getElementById('close-info-modal-bottom');

            if (infoBtn && infoModal) {
                infoBtn.addEventListener('click', () => {
                    infoModal.style.display = 'flex';
                });
            }

            if (closeInfoModal && infoModal) {
                closeInfoModal.addEventListener('click', () => {
                    infoModal.style.display = 'none';
                });
            }

            if (closeInfoModalBottom && infoModal) {
                closeInfoModalBottom.addEventListener('click', () => {
                    infoModal.style.display = 'none';
                });
            }

            // Fechar modal ao clicar no backdrop
            if (infoModal) {
                infoModal.addEventListener('click', (e) => {
                    if (e.target === infoModal) {
                        infoModal.style.display = 'none';
                    }
                });
            }
            
            arquivoInput.addEventListener('change', () => {
                attachedFiles = [...arquivoInput.files];
                renderFilePreviews();
            });

            const uploadIcon = document.getElementById('upload-btn');
            if (uploadIcon) {
                uploadIcon.addEventListener('click', () => {
                    arquivoInput.click();
                });
            }

            function renderFilePreviews() {
                filePreviews.innerHTML = '';
                if (attachedFiles.length > 0) {
                    filePreviews.style.display = 'flex';
                    attachedFiles.forEach((file, index) => {
                        const previewEl = document.createElement('div');
                        previewEl.classList.add('file-preview');
                        
                        let iconHtml = '<i class="fas fa-file-alt file-icon"></i>';
                        if (file.type.startsWith('image/')) {
                            iconHtml = `<img src="${URL.createObjectURL(file)}" alt="${file.name}">`;
                        } else if (file.type.startsWith('audio/')) {
                            iconHtml = `<i class="fas fa-file-audio file-icon"></i>`;
                        }

                        previewEl.innerHTML = `
                            ${iconHtml}
                            <span class="file-name">${file.name}</span>
                            <button class="remove-file-btn" data-index="${index}" title="Remover arquivo">
                                <i class="fas fa-times"></i>
                            </button>
                        `;

                        filePreviews.appendChild(previewEl);
                    });
                } else {
                    filePreviews.style.display = 'none';
                }
            }

            filePreviews.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-file-btn');
                if (removeBtn) {
                    const indexToRemove = parseInt(removeBtn.dataset.index, 10);
                    attachedFiles.splice(indexToRemove, 1);
                    renderFilePreviews();
                    if (attachedFiles.length === 0) {
                        arquivoInput.value = '';
                    }
                }
            });

            let neuralCanvas, neuralCtx, neuralAnimationId;
            let neuralNodes = [];
            let neuralConnections = [];
            let neuralParticles = [];
            let neuralSignals = [];
            let neuralTime = 0;

            function initNeuralNetwork() {
                neuralCanvas = document.getElementById('neural-canvas');
                if (!neuralCanvas) return;
                neuralCtx = neuralCanvas.getContext('2d');

                // Criar nós neurais em camadas
                const layers = [4, 6, 6, 4]; // Camadas de neurônios
                const layerSpacing = neuralCanvas.width / (layers.length + 1);

                neuralNodes = [];
                layers.forEach((numNodes, layerIndex) => {
                    const layerX = layerSpacing * (layerIndex + 1);
                    const nodeSpacing = neuralCanvas.height / (numNodes + 1);

                    for (let i = 0; i < numNodes; i++) {
                        const nodeY = nodeSpacing * (i + 1);
                        neuralNodes.push({
                            x: layerX + (Math.random() - 0.5) * 20,
                            y: nodeY + (Math.random() - 0.5) * 15,
                            radius: 4 + Math.random() * 3,
                            pulse: Math.random() * Math.PI * 2,
                            layer: layerIndex,
                            energy: Math.random()
                        });
                    }
                });

                // Criar conexões entre camadas
                neuralConnections = [];
                for (let i = 0; i < layers.length - 1; i++) {
                    const startIndex = layers.slice(0, i).reduce((a, b) => a + b, 0);
                    const endIndex = startIndex + layers[i];
                    const nextStartIndex = endIndex;
                    const nextEndIndex = nextStartIndex + layers[i + 1];

                    for (let j = startIndex; j < endIndex; j++) {
                        for (let k = nextStartIndex; k < nextEndIndex; k++) {
                            if (Math.random() < 0.7) { // 70% de chance de conexão
                                neuralConnections.push({
                                    from: j,
                                    to: k,
                                    strength: Math.random(),
                                    active: Math.random() > 0.3
                                });
                            }
                        }
                    }
                }

                // Criar partículas flutuantes
                neuralParticles = [];
                for (let i = 0; i < 25; i++) {
                    neuralParticles.push({
                        x: Math.random() * neuralCanvas.width,
                        y: Math.random() * neuralCanvas.height,
                        vx: (Math.random() - 0.5) * 0.5,
                        vy: (Math.random() - 0.5) * 0.5,
                        size: Math.random() * 3 + 1,
                        alpha: Math.random() * 0.6 + 0.2,
                        hue: Math.random() * 60 + 240 // Tons de azul-roxo
                    });
                }
            }

            function animateNeuralNetwork() {
                if (!neuralCtx) return;

                neuralTime += 0.02;
                neuralCtx.clearRect(0, 0, neuralCanvas.width, neuralCanvas.height);

                // Fundo preto
                neuralCtx.fillStyle = 'black';
                neuralCtx.fillRect(0, 0, neuralCanvas.width, neuralCanvas.height);

                // Adicionar ondas de fundo aumentadas
                for (let w = 0; w < 4; w++) {
                    neuralCtx.beginPath();
                    neuralCtx.moveTo(0, neuralCanvas.height * (0.2 + w * 0.15));
                    for (let i = 0; i <= neuralCanvas.width; i += 5) {
                        const waveY = neuralCanvas.height * (0.2 + w * 0.15) + Math.sin((i * 0.02) + neuralTime * (2 + w * 0.5)) * 15;
                        neuralCtx.lineTo(i, waveY);
                    }
                    neuralCtx.strokeStyle = `rgba(255,255,255, ${0.4 - w * 0.05})`;
                    neuralCtx.lineWidth = 3 - w * 0.2;
                    neuralCtx.stroke();
                }

                neuralAnimationId = requestAnimationFrame(animateNeuralNetwork);
            }

            function startNeuralAnimation() {
                if (!neuralCanvas) initNeuralNetwork();
                if (neuralAnimationId) cancelAnimationFrame(neuralAnimationId);
                animateNeuralNetwork();
            }

            function stopNeuralAnimation() {
                if (neuralAnimationId) {
                    cancelAnimationFrame(neuralAnimationId);
                    neuralAnimationId = null;
                }
                if (neuralCtx) {
                    neuralCtx.clearRect(0, 0, neuralCanvas.width, neuralCanvas.height);
                }
                signals = []; // Clear signals
            }

            function showLoading(loading) {
                // Não mostrar botão de cancelamento se estiver gravando voz
                if (isRecording) return;

                isLoading = loading;
                loader.style.display = loading ? 'flex' : 'none';
                sendButton.style.display = loading ? 'none' : 'flex';
                cancelButton.style.display = loading ? 'flex' : 'none';
                if (loading) {
                    startNeuralAnimation();
                    mensagensContainer.appendChild(loader);
                    setTimeout(() => mensagensContainer.scrollTop = mensagensContainer.scrollHeight, 50);
                } else {
                    stopNeuralAnimation();
                }
            }

            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                
                if (!toast || !toastMessage) return;
                
                toastMessage.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'flex';
                
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }

            // Event listeners para botões de feedback
            mensagensContainer.addEventListener('click', async (e) => {
                // Copiar texto da mensagem para o campo de input quando clicar em mensagem do usuário
                const messageEl = e.target.closest('.message.user');
                if (messageEl && !e.target.closest('.message-buttons') && !e.target.closest('.feedback-buttons') && !e.target.closest('.tts-btn') && !e.target.closest('.delete-msg-btn') && !e.target.closest('.edit-msg-btn') && !e.target.closest('.save-edit-btn') && !e.target.closest('.cancel-edit-btn')) {
                    const contentEl = messageEl.querySelector('.content');
                    if (contentEl && mensagemInput) {
                        const text = contentEl.textContent || contentEl.innerText || '';
                        if (text.trim()) {
                            mensagemInput.value = text.trim();
                            mensagemInput.focus();
                            mensagemInput.setSelectionRange(mensagemInput.value.length, mensagemInput.value.length);
                            // Auto-resize textarea
                            mensagemInput.style.height = 'auto';
                            mensagemInput.style.height = mensagemInput.scrollHeight + 'px';
                            // Trigger input event to show/hide send button
                            mensagemInput.dispatchEvent(new Event('input'));
                            showToast('Texto copiado para o campo de mensagem', 'info');
                        }
                    }
                    return;
                }

                const likeBtn = e.target.closest('.feedback-btn.like');
                const dislikeBtn = e.target.closest('.feedback-btn.dislike');
                
                if (likeBtn || dislikeBtn) {
                    const messageEl = e.target.closest('.message');
                    if (!messageEl) return;
                    
                    const messageId = messageEl.dataset.messageId;
                    if (!messageId) return;
                    
                    const tipo = likeBtn ? 'like' : 'dislike';
                    
                    try {
                        const response = await fetch(`/api/mensagem/${messageId}/reacao/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ tipo: tipo })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Erro ao enviar reação');
                        }
                        
                        const data = await response.json();
                        
                        // Atualizar contadores
                        const likeCountEl = likeBtn ? likeBtn.querySelector('.like-count') : messageEl.querySelector('.like-count');
                        const dislikeCountEl = dislikeBtn ? dislikeBtn.querySelector('.dislike-count') : messageEl.querySelector('.dislike-count');
                        
                        if (likeCountEl) likeCountEl.textContent = data.likes_count;
                        if (dislikeCountEl) dislikeCountEl.textContent = data.dislikes_count;
                        
                        // Atualizar estado ativo (simples toggle visual)
                        if (likeBtn) {
                            likeBtn.classList.toggle('active');
                            const dislikeBtnInSameMessage = likeBtn.parentElement.querySelector('.dislike');
                            if (dislikeBtnInSameMessage) {
                                dislikeBtnInSameMessage.classList.remove('active');
                            }
                        } else if (dislikeBtn) {
                            dislikeBtn.classList.toggle('active');
                            const likeBtnInSameMessage = dislikeBtn.parentElement.querySelector('.like');
                            if (likeBtnInSameMessage) {
                                likeBtnInSameMessage.classList.remove('active');
                            }
                        }
                        
                        showToast(data.message, 'success');
                        
                    } catch (error) {
                        console.error('Erro ao enviar reação:', error);
                        showToast('Erro ao enviar reação: ' + error.message, 'error');
                    }
                    return;
                }

                // Event listeners para botões de comentário
                const cancelBtn = e.target.closest('.feedback-comment-btn.cancel');
                const submitBtn = e.target.closest('.feedback-comment-btn.submit');

                if (cancelBtn) {
                    const messageId = cancelBtn.dataset.messageId;
                    const commentBox = document.getElementById(`comment-box-${messageId}`);
                    const textarea = commentBox.querySelector('.feedback-comment-input');
                    if (commentBox && textarea) {
                        textarea.value = '';
                        commentBox.classList.remove('show');
                    }
                }

                if (submitBtn) {
                    const messageId = submitBtn.dataset.messageId;
                    const commentBox = document.getElementById(`comment-box-${messageId}`);
                    const textarea = commentBox.querySelector('.feedback-comment-input');
                    
                    if (commentBox && textarea) {
                        const comentario = textarea.value.trim();
                        if (comentario) {
                            try {
                                const response = await fetch(`/api/feedback/${messageId}/`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                    },
                                    body: JSON.stringify({ 
                                        feedback: false, 
                                        comentario: comentario 
                                    })
                                });
                                
                                if (response.ok) {
                                    textarea.value = '';
                                    commentBox.classList.remove('show');
                                    showToast('Comentário enviado com sucesso!', 'success');
                                } else {
                                    throw new Error('Erro ao enviar comentário');
                                }
                            } catch (error) {
                                console.error('Erro ao enviar comentário:', error);
                                showToast('Erro ao enviar comentário', 'error');
                            }
                        } else {
                            showToast('Por favor, escreva um comentário', 'warning');
                        }
                    }
                }

                // Event listener para botão TTS
                const ttsBtn = e.target.closest('.tts-btn');
                if (ttsBtn) {
                    const messageId = ttsBtn.dataset.messageId;
                    if (!messageId) return;

                    // Verificar se SpeechSynthesis está disponível
                    if (!('speechSynthesis' in window)) {
                        showToast('Seu navegador não suporta síntese de voz', 'error');
                        return;
                    }

                    // Encontrar o elemento da mensagem primeiro
                    const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (!messageEl) {
                        showToast('Mensagem não encontrada', 'error');
                        return;
                    }

                    const contentEl = messageEl.querySelector('.content');
                    if (!contentEl) {
                        showToast('Conteúdo da mensagem não encontrado', 'error');
                        return;
                    }

                    // Check if already playing for this message
                    if (currentTTSUtterances.has(messageId)) {
                        // Stop the current speech and remove highlighting
                        isStoppingTTSManually = true;
                        const currentUtterance = currentTTSUtterances.get(messageId);
                        speechSynthesis.cancel();
                        currentTTSUtterances.delete(messageId);
                        ttsBtn.classList.remove('playing');
                        isStoppingTTSManually = false;
                        // Restore HTML to remove word highlighting
                        contentEl.innerHTML = originalHTML;
                        return;
                    }

                    // Adicionar classe playing
                    ttsBtn.classList.add('playing');

                    try {
                        // Extrair texto da mensagem (remover HTML)
                        const text = contentEl.textContent || contentEl.innerText || '';

                        if (!text.trim()) {
                            throw new Error('Mensagem sem texto para falar');
                        }

                        // Verificar se é texto plano (sem HTML complexo) para destacar palavras
                        const hasComplexHTML = /<(a|img|table|blockquote)/i.test(contentEl.innerHTML);
                        const isPlainText = !hasComplexHTML && contentEl.innerHTML.trim() === contentEl.textContent.trim();
                        let wrapped = false;
                        originalHTML = contentEl.innerHTML;
                        let wordSpans = [];
                        let highlightInterval = null;
                        if (!hasComplexHTML) {
                            // Melhorar a segmentação de palavras para incluir pontuação
                            const words = text.match(/\S+/g) || []; // Match sequences of non-whitespace characters
                            if (words.length > 0) {
                                // Usar textContent para recriar HTML com spans
                                let wrappedHTML = '';
                                let lastIndex = 0;
                                words.forEach(word => {
                                    const index = text.indexOf(word, lastIndex);
                                    if (index !== -1) {
                                        wrappedHTML += text.substring(lastIndex, index) + `<span class="tts-word">${word}</span>`;
                                        lastIndex = index + word.length;
                                    }
                                });
                                wrappedHTML += text.substring(lastIndex);
                                contentEl.innerHTML = wrappedHTML;
                                wordSpans = contentEl.querySelectorAll('.tts-word');
                                wrapped = true;
                            }
                        }

                        // Criar utterance
                        const utterance = new SpeechSynthesisUtterance(text);

                        // Store the utterance
                        currentTTSUtterances.set(messageId, utterance);

                        // Configurar voz (opcional, usar voz padrão ou primeira disponível)
                        const voices = speechSynthesis.getVoices();
                        if (voices.length > 0) {
                            // Tentar encontrar uma voz em português
                            const ptVoice = voices.find(voice => voice.lang.startsWith('pt'));
                            if (ptVoice) {
                                utterance.voice = ptVoice;
                            }
                        }

                        // Configurar velocidade e tom
                        utterance.rate = 1.3; // Um pouco mais rápido ainda
                        utterance.pitch = 1; // Tom normal
                        utterance.volume = 1; // Volume máximo

                        let currentWordIndex = 0;

                        // Função para destacar palavra
                        const highlightWord = (index) => {
                            if (wrapped && wordSpans.length > 0) {
                                wordSpans.forEach(span => span.classList.remove('highlight'));
                                if (index < wordSpans.length) {
                                    wordSpans[index].classList.add('highlight');
                                }
                            }
                        };

                        // Destaque usando boundary se suportado, senão timer
                        let boundarySupported = false; // Forçar uso do timer para melhor sincronização
                        utterance.onboundary = (event) => {
                            if (event.name === 'word') {
                                boundarySupported = true;
                                // Mesmo com boundary, usar timer para consistência
                            }
                        };

                        let timeouts = [];

                        utterance.onstart = () => {
                            // Fallback com timer melhorado se boundary não for suportado
                            if (!boundarySupported && wrapped) {
                                let cumulativeDelay = 0;
                                wordSpans.forEach((span, index) => {
                                    const word = span.textContent;
                                    // Calcular tempo baseado no comprimento da palavra e pontuação (ajustável pela velocidade)
                                    let wordTime = (178 + (word.length * 40)) * ttsHighlightSpeed; // Mais devagar para melhor sincronização
                                    // Adicionar pausa para pontuação
                                    if (word.match(/[.!?]$/)) {
                                        wordTime += ttsPauseEndOfSentence; // Pausa ajustável para fim de frase
                                    } else if (word.match(/[,;]$/)) {
                                        wordTime += ttsPauseComma; // Pausa ajustável para vírgula e ponto e vírgula
                                    } else if (word.match(/:$/)) {
                                        wordTime += ttsPauseColon; // Pausa ajustável para dois pontos
                                    }
                                    // Pausa extra para números
                                    if (word.match(/^\d+$/)) {
                                        wordTime += ttsPauseNumber; // Pausa extra para números
                                    }
                                    // Limitar tempo mínimo e máximo
                                    wordTime = Math.max(100, Math.min(wordTime, 2000));
                                    
                                    const timeoutId = setTimeout(() => {
                                        highlightWord(index);
                                    }, cumulativeDelay);
                                    timeouts.push(timeoutId);
                                    cumulativeDelay += wordTime;
                                });
                            }
                        };

                        // Eventos
                        utterance.onend = () => {
                            currentTTSUtterances.delete(messageId);
                            ttsBtn.classList.remove('playing');
                            // Cancelar timeouts pendentes
                            timeouts.forEach(id => clearTimeout(id));
                            timeouts = [];
                            // Remover destaques e restaurar HTML original
                            if (wrapped) {
                                // Primeiro remover todas as classes highlight
                                wordSpans.forEach(span => span.classList.remove('highlight'));
                                // Depois restaurar HTML original
                                contentEl.innerHTML = originalHTML;
                            }
                        };

                        

                        // Falar
                        speechSynthesis.speak(utterance);

                    } catch (error) {
                        console.error('Erro ao gerar TTS:', error);
                        showToast('Erro ao gerar áudio: ' + error.message, 'error');
                        ttsBtn.classList.remove('playing');
                    }
                }

                // Event listener para botão de excluir mensagem
                const deleteMsgBtn = e.target.closest('.delete-msg-btn');
                if (deleteMsgBtn) {
                    const messageId = deleteMsgBtn.dataset.messageId;
                    if (!messageId) return;

                    // Obter o elemento da mensagem
                    const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (!messageEl) return;

                    // Obter o conteúdo da mensagem
                    const contentEl = messageEl.querySelector('.content');
                    let messageContent = '';
                    if (contentEl) {
                        messageContent = contentEl.innerHTML || contentEl.textContent || '';
                    }

                    // Preencher o modal com o conteúdo
                    const previewEl = document.getElementById('mensagem-preview-content');
                    if (previewEl) {
                        previewEl.innerHTML = messageContent;
                    }

                    // Mostrar o modal
                    const modal = document.getElementById('excluir-mensagem-modal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }

                    // Configurar o botão de confirmar
                    const confirmBtn = document.getElementById('confirmar-excluir-mensagem-btn');
                    if (confirmBtn) {
                        // Remover event listeners anteriores
                        const newConfirmBtn = confirmBtn.cloneNode(true);
                        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                        newConfirmBtn.addEventListener('click', async () => {
                            // Esconder o modal
                            if (modal) {
                                modal.style.display = 'none';
                            }

                            // Enviar requisição para excluir
                            try {
                                const response = await fetch(`/api/mensagem/${messageId}/excluir/`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                    }
                                });
                                const data = await response.json();
                                if (data.success) {
                                    // Atualizar a mensagem no DOM para mostrar como excluída
                                    if (messageEl) {
                                        messageEl.classList.add('deleted-message');
                                        const date = new Date();
                                        const day = String(date.getDate()).padStart(2, '0');
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const year = String(date.getFullYear()).slice(-2);
                                        const hours = String(date.getHours()).padStart(2, '0');
                                        const minutes = String(date.getMinutes()).padStart(2, '0');
                                        const timestamp = `${day}/${month}/${year} :${hours}:${minutes}`;
                                        messageEl.innerHTML = `
                                            <div class="deleted-message-content">
                                                <i class="fas fa-trash-alt"></i>
                                                <span>Esta mensagem foi excluída</span>
                                            </div>
                                            <div class="timestamp">${timestamp}</div>
                                        `;
                                    }
                                    showToast('Mensagem excluída com sucesso!', 'success');
                                } else {
                                    showToast('Erro ao excluir mensagem: ' + data.error, 'error');
                                }
                            } catch (error) {
                                console.error('Erro ao excluir mensagem:', error);
                                showToast('Erro ao excluir mensagem', 'error');
                            }
                        });
                    }
                }

                // Event listener para botão de editar mensagem
                const editMsgBtn = e.target.closest('.edit-msg-btn');
                if (editMsgBtn) {
                    const messageId = editMsgBtn.dataset.messageId;
                    if (!messageId) return;

                    const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (!messageEl) return;

                    const contentEl = messageEl.querySelector('.content');
                    if (!contentEl) return;

                    // Salvar conteúdo original
                    const originalHTML = contentEl.innerHTML;
                    const originalText = contentEl.textContent || contentEl.innerText || '';

                    // Criar textarea para edição
                    const textarea = document.createElement('textarea');
                    textarea.value = originalText.trim();
                    textarea.className = 'message-edit-textarea';
                    textarea.dataset.originalText = originalText.trim();
                    textarea.style.width = '100%';
                    textarea.style.minHeight = '60px';
                    textarea.style.padding = '8px';
                    textarea.style.border = '1px solid var(--border-color)';
                    textarea.style.borderRadius = '8px';
                    textarea.style.resize = 'vertical';

                    // Substituir conteúdo
                    contentEl.innerHTML = '';
                    contentEl.appendChild(textarea);
                    textarea.focus();
                    textarea.select();

                    // Esconder botões originais e mostrar botões de edição
                    const messageButtons = messageEl.querySelector('.message-buttons');
                    if (messageButtons) {
                        messageButtons.innerHTML = `
                            <button class="save-edit-btn" data-message-id="${messageId}" title="Salvar edição">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="cancel-edit-btn" data-message-id="${messageId}" title="Cancelar edição">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    }
                }

                // Event listener para salvar edição
                const saveEditBtn = e.target.closest('.save-edit-btn');
                if (saveEditBtn) {
                    const messageId = saveEditBtn.dataset.messageId;
                    if (!messageId) return;

                    const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (!messageEl) return;

                    const textarea = messageEl.querySelector('.message-edit-textarea');
                    if (!textarea) return;

                    const newText = textarea.value.trim();
                    if (!newText) {
                        showToast('A mensagem não pode estar vazia.', 'warning');
                        return;
                    }

                    // Restaurar visual da mensagem
                    const contentEl = messageEl.querySelector('.content');
                    contentEl.innerHTML = `<div class="content markdown-container">${newText}</div>`;
                    processCodeBlocks();

                    // Restaurar botões originais
                    const messageButtons = messageEl.querySelector('.message-buttons');
                    if (messageButtons) {
                        messageButtons.innerHTML = `
                            ${isConversationOwner ? `<button class="edit-msg-btn" data-message-id="${messageId}" title="Editar mensagem">
                                <i class="fas fa-edit"></i>
                            </button>` : ''}
                            ${isConversationOwner ? `<button class="delete-msg-btn" data-message-id="${messageId}" title="Excluir mensagem">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        `;
                    }

                    // Remover todas as mensagens após a editada (serão deletadas no backend)
                    const allMessages = Array.from(mensagensContainer.querySelectorAll('.message'));
                    const currentIndex = allMessages.indexOf(messageEl);
                    for (let i = currentIndex + 1; i < allMessages.length; i++) {
                        allMessages[i].remove();
                    }
                    
                    // Criar nova resposta da IA
                    const aiResponseEl = document.createElement('div');
                    aiResponseEl.classList.add('message', 'model');
                    aiResponseEl.dataset.messageId = 'temp-' + Date.now();
                    
                    const aiAvatarHtml = (selectedPersonality && selectedPersonality.foto_ia_url) ? 
                        `<div class="avatar"><img src="${selectedPersonality.foto_ia_url}" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div>` : 
                        `<div class="avatar"><img src="logos.jpeg" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div>`;
                    
                    aiResponseEl.innerHTML = `
                        ${aiAvatarHtml}
                        <div class="message-content">
                            <div class="content markdown-container" id="streaming-content"></div>
                            <div class="message-disclaimer" style="font-size: 10px; color: #5f6368; margin-top: 8px; text-align: center; opacity: 0.7;">
                                A Duck Intelligence pode cometer erros. Por isso, é bom checar as respostas.
                            </div>
                            <div class="message-buttons" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 8px;">
                                <div class="tts-container">
                                    <button class="tts-btn" title="Ouvir mensagem">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                                ${isConversationOwner ? `<button class="delete-msg-btn" title="Excluir mensagem">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''}
                            </div>
                            <div class="timestamp">${(() => {
                                const date = new Date();
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = String(date.getFullYear()).slice(-2);
                                const hours = String(date.getHours()).padStart(2, '0');
                                const minutes = String(date.getMinutes()).padStart(2, '0');
                                return `${day}/${month}/${year} :${hours}:${minutes}`;
                            })()}</div>
                        </div>
                    `;
                    
                    // Inserir após a mensagem editada
                    messageEl.insertAdjacentElement('afterend', aiResponseEl);
                    
                    // Limpar conteúdo anterior da resposta da IA
                    const streamingContent = aiResponseEl.querySelector('.content') || aiResponseEl.querySelector('#streaming-content');
                    if (streamingContent) {
                        streamingContent.innerHTML = '';
                    }
                    
                    mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                    
                    // Primeiro, salvar a edição no backend
                    const editResponse = await fetch(`/api/mensagem/${messageId}/editar/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ texto: newText })
                    });
                    
                    if (!editResponse.ok) {
                        const errorData = await editResponse.json();
                        throw new Error(errorData.error || 'Erro ao editar mensagem');
                    }
                    
                    const editData = await editResponse.json();
                    if (!editData.success) {
                        throw new Error(editData.error || 'Erro ao editar mensagem');
                    }
                    
                    // Agora reprocessar
                    const reprocessData = {
                        conversa_id: currentConversationId,
                        mensagem_id: messageId
                    };
                    
                    const response = await fetch('/api/chat/reprocessar/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify(reprocessData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Erro no reprocessamento');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.response) {
                        // Atualizar o conteúdo da resposta da IA
                        const streamingContent = aiResponseEl.querySelector('.content') || aiResponseEl.querySelector('#streaming-content');
                        streamingContent.innerHTML = data.response.resposta;
                        processCodeBlocks();
                        
                        // Atualizar ID da mensagem se necessário
                        if (data.response.mensagem_id && aiResponseEl.dataset.messageId.startsWith('temp-')) {
                            aiResponseEl.dataset.messageId = data.response.mensagem_id;
                        }
                        
                        mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
                        
                        showToast('Mensagem reprocessada com sucesso!', 'success');
                        
                        // Recarregar a conversa para atualizar tudo
                        await selectConversation(currentConversationId, true);
                    } else {
                        throw new Error(data.error || 'Erro no reprocessamento');
                    }
                }

                // Event listener para cancelar edição
                const cancelEditBtn = e.target.closest('.cancel-edit-btn');
                if (cancelEditBtn) {
                    const messageId = cancelEditBtn.dataset.messageId;
                    if (!messageId) return;

                    const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (!messageEl) return;

                    // Restaurar conteúdo original
                    const contentEl = messageEl.querySelector('.content');
                    const textarea = contentEl.querySelector('.message-edit-textarea');
                    if (textarea) {
                        const originalText = textarea.dataset.originalText || '';
                        contentEl.innerHTML = `<div class="content markdown-container">${originalText}</div>`;
                        processCodeBlocks();
                    }

                    // Restaurar botões originais
                    const messageButtons = messageEl.querySelector('.message-buttons');
                    if (messageButtons) {
                        messageButtons.innerHTML = `
                            ${isConversationOwner ? `<button class="edit-msg-btn" data-message-id="${messageId}" title="Editar mensagem">
                                <i class="fas fa-edit"></i>
                            </button>` : ''}
                            ${isConversationOwner ? `<button class="delete-msg-btn" data-message-id="${messageId}" title="Excluir mensagem">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        `;
                    }
                }
            });

            // Event listeners para personalidade modal
            const personalidadeBtn = document.getElementById('personalidade-btn');
            const closePersonalidadeModalBtn = document.getElementById('close-personalidade-modal-btn');
            const personalidadeModal = document.getElementById('personalidade-modal');

            if (personalidadeBtn) {
                personalidadeBtn.addEventListener('click', togglePersonalidadeModal);
            }
            if (closePersonalidadeModalBtn) {
                closePersonalidadeModalBtn.addEventListener('click', closePersonalidadeModal);
            }
            if (personalidadeModal) {
                personalidadeModal.addEventListener('click', (e) => {
                    if (e.target === personalidadeModal) {
                        closePersonalidadeModal();
                    }
                });
            }

            // Event listener para botão de cancelar resposta
            const cancelResponseBtn = document.getElementById('cancel-response-btn');
            if (cancelResponseBtn) {
                cancelResponseBtn.addEventListener('click', async () => {
                    try {
                        const response = await fetch('/api/cancelar_resposta/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json',
                            },
                        });

                        if (response.ok) {
                            showToast('Resposta cancelada!', 'success');
                            showLoading(false);
                            await selectConversation(currentConversationId, true); // Recarregar a conversa atual após cancelar, como ao selecionar
                        } else {
                            throw new Error('Falha ao cancelar resposta');
                        }
                    } catch (error) {
                        console.error('Erro ao cancelar resposta:', error);
                        showToast('Erro ao cancelar resposta: ' + error.message, 'error');
                    }
                });
            }

            // Event listener para botão de nova conversa
            if (novaConversaBtn) {
                novaConversaBtn.addEventListener('click', () => {
                    localStorage.removeItem('lastConversationId');
                    // Redirecionar para a página inicial
                    window.location.href = '/';
                });
            }

            // Event listeners para modal de exclusão de conversa
            const excluirConversaModal = document.getElementById('excluir-conversa-modal');
            const cancelarExcluirConversaBtn = document.getElementById('cancelar-excluir-conversa-btn');
            const confirmarExcluirConversaBtn = document.getElementById('confirmar-excluir-conversa-btn');
            let conversaIdParaExcluir = null;

            if (cancelarExcluirConversaBtn) {
                cancelarExcluirConversaBtn.addEventListener('click', () => {
                    if (excluirConversaModal) excluirConversaModal.style.display = 'none';
                    conversaIdParaExcluir = null;
                });
            }

            if (excluirConversaModal) {
                excluirConversaModal.addEventListener('click', (e) => {
                    if (e.target === excluirConversaModal) {
                        excluirConversaModal.style.display = 'none';
                        conversaIdParaExcluir = null;
                    }
                });
            }

            if (confirmarExcluirConversaBtn) {
                confirmarExcluirConversaBtn.addEventListener('click', async () => {
                    if (!conversaIdParaExcluir) return;

                    try {
                        const response = await fetch('/api/conversa/excluir/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ conversa_id: conversaIdParaExcluir }),
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'Falha ao excluir a conversa.');
                        
                        if (currentConversationId === conversaIdParaExcluir) {
                            showInitialState();
                        }
                        await loadConversations();
                        showToast('Conversa excluída com sucesso!', 'success');
                        if (excluirConversaModal) excluirConversaModal.style.display = 'none';
                        conversaIdParaExcluir = null;
                    } catch (error) {
                        console.error('Erro:', error);
                        showToast('Erro ao excluir conversa: ' + error.message, 'error');
                    }
                });
            }

            async function deleteConversation(conversaId) {
                try {
                    const response = await fetch('/api/conversa/excluir/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ conversa_id: conversaId }),
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Falha ao excluir a conversa.');
                    
                    if (currentConversationId === conversaId) {
                        showInitialState();
                    }
                    await loadConversations();
                    showToast('Conversa movida para lixeira!', 'success');
                } catch (error) {
                    console.error('Erro:', error);
                    showToast('Erro ao excluir conversa: ' + error.message, 'error');
                }
            }

            // Event listeners para modal de exclusão de mensagem
            const excluirMensagemModal = document.getElementById('excluir-mensagem-modal');
            const cancelarExcluirMensagemBtn = document.getElementById('cancelar-excluir-mensagem-btn');

            if (cancelarExcluirMensagemBtn) {
                cancelarExcluirMensagemBtn.addEventListener('click', () => {
                    if (excluirMensagemModal) excluirMensagemModal.style.display = 'none';
                });
            }

            if (excluirMensagemModal) {
                excluirMensagemModal.addEventListener('click', (e) => {
                    if (e.target === excluirMensagemModal) {
                        excluirMensagemModal.style.display = 'none';
                    }
                });
            }

            // Função auxiliar para abrir modal de exclusão
            function openExcluirConversaModal(conversaId) {
                conversaIdParaExcluir = conversaId;
                // Buscar informações da conversa para mostrar no modal
                const conversaItem = document.querySelector(`[data-id="${conversaId}"]`);
                const conversaTitulo = conversaItem ? conversaItem.querySelector('h3').textContent : 'Conversa';

                // Preencher o modal com informações da conversa
                const tituloEl = document.getElementById('excluir-conversa-titulo');
                if (tituloEl) tituloEl.textContent = conversaTitulo;

                // Mostrar o modal
                const modal = document.getElementById('excluir-conversa-modal');
                if (modal) modal.style.display = 'flex';
            }

            // Event listeners para lixeira modal
            const lixeiraBtn = document.getElementById('lixeira-btn');
            const closeLixeiraModalBtn = document.getElementById('close-lixeira-modal-btn');
            const esvaziarLixeiraBtn = document.getElementById('esvaziar-lixeira-btn');
            const lixeiraModal = document.getElementById('lixeira-modal');
            const lixeiraList = document.getElementById('lixeira-list');

            function openLixeiraModal() {
                if (lixeiraModal) {
                    lixeiraModal.style.display = 'flex';
                    carregarConversasExcluidas();
                }
            }

            function closeLixeiraModal() {
                if (lixeiraModal) {
                    lixeiraModal.style.display = 'none';
                }
            }

            async function carregarConversasExcluidas() {
                try {
                    const response = await fetch('/api/conversas/excluidas/');
                    if (!response.ok) throw new Error('Não foi possível carregar as conversas excluídas.');
                    const data = await response.json();

                    lixeiraList.innerHTML = '';
                    if (data.conversas.length === 0) {
                        lixeiraList.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 2rem;">Nenhuma conversa na lixeira.</p>`;
                        return;
                    }

                    data.conversas.forEach(conversa => {
                        const item = document.createElement('div');
                        item.classList.add('lixeira-item');
                        item.innerHTML = `
                            <div class="lixeira-item-info">
                                <h4>${conversa.titulo}</h4>
                                <p>Excluída em ${new Date(conversa.excluida_em).toLocaleDateString('pt-BR')} - ${conversa.total_mensagens} mensagens</p>
                            </div>
                            <div class="lixeira-item-actions">
                                ${conversa.is_owner ? `<button class="restore-btn" data-id="${conversa.id}" title="Restaurar conversa">
                                    <i class="fas fa-undo"></i>
                                </button>` : ''}
                                <button class="delete-btn" data-id="${conversa.id}" title="Excluir permanentemente">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `;

                        // Event listeners para os botões
                        const restoreBtn = item.querySelector('.restore-btn');
                        const deleteBtn = item.querySelector('.delete-btn');

                        if (restoreBtn) {
                            restoreBtn.addEventListener('click', () => restaurarConversa(conversa.id));
                        }
                        deleteBtn.addEventListener('click', () => excluirPermanentemente(conversa.id));

                        lixeiraList.appendChild(item);
                    });

                } catch (error) {
                    console.error('Erro ao carregar conversas excluídas:', error);
                    showToast('Erro ao carregar lixeira: ' + error.message, 'error');
                }
            }

            async function restaurarConversa(conversaId) {
                try {
                    const response = await fetch(`/api/conversa/${conversaId}/restaurar/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                        },
                    });

                    if (!response.ok) throw new Error('Falha ao restaurar a conversa.');

                    showToast('Conversa restaurada com sucesso!', 'success');
                    carregarConversasExcluidas();
                    loadConversations(); // Recarregar lista de conversas ativas
                    await selectConversation(currentConversationId, true); // Recarregar a conversa atual forçadamente
                } catch (error) {
                    console.error('Erro ao restaurar conversa:', error);
                    showToast('Erro ao restaurar conversa: ' + error.message, 'error');
                }
            }

            async function excluirPermanentemente(conversaId) {
                showCustomConfirm('Esta ação é irreversível. Deseja excluir permanentemente esta conversa?', async () => {
                    try {
                        // Como já está excluída (soft delete), podemos fazer hard delete
                        const response = await fetch('/api/conversa/excluir/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ conversa_id: conversaId }),
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'Falha ao excluir permanentemente.');

                        showToast('Conversa excluída permanentemente!', 'success');
                        carregarConversasExcluidas();
                    } catch (error) {
                        console.error('Erro ao excluir permanentemente:', error);
                        showToast('Erro ao excluir permanentemente: ' + error.message, 'error');
                    }
                });
            }

            async function esvaziarLixeira() {
                showCustomConfirm('Esta ação é irreversível. Deseja excluir permanentemente todas as conversas da lixeira?', async () => {
                    try {
                        const response = await fetch('/api/limpar/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                            },
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'Falha ao esvaziar lixeira.');

                        showToast('Lixeira esvaziada com sucesso!', 'success');
                        carregarConversasExcluidas();
                    } catch (error) {
                        console.error('Erro ao esvaziar lixeira:', error);
                        showToast('Erro ao esvaziar lixeira: ' + error.message, 'error');
                    }
                });
            }

            if (lixeiraBtn) {
                lixeiraBtn.addEventListener('click', openLixeiraModal);
            }
            if (closeLixeiraModalBtn) {
                closeLixeiraModalBtn.addEventListener('click', closeLixeiraModal);
            }
            const closeLixeiraModalBtnBottom = document.getElementById('close-lixeira-modal-btn-bottom');
            if (closeLixeiraModalBtnBottom) {
                closeLixeiraModalBtnBottom.addEventListener('click', closeLixeiraModal);
            }
            if (esvaziarLixeiraBtn) {
                esvaziarLixeiraBtn.addEventListener('click', esvaziarLixeira);
            }
            if (lixeiraModal) {
                lixeiraModal.addEventListener('click', (e) => {
                    if (e.target === lixeiraModal) {
                        closeLixeiraModal();
                    }
                });
            }
            if (esvaziarLixeiraBtn) {
                esvaziarLixeiraBtn.addEventListener('click', () => {
                    showCustomConfirm('Deseja excluir permanentemente todas as conversas da lixeira?', async () => {
                        try {
                            // Para esvaziar lixeira, podemos fazer uma operação em lote
                            const conversas = document.querySelectorAll('.lixeira-item .delete-btn');
                            for (const btn of conversas) {
                                const conversaId = btn.dataset.id;
                                await excluirPermanentemente(conversaId);
                            }
                        } catch (error) {
                            console.error('Erro ao esvaziar lixeira:', error);
                            showToast('Erro ao esvaziar lixeira: ' + error.message, 'error');
                        }
                    });
                });
            }

            async function init() {
                // Adicionamos verificações para garantir que os elementos existem
                if (conversaTitulo) {
                    conversaTitulo.textContent = '';
                }
                if (conversaTituloMobile) {
                    conversaTituloMobile.textContent = '';
                }
                if (tokenCountSidebar) {
                    tokenCountSidebar.textContent = `Tokens: 0`;
                }
                if (shareBtn) {
                    shareBtn.style.display = 'none';
                }
                if (shareBtnMobile) {
                    shareBtnMobile.style.display = 'none';
                }

                initNeuralNetwork();
                await loadPersonalidades();
                await loadConversations();

                // Carregar conversa inicial se existir
                if (initialConversationId) {
                    selectConversation(initialConversationId);
                }

                // Adicionar botões de copiar aos blocos de código existentes
                processCodeBlocks();
            }



            function addEnhancedCodeUI() {
                console.log('addEnhancedCodeUI called');
                // Remove existing UI elements to avoid duplicates
                document.querySelectorAll('.code-block').forEach(el => {
                    // Unwrap the pre element
                    const pre = el.querySelector('pre');
                    if (pre) {
                        el.parentNode.insertBefore(pre, el);
                        el.remove();
                    }
                });

                // Process all pre elements
                const preElements = document.querySelectorAll('pre:not(.code-processed)');
                console.log('Found pre elements:', preElements.length);
                preElements.forEach(pre => {
                    console.log('Processing pre element:', pre);
                    const code = pre.querySelector('code');
                    if (!code) {
                        console.log('No code element found in pre');
                        return;
                    }

                    // Create custom code block wrapper
                    const codeBlock = document.createElement('div');
                    codeBlock.className = 'code-block';
                    codeBlock.setAttribute('aria-label', 'Bloco de código');
                    
                    // Create code header
                    const codeHeader = document.createElement('div');
                    codeHeader.className = 'code-header';
                    
                    // Language info
                    const languageInfo = document.createElement('div');
                    languageInfo.className = 'language-info';
                    
                    // Detect language
                    let language = 'text';
                    const classes = code.className.split(' ');
                    for (const cls of classes) {
                        if (cls.startsWith('language-')) {
                            language = cls.replace('language-', '');
                            break;
                        }
                    }
                    
                    const languageBadge = document.createElement('span');
                    languageBadge.className = 'language-badge';
                    languageBadge.textContent = getLanguageDisplayName(language);
                    languageInfo.appendChild(languageBadge);
                    
                    codeHeader.appendChild(languageInfo);
                    
                    // Code actions
                    const codeActions = document.createElement('div');
                    codeActions.className = 'code-actions';
                    
                    // Copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.type = 'button';
                    copyBtn.title = 'Copiar código';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copiar';
                    copyBtn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(pre.textContent.trim());
                            const prev = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                            copyBtn.classList.add('success', 'feedback');
                            setTimeout(() => {
                                copyBtn.innerHTML = prev;
                                copyBtn.classList.remove('success', 'feedback');
                            }, 2000);
                        } catch (e) {
                            console.error('Erro ao copiar:', e);
                            copyBtn.innerHTML = '<i class="fas fa-times"></i> Erro';
                            copyBtn.classList.add('feedback');
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copiar';
                                copyBtn.classList.remove('feedback');
                            }, 2000);
                        }
                    });
                    codeActions.appendChild(copyBtn);
                    
                    // Download button
                    const downloadBtn = document.createElement('button');
                    downloadBtn.type = 'button';
                    downloadBtn.title = 'Baixar código';
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> Baixar';
                    downloadBtn.addEventListener('click', () => {
                        const blob = new Blob([pre.textContent.trim()], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `codigo.${getFileExtension(language)}`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                        downloadBtn.innerHTML = '<i class="fas fa-check"></i> Baixado!';
                        downloadBtn.classList.add('success', 'feedback');
                        setTimeout(() => {
                            downloadBtn.innerHTML = '<i class="fas fa-download"></i> Baixar';
                            downloadBtn.classList.remove('success', 'feedback');
                        }, 2000);
                    });
                    codeActions.appendChild(downloadBtn);
                    
                    // Wrap button
                    const wrapBtn = document.createElement('button');
                    wrapBtn.type = 'button';
                    wrapBtn.title = 'Alternar quebra de linha';
                    wrapBtn.innerHTML = '<i class="fas fa-align-left"></i> Wrap';
                    wrapBtn.addEventListener('click', () => {
                        if (pre.classList.contains('wrap')) {
                            pre.classList.remove('wrap');
                            wrapBtn.innerHTML = '<i class="fas fa-align-left"></i> Wrap';
                            wrapBtn.title = 'Quebrar linhas';
                        } else {
                            pre.classList.add('wrap');
                            wrapBtn.innerHTML = '<i class="fas fa-align-justify"></i> Unwrap';
                            wrapBtn.title = 'Não quebrar linhas';
                        }
                        wrapBtn.classList.add('feedback');
                        setTimeout(() => wrapBtn.classList.remove('feedback'), 600);
                    });
                    codeActions.appendChild(wrapBtn);
                    
                    // Line numbers button
                    const lineBtn = document.createElement('button');
                    lineBtn.type = 'button';
                    lineBtn.title = 'Mostrar números de linha';
                    lineBtn.innerHTML = '<i class="fas fa-list-ol"></i> Linhas';
                    lineBtn.addEventListener('click', () => {
                        if (pre.classList.contains('show-line-numbers')) {
                            pre.classList.remove('show-line-numbers');
                            lineBtn.innerHTML = '<i class="fas fa-list-ol"></i> Linhas';
                            lineBtn.title = 'Mostrar números de linha';
                        } else {
                            pre.classList.add('show-line-numbers');
                            lineBtn.innerHTML = '<i class="fas fa-list"></i> Sem linhas';
                            lineBtn.title = 'Ocultar números de linha';
                        }
                        lineBtn.classList.add('feedback');
                        setTimeout(() => lineBtn.classList.remove('feedback'), 600);
                    });
                    codeActions.appendChild(lineBtn);
                    
                    codeHeader.appendChild(codeActions);
                    
                    // Code area
                    const codeArea = document.createElement('div');
                    codeArea.className = 'code-area';
                    codeArea.appendChild(pre);
                    
                    // Code footer
                    const codeFooter = document.createElement('div');
                    codeFooter.className = 'code-footer';
                    
                    const lineCount = pre.textContent.split('\n').length;
                    const charCount = pre.textContent.trim().length;
                    
                    codeFooter.innerHTML = `
                        <div class="code-meta">
                            <strong>${getLanguageDisplayName(language)}</strong> • ${lineCount} linha${lineCount !== 1 ? 's' : ''} • ${charCount} caracteres
                        </div>
                        <div class="code-hint">Use os botões acima para copiar ou baixar o código</div>
                    `;
                    
                    // Assemble code block
                    codeBlock.appendChild(codeHeader);
                    codeBlock.appendChild(codeArea);
                    codeBlock.appendChild(codeFooter);
                    
                    // Insert code block and remove original pre
                    pre.parentNode.insertBefore(codeBlock, pre);
                    pre.remove();
                    
                    pre.classList.add('code-processed');
                });
            }
            
            function getLanguageDisplayName(language) {
                return 'Bash';
            }
            
            function getFileExtension(language) {
                const extensions = {
                    'javascript': 'js',
                    'typescript': 'ts',
                    'python': 'py',
                    'html': 'html',
                    'css': 'css',
                    'json': 'json',
                    'sql': 'sql',
                    'bash': 'sh',
                    'php': 'php',
                    'java': 'java',
                    'cpp': 'cpp',
                    'c': 'c',
                    'text': 'txt'
                };
                return extensions[language] || 'txt';
            }

            function addExpandButtons(messageEl) {
                // Handle message content expansion
                const contentDivs = messageEl.querySelectorAll('.content');
                contentDivs.forEach(contentDiv => {
                    if (contentDiv.scrollHeight > 250 && !contentDiv.querySelector('.expand-btn')) {
                        contentDiv.classList.add('collapsed');
                        const btn = document.createElement('button');
                        btn.className = 'expand-btn';
                        btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                        btn.title = 'Expandir mensagem';
                        btn.onclick = () => {
                            contentDiv.classList.toggle('collapsed');
                            if (contentDiv.classList.contains('collapsed')) {
                                btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                                btn.title = 'Expandir mensagem';
                            } else {
                                btn.innerHTML = '<i class="fas fa-chevron-up"></i>';
                                btn.title = 'Recolher mensagem';
                            }
                        };
                        contentDiv.insertBefore(btn, contentDiv.firstChild);
                    }
                });
            }
            const observer = new MutationObserver(() => {
                processCodeBlocks();
            });
            observer.observe(document.body, { childList: true, subtree: true });

            // Dismiss banner functionality (removed)

            // Initial warning modal (removed)

            // Audio functionality
            let userUsedVoice = false;

            // Audio recording functionality
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;
            let currentStream;
            const audioIcon = document.getElementById('audio-btn');

            // Hide/show audio icon when typing
            mensagemInput.addEventListener('input', () => {
                if (mensagemInput.value.trim()) {
                    audioIcon.style.display = 'none';
                } else {
                    audioIcon.style.display = '';
                }
            });
            mensagemInput.addEventListener('blur', () => {
                if (!mensagemInput.value.trim()) {
                    audioIcon.style.display = '';
                }
            });

            // Voice recognition
            let recognition;
            let audioContext;
            let analyser;
            let dataArray;
            let canvas;
            let canvasCtx;
            let animationId;
            let currentTranscript = '';
            const voiceModal = document.getElementById('voice-modal');
            const startVoiceBtn = document.getElementById('start-voice-btn');
            const stopVoiceBtn = document.getElementById('stop-voice-btn');
            const sendVoiceBtn = document.getElementById('send-voice-btn');
            const closeVoiceModalBtn = document.getElementById('close-voice-modal');

            // Inicializar estado dos botões
            startVoiceBtn.addEventListener('click', () => {
                if (!isRecording) {
                    startVoiceRecording();
                }
            });

            stopVoiceBtn.addEventListener('click', () => {
                if (isRecording) {
                    stopVoiceRecording();
                }
            });

            sendVoiceBtn.addEventListener('click', () => {
                if (currentTranscript.trim()) {
                    const textarea = document.getElementById('mensagem-input');
                    textarea.value += (textarea.value ? ' ' : '') + currentTranscript.trim();
                    textarea.focus();
                    document.getElementById('chat-form').dispatchEvent(new Event('submit'));

                    // Esconder o microfone após enviar
                    audioIcon.style.display = 'none';
                    // Fechar modal
                    voiceModal.style.display = 'none';
                    stopRecordingCleanup();
                }
            });

            closeVoiceModalBtn.addEventListener('click', () => {
                if (isRecording) {
                    stopVoiceRecording();
                }
                voiceModal.style.display = 'none';
            });

            audioIcon.addEventListener('click', (e) => {
                e.preventDefault();
                if (!isRecording) {
                    startVoiceRecording();
                }
            });

            audioIcon.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!isRecording) {
                    voiceModal.style.display = 'flex';
                    startVoiceBtn.style.display = 'inline-flex';
                    stopVoiceBtn.style.display = 'none';
                    sendVoiceBtn.style.display = 'none';
                }
            });

            audioIcon.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (isRecording) {
                    stopVoiceRecording();
                }
            });

            function startVoiceRecording() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Seu navegador não suporta reconhecimento de voz.');
                    return;
                }

                userUsedVoice = true;
                isRecording = true;
                voiceModal.classList.add('recording');
                startVoiceBtn.style.display = 'none';
                stopVoiceBtn.style.display = 'inline-flex';
                sendVoiceBtn.style.display = 'none';

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'pt-BR';

                recognition.onstart = async () => {
                    currentTranscript = '';

                    // Iniciar visualização de áudio no modal
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        currentStream = stream;
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        analyser = audioContext.createAnalyser();
                        const source = audioContext.createMediaStreamSource(stream);
                        source.connect(analyser);
                        analyser.fftSize = 256;
                        const bufferLength = analyser.frequencyBinCount;
                        dataArray = new Uint8Array(bufferLength);

                        // Usar o canvas do modal
                        canvas = document.getElementById('voice-canvas');
                        canvasCtx = canvas.getContext('2d');
                        draw();
                    } catch (error) {
                        console.error('Erro ao configurar visualização de áudio:', error);
                    }
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    currentTranscript = transcript;
                };

                recognition.onerror = (event) => {
                    console.error('Erro no reconhecimento:', event.error);
                    stopRecordingCleanup();
                };

                recognition.onend = () => {
                    stopRecordingCleanup();
                    if (currentTranscript.trim()) {
                        startVoiceBtn.style.display = 'none';
                        stopVoiceBtn.style.display = 'none';
                        sendVoiceBtn.style.display = 'inline-flex';
                    } else {
                        startVoiceBtn.style.display = 'inline-flex';
                        stopVoiceBtn.style.display = 'none';
                        sendVoiceBtn.style.display = 'none';
                        visualizerOverlay.style.opacity = '1';
                    }
                };

                recognition.start();
            }

            function stopVoiceRecording() {
                if (isRecording && recognition) {
                    recognition.stop();
                }
            }

            function stopRecordingCleanup() {
                isRecording = false;
                voiceModal.classList.remove('recording');
                audioIcon.classList.remove('recording');

                // Limpar visualização
                stopVisualization();

                // Parar stream de áudio
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
            }

            function stopVisualization() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                if (audioContext) {
                    audioContext.close();
                }
            }

            function draw() {
                if (!analyser || !canvasCtx) return;

                analyser.getByteFrequencyData(dataArray);

                // Fundo com gradiente animado
                const time = Date.now() * 0.001;
                const gradientBg = canvasCtx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradientBg.addColorStop(0, `rgba(${20 + Math.sin(time) * 10}, 0, ${40 + Math.cos(time) * 20}, 0.9)`);
                gradientBg.addColorStop(0.5, 'rgba(20, 20, 40, 0.8)');
                gradientBg.addColorStop(1, `rgba(${Math.sin(time + Math.PI) * 10}, 0, ${20 + Math.cos(time + Math.PI) * 15}, 0.9)`);
                canvasCtx.fillStyle = gradientBg;
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / dataArray.length) * 3;
                let barHeight;
                let x = 0;

                for (let i = 0; i < dataArray.length; i++) {
                    barHeight = (dataArray[i] / 255) * canvas.height * 0.8;

                    // Gradiente colorido dinâmico para as barras
                    const hue = (i / dataArray.length) * 360 + time * 50;
                    const barGradient = canvasCtx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                    barGradient.addColorStop(0, `hsl(${hue % 360}, 80%, 60%)`);
                    barGradient.addColorStop(0.5, `hsl(${(hue + 60) % 360}, 90%, 70%)`);
                    barGradient.addColorStop(1, `hsl(${(hue + 120) % 360}, 100%, 80%)`);

                    canvasCtx.fillStyle = barGradient;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                    // Adicionar brilho nas barras altas
                    if (barHeight > canvas.height * 0.6) {
                        canvasCtx.shadowColor = `hsl(${hue % 360}, 100%, 70%)`;
                        canvasCtx.shadowBlur = 15;
                        canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        canvasCtx.shadowBlur = 0;
                    }

                    x += barWidth + 2;
                }

                // Adicionar efeito de particulas flutuantes
                for (let i = 0; i < 30; i++) {
                    const particleX = (Math.sin(time * 2 + i) * 0.5 + 0.5) * canvas.width;
                    const particleY = (Math.cos(time * 1.5 + i) * 0.5 + 0.5) * canvas.height;
                    const particleSize = Math.sin(time + i) * 2 + 3;
                    const alpha = (Math.sin(time * 3 + i) * 0.5 + 0.5) * 0.6 + 0.2;

                    canvasCtx.beginPath();
                    canvasCtx.arc(particleX, particleY, particleSize, 0, Math.PI * 2);
                    canvasCtx.fillStyle = `hsla(${(time * 100 + i * 20) % 360}, 80%, 70%, ${alpha})`;
                    canvasCtx.fill();
                }

                // Adicionar ondas de fundo sutis
                canvasCtx.beginPath();
                canvasCtx.moveTo(0, canvas.height * 0.7);
                for (let i = 0; i <= canvas.width; i += 10) {
                    const waveY = canvas.height * 0.7 + Math.sin((i * 0.01) + time * 2) * 10;
                    canvasCtx.lineTo(i, waveY);
                }
                canvasCtx.strokeStyle = 'rgba(100, 126, 234, 0.1)';
                canvasCtx.lineWidth = 2;
                canvasCtx.stroke();

                // Desenhar texto da transcrição no canvas
                canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                canvasCtx.font = 'bold 20px Poppins';
                canvasCtx.textAlign = 'center';
                canvasCtx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                canvasCtx.shadowBlur = 4;

                const displayText = currentTranscript.trim() || 'Fale...';
                const lines = wrapText(canvasCtx, displayText, canvas.width - 40, 22);

                lines.forEach((line, index) => {
                    canvasCtx.fillText(line, canvas.width / 2, canvas.height - 35 + index * 22);
                });

                canvasCtx.shadowBlur = 0;

                animationId = requestAnimationFrame(draw);
            }

            function wrapText(context, text, maxWidth, lineHeight) {
                const words = text.split(' ');
                const lines = [];
                let currentLine = '';

                for (let i = 0; i < words.length; i++) {
                    const testLine = currentLine + words[i] + ' ';
                    const metrics = context.measureText(testLine);
                    if (metrics.width > maxWidth && i > 0) {
                        lines.push(currentLine.trim());
                        currentLine = words[i] + ' ';
                    } else {
                        currentLine = testLine;
                    }
                }
                lines.push(currentLine.trim());
                return lines;
            }

            // Modal de aviso de link
            const linkWarningModal = document.getElementById('link-warning-modal');
            const linkWarningUrl = document.getElementById('link-warning-url');
            const cancelLinkBtn = document.getElementById('cancel-link-btn');
            const confirmLinkBtn = document.getElementById('confirm-link-btn');
            let pendingLinkUrl = null;

            // Event listener para links nas mensagens
            mensagensContainer.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link) {
                    e.preventDefault();
                    const href = link.href;
                    if (href && href.startsWith('http')) {
                        pendingLinkUrl = href;
                        linkWarningUrl.textContent = href;
                        linkWarningModal.style.display = 'flex';
                    }
                }
            });

            // Botões do modal de link
            if (cancelLinkBtn) {
                cancelLinkBtn.addEventListener('click', () => {
                    linkWarningModal.style.display = 'none';
                    pendingLinkUrl = null;
                });
            }

            if (confirmLinkBtn) {
                confirmLinkBtn.addEventListener('click', () => {
                    if (pendingLinkUrl) {
                        window.open(pendingLinkUrl, '_blank');
                    }
                    linkWarningModal.style.display = 'none';
                    pendingLinkUrl = null;
                });
            }

            // Funcionalidade de edição de título da conversa
            function enableTitleEditing(titleElement, isMobile = false) {
                if (!titleElement || !currentConversationId) return;

                const originalText = titleElement.textContent.trim();
                titleElement.classList.add('editing');

                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalText;
                input.maxLength = 100;
                input.style.fontSize = 'inherit';
                input.style.fontWeight = 'inherit';
                input.style.width = '100%';
                input.style.textAlign = 'center';
                input.style.background = 'transparent';
                input.style.border = 'none';
                input.style.outline = 'none';
                input.style.color = 'var(--text-primary)';

                titleElement.innerHTML = '';
                titleElement.appendChild(input);
                input.focus();
                input.select();

                function saveTitle() {
                    const newTitle = input.value.trim();
                    if (newTitle && newTitle !== originalText) {
                        updateConversationTitle(currentConversationId, newTitle);
                    } else {
                        titleElement.textContent = originalText;
                    }
                    titleElement.classList.remove('editing');
                }

                function cancelEdit() {
                    titleElement.textContent = originalText;
                    titleElement.classList.remove('editing');
                }

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveTitle();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEdit();
                    }
                });

                input.addEventListener('blur', () => {
                    saveTitle();
                });

                // Prevenir que o clique no input propague para o título
                input.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            async function updateConversationTitle(conversationId, newTitle) {
                console.log('Chamando update para conversa:', conversationId, 'novo título:', newTitle);
                console.log('CSRF Token:', csrfToken);
                try {
                    const response = await fetch(`/api/conversa/${conversationId}/titulo/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({ titulo: newTitle }),
                    });

                    if (!response.ok) {
                        throw new Error('Erro ao atualizar título');
                    }

                    const data = await response.json();
                    if (data.success) {
                        // Atualizar título nos elementos
                        if (conversaTitulo) conversaTitulo.textContent = newTitle;
                        if (conversaTituloMobile) conversaTituloMobile.textContent = newTitle;

                        // Atualizar na lista de conversas
                        const conversationItem = document.querySelector(`[data-id="${conversationId}"] .conversation-content h3`);
                        if (conversationItem) {
                            conversationItem.textContent = newTitle;
                        }

                        showToast('Título atualizado com sucesso!', 'success');
                    } else {
                        throw new Error(data.error || 'Erro ao atualizar título');
                    }
                } catch (error) {
                    console.error('Erro ao atualizar título:', error);
                    showToast('Erro ao atualizar título: ' + error.message, 'error');

                    // Reverter título em caso de erro
                    if (conversaTitulo) conversaTitulo.textContent = newTitle; // manter o novo título temporariamente
                    if (conversaTituloMobile) conversaTituloMobile.textContent = newTitle;
                }
            }


            init();
        });
    </script>
    <!-- Share Message Overlay -->
    <div id="share-message-overlay" class="share-overlay" style="display: none;">
        <div class="share-modal">
            <div class="share-header">
                <h3>Compartilhar Mensagem</h3>
                <button id="close-share-modal" class="close-btn">&times;</button>
            </div>
            <div class="share-content">
                <p id="share-text-preview"></p>
            </div>
            <div class="share-buttons">
                <button class="share-btn whatsapp" data-platform="whatsapp">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-btn twitter" data-platform="twitter">
                    <i class="fab fa-twitter"></i> Twitter
                </button>
                <button class="share-btn facebook" data-platform="facebook">
                    <i class="fab fa-facebook"></i> Facebook
                </button>
                <button class="share-btn copy" data-platform="copy">
                    <i class="fas fa-copy"></i> Copiar
                </button>
            </div>
        </div>
    </div>
</body>
</html>
